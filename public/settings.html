<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1A4D6D">
    <title>Ayarlar - Voyage Assistant</title>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --voyage-navy: #1A4D6D;
            --voyage-blue: #2C6E8F;
            --voyage-light-blue: #E8F1F5;
            --voyage-gold: #C9A961;
            --text-dark: #2C3E50;
            --text-light: #6C757D;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --border: #dee2e6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--voyage-navy);
            font-size: 24px;
            font-weight: 700;
        }

        .nav-link {
            color: var(--voyage-navy);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .nav-link:hover {
            background: var(--voyage-light-blue);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tab.active {
            background: var(--voyage-navy);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--voyage-light-blue);
            color: var(--voyage-navy);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--voyage-light-blue);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--voyage-navy);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--voyage-navy);
            color: white;
        }

        .btn-primary:hover {
            background: var(--voyage-blue);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--text-light);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--voyage-navy);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--voyage-navy);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            background: var(--voyage-light-blue);
            font-weight: 600;
            color: var(--voyage-navy);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--voyage-light-blue);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--voyage-navy);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: var(--voyage-light-blue);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--voyage-navy);
            background: var(--voyage-light-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--voyage-navy);
            overflow: hidden;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload input[type="file"] {
            display: none;
        }

        .avatar-upload-btn {
            padding: 8px 16px;
            background: var(--voyage-navy);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .avatar-upload-btn:hover {
            background: var(--voyage-blue);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
        }

        .team-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .team-card {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .team-card:hover {
            border-color: var(--voyage-navy);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .team-card.selected {
            border-color: var(--voyage-navy);
            background: var(--voyage-light-blue);
        }

        .team-card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--voyage-navy);
            margin-bottom: 8px;
        }

        .team-card-description {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: var(--voyage-light-blue);
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .assignment-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid var(--voyage-light-blue);
        }

        .date-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .date-filter .form-group {
            margin-bottom: 0;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Ayarlar</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('assistants')">üë• Assistant'lar</button>
            <button class="tab" onclick="switchTab('teams')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Takƒ±mlar</button>
            <button class="tab" onclick="switchTab('assignments')">üîó E≈üle≈ütirmeler</button>
            <button class="tab" onclick="switchTab('unassigned')">‚ö†Ô∏è E≈üle≈ümemi≈ü Odalar</button>
        </div>

        <!-- Assistants Tab -->
        <div id="assistants-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Assistant Y√∂netimi</h2>
                    <button class="btn btn-primary" onclick="openAssistantModal()">+ Yeni Assistant</button>
                </div>
                <div id="assistants-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Teams Tab -->
        <div id="teams-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Takƒ±m Y√∂netimi</h2>
                    <button class="btn btn-primary" onclick="openTeamModal()">+ Yeni Takƒ±m</button>
                </div>
                <div id="teams-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Assignments Tab -->
        <div id="assignments-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Takƒ±m-Misafir E≈üle≈ütirmeleri</h2>
                    <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni E≈üle≈ütirme</button>
                </div>
                <div class="date-filter">
                    <div class="form-group">
                        <label class="form-label">Check-in Tarihi</label>
                        <input type="date" id="checkin-date-filter" class="form-input" onchange="loadAssignments()">
                    </div>
                    <button class="btn btn-primary" onclick="loadAssignments()">Filtrele</button>
                    <button class="btn btn-secondary" onclick="loadAllRoomsForDate()">O Tarihte T√ºm Odalarƒ± G√∂ster</button>
                </div>
                <div id="assignments-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Unassigned Rooms Tab -->
        <div id="unassigned-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">E≈üle≈ümemi≈ü Odalar</h2>
                    <button class="btn btn-primary" onclick="loadUnassignedRooms()">üîÑ Yenile</button>
                </div>
                <div class="date-filter">
                    <div class="form-group">
                        <label class="form-label">Check-in Tarihi (Opsiyonel)</label>
                        <input type="date" id="unassigned-date-filter" class="form-input" onchange="loadUnassignedRooms()">
                    </div>
                    <button class="btn btn-primary" onclick="loadUnassignedRooms()">Filtrele</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('unassigned-date-filter').value = ''; loadUnassignedRooms();">Filtreyi Temizle</button>
                </div>
                <div id="unassigned-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assistant Modal -->
    <div id="assistant-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="assistant-modal-title">Yeni Assistant</h3>
                <button class="close-btn" onclick="closeAssistantModal()">&times;</button>
            </div>
            <form id="assistant-form" onsubmit="saveAssistant(event)">
                <div class="form-group">
                    <label class="form-label">Avatar</label>
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="assistant-avatar-preview">
                            <span>üë§</span>
                        </div>
                        <input type="file" id="assistant-avatar-input" accept="image/*" onchange="handleAssistantAvatarChange(event)">
                        <button type="button" class="avatar-upload-btn" onclick="document.getElementById('assistant-avatar-input').click()">
                            Fotoƒüraf Se√ß
                        </button>
                        <input type="hidden" id="assistant-avatar-data">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Assistant Adƒ± *</label>
                    <input type="text" id="assistant-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email (Opsiyonel)</label>
                    <input type="email" id="assistant-email" class="form-input">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAssistantModal()">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="team-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="team-modal-title">Yeni Takƒ±m</h3>
                <button class="close-btn" onclick="closeTeamModal()">&times;</button>
            </div>
            <form id="team-form" onsubmit="saveTeam(event)">
                <div class="form-group">
                    <label class="form-label">Avatar</label>
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="team-avatar-preview">
                            <span>üë•</span>
                        </div>
                        <input type="file" id="team-avatar-input" accept="image/*" onchange="handleTeamAvatarChange(event)">
                        <button type="button" class="avatar-upload-btn" onclick="document.getElementById('team-avatar-input').click()">
                            Fotoƒüraf Se√ß
                        </button>
                        <input type="hidden" id="team-avatar-data">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Takƒ±m Adƒ± *</label>
                    <input type="text" id="team-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">A√ßƒ±klama</label>
                    <textarea id="team-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Assistant'lar</label>
                    <div id="team-assistants-checkboxes" class="checkbox-group">
                        <div class="loading">Y√ºkleniyor...</div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTeamModal()">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team QR Modal -->
    <div id="team-qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="team-qr-modal-title">Takƒ±m QR Kodu</h3>
                <button class="close-btn" onclick="closeTeamQRModal()">&times;</button>
            </div>
            <div style="text-align: center;">
                <img id="team-qr-code-image" src="" alt="QR Code" style="max-width: 300px; width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 20px 0;">
                <div class="qr-link" id="team-qr-link" style="margin-top: 20px; padding: 12px; background: #f0f2f5; border-radius: 8px; word-break: break-all; font-size: 12px; color: #667781;"></div>
                <div style="margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; font-size: 14px; color: #1976d2;">
                    <strong>‚ÑπÔ∏è Bilgi:</strong> Bu QR kodu okutan assistant otomatik olarak takƒ±ma katƒ±lacaktƒ±r.
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeTeamQRModal()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div id="assignment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Takƒ±m-Misafir E≈üle≈ütirmesi</h3>
                <button class="close-btn" onclick="closeAssignmentModal()">&times;</button>
            </div>
            <form id="assignment-form" onsubmit="saveAssignment(event)">
                <!-- Oda Bilgileri (tek oda i√ßin e≈üle≈ütirme yapƒ±ldƒ±ƒüƒ±nda g√∂sterilir) -->
                <div id="assignment-room-info" class="form-group" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 12px; color: var(--voyage-navy);">Oda Bilgileri</h4>
                    <div id="assignment-room-details" style="font-size: 14px; line-height: 1.8;">
                        <!-- Oda bilgileri buraya eklenecek -->
                    </div>
                </div>

                <!-- Takƒ±m Se√ßimi - Kartlar (tek oda i√ßin) -->
                <div class="form-group">
                    <label class="form-label">Takƒ±m Se√ßin *</label>
                    <select id="assignment-team" class="form-select" required style="display: none;">
                        <option value="">Takƒ±m Se√ßin</option>
                    </select>
                    <div id="assignment-teams-cards" class="team-cards-container">
                        <div class="loading">Y√ºkleniyor...</div>
                    </div>
                </div>

                <!-- Eski checkbox grubu (√ßoklu oda se√ßimi i√ßin - gizli) -->
                <div class="form-group" id="assignment-guests-group" style="display: none;">
                    <label class="form-label">Misafirler (Room Number - Guest Name)</label>
                    <div id="assignment-guests-checkboxes" class="checkbox-group">
                        <div class="loading">Y√ºkleniyor...</div>
                    </div>
                </div>

                <!-- Hidden input for selected room (tek oda e≈üle≈ütirmesi i√ßin) -->
                <input type="hidden" id="assignment-selected-room-number">
                <input type="hidden" id="assignment-selected-checkin-date">

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAssignmentModal()">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">E≈üle≈ütir</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentAssistantId = null;
        let currentTeamId = null;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'assistants') loadAssistants();
            if (tabName === 'teams') loadTeams();
            if (tabName === 'assignments') loadAssignments();
            if (tabName === 'unassigned') loadUnassignedRooms();
        }

        // Load assistants
        async function loadAssistants() {
            try {
                const response = await fetch('/api/assistants');
                const assistants = await response.json();
                
                const listEl = document.getElementById('assistants-list');
                if (assistants.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>Hen√ºz assistant eklenmemi≈ü</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Avatar</th>
                                <th>Ad</th>
                                <th>Email</th>
                                <th>Takƒ±m</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assistants.map(a => `
                                <tr>
                                    <td>${a.id}</td>
                                    <td>
                                        ${a.avatar ? `
                                            <img src="${a.avatar}" alt="${a.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);">üë§</div>
                                        `}
                                    </td>
                                    <td>${a.name}</td>
                                    <td>${a.email || '-'}</td>
                                    <td>
                                        ${a.teams ? `
                                            <span class="badge badge-success">${a.teams}</span>
                                        ` : `
                                            <span style="color: #999; font-style: italic;">Takƒ±m yok</span>
                                        `}
                                    </td>
                                    <td>
                                        <span class="badge ${a.is_active ? 'badge-success' : 'badge-danger'}">
                                            ${a.is_active ? 'Aktif' : 'Pasif'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editAssistant(${a.id})" style="padding: 6px 12px; font-size: 12px;">D√ºzenle</button>
                                        <button class="btn btn-danger" onclick="deleteAssistant(${a.id})" style="padding: 6px 12px; font-size: 12px;">Sil</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading assistants:', error);
                document.getElementById('assistants-list').innerHTML = `
                    <div class="alert alert-error">Assistant'lar y√ºklenirken hata olu≈ütu</div>
                `;
            }
        }

        // Load teams
        async function loadTeams() {
            try {
                const response = await fetch('/api/teams');
                const teams = await response.json();
                
                const listEl = document.getElementById('teams-list');
                if (teams.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                            <p>Hen√ºz takƒ±m olu≈üturulmamƒ±≈ü</p>
                        </div>
                    `;
                    return;
                }

                // Load assistants and QR codes for each team
                const teamsWithData = await Promise.all(teams.map(async (team) => {
                    const assistantsRes = await fetch(`/api/teams/${team.id}/assistants`);
                    const assistants = await assistantsRes.json();
                    
                    // Load QR code
                    let qrData = null;
                    try {
                        const qrRes = await fetch(`/api/teams/${team.id}/invite`);
                        if (qrRes.ok) {
                            qrData = await qrRes.json();
                        }
                    } catch (e) {
                        console.error('Error loading QR for team:', team.id, e);
                    }
                    
                    return { ...team, assistants, qrData };
                }));

                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Avatar</th>
                                <th>Takƒ±m Adƒ±</th>
                                <th>A√ßƒ±klama</th>
                                <th>Assistant'lar</th>
                                <th>Aktif Oda Sayƒ±sƒ±</th>
                                <th>QR Kod</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${teamsWithData.map(t => `
                                <tr>
                                    <td>${t.id}</td>
                                    <td>
                                        ${t.avatar ? `
                                            <img src="${t.avatar}" alt="${t.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);">üë•</div>
                                        `}
                                    </td>
                                    <td>${t.name}</td>
                                    <td>${t.description || '-'}</td>
                                    <td>${t.assistants.map(a => a.name).join(', ') || '-'}</td>
                                    <td>
                                        <span class="badge badge-success">${t.active_room_count || 0} Oda</span>
                                    </td>
                                    <td>
                                        ${t.qrData ? `
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <img src="${t.qrData.qrCodeUrl}" alt="QR Code" style="width: 60px; height: 60px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onclick="showTeamQRModal(${t.id}, '${t.name}')">
                                                <button class="btn btn-primary" onclick="showTeamQRModal(${t.id}, '${t.name}')" style="padding: 6px 12px; font-size: 12px;">üì± G√∂ster</button>
                                            </div>
                                        ` : `
                                            <button class="btn btn-secondary" onclick="generateTeamQR(${t.id})" style="padding: 6px 12px; font-size: 12px;">QR Olu≈ütur</button>
                                        `}
                                    </td>
                                    <td>
                                        <span class="badge ${t.is_active ? 'badge-success' : 'badge-danger'}">
                                            ${t.is_active ? 'Aktif' : 'Pasif'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editTeam(${t.id})" style="padding: 6px 12px; font-size: 12px;">D√ºzenle</button>
                                        <button class="btn btn-danger" onclick="deleteTeam(${t.id})" style="padding: 6px 12px; font-size: 12px;">Sil</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading teams:', error);
                document.getElementById('teams-list').innerHTML = `
                    <div class="alert alert-error">Takƒ±mlar y√ºklenirken hata olu≈ütu</div>
                `;
            }
        }

        // Load assignments
        async function loadAssignments() {
            try {
                const dateFilter = document.getElementById('checkin-date-filter').value;
                console.log('üìÖ Loading assignments with filter:', dateFilter);
                
                const listEl = document.getElementById('assignments-list');
                
                // If date filter is set, show both assigned and unassigned rooms
                if (dateFilter) {
                    console.log('üîç Date filter active, loading both assignments and rooms');
                    
                    // Load assignments for this date
                    const assignmentsUrl = `/api/team-assignments?checkin_date=${dateFilter}`;
                    console.log('üîó Fetching assignments from:', assignmentsUrl);
                    
                    const assignmentsResponse = await fetch(assignmentsUrl);
                    if (!assignmentsResponse.ok) {
                        throw new Error(`Failed to load assignments: ${assignmentsResponse.status}`);
                    }
                    const assignments = await assignmentsResponse.json();
                    console.log('‚úÖ Assignments received:', assignments.length, assignments);
                    
                    // Load all rooms for this date
                    const roomsUrl = `/api/rooms?start_date=${dateFilter}&end_date=${dateFilter}`;
                    console.log('üè® Fetching rooms from:', roomsUrl);
                    
                    const roomsResponse = await fetch(roomsUrl);
                    if (!roomsResponse.ok) {
                        throw new Error(`Failed to load rooms: ${roomsResponse.status}`);
                    }
                    const rooms = await roomsResponse.json();
                    console.log('üè® Rooms found:', rooms.length, rooms);
                    
                    if (rooms.length === 0) {
                        listEl.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üîó</div>
                                <p>${dateFilter} tarihi i√ßin check-in bulunamadƒ±</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Create a set of assigned room keys (room_number + checkin_date)
                    const assignedKeys = new Set(
                        assignments.map(a => `${a.room_number}_${a.checkin_date}`)
                    );
                    console.log('üîë Assigned room keys:', Array.from(assignedKeys));
                    
                    // Separate assigned and unassigned rooms
                    const assignedRooms = rooms.filter(r => 
                        assignedKeys.has(`${r.room_number}_${r.checkin_date}`)
                    );
                    const unassignedRooms = rooms.filter(r => 
                        !assignedKeys.has(`${r.room_number}_${r.checkin_date}`)
                    );
                    
                    console.log('‚úÖ Assigned rooms:', assignedRooms.length);
                    console.log('‚ùå Unassigned rooms:', unassignedRooms.length);
                    
                    // Create assignment map for quick lookup
                    const assignmentMap = new Map();
                    assignments.forEach(a => {
                        const key = `${a.room_number}_${a.checkin_date}`;
                        if (!assignmentMap.has(key)) {
                            assignmentMap.set(key, []);
                        }
                        assignmentMap.get(key).push(a);
                    });
                    
                    let html = `
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni E≈üle≈ütirme</button>
                        </div>
                    `;
                    
                    // Show assigned rooms section
                    if (assignedRooms.length > 0) {
                        html += `
                            <div style="margin-bottom: 24px;">
                                <h3 style="margin-bottom: 12px; color: #25D366; font-size: 16px;">
                                    ‚úÖ E≈üle≈ütirilmi≈ü Odalar (${assignedRooms.length})
                                </h3>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Takƒ±m</th>
                                            <th>Oda No</th>
                                            <th>Avatar</th>
                                            <th>Misafir</th>
                                            <th>Check-in Tarihi</th>
                                            <th>Yeti≈ükin</th>
                                            <th>√áocuk</th>
                                            <th>√úlke</th>
                                            <th>Acente</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${assignedRooms.map(r => {
                                            const key = `${r.room_number}_${r.checkin_date}`;
                                            const roomAssignments = assignmentMap.get(key) || [];
                                            return roomAssignments.map(a => `
                                                <tr style="background: #f0f9f4;">
                                                    <td>${a.team_name}</td>
                                                    <td>${r.room_number}</td>
                                                    <td>
                                                        ${r.profile_photo ? `
                                                            <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                                        ` : `
                                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);">üè®</div>
                                                        `}
                                                    </td>
                                                    <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                                    <td>${r.checkin_date || '-'}</td>
                                                    <td>${r.adult_count || '-'}</td>
                                                    <td>${r.child_count || '-'}</td>
                                                    <td>${r.country || '-'}</td>
                                                    <td>${r.agency || '-'}</td>
                                                    <td>
                                                        <button class="btn btn-danger" onclick="deleteAssignment(${a.id})" style="padding: 6px 12px; font-size: 12px;">Kaldƒ±r</button>
                                                    </td>
                                                </tr>
                                            `).join('');
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    // Show unassigned rooms section
                    if (unassignedRooms.length > 0) {
                        html += `
                            <div style="margin-bottom: 24px;">
                                <h3 style="margin-bottom: 12px; color: #ff9800; font-size: 16px;">
                                    ‚ö†Ô∏è E≈üle≈ütirilmemi≈ü Odalar (${unassignedRooms.length})
                                </h3>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Oda No</th>
                                            <th>Avatar</th>
                                            <th>Misafir</th>
                                            <th>Check-in Tarihi</th>
                                            <th>Yeti≈ükin</th>
                                            <th>√áocuk</th>
                                            <th>√úlke</th>
                                            <th>Acente</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${unassignedRooms.map(r => `
                                            <tr style="background: #fff3cd;">
                                                <td>${r.room_number}</td>
                                                <td>
                                                    ${r.profile_photo ? `
                                                        <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                                    ` : `
                                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);">üè®</div>
                                                    `}
                                                </td>
                                                <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                                <td>${r.checkin_date || '-'}</td>
                                                <td>${r.adult_count || '-'}</td>
                                                <td>${r.child_count || '-'}</td>
                                                <td>${r.country || '-'}</td>
                                                <td>${r.agency || '-'}</td>
                                                <td>
                                                    <button class="btn btn-primary" onclick="openAssignmentModalForRoom('${r.room_number}', '${r.checkin_date}')" style="padding: 6px 12px; font-size: 12px;">E≈üle≈ütir</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    if (assignedRooms.length === 0 && unassignedRooms.length === 0) {
                        html = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üîó</div>
                                <p>${dateFilter} tarihi i√ßin check-in bulunamadƒ±</p>
                            </div>
                        `;
                    }
                    
                    listEl.innerHTML = html;
                    return;
                }
                
                // No date filter - show all assignments
                const url = '/api/team-assignments';
                console.log('üîó Fetching from URL:', url);
                
                const response = await fetch(url);
                console.log('üì° Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const assignments = await response.json();
                console.log('‚úÖ Assignments received:', assignments.length, assignments);
                
                if (assignments.length === 0) {
                    console.log('‚ÑπÔ∏è No assignments found');
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîó</div>
                            <p>Hen√ºz e≈üle≈ütirme yapƒ±lmamƒ±≈ü. L√ºtfen bir tarih se√ßip filtreleyin.</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni E≈üle≈ütirme</button>
                    </div>
                    <div style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <strong>‚ÑπÔ∏è Bilgi:</strong> T√ºm e≈üle≈ütirmeler g√∂steriliyor. Belirli bir tarih i√ßin filtrelemek i√ßin tarih se√ßin.
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Takƒ±m</th>
                                <th>Oda No</th>
                                <th>Avatar</th>
                                <th>Misafir</th>
                                <th>Check-in Tarihi</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assignments.map(a => `
                                <tr>
                                    <td>${a.team_name}</td>
                                    <td>${a.room_number}</td>
                                    <td>
                                        ${a.profile_photo ? `
                                            <img src="${a.profile_photo}" alt="${a.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);">üè®</div>
                                        `}
                                    </td>
                                    <td>${a.guest_name || '-'} ${a.guest_surname || ''}</td>
                                    <td>${a.checkin_date}</td>
                                    <td>
                                        <button class="btn btn-danger" onclick="deleteAssignment(${a.id})" style="padding: 6px 12px; font-size: 12px;">Kaldƒ±r</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('assignments-list').innerHTML = `
                    <div class="alert alert-error">E≈üle≈ütirmeler y√ºklenirken hata olu≈ütu: ${error.message}</div>
                `;
            }
        }

        // Avatar handling functions
        function handleAssistantAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('assistant-avatar-preview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Avatar">`;
                    document.getElementById('assistant-avatar-data').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleTeamAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('team-avatar-preview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Avatar">`;
                    document.getElementById('team-avatar-data').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Assistant modal functions
        function openAssistantModal(id = null) {
            currentAssistantId = id;
            document.getElementById('assistant-modal-title').textContent = id ? 'Assistant D√ºzenle' : 'Yeni Assistant';
            document.getElementById('assistant-modal').classList.add('active');
            
            if (id) {
                fetch(`/api/assistants/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('assistant-name').value = data.name;
                        document.getElementById('assistant-email').value = data.email || '';
                        const preview = document.getElementById('assistant-avatar-preview');
                        if (data.avatar) {
                            preview.innerHTML = `<img src="${data.avatar}" alt="Avatar">`;
                            document.getElementById('assistant-avatar-data').value = data.avatar;
                        } else {
                            preview.innerHTML = '<span>üë§</span>';
                            document.getElementById('assistant-avatar-data').value = '';
                        }
                    });
            } else {
                document.getElementById('assistant-form').reset();
                document.getElementById('assistant-avatar-preview').innerHTML = '<span>üë§</span>';
                document.getElementById('assistant-avatar-data').value = '';
            }
        }

        function closeAssistantModal() {
            document.getElementById('assistant-modal').classList.remove('active');
            currentAssistantId = null;
        }

        async function saveAssistant(e) {
            e.preventDefault();
            const avatarData = document.getElementById('assistant-avatar-data').value;
            const data = {
                name: document.getElementById('assistant-name').value,
                email: document.getElementById('assistant-email').value || null,
                avatar: avatarData || null  // Send empty string as null
            };

            console.log('üíæ Saving assistant:', { ...data, avatar: avatarData ? 'base64 data (hidden)' : 'null' });

            try {
                const url = currentAssistantId 
                    ? `/api/assistants/${currentAssistantId}`
                    : '/api/assistants';
                const method = currentAssistantId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeAssistantModal();
                    loadAssistants();
                    showAlert('Assistant ba≈üarƒ±yla kaydedildi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function deleteAssistant(id) {
            if (!confirm('Bu assistant\'ƒ± silmek istediƒüinize emin misiniz?')) return;

            try {
                const response = await fetch(`/api/assistants/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAssistants();
                    showAlert('Assistant silindi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function editAssistant(id) {
            openAssistantModal(id);
        }

        // Team modal functions
        async function openTeamModal(id = null) {
            currentTeamId = id;
            document.getElementById('team-modal-title').textContent = id ? 'Takƒ±m D√ºzenle' : 'Yeni Takƒ±m';
            document.getElementById('team-modal').classList.add('active');
            
            // Load assistants for checkboxes
            const assistantsRes = await fetch('/api/assistants');
            const assistants = await assistantsRes.json();
            
            let selectedAssistants = [];
            if (id) {
                const teamRes = await fetch(`/api/teams/${id}`);
                const team = await teamRes.json();
                document.getElementById('team-name').value = team.name;
                document.getElementById('team-description').value = team.description || '';
                const preview = document.getElementById('team-avatar-preview');
                if (team.avatar) {
                    preview.innerHTML = `<img src="${team.avatar}" alt="Avatar">`;
                    document.getElementById('team-avatar-data').value = team.avatar;
                } else {
                    preview.innerHTML = '<span>üë•</span>';
                    document.getElementById('team-avatar-data').value = '';
                }
                
                const teamAssistantsRes = await fetch(`/api/teams/${id}/assistants`);
                selectedAssistants = await teamAssistantsRes.json();
            } else {
                document.getElementById('team-form').reset();
                document.getElementById('team-avatar-preview').innerHTML = '<span>üë•</span>';
                document.getElementById('team-avatar-data').value = '';
            }

            const checkboxesEl = document.getElementById('team-assistants-checkboxes');
            checkboxesEl.innerHTML = assistants.map(a => `
                <div class="checkbox-item">
                    <input type="checkbox" id="assistant-${a.id}" value="${a.id}" 
                        ${selectedAssistants.some(sa => sa.id === a.id) ? 'checked' : ''}>
                    <label for="assistant-${a.id}">${a.name}</label>
                </div>
            `).join('');
        }

        function closeTeamModal() {
            document.getElementById('team-modal').classList.remove('active');
            currentTeamId = null;
        }

        async function saveTeam(e) {
            e.preventDefault();
            const selectedAssistants = Array.from(document.querySelectorAll('#team-assistants-checkboxes input:checked'))
                .map(cb => parseInt(cb.value));

            const data = {
                name: document.getElementById('team-name').value,
                description: document.getElementById('team-description').value || null,
                assistant_ids: selectedAssistants,
                avatar: document.getElementById('team-avatar-data').value || null
            };

            try {
                const url = currentTeamId 
                    ? `/api/teams/${currentTeamId}`
                    : '/api/teams';
                const method = currentTeamId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeTeamModal();
                    loadTeams();
                    showAlert('Takƒ±m ba≈üarƒ±yla kaydedildi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function deleteTeam(id) {
            if (!confirm('Bu takƒ±mƒ± silmek istediƒüinize emin misiniz?')) return;

            try {
                const response = await fetch(`/api/teams/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadTeams();
                    showAlert('Takƒ±m silindi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function editTeam(id) {
            openTeamModal(id);
        }

        // Open assignment modal for specific room
        async function openAssignmentModalForRoom(roomNumber, checkinDate) {
            console.log('üìÇ Opening assignment modal for room:', roomNumber, checkinDate);
            
            // Store selected room info
            document.getElementById('assignment-selected-room-number').value = roomNumber;
            document.getElementById('assignment-selected-checkin-date').value = checkinDate;
            
            // Hide guest checkboxes, show room info
            document.getElementById('assignment-room-info').style.display = 'block';
            document.getElementById('assignment-guests-group').style.display = 'none';
            
            // Load room details
            try {
                const roomsUrl = `/api/rooms?start_date=${checkinDate}&end_date=${checkinDate}`;
                const roomsRes = await fetch(roomsUrl);
                const rooms = await roomsRes.json();
                const room = rooms.find(r => r.room_number === roomNumber && r.checkin_date === checkinDate);
                
                if (room) {
                    // Show room info
                    const roomDetailsEl = document.getElementById('assignment-room-details');
                    roomDetailsEl.innerHTML = `
                        <div><strong>Oda No:</strong> ${room.room_number}</div>
                        <div><strong>Misafir:</strong> ${room.guest_name || ''} ${room.guest_surname || ''}</div>
                        <div><strong>Check-in:</strong> ${new Date(room.checkin_date).toLocaleDateString('tr-TR')}</div>
                        ${room.adult_count ? `<div><strong>Yeti≈ükin:</strong> ${room.adult_count}</div>` : ''}
                        ${room.child_count ? `<div><strong>√áocuk:</strong> ${room.child_count}</div>` : ''}
                        ${room.country ? `<div><strong>√úlke:</strong> ${room.country}</div>` : ''}
                        ${room.agency ? `<div><strong>Acente:</strong> ${room.agency}</div>` : ''}
                    `;
                }
            } catch (error) {
                console.error('Error loading room details:', error);
            }
            
            // Hide dropdown, show team cards
            document.getElementById('assignment-team').style.display = 'none';
            document.getElementById('assignment-teams-cards').style.display = 'grid';
            
            // Load teams as cards
            await loadTeamsForAssignment();
            
            // Open modal
            document.getElementById('assignment-modal').classList.add('active');
        }

        // Load teams as cards for selection
        async function loadTeamsForAssignment() {
            try {
                const teamsRes = await fetch('/api/teams');
                const teams = await teamsRes.json();
                
                const cardsContainer = document.getElementById('assignment-teams-cards');
                
                if (teams.length === 0) {
                    cardsContainer.innerHTML = '<div class="empty-state">Hen√ºz takƒ±m olu≈üturulmamƒ±≈ü</div>';
                    return;
                }
                
                cardsContainer.innerHTML = teams
                    .filter(t => t.is_active)
                    .map(team => `
                        <div class="team-card" onclick="selectTeamCard(${team.id})" data-team-id="${team.id}">
                            <div class="team-card-title">${team.name}</div>
                            ${team.description ? `<div class="team-card-description">${team.description}</div>` : '<div class="team-card-description" style="color: #999; font-style: italic;">A√ßƒ±klama yok</div>'}
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Error loading teams:', error);
                document.getElementById('assignment-teams-cards').innerHTML = 
                    '<div class="alert alert-error">Takƒ±mlar y√ºklenirken hata olu≈ütu</div>';
            }
        }

        // Select team card
        function selectTeamCard(teamId) {
            // Remove previous selection
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select clicked card
            const card = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (card) {
                card.classList.add('selected');
                document.getElementById('assignment-team').value = teamId;
            }
        }

        // Assignment modal functions (for multi-room assignment)
        async function openAssignmentModal() {
            console.log('üìÇ Opening assignment modal (multi-room)');
            document.getElementById('assignment-modal').classList.add('active');
            
            // Hide room info, show guest checkboxes
            document.getElementById('assignment-room-info').style.display = 'none';
            document.getElementById('assignment-guests-group').style.display = 'block';
            
            // Clear selected room
            document.getElementById('assignment-selected-room-number').value = '';
            document.getElementById('assignment-selected-checkin-date').value = '';
            
            // Hide team cards, show dropdown
            document.getElementById('assignment-teams-cards').style.display = 'none';
            document.getElementById('assignment-team').style.display = 'block';
            
            // Load teams
            console.log('üë• Loading teams...');
            const teamsRes = await fetch('/api/teams');
            console.log('üë• Teams response status:', teamsRes.status);
            const teams = await teamsRes.json();
            console.log('üë• Teams loaded:', teams.length, teams);
            
            const teamSelect = document.getElementById('assignment-team');
            teamSelect.style.display = 'block';
            teamSelect.innerHTML = '<option value="">Takƒ±m Se√ßin</option>' + 
                teams.filter(t => t.is_active).map(t => `<option value="${t.id}">${t.name}</option>`).join('');

            // Load guests (rooms) - next 10 days
            const today = new Date();
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 10);
            const startDateStr = today.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            console.log('üè® Loading rooms from', startDateStr, 'to', endDateStr);
            const roomsUrl = `/api/rooms?start_date=${startDateStr}&end_date=${endDateStr}`;
            console.log('üîó Rooms URL:', roomsUrl);
            
            const roomsRes = await fetch(roomsUrl);
            console.log('üè® Rooms response status:', roomsRes.status);
            
            if (!roomsRes.ok) {
                const errorText = await roomsRes.text();
                console.error('‚ùå Error loading rooms:', errorText);
                document.getElementById('assignment-guests-checkboxes').innerHTML = 
                    `<div class="alert alert-error">Odalar y√ºklenirken hata: ${errorText}</div>`;
                return;
            }
            
            const rooms = await roomsRes.json();
            console.log('üè® Rooms loaded:', rooms.length, rooms);
            
            const guestsEl = document.getElementById('assignment-guests-checkboxes');
            
            if (rooms.length === 0) {
                console.log('‚ÑπÔ∏è No rooms found for next 10 days');
                guestsEl.innerHTML = '<div class="empty-state">√ñn√ºm√ºzdeki 10 g√ºn i√ßin check-in bulunamadƒ±</div>';
                return;
            }
            
            guestsEl.innerHTML = rooms.map(r => {
                const guestInfo = `${r.guest_name || 'Misafir'} ${r.guest_surname || ''}`.trim();
                const guestDetails = [
                    guestInfo || 'ƒ∞simsiz',
                    r.adult_count ? `${r.adult_count} Yeti≈ükin` : '',
                    r.child_count ? `${r.child_count} √áocuk` : '',
                    r.country || '',
                    r.agency || ''
                ].filter(Boolean).join(' ‚Ä¢ ');
                
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" id="guest-${r.room_number}-${r.checkin_date}" 
                            value="${r.room_number}|${r.checkin_date}">
                        <label for="guest-${r.room_number}-${r.checkin_date}" style="flex: 1;">
                            <strong>Oda ${r.room_number}</strong> - ${guestDetails}
                            <br><small style="color: #667781;">Check-in: ${r.checkin_date || 'Tarih yok'}</small>
                        </label>
                    </div>
                `;
            }).join('');
        }

        function closeAssignmentModal() {
            document.getElementById('assignment-modal').classList.remove('active');
            document.getElementById('assignment-form').reset();
            // Reset UI elements
            document.getElementById('assignment-room-info').style.display = 'none';
            document.getElementById('assignment-guests-group').style.display = 'none';
            document.getElementById('assignment-teams-cards').style.display = 'grid';
            document.getElementById('assignment-team').style.display = 'none';
            // Clear selections
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        async function saveAssignment(e) {
            e.preventDefault();
            const teamId = parseInt(document.getElementById('assignment-team').value);
            
            if (!teamId) {
                showAlert('L√ºtfen bir takƒ±m se√ßin', 'error');
                return;
            }
            
            // Check if single room assignment
            const selectedRoomNumber = document.getElementById('assignment-selected-room-number').value;
            const selectedCheckinDate = document.getElementById('assignment-selected-checkin-date').value;
            
            let selectedGuests = [];
            
            if (selectedRoomNumber && selectedCheckinDate) {
                // Single room assignment
                selectedGuests = [{ 
                    room_number: selectedRoomNumber, 
                    checkin_date: selectedCheckinDate 
                }];
            } else {
                // Multi-room assignment (from checkboxes)
                selectedGuests = Array.from(document.querySelectorAll('#assignment-guests-checkboxes input:checked'))
                    .map(cb => {
                        const [roomNumber, date] = cb.value.split('|');
                        if (!date) {
                            throw new Error('Misafir se√ßiminde check-in tarihi bulunamadƒ±');
                        }
                        return { room_number: roomNumber, checkin_date: date };
                    });
                
                if (selectedGuests.length === 0) {
                    showAlert('L√ºtfen en az bir misafir se√ßin', 'error');
                    return;
                }
            }

            try {
                const response = await fetch('/api/team-assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        team_id: teamId,
                        assignments: selectedGuests
                    })
                });

                if (response.ok) {
                    closeAssignmentModal();
                    loadAssignments();
                    loadUnassignedRooms(); // Yenile
                    showAlert('E≈üle≈ütirme ba≈üarƒ±yla yapƒ±ldƒ±', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function deleteAssignment(id) {
            if (!confirm('Bu e≈üle≈ütirmeyi kaldƒ±rmak istediƒüinize emin misiniz?')) return;

            try {
                const response = await fetch(`/api/team-assignments/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAssignments();
                    showAlert('E≈üle≈ütirme kaldƒ±rƒ±ldƒ±', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        // Load all rooms for selected date (not just assignments)
        async function loadAllRoomsForDate() {
            try {
                const dateFilter = document.getElementById('checkin-date-filter').value;
                if (!dateFilter) {
                    showAlert('L√ºtfen bir tarih se√ßin', 'error');
                    return;
                }
                
                console.log('üè® Loading all rooms for date:', dateFilter);
                const url = `/api/rooms?start_date=${dateFilter}&end_date=${dateFilter}`;
                console.log('üîó Fetching from URL:', url);
                
                const response = await fetch(url);
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const rooms = await response.json();
                console.log('‚úÖ Rooms received:', rooms.length, rooms);
                
                const listEl = document.getElementById('assignments-list');
                if (rooms.length === 0) {
                    console.log('‚ÑπÔ∏è No rooms found for date:', dateFilter);
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üè®</div>
                            <p>${dateFilter} tarihi i√ßin check-in bulunamadƒ±</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni E≈üle≈ütirme</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Oda No</th>
                                <th>Avatar</th>
                                <th>Misafir</th>
                                <th>Check-in Tarihi</th>
                                <th>Yeti≈ükin</th>
                                <th>√áocuk</th>
                                <th>√úlke</th>
                                <th>Acente</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rooms.map(r => `
                                <tr>
                                    <td>${r.room_number}</td>
                                    <td>
                                        ${r.profile_photo ? `
                                            <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);">üè®</div>
                                        `}
                                    </td>
                                    <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                    <td>${r.checkin_date || '-'}</td>
                                    <td>${r.adult_count || '-'}</td>
                                    <td>${r.child_count || '-'}</td>
                                    <td>${r.country || '-'}</td>
                                    <td>${r.agency || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading rooms:', error);
                document.getElementById('assignments-list').innerHTML = `
                    <div class="alert alert-error">Odalar y√ºklenirken hata olu≈ütu: ${error.message}</div>
                `;
            }
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alert.textContent = message;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.tabs'));
            setTimeout(() => alert.remove(), 3000);
        }

        // Load unassigned rooms
        async function loadUnassignedRooms() {
            try {
                const dateFilter = document.getElementById('unassigned-date-filter').value;
                console.log('‚ö†Ô∏è Loading unassigned rooms with filter:', dateFilter || 'all dates');
                
                const listEl = document.getElementById('unassigned-list');
                listEl.innerHTML = '<div class="loading">Y√ºkleniyor...</div>';
                
                // Load all assignments to find which rooms are assigned
                const assignmentsResponse = await fetch('/api/team-assignments');
                if (!assignmentsResponse.ok) {
                    throw new Error(`Failed to load assignments: ${assignmentsResponse.status}`);
                }
                const assignments = await assignmentsResponse.json();
                console.log('‚úÖ Assignments loaded:', assignments.length);
                
                // Create a set of assigned room keys (room_number + checkin_date)
                const assignedKeys = new Set(
                    assignments.map(a => `${a.room_number}_${a.checkin_date}`)
                );
                console.log('üîë Assigned room keys:', Array.from(assignedKeys).slice(0, 10), '...');
                
                // Load all rooms (next 30 days or filtered date)
                let roomsUrl = '/api/rooms';
                if (dateFilter) {
                    roomsUrl = `/api/rooms?start_date=${dateFilter}&end_date=${dateFilter}`;
                } else {
                    // Load next 30 days
                    const today = new Date();
                    const endDate = new Date(today);
                    endDate.setDate(today.getDate() + 30);
                    const startDateStr = today.toISOString().split('T')[0];
                    const endDateStr = endDate.toISOString().split('T')[0];
                    roomsUrl = `/api/rooms?start_date=${startDateStr}&end_date=${endDateStr}`;
                }
                
                console.log('üè® Fetching rooms from:', roomsUrl);
                const roomsResponse = await fetch(roomsUrl);
                if (!roomsResponse.ok) {
                    throw new Error(`Failed to load rooms: ${roomsResponse.status}`);
                }
                const rooms = await roomsResponse.json();
                console.log('üè® Total rooms found:', rooms.length);
                
                // Filter unassigned rooms
                const unassignedRooms = rooms.filter(r => {
                    const key = `${r.room_number}_${r.checkin_date}`;
                    return !assignedKeys.has(key);
                });
                
                console.log('‚ö†Ô∏è Unassigned rooms:', unassignedRooms.length);
                
                if (unassignedRooms.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚úÖ</div>
                            <p>${dateFilter ? dateFilter + ' tarihi i√ßin' : 'T√ºm'} e≈üle≈ümemi≈ü oda bulunamadƒ±. T√ºm odalar e≈üle≈ütirilmi≈ü!</p>
                        </div>
                    `;
                    return;
                }
                
                // Group by date for better organization
                const roomsByDate = {};
                unassignedRooms.forEach(r => {
                    const date = r.checkin_date || 'Tarih Yok';
                    if (!roomsByDate[date]) {
                        roomsByDate[date] = [];
                    }
                    roomsByDate[date].push(r);
                });
                
                const sortedDates = Object.keys(roomsByDate).sort();
                
                let html = `
                    <div style="margin-bottom: 16px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <strong>‚ö†Ô∏è Toplam ${unassignedRooms.length} e≈üle≈ümemi≈ü oda bulundu</strong>
                    </div>
                `;
                
                sortedDates.forEach(date => {
                    const dateRooms = roomsByDate[date];
                    html += `
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 12px; color: #ff9800; font-size: 16px; padding: 8px; background: #fff3cd; border-radius: 6px;">
                                üìÖ ${date} - ${dateRooms.length} Oda
                            </h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Oda No</th>
                                        <th>Avatar</th>
                                        <th>Misafir</th>
                                        <th>Check-in Tarihi</th>
                                        <th>Yeti≈ükin</th>
                                        <th>√áocuk</th>
                                        <th>√úlke</th>
                                        <th>Acente</th>
                                        <th>ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dateRooms.map(r => `
                                        <tr style="background: #fff3cd; cursor: pointer;" onclick="openAssignmentModalForRoom('${r.room_number}', '${r.checkin_date}')">
                                            <td><strong>${r.room_number}</strong></td>
                                            <td>
                                                ${r.profile_photo ? `
                                                    <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                                ` : `
                                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);">üè®</div>
                                                `}
                                            </td>
                                            <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                            <td>${r.checkin_date || '-'}</td>
                                            <td>${r.adult_count || '-'}</td>
                                            <td>${r.child_count || '-'}</td>
                                            <td>${r.country || '-'}</td>
                                            <td>${r.agency || '-'}</td>
                                            <td>
                                                <button class="btn btn-primary" onclick="event.stopPropagation(); openAssignmentModalForRoom('${r.room_number}', '${r.checkin_date}')" style="padding: 6px 12px; font-size: 12px;">E≈üle≈ütir</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                listEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading unassigned rooms:', error);
                document.getElementById('unassigned-list').innerHTML = `
                    <div class="alert alert-error">E≈üle≈ümemi≈ü odalar y√ºklenirken hata olu≈ütu: ${error.message}</div>
                `;
            }
        }

        // Team QR Code Functions
        async function generateTeamQR(teamId) {
            try {
                const response = await fetch(`/api/teams/${teamId}/invite`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error('QR kod olu≈üturulamadƒ±');
                }
                
                const qrData = await response.json();
                showTeamQRModal(teamId, null, qrData);
                loadTeams(); // Refresh list to show QR
            } catch (error) {
                console.error('Error generating team QR:', error);
                showAlert('QR kod olu≈üturulurken hata olu≈ütu', 'error');
            }
        }

        async function showTeamQRModal(teamId, teamName, qrData = null) {
            if (!qrData) {
                try {
                    const response = await fetch(`/api/teams/${teamId}/invite`);
                    if (!response.ok) {
                        throw new Error('QR kod y√ºklenemedi');
                    }
                    qrData = await response.json();
                } catch (error) {
                    console.error('Error loading QR:', error);
                    showAlert('QR kod y√ºklenirken hata olu≈ütu', 'error');
                    return;
                }
            }
            
            document.getElementById('team-qr-code-image').src = qrData.qrCodeUrl;
            document.getElementById('team-qr-link').textContent = qrData.inviteLink;
            
            const title = teamName ? `${teamName} - QR Kod` : 'Takƒ±m QR Kodu';
            document.getElementById('team-qr-modal-title').textContent = title;
            
            document.getElementById('team-qr-modal').classList.add('active');
        }

        function closeTeamQRModal() {
            document.getElementById('team-qr-modal').classList.remove('active');
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alert.textContent = message;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.tabs'));
            setTimeout(() => alert.remove(), 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadAssistants();
        });
    </script>
</body>
</html>

