<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>Ayarlar - Voyage Assistant</title>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Lucide Icons Styling */
        .icon {
            width: 1em;
            height: 1em;
            stroke-width: 2;
            display: inline-block;
            vertical-align: middle;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .icon-md {
            width: 20px;
            height: 20px;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
        }

        .icon-xl {
            width: 32px;
            height: 32px;
        }

        :root {
            --voyage-navy: #1A4D6D;
            --voyage-blue: #2C6E8F;
            --voyage-light-blue: #E8F1F5;
            --voyage-gold: #C9A961;
            --text-dark: #2C3E50;
            --text-light: #6C757D;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --border: #dee2e6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: white;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--voyage-navy);
            font-size: 24px;
            font-weight: 700;
        }

        .nav-link {
            color: var(--voyage-navy);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .nav-link:hover {
            background: var(--voyage-light-blue);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tab.active {
            background: var(--voyage-navy);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--voyage-light-blue);
            color: var(--voyage-navy);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--voyage-light-blue);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--voyage-navy);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--voyage-navy);
            color: white;
        }

        .btn-primary:hover {
            background: var(--voyage-blue);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--text-light);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--voyage-navy);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--voyage-navy);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            background: var(--voyage-light-blue);
            font-weight: 600;
            color: var(--voyage-navy);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tr:hover {
            background: white;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--voyage-light-blue);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--voyage-navy);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: var(--voyage-light-blue);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--voyage-navy);
            background: var(--voyage-light-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--voyage-navy);
            overflow: hidden;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload input[type="file"] {
            display: none;
        }

        .avatar-upload-btn {
            padding: 8px 16px;
            background: var(--voyage-navy);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .avatar-upload-btn:hover {
            background: var(--voyage-blue);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
        }

        .team-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .team-card {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .team-card:hover {
            border-color: var(--voyage-navy);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .team-card.selected {
            border-color: var(--voyage-navy);
            background: var(--voyage-light-blue);
        }

        .team-card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--voyage-navy);
            margin-bottom: 8px;
        }

        .team-card-description {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: var(--voyage-light-blue);
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .assignment-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid var(--voyage-light-blue);
        }

        .date-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .date-filter .form-group {
            margin-bottom: 0;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i data-lucide="settings" class="icon icon-lg"></i> Ayarlar</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('assistants')"><i data-lucide="users" class="icon icon-md"></i> Assistant'lar</button>
            <button class="tab" onclick="switchTab('teams')"><i data-lucide="users-round" class="icon icon-md"></i> Takƒ±mlar</button>
            <button class="tab" onclick="switchTab('assignments')"><i data-lucide="link" class="icon icon-md"></i> E≈üle≈ütirmeler</button>
            <button class="tab" onclick="switchTab('unassigned')"><i data-lucide="alert-triangle" class="icon icon-md"></i> E≈üle≈ümemi≈ü Odalar</button>
            <button class="tab" onclick="switchTab('activities')"><i data-lucide="sparkles" class="icon icon-md"></i> Hikayeler</button>
            <button class="tab" onclick="switchTab('posts')"><i data-lucide="image" class="icon icon-md"></i> Postlar</button>
        </div>

        <!-- Assistants Tab -->
        <div id="assistants-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Assistant Y√∂netimi</h2>
                    <button class="btn btn-primary" onclick="openAssistantModal()">+ Yeni Assistant</button>
                </div>
                <div id="assistants-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Teams Tab -->
        <div id="teams-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Takƒ±m Y√∂netimi</h2>
                    <button class="btn btn-primary" onclick="openTeamModal()">+ Yeni Takƒ±m</button>
                </div>
                <div id="teams-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Assignments Tab -->
        <div id="assignments-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Takƒ±m-Misafir E≈üle≈ütirmeleri</h2>
                    <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni E≈üle≈ütirme</button>
                </div>
                <div class="date-filter">
                    <div class="form-group">
                        <label class="form-label">Check-in Tarihi</label>
                        <input type="date" id="checkin-date-filter" class="form-input" onchange="loadAssignments()">
                    </div>
                    <button class="btn btn-primary" onclick="loadAssignments()">Filtrele</button>
                    <button class="btn btn-secondary" onclick="loadAllRoomsForDate()">O Tarihte T√ºm Odalarƒ± G√∂ster</button>
                </div>
                <div id="assignments-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Unassigned Rooms Tab -->
        <div id="unassigned-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">E≈üle≈ümemi≈ü Odalar</h2>
                    <button class="btn btn-primary" onclick="loadUnassignedRooms()">üîÑ Yenile</button>
                </div>
                <div class="date-filter">
                    <div class="form-group">
                        <label class="form-label">Check-in Tarihi (Opsiyonel)</label>
                        <input type="date" id="unassigned-date-filter" class="form-input" onchange="loadUnassignedRooms()">
                    </div>
                    <button class="btn btn-primary" onclick="loadUnassignedRooms()">Filtrele</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('unassigned-date-filter').value = ''; loadUnassignedRooms();">Filtreyi Temizle</button>
                </div>
                <div id="unassigned-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Activities Tab -->
        <div id="activities-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Hikaye Y√∂netimi (Story Tray)</h2>
                    <button class="btn btn-primary" onclick="openActivityModal()">+ Yeni Hikaye</button>
                </div>
                <div id="activities-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Posts Tab -->
        <div id="posts-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Post Y√∂netimi</h2>
                    <button class="btn btn-primary" onclick="openPostModal()">+ Yeni Post</button>
                </div>
                <div id="posts-list">
                    <div class="loading">Y√ºkleniyor...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assistant Modal -->
    <div id="assistant-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="assistant-modal-title">Yeni Assistant</h3>
                <button class="close-btn" onclick="closeAssistantModal()">&times;</button>
            </div>
            <form id="assistant-form" onsubmit="saveAssistant(event)">
                <div class="form-group">
                    <label class="form-label">Avatar</label>
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="assistant-avatar-preview">
                            <i data-lucide="user" class="icon icon-lg"></i>
                        </div>
                        <input type="file" id="assistant-avatar-input" accept="image/*" onchange="handleAssistantAvatarChange(event)">
                        <button type="button" class="avatar-upload-btn" onclick="document.getElementById('assistant-avatar-input').click()">
                            Fotoƒüraf Se√ß
                        </button>
                        <input type="hidden" id="assistant-avatar-data">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Assistant Adƒ± *</label>
                    <input type="text" id="assistant-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Assistant Soyadƒ± *</label>
                    <input type="text" id="assistant-surname" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email (Opsiyonel)</label>
                    <input type="email" id="assistant-email" class="form-input">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAssistantModal()">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="team-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="team-modal-title">Yeni Takƒ±m</h3>
                <button class="close-btn" onclick="closeTeamModal()">&times;</button>
            </div>
            <form id="team-form" onsubmit="saveTeam(event)">
                <div class="form-group">
                    <label class="form-label">Avatar</label>
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="team-avatar-preview">
                            <span>üë•</span>
                        </div>
                        <input type="file" id="team-avatar-input" accept="image/*" onchange="handleTeamAvatarChange(event)">
                        <button type="button" class="avatar-upload-btn" onclick="document.getElementById('team-avatar-input').click()">
                            Fotoƒüraf Se√ß
                        </button>
                        <input type="hidden" id="team-avatar-data">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Takƒ±m Adƒ± *</label>
                    <input type="text" id="team-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">A√ßƒ±klama</label>
                    <textarea id="team-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Assistant'lar</label>
                    <div id="team-assistants-checkboxes" class="checkbox-group">
                        <div class="loading">Y√ºkleniyor...</div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTeamModal()">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team QR Modal -->
    <div id="team-qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="team-qr-modal-title">Takƒ±m QR Kodu</h3>
                <button class="close-btn" onclick="closeTeamQRModal()">&times;</button>
            </div>
            <div style="text-align: center;">
                <img id="team-qr-code-image" src="" alt="QR Code" style="max-width: 300px; width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 20px 0;">
                <div class="qr-link" id="team-qr-link" style="margin-top: 20px; padding: 12px; background: white; border-radius: 8px; word-break: break-all; font-size: 12px; color: #667781;"></div>
                <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 8px; font-size: 14px; color: #1976d2;">
                    <strong><i data-lucide="info" class="icon icon-sm"></i> Bilgi:</strong> Bu QR kodu okutan assistant otomatik olarak takƒ±ma katƒ±lacaktƒ±r.
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeTeamQRModal()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div id="assignment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Takƒ±m-Misafir E≈üle≈ütirmesi</h3>
                <button class="close-btn" onclick="closeAssignmentModal()">&times;</button>
            </div>
            <form id="assignment-form" onsubmit="saveAssignment(event)">
                <!-- Oda Bilgileri (tek oda i√ßin e≈üle≈ütirme yapƒ±ldƒ±ƒüƒ±nda g√∂sterilir) -->
                <div id="assignment-room-info" class="form-group" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 12px; color: var(--voyage-navy);">Oda Bilgileri</h4>
                    <div id="assignment-room-details" style="font-size: 14px; line-height: 1.8;">
                        <!-- Oda bilgileri buraya eklenecek -->
                    </div>
                </div>

                <!-- Takƒ±m Se√ßimi - Kartlar (tek oda i√ßin) -->
                <div class="form-group">
                    <label class="form-label">Takƒ±m Se√ßin *</label>
                    <select id="assignment-team" class="form-select" style="display: none;">
                        <option value="">Takƒ±m Se√ßin</option>
                    </select>
                    <div id="assignment-teams-cards" class="team-cards-container">
                        <div class="loading">Y√ºkleniyor...</div>
                    </div>
                </div>

                <!-- Eski checkbox grubu (√ßoklu oda se√ßimi i√ßin - gizli) -->
                <div class="form-group" id="assignment-guests-group" style="display: none;">
                    <label class="form-label">Misafirler (Room Number - Guest Name)</label>
                    <div id="assignment-guests-checkboxes" class="checkbox-group">
                        <div class="loading">Y√ºkleniyor...</div>
                    </div>
                </div>

                <!-- Hidden input for selected room (tek oda e≈üle≈ütirmesi i√ßin) -->
                <input type="hidden" id="assignment-selected-room-number">
                <input type="hidden" id="assignment-selected-checkin-date">
                <input type="hidden" id="assignment-selected-guest-unique-id">

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAssignmentModal()">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">E≈üle≈ütir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activity-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="activity-modal-title">Yeni Hikaye</h3>
                <button class="close-btn" onclick="closeActivityModal()">&times;</button>
            </div>
            <form id="activity-form" onsubmit="saveActivity(event)">
                <div class="form-group">
                    <label class="form-label">Ba≈ülƒ±k *</label>
                    <input type="text" id="activity-title" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ƒ∞kon (opsiyonel)</label>
                    <input type="text" id="activity-icon" class="form-input" placeholder="√ñrn: activity-1">
                </div>
                <div class="form-group">
                    <label class="form-label">Tarih</label>
                    <input type="date" id="activity-date" class="form-input">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label">Ba≈ülangƒ±√ß Saati</label>
                        <input type="time" id="activity-start-time" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">Biti≈ü Saati</label>
                        <input type="time" id="activity-end-time" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Kategori</label>
                    <input type="text" id="activity-category" class="form-input" placeholder="√ñrn: Sabah / √ñƒüle / Ak≈üam">
                </div>
                <div class="form-group">
                    <label class="form-label">T√ºr</label>
                    <input type="text" id="activity-type" class="form-input" placeholder="√ñrn: Spor / √áocuk / G√∂steri">
                </div>
                <div class="form-group">
                    <label class="form-label">Lokasyon</label>
                    <input type="text" id="activity-location" class="form-input" placeholder="√ñrn: Ana Sahne / Havuz">
                </div>
                <div class="form-group">
                    <label class="form-label">A√ßƒ±klama</label>
                    <textarea id="activity-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label">Eƒüitmen</label>
                        <input type="text" id="activity-instructor" class="form-input" placeholder="Opsiyonel">
                    </div>
                    <div>
                        <label class="form-label">Ya≈ü Grubu</label>
                        <input type="text" id="activity-age-group" class="form-input" placeholder="√ñrn: Kids / Adults / All">
                    </div>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label">Kapasite</label>
                        <input type="number" id="activity-capacity" class="form-input" min="0" step="1">
                    </div>
                    <div>
                        <label class="form-label">Enlem</label>
                        <input type="number" id="activity-lat" class="form-input" step="0.00000001">
                    </div>
                    <div>
                        <label class="form-label">Boylam</label>
                        <input type="number" id="activity-lng" class="form-input" step="0.00000001">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="activity-featured"> √ñne √áƒ±kan
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Medya (Foto/Video URL)</label>
                    <input type="text" id="activity-image-url" class="form-input" placeholder="Fotoƒüraf URL (opsiyonel)">
                    <div style="height: 8px;"></div>
                    <input type="text" id="activity-video-url" class="form-input" placeholder="Video URL (opsiyonel)">
                    <div style="font-size: 12px; color: #667781; margin-top: 6px;">
                        Not: Video URL girerseniz fotoƒüraf alanƒ± otomatik bo≈üaltƒ±lƒ±r (ve tersi).
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Sƒ±ra (opsiyonel)</label>
                    <input type="number" id="activity-display-order" class="form-input" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="activity-is-active" checked> Aktif
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeActivityModal()">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Post Modal -->
    <div id="post-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="post-modal-title">Yeni Post</h3>
                <button class="close-btn" onclick="closePostModal()">&times;</button>
            </div>
            <form id="post-form" onsubmit="savePost(event)">
                <div class="form-group">
                    <label class="form-label">Post ID *</label>
                    <input type="text" id="post-post-id" class="form-input" required placeholder="√ñrn: post-1">
                </div>
                <div class="form-group">
                    <label class="form-label">Ba≈ülƒ±k *</label>
                    <input type="text" id="post-title" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ƒ∞kon (opsiyonel)</label>
                    <input type="text" id="post-icon" class="form-input" placeholder="√ñrn: activity-1">
                </div>
                <div class="form-group">
                    <label class="form-label">Lokasyon</label>
                    <input type="text" id="post-location" class="form-input" placeholder="√ñrn: Voyage Sorgun / Lobby">
                </div>
                <div class="form-group">
                    <label class="form-label">A√ßƒ±klama (opsiyonel)</label>
                    <textarea id="post-caption" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Medya (Foto/Video URL)</label>
                    <input type="text" id="post-image-url" class="form-input" placeholder="Fotoƒüraf URL (opsiyonel)">
                    <div style="height: 8px;"></div>
                    <input type="text" id="post-video-url" class="form-input" placeholder="Video URL (opsiyonel)">
                    <div style="font-size: 12px; color: #667781; margin-top: 6px;">
                        Not: Video URL girerseniz fotoƒüraf alanƒ± otomatik bo≈üaltƒ±lƒ±r (ve tersi).
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Sƒ±ra (opsiyonel)</label>
                    <input type="number" id="post-display-order" class="form-input" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="post-is-active" checked> Aktif
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePostModal()">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentAssistantId = null;
        let currentTeamId = null;
        let currentActivityId = null;
        let currentPostId = null;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'assistants') loadAssistants();
            if (tabName === 'teams') loadTeams();
            if (tabName === 'assignments') loadAssignments();
            if (tabName === 'unassigned') loadUnassignedRooms();
            if (tabName === 'activities') loadActivities();
            if (tabName === 'posts') loadPosts();
        }

        // Load assistants
        async function loadAssistants() {
            try {
                const response = await fetch('/api/assistants');
                const assistants = await response.json();
                
                const listEl = document.getElementById('assistants-list');
                if (assistants.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>Hen√ºz assistant eklenmemi≈ü</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Asistan ID</th>
                                <th>Avatar</th>
                                <th>Ad</th>
                                <th>Soyad</th>
                                <th>Takƒ±m</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assistants.map(a => {
                                // Use name and surname directly from database
                                const firstName = a.name || '';
                                const lastName = a.surname || '';
                                
                                return `
                                <tr>
                                    <td>${a.id}</td>
                                    <td>
                                        ${a.avatar ? `
                                            <img src="${a.avatar}" alt="${a.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="user" class="icon icon-lg"></i></div>
                                        `}
                                    </td>
                                    <td>${firstName}</td>
                                    <td>${lastName || '-'}</td>
                                    <td>
                                        ${a.teams ? `
                                            <span class="badge badge-success">${a.teams}</span>
                                        ` : `
                                            <span style="color: #999; font-style: italic;">Takƒ±m yok</span>
                                        `}
                                    </td>
                                    <td>
                                        <span class="badge ${a.is_active ? 'badge-success' : 'badge-danger'}">
                                            ${a.is_active ? 'Aktif' : 'Pasif'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editAssistant(${a.id})" style="padding: 6px 12px; font-size: 12px;">D√ºzenle</button>
                                        <button class="btn btn-danger" onclick="deleteAssistant(${a.id})" style="padding: 6px 12px; font-size: 12px;">Sil</button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading assistants:', error);
                document.getElementById('assistants-list').innerHTML = `
                    <div class="alert alert-error">Assistant'lar y√ºklenirken hata olu≈ütu</div>
                `;
            }
        }

        // Load teams
        async function loadTeams() {
            try {
                const response = await fetch('/api/teams');
                const teams = await response.json();
                
                const listEl = document.getElementById('teams-list');
                if (teams.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                            <p>Hen√ºz takƒ±m olu≈üturulmamƒ±≈ü</p>
                        </div>
                    `;
                    return;
                }

                // Load assistants for each team
                const teamsWithData = await Promise.all(teams.map(async (team) => {
                    const assistantsRes = await fetch(`/api/teams/${team.id}/assistants`);
                    const assistants = await assistantsRes.json();
                    
                    return { ...team, assistants };
                }));

                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Avatar</th>
                                <th>Takƒ±m Adƒ±</th>
                                <th>A√ßƒ±klama</th>
                                <th>Assistant'lar</th>
                                <th>Aktif Oda Sayƒ±sƒ±</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${teamsWithData.map(t => `
                                <tr>
                                    <td>${t.id}</td>
                                    <td>
                                        ${t.avatar ? `
                                            <img src="${t.avatar}" alt="${t.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);">üë•</div>
                                        `}
                                    </td>
                                    <td>${t.name}</td>
                                    <td>${t.description || '-'}</td>
                                    <td>${t.assistants.map(a => a.name).join(', ') || '-'}</td>
                                    <td>
                                        <span class="badge badge-success">${t.active_room_count || 0} Oda</span>
                                    </td>
                                    <td>
                                        <span class="badge ${t.is_active ? 'badge-success' : 'badge-danger'}">
                                            ${t.is_active ? 'Aktif' : 'Pasif'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editTeam(${t.id})" style="padding: 6px 12px; font-size: 12px;">D√ºzenle</button>
                                        <button class="btn btn-danger" onclick="deleteTeam(${t.id})" style="padding: 6px 12px; font-size: 12px;">Sil</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading teams:', error);
                document.getElementById('teams-list').innerHTML = `
                    <div class="alert alert-error">Takƒ±mlar y√ºklenirken hata olu≈ütu</div>
                `;
            }
        }

        // Load assignments
        async function loadAssignments() {
            try {
                const dateFilter = document.getElementById('checkin-date-filter').value;
                console.log('üìÖ Loading assignments with filter:', dateFilter);
                
                const listEl = document.getElementById('assignments-list');
                
                // If date filter is set, show both assigned and unassigned rooms
                if (dateFilter) {
                    console.log('üîç Date filter active, loading both assignments and rooms');
                    
                    // Load assignments for this date
                    const assignmentsUrl = `/api/team-assignments?checkin_date=${dateFilter}`;
                    console.log('üîó Fetching assignments from:', assignmentsUrl);
                    
                    const assignmentsResponse = await fetch(assignmentsUrl);
                    if (!assignmentsResponse.ok) {
                        throw new Error(`Failed to load assignments: ${assignmentsResponse.status}`);
                    }
                    const assignments = await assignmentsResponse.json();
                    console.log('‚úÖ Assignments received:', assignments.length, assignments);
                    
                    // Load all rooms for this date
                    const roomsUrl = `/api/rooms?start_date=${dateFilter}&end_date=${dateFilter}`;
                    console.log('üè® Fetching rooms from:', roomsUrl);
                    
                    const roomsResponse = await fetch(roomsUrl);
                    if (!roomsResponse.ok) {
                        throw new Error(`Failed to load rooms: ${roomsResponse.status}`);
                    }
                    const rooms = await roomsResponse.json();
                    console.log('üè® Rooms found:', rooms.length, rooms);
                    
                    if (rooms.length === 0) {
                        listEl.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üîó</div>
                                <p>${dateFilter} tarihi i√ßin check-in bulunamadƒ±</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Create a set of assigned room keys (room_number + checkin_date)
                    const assignedKeys = new Set(
                        assignments.map(a => `${a.room_number}_${a.checkin_date}`)
                    );
                    console.log('üîë Assigned room keys:', Array.from(assignedKeys));
                    
                    // Separate assigned and unassigned rooms
                    const assignedRooms = rooms.filter(r => 
                        assignedKeys.has(`${r.room_number}_${r.checkin_date}`)
                    );
                    const unassignedRooms = rooms.filter(r => 
                        !assignedKeys.has(`${r.room_number}_${r.checkin_date}`)
                    );
                    
                    console.log('‚úÖ Assigned rooms:', assignedRooms.length);
                    console.log('‚ùå Unassigned rooms:', unassignedRooms.length);
                    
                    // Create assignment map for quick lookup
                    const assignmentMap = new Map();
                    assignments.forEach(a => {
                        const key = `${a.room_number}_${a.checkin_date}`;
                        if (!assignmentMap.has(key)) {
                            assignmentMap.set(key, []);
                        }
                        assignmentMap.get(key).push(a);
                    });
                    
                    let html = `
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni E≈üle≈ütirme</button>
                        </div>
                    `;
                    
                    // Show assigned rooms section
                    if (assignedRooms.length > 0) {
                        html += `
                            <div style="margin-bottom: 24px;">
                                <h3 style="margin-bottom: 12px; color: #25D366; font-size: 16px;">
                                    ‚úÖ E≈üle≈ütirilmi≈ü Odalar (${assignedRooms.length})
                                </h3>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Takƒ±m</th>
                                            <th>Unique ID</th>
                                            <th>Avatar</th>
                                            <th>Misafir</th>
                                            <th>Check-in Tarihi</th>
                                            <th>Yeti≈ükin</th>
                                            <th>√áocuk</th>
                                            <th>√úlke</th>
                                            <th>Acente</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${assignedRooms.map(r => {
                                            const key = `${r.room_number}_${r.checkin_date}`;
                                            const roomAssignments = assignmentMap.get(key) || [];
                                            return roomAssignments.map(a => `
                                                <tr style="background: white;">
                                                    <td>${a.team_name}</td>
                                                    <td style="font-family: monospace; font-size: 11px;">${r.guest_unique_id || '-'}</td>
                                                    <td>
                                                        ${r.profile_photo ? `
                                                            <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                                        ` : `
                                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                                        `}
                                                    </td>
                                                    <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                                    <td>${r.checkin_date || '-'}</td>
                                                    <td>${r.adult_count || '-'}</td>
                                                    <td>${r.child_count || '-'}</td>
                                                    <td>${r.country || '-'}</td>
                                                    <td>${r.agency || '-'}</td>
                                                    <td>
                                                        <button class="btn btn-danger" onclick="deleteAssignment(${a.id})" style="padding: 6px 12px; font-size: 12px;">Kaldƒ±r</button>
                                                    </td>
                                                </tr>
                                            `).join('');
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    // Show unassigned rooms section
                    if (unassignedRooms.length > 0) {
                        html += `
                            <div style="margin-bottom: 24px;">
                                <h3 style="margin-bottom: 12px; color: #ff9800; font-size: 16px;">
                                    ‚ö†Ô∏è E≈üle≈ütirilmemi≈ü Odalar (${unassignedRooms.length})
                                </h3>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Unique ID</th>
                                            <th>Avatar</th>
                                            <th>Misafir</th>
                                            <th>Check-in Tarihi</th>
                                            <th>Yeti≈ükin</th>
                                            <th>√áocuk</th>
                                            <th>√úlke</th>
                                            <th>Acente</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${unassignedRooms.map(r => `
                                            <tr style="background: white;">
                                                <td style="font-family: monospace; font-size: 11px;">${r.guest_unique_id || '-'}</td>
                                                <td>
                                                    ${r.profile_photo ? `
                                                        <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                                    ` : `
                                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                                    `}
                                                </td>
                                                <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                                <td>${r.checkin_date || '-'}</td>
                                                <td>${r.adult_count || '-'}</td>
                                                <td>${r.child_count || '-'}</td>
                                                <td>${r.country || '-'}</td>
                                                <td>${r.agency || '-'}</td>
                                                <td>
                                                    <button class="btn btn-primary" onclick="openAssignmentModalForRoomByGuestId('${r.guest_unique_id || ''}', '${r.room_number || ''}', '${r.checkin_date || ''}')" style="padding: 6px 12px; font-size: 12px;">E≈üle≈ütir</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    if (assignedRooms.length === 0 && unassignedRooms.length === 0) {
                        html = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üîó</div>
                                <p>${dateFilter} tarihi i√ßin check-in bulunamadƒ±</p>
                            </div>
                        `;
                    }
                    
                    listEl.innerHTML = html;
                    return;
                }
                
                // No date filter - show all assignments
                const url = '/api/team-assignments';
                console.log('üîó Fetching from URL:', url);
                
                const response = await fetch(url);
                console.log('üì° Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const assignments = await response.json();
                console.log('‚úÖ Assignments received:', assignments.length, assignments);
                
                if (assignments.length === 0) {
                    console.log('‚ÑπÔ∏è No assignments found');
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîó</div>
                            <p>Hen√ºz e≈üle≈ütirme yapƒ±lmamƒ±≈ü. L√ºtfen bir tarih se√ßip filtreleyin.</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni E≈üle≈ütirme</button>
                    </div>
                    <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <strong><i data-lucide="info" class="icon icon-sm"></i> Bilgi:</strong> T√ºm e≈üle≈ütirmeler g√∂steriliyor. Belirli bir tarih i√ßin filtrelemek i√ßin tarih se√ßin.
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Takƒ±m</th>
                                <th>Oda No</th>
                                <th>Avatar</th>
                                <th>Misafir</th>
                                <th>Check-in Tarihi</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assignments.map(a => `
                                <tr>
                                    <td>${a.team_name}</td>
                                    <td style="font-family: monospace; font-size: 11px;">${a.guest_unique_id || a.room_number || '-'}</td>
                                    <td>
                                        ${a.profile_photo ? `
                                            <img src="${a.profile_photo}" alt="${a.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                        `}
                                    </td>
                                    <td>${a.guest_name || '-'} ${a.guest_surname || ''}</td>
                                    <td>${a.checkin_date}</td>
                                    <td>
                                        <button class="btn btn-danger" onclick="deleteAssignment(${a.id})" style="padding: 6px 12px; font-size: 12px;">Kaldƒ±r</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('assignments-list').innerHTML = `
                    <div class="alert alert-error">E≈üle≈ütirmeler y√ºklenirken hata olu≈ütu: ${error.message}</div>
                `;
            }
        }

        // Resize image to optimal size for avatar
        function resizeImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions while maintaining aspect ratio
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to base64
                        const resizedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(resizedDataUrl);
                    };
                    img.onerror = function() {
                        reject(new Error('Resim y√ºklenirken hata olu≈ütu'));
                    };
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    reject(new Error('Dosya okunurken hata olu≈ütu'));
                };
                reader.readAsDataURL(file);
            });
        }

        // Avatar handling functions
        async function handleAssistantAvatarChange(event) {
            const file = event.target.files[0];
            console.log('üì∏ Avatar file selected:', file ? file.name : 'none');
            
            if (file) {
                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert('L√ºtfen bir resim dosyasƒ± se√ßin.');
                    event.target.value = ''; // Clear selection
                    return;
                }
                
                const preview = document.getElementById('assistant-avatar-preview');
                const avatarDataInput = document.getElementById('assistant-avatar-data');
                
                if (!preview || !avatarDataInput) {
                    console.error('‚ùå Avatar preview or data input not found');
                    return;
                }
                
                // Show loading state
                preview.innerHTML = '<span style="font-size: 14px;">Y√ºkleniyor...</span>';
                
                try {
                    // Resize image to 400x400 max (avatar size) with 0.9 quality
                    const originalSize = (file.size / 1024 / 1024).toFixed(2);
                    console.log('üì∏ Original file size:', originalSize, 'MB');
                    
                    const resizedData = await resizeImage(file, 400, 400, 0.9);
                    const resizedSize = (resizedData.length / 1024 / 1024).toFixed(2);
                    console.log('üì∏ Resized data size:', resizedSize, 'MB');
                    console.log('üì∏ Compression ratio:', ((1 - resizedData.length / (file.size * 1.33)) * 100).toFixed(1) + '%'); // base64 is ~33% larger
                    
                    preview.innerHTML = `<img src="${resizedData}" alt="Avatar">`;
                    avatarDataInput.value = resizedData;
                    
                    console.log('‚úÖ Avatar resized and saved to hidden input');
                } catch (error) {
                    console.error('‚ùå Error processing avatar:', error);
                    alert('Fotoƒüraf i≈ülenirken bir hata olu≈ütu: ' + error.message);
                    preview.innerHTML = '<i data-lucide="user" class="icon icon-xl"></i>';
                    event.target.value = ''; // Clear selection
                }
            } else {
                console.log('‚ö†Ô∏è No file selected');
            }
        }

        async function handleTeamAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert('L√ºtfen bir resim dosyasƒ± se√ßin.');
                    event.target.value = ''; // Clear selection
                    return;
                }
                
                    const preview = document.getElementById('team-avatar-preview');
                const avatarDataInput = document.getElementById('team-avatar-data');
                
                if (!preview || !avatarDataInput) {
                    console.error('‚ùå Team avatar preview or data input not found');
                    return;
                }
                
                // Show loading state
                preview.innerHTML = '<span style="font-size: 14px;">Y√ºkleniyor...</span>';
                
                try {
                    // Resize image to 400x400 max (avatar size) with 0.9 quality
                    const originalSize = (file.size / 1024 / 1024).toFixed(2);
                    console.log('üì∏ Team avatar - Original file size:', originalSize, 'MB');
                    
                    const resizedData = await resizeImage(file, 400, 400, 0.9);
                    const resizedSize = (resizedData.length / 1024 / 1024).toFixed(2);
                    console.log('üì∏ Team avatar - Resized data size:', resizedSize, 'MB');
                    console.log('üì∏ Team avatar - Compression ratio:', ((1 - resizedData.length / (file.size * 1.33)) * 100).toFixed(1) + '%');
                    
                    preview.innerHTML = `<img src="${resizedData}" alt="Avatar">`;
                    avatarDataInput.value = resizedData;
                    
                    console.log('‚úÖ Team avatar resized and saved to hidden input');
                } catch (error) {
                    console.error('‚ùå Error processing team avatar:', error);
                    alert('Fotoƒüraf i≈ülenirken bir hata olu≈ütu: ' + error.message);
                    preview.innerHTML = '<span>üë•</span>';
                    event.target.value = ''; // Clear selection
                }
            }
        }

        // Assistant modal functions
        function openAssistantModal(id = null) {
            currentAssistantId = id;
            document.getElementById('assistant-modal-title').textContent = id ? 'Assistant D√ºzenle' : 'Yeni Assistant';
            document.getElementById('assistant-modal').classList.add('active');
            
            if (id) {
                fetch(`/api/assistants/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('assistant-name').value = data.name || '';
                        document.getElementById('assistant-surname').value = data.surname || '';
                        document.getElementById('assistant-email').value = data.email || '';
                        const preview = document.getElementById('assistant-avatar-preview');
                        if (data.avatar) {
                            preview.innerHTML = `<img src="${data.avatar}" alt="Avatar">`;
                            document.getElementById('assistant-avatar-data').value = data.avatar;
                        } else {
                            preview.innerHTML = '<i data-lucide="user" class="icon icon-xl"></i>';
                            document.getElementById('assistant-avatar-data').value = '';
                        }
                    });
            } else {
                document.getElementById('assistant-form').reset();
                document.getElementById('assistant-avatar-preview').innerHTML = '<span>üë§</span>';
                document.getElementById('assistant-avatar-data').value = '';
            }
        }

        function closeAssistantModal() {
            document.getElementById('assistant-modal').classList.remove('active');
            currentAssistantId = null;
        }

        async function saveAssistant(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üíæ saveAssistant called');
            
            try {
                const nameInput = document.getElementById('assistant-name');
                const surnameInput = document.getElementById('assistant-surname');
                const emailInput = document.getElementById('assistant-email');
                const avatarDataInput = document.getElementById('assistant-avatar-data');
                
                if (!nameInput || !surnameInput || !avatarDataInput) {
                    console.error('‚ùå Form elements not found');
                    showAlert('Form elemanlarƒ± bulunamadƒ±', 'error');
                    return;
                }
                
                const name = nameInput.value.trim();
                const surname = surnameInput.value.trim();
                
                if (!name) {
                    showAlert('Assistant adƒ± gereklidir', 'error');
                    return;
                }
                
                if (!surname) {
                    showAlert('Assistant soyadƒ± gereklidir', 'error');
                    return;
                }
                
                const avatarData = avatarDataInput.value || null;
            const data = {
                    name: name,
                    surname: surname,
                    email: emailInput ? (emailInput.value.trim() || null) : null,
                    avatar: avatarData || null
                };

                console.log('üíæ Saving assistant:', { 
                    id: currentAssistantId,
                    name: data.name,
                    email: data.email,
                    avatar: avatarData ? `base64 (${avatarData.length} chars)` : 'null' 
                });

                const url = currentAssistantId 
                    ? `/api/assistants/${currentAssistantId}`
                    : '/api/assistants';
                const method = currentAssistantId ? 'PUT' : 'POST';

                console.log('üì° Sending request:', method, url);

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                console.log('üì° Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Assistant saved successfully:', result);
                    closeAssistantModal();
                    loadAssistants();
                    showAlert('Assistant ba≈üarƒ±yla kaydedildi', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', response.status, errorText);
                    showAlert('Hata: ' + errorText, 'error');
                }
            } catch (error) {
                console.error('‚ùå Exception in saveAssistant:', error);
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function deleteAssistant(id) {
            if (!confirm('Bu assistant\'ƒ± silmek istediƒüinize emin misiniz?')) return;

            try {
                const response = await fetch(`/api/assistants/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAssistants();
                    showAlert('Assistant silindi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function editAssistant(id) {
            openAssistantModal(id);
        }

        // Team modal functions
        async function openTeamModal(id = null) {
            currentTeamId = id;
            document.getElementById('team-modal-title').textContent = id ? 'Takƒ±m D√ºzenle' : 'Yeni Takƒ±m';
            document.getElementById('team-modal').classList.add('active');
            
            // Load assistants for checkboxes
            const assistantsRes = await fetch('/api/assistants');
            const assistants = await assistantsRes.json();
            
            let selectedAssistants = [];
            if (id) {
                const teamRes = await fetch(`/api/teams/${id}`);
                const team = await teamRes.json();
                document.getElementById('team-name').value = team.name;
                document.getElementById('team-description').value = team.description || '';
                const preview = document.getElementById('team-avatar-preview');
                if (team.avatar) {
                    preview.innerHTML = `<img src="${team.avatar}" alt="Avatar">`;
                    document.getElementById('team-avatar-data').value = team.avatar;
                } else {
                    preview.innerHTML = '<span>üë•</span>';
                    document.getElementById('team-avatar-data').value = '';
                }
                
                const teamAssistantsRes = await fetch(`/api/teams/${id}/assistants`);
                selectedAssistants = await teamAssistantsRes.json();
            } else {
                document.getElementById('team-form').reset();
                document.getElementById('team-avatar-preview').innerHTML = '<span>üë•</span>';
                document.getElementById('team-avatar-data').value = '';
            }

            const checkboxesEl = document.getElementById('team-assistants-checkboxes');
            checkboxesEl.innerHTML = assistants.map(a => `
                <div class="checkbox-item">
                    <input type="checkbox" id="assistant-${a.id}" value="${a.id}" 
                        ${selectedAssistants.some(sa => sa.id === a.id) ? 'checked' : ''}>
                    <label for="assistant-${a.id}">${a.name}</label>
                </div>
            `).join('');
        }

        function closeTeamModal() {
            document.getElementById('team-modal').classList.remove('active');
            currentTeamId = null;
        }

        async function saveTeam(e) {
            e.preventDefault();
            const selectedAssistants = Array.from(document.querySelectorAll('#team-assistants-checkboxes input:checked'))
                .map(cb => parseInt(cb.value));

            const data = {
                name: document.getElementById('team-name').value,
                description: document.getElementById('team-description').value || null,
                assistant_ids: selectedAssistants,
                avatar: document.getElementById('team-avatar-data').value || null
            };

            try {
                const url = currentTeamId 
                    ? `/api/teams/${currentTeamId}`
                    : '/api/teams';
                const method = currentTeamId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeTeamModal();
                    loadTeams();
                    showAlert('Takƒ±m ba≈üarƒ±yla kaydedildi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function deleteTeam(id) {
            if (!confirm('Bu takƒ±mƒ± silmek istediƒüinize emin misiniz?')) return;

            try {
                const response = await fetch(`/api/teams/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadTeams();
                    showAlert('Takƒ±m silindi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function editTeam(id) {
            openTeamModal(id);
        }

        // Generate guest unique ID (same algorithm as backend)
        async function generateGuestUniqueId(guestName, guestSurname, checkinDate, checkoutDate) {
            if (!checkinDate) {
                return null;
            }
            
            // Normalize function for Turkish locale and Unicode
            function normalizeText(text) {
                if (!text) return '';
                // Unicode normalization (NFC) - handles composed characters
                let normalized = text.normalize('NFC');
                // Turkish locale-aware lowercase conversion
                normalized = normalized.toLocaleLowerCase('tr-TR');
                // Replace multiple spaces with single space, then with underscore
                normalized = normalized.trim().replace(/\s+/g, '_');
                // Remove any remaining special characters except underscore
                normalized = normalized.replace(/[^a-z0-9_ƒü√º≈üƒ±√∂√ß]/gi, '');
                return normalized;
            }
            
            // Normalize inputs - use 'Guest' if name is not provided
            const name = normalizeText(guestName || guestSurname || 'Guest');
            const surname = normalizeText(guestSurname || '');
            
            // Normalize dates
            let checkin = '';
            if (checkinDate instanceof Date) {
                checkin = checkinDate.toISOString().split('T')[0];
            } else if (checkinDate) {
                checkin = String(checkinDate).split('T')[0];
            }
            
            let checkout = '';
            if (checkoutDate instanceof Date) {
                checkout = checkoutDate.toISOString().split('T')[0];
            } else if (checkoutDate) {
                checkout = String(checkoutDate).split('T')[0];
            }
            
            // Create unique ID: name_surname_checkin_checkout (hash for uniqueness)
            const combined = checkout 
                ? `${name}_${surname}_${checkin}_${checkout}`
                : `${name}_${surname}_${checkin}`;
            
            // Use Web Crypto API to create SHA256 hash (same as backend)
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(combined);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
                
                return checkout 
                    ? `${name}_${surname}_${checkin}_${checkout}_${hash}`
                    : `${name}_${surname}_${checkin}_${hash}`;
            } catch (error) {
                console.error('Error generating hash:', error);
                // Fallback to simple hash if crypto API fails
                function simpleHash(str) {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        const char = str.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return Math.abs(hash).toString(16).substring(0, 16);
                }
                const hash = simpleHash(combined);
                return checkout 
                    ? `${name}_${surname}_${checkin}_${checkout}_${hash}`
                    : `${name}_${surname}_${checkin}_${hash}`;
            }
        }

        // Open assignment modal for specific room by guest_unique_id (or room_number + checkin_date)
        async function openAssignmentModalForRoomByGuestId(guestUniqueId, roomNumber = null, checkinDate = null) {
            console.log('üìÇ Opening assignment modal for guest_unique_id:', guestUniqueId, 'roomNumber:', roomNumber, 'checkinDate:', checkinDate);
            
            // Hide guest checkboxes, show room info
            document.getElementById('assignment-room-info').style.display = 'block';
            document.getElementById('assignment-guests-group').style.display = 'none';
            
            // Load room details - try by guest_unique_id first, then by room_number + checkin_date
            let room = null;
            let actualGuestUniqueId = guestUniqueId;
            
            try {
                const roomsUrl = '/api/rooms';
                const roomsRes = await fetch(roomsUrl);
                const rooms = await roomsRes.json();
                
                // If guestUniqueId is provided and not empty, try to find by it
                if (guestUniqueId && guestUniqueId.trim() !== '') {
                    room = rooms.find(r => r.guest_unique_id === guestUniqueId);
                    console.log('üîç Searched by guest_unique_id:', guestUniqueId, 'Found:', !!room);
                }
                
                // If not found and we have room_number and checkin_date, try to find by them
                if (!room && roomNumber && checkinDate) {
                    room = rooms.find(r => r.room_number === roomNumber && r.checkin_date === checkinDate);
                    console.log('üîç Searched by room_number + checkin_date:', roomNumber, checkinDate, 'Found:', !!room);
                }
            } catch (error) {
                console.error('Error loading room details:', error);
            }
            
            // If room not found, show error
            if (!room) {
                showAlert('Misafir bilgisi bulunamadƒ±', 'error');
                return;
            }
            
            // If room found but guest_unique_id is missing, generate it
            if (room && (!room.guest_unique_id || room.guest_unique_id.trim() === '')) {
                console.log('üîß Room found but guest_unique_id is missing, generating...');
                if (room.guest_name && room.checkin_date && room.checkout_date) {
                    actualGuestUniqueId = await generateGuestUniqueId(
                        room.guest_name, 
                        room.guest_surname, 
                        room.checkin_date, 
                        room.checkout_date
                    );
                    console.log('‚úÖ Generated guest_unique_id:', actualGuestUniqueId);
                    
                    // Update room object
                    room.guest_unique_id = actualGuestUniqueId;
                    
                    // Note: guest_unique_id will be updated in backend when assignment is saved
                } else {
                    console.error('‚ùå Cannot generate guest_unique_id: missing required info', {
                        guest_name: room.guest_name,
                        checkin_date: room.checkin_date,
                        checkout_date: room.checkout_date
                    });
                    showAlert('Misafir bilgisi eksik. Unique ID olu≈üturulamadƒ±.', 'error');
                    return;
                }
            }
            
            // Store selected guest unique id
            const guestUniqueIdEl = document.getElementById('assignment-selected-guest-unique-id');
            if (guestUniqueIdEl) {
                guestUniqueIdEl.value = actualGuestUniqueId || room.guest_unique_id || '';
            }
            
            // Store room info for saveAssignment
            document.getElementById('assignment-selected-room-number').value = room.room_number || '';
            document.getElementById('assignment-selected-checkin-date').value = room.checkin_date || '';
            
            // Use room data
            const displayRoomNumber = room.room_number || 'Hen√ºz atanmadƒ±';
            const displayGuestName = room.guest_name || '';
            const displayGuestSurname = room.guest_surname || '';
            const displayCheckinDate = room.checkin_date || '';
            const displayCheckoutDate = room.checkout_date || '';
            const displayUniqueId = actualGuestUniqueId || room.guest_unique_id || '';
            
                    // Show room info
                    const roomDetailsEl = document.getElementById('assignment-room-details');
                    roomDetailsEl.innerHTML = `
                <div><strong>Unique ID:</strong> ${displayUniqueId}</div>
                <div><strong>Oda No:</strong> ${displayRoomNumber}</div>
                <div><strong>Misafir:</strong> ${displayGuestName} ${displayGuestSurname}</div>
                <div><strong>Check-in:</strong> ${displayCheckinDate ? formatDate(displayCheckinDate) : '-'}</div>
                ${displayCheckoutDate ? `<div><strong>Check-out:</strong> ${formatDate(displayCheckoutDate)}</div>` : ''}
                        ${room.adult_count ? `<div><strong>Yeti≈ükin:</strong> ${room.adult_count}</div>` : ''}
                        ${room.child_count ? `<div><strong>√áocuk:</strong> ${room.child_count}</div>` : ''}
                        ${room.country ? `<div><strong>√úlke:</strong> ${room.country}</div>` : ''}
                        ${room.agency ? `<div><strong>Acente:</strong> ${room.agency}</div>` : ''}
                    `;
            
            // Hide dropdown, show team cards
            document.getElementById('assignment-team').style.display = 'none';
            document.getElementById('assignment-teams-cards').style.display = 'grid';
            
            // Load teams as cards
            await loadTeamsForAssignment();
            
            // Show modal
            document.getElementById('assignment-modal').classList.add('active');
        }

        // Open assignment modal for specific room (legacy function, kept for backward compatibility)
        async function openAssignmentModalForRoom(roomNumber, checkinDate, guestName = null, guestSurname = null) {
            console.log('üìÇ Opening assignment modal for room:', roomNumber, checkinDate, guestName, guestSurname);
            
            // Store selected room info
            document.getElementById('assignment-selected-room-number').value = roomNumber || '';
            document.getElementById('assignment-selected-checkin-date').value = checkinDate || '';
            
            // Hide guest checkboxes, show room info
            document.getElementById('assignment-room-info').style.display = 'block';
            document.getElementById('assignment-guests-group').style.display = 'none';
            
            // Load room details if room_number exists, otherwise use provided guest info
            let room = null;
            if (roomNumber && checkinDate) {
                try {
                    const roomsUrl = `/api/rooms?start_date=${checkinDate}&end_date=${checkinDate}`;
                    const roomsRes = await fetch(roomsUrl);
                    const rooms = await roomsRes.json();
                    room = rooms.find(r => r.room_number === roomNumber && r.checkin_date === checkinDate);
            } catch (error) {
                console.error('Error loading room details:', error);
                }
            }
            
            // Use room data if available, otherwise use provided guest info
            const displayRoomNumber = room?.room_number || roomNumber || 'Hen√ºz atanmadƒ±';
            const displayGuestName = room?.guest_name || guestName || '';
            const displayGuestSurname = room?.guest_surname || guestSurname || '';
            const displayCheckinDate = room?.checkin_date || checkinDate || '';
            const displayCheckoutDate = room?.checkout_date || '';
            
            // Show room info
            const roomDetailsEl = document.getElementById('assignment-room-details');
            roomDetailsEl.innerHTML = `
                <div><strong>Oda No:</strong> ${displayRoomNumber}</div>
                <div><strong>Misafir:</strong> ${displayGuestName} ${displayGuestSurname}</div>
                <div><strong>Check-in:</strong> ${displayCheckinDate ? formatDate(displayCheckinDate) : '-'}</div>
                ${displayCheckoutDate ? `<div><strong>Check-out:</strong> ${formatDate(displayCheckoutDate)}</div>` : ''}
                ${room?.adult_count ? `<div><strong>Yeti≈ükin:</strong> ${room.adult_count}</div>` : ''}
                ${room?.child_count ? `<div><strong>√áocuk:</strong> ${room.child_count}</div>` : ''}
                ${room?.country ? `<div><strong>√úlke:</strong> ${room.country}</div>` : ''}
                ${room?.agency ? `<div><strong>Acente:</strong> ${room.agency}</div>` : ''}
            `;
            
            // Hide dropdown, show team cards
            document.getElementById('assignment-team').style.display = 'none';
            document.getElementById('assignment-teams-cards').style.display = 'grid';
            
            // Load teams as cards
            await loadTeamsForAssignment();
            
            // Open modal
            document.getElementById('assignment-modal').classList.add('active');
        }

        // Load teams as cards for selection
        async function loadTeamsForAssignment() {
            try {
                const teamsRes = await fetch('/api/teams');
                const teams = await teamsRes.json();
                
                const cardsContainer = document.getElementById('assignment-teams-cards');
                
                if (teams.length === 0) {
                    cardsContainer.innerHTML = '<div class="empty-state">Hen√ºz takƒ±m olu≈üturulmamƒ±≈ü</div>';
                    return;
                }
                
                cardsContainer.innerHTML = teams
                    .filter(t => t.is_active)
                    .map(team => `
                        <div class="team-card" onclick="selectTeamCard(${team.id})" data-team-id="${team.id}">
                            <div class="team-card-title">${team.name}</div>
                            ${team.description ? `<div class="team-card-description">${team.description}</div>` : '<div class="team-card-description" style="color: #999; font-style: italic;">A√ßƒ±klama yok</div>'}
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Error loading teams:', error);
                document.getElementById('assignment-teams-cards').innerHTML = 
                    '<div class="alert alert-error">Takƒ±mlar y√ºklenirken hata olu≈ütu</div>';
            }
        }

        // Select team card
        function selectTeamCard(teamId) {
            console.log('üé¥ selectTeamCard called with teamId:', teamId);
            
            // Remove previous selection
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select clicked card
            const card = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (card) {
                card.classList.add('selected');
                console.log('‚úÖ Team card selected:', teamId);
                
                // Also update the hidden select element (for compatibility)
                const teamSelect = document.getElementById('assignment-team');
                if (teamSelect) {
                    teamSelect.value = teamId;
                    console.log('‚úÖ Team select value updated:', teamId);
                }
            } else {
                console.error('‚ùå Team card not found for teamId:', teamId);
            }
        }

        // Assignment modal functions (for multi-room assignment)
        async function openAssignmentModal() {
            console.log('üìÇ Opening assignment modal (multi-room)');
            document.getElementById('assignment-modal').classList.add('active');
            
            // Hide room info, show guest checkboxes
            document.getElementById('assignment-room-info').style.display = 'none';
            document.getElementById('assignment-guests-group').style.display = 'block';
            
            // Clear selected room
            document.getElementById('assignment-selected-room-number').value = '';
            const guestUniqueIdEl = document.getElementById('assignment-selected-guest-unique-id');
            if (guestUniqueIdEl) {
                guestUniqueIdEl.value = '';
            }
            document.getElementById('assignment-selected-checkin-date').value = '';
            
            // Hide team cards, show dropdown
            document.getElementById('assignment-teams-cards').style.display = 'none';
            document.getElementById('assignment-team').style.display = 'block';
            
            // Load teams
            console.log('üë• Loading teams...');
            const teamsRes = await fetch('/api/teams');
            console.log('üë• Teams response status:', teamsRes.status);
            const teams = await teamsRes.json();
            console.log('üë• Teams loaded:', teams.length, teams);
            
            const teamSelect = document.getElementById('assignment-team');
            teamSelect.style.display = 'block';
            teamSelect.innerHTML = '<option value="">Takƒ±m Se√ßin</option>' + 
                teams.filter(t => t.is_active).map(t => `<option value="${t.id}">${t.name}</option>`).join('');

            // Load guests (rooms) - next 10 days
            const today = new Date();
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 10);
            const startDateStr = today.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            console.log('üè® Loading rooms from', startDateStr, 'to', endDateStr);
            const roomsUrl = `/api/rooms?start_date=${startDateStr}&end_date=${endDateStr}`;
            console.log('üîó Rooms URL:', roomsUrl);
            
            const roomsRes = await fetch(roomsUrl);
            console.log('üè® Rooms response status:', roomsRes.status);
            
            if (!roomsRes.ok) {
                const errorText = await roomsRes.text();
                console.error('‚ùå Error loading rooms:', errorText);
                document.getElementById('assignment-guests-checkboxes').innerHTML = 
                    `<div class="alert alert-error">Odalar y√ºklenirken hata: ${errorText}</div>`;
                return;
            }
            
            const rooms = await roomsRes.json();
            console.log('üè® Rooms loaded:', rooms.length, rooms);
            
            const guestsEl = document.getElementById('assignment-guests-checkboxes');
            
            if (rooms.length === 0) {
                console.log('‚ÑπÔ∏è No rooms found for next 10 days');
                guestsEl.innerHTML = '<div class="empty-state">√ñn√ºm√ºzdeki 10 g√ºn i√ßin check-in bulunamadƒ±</div>';
                return;
            }
            
            guestsEl.innerHTML = rooms.map(r => {
                const guestInfo = `${r.guest_name || 'Misafir'} ${r.guest_surname || ''}`.trim();
                const guestDetails = [
                    guestInfo || 'ƒ∞simsiz',
                    r.adult_count ? `${r.adult_count} Yeti≈ükin` : '',
                    r.child_count ? `${r.child_count} √áocuk` : '',
                    r.country || '',
                    r.agency || ''
                ].filter(Boolean).join(' ‚Ä¢ ');
                
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" id="guest-${r.room_number}-${r.checkin_date}" 
                            value="${r.room_number}|${r.checkin_date}">
                        <label for="guest-${r.room_number}-${r.checkin_date}" style="flex: 1;">
                            <strong>Oda ${r.room_number}</strong> - ${guestDetails}
                            <br><small style="color: #667781;">Check-in: ${r.checkin_date || 'Tarih yok'}</small>
                        </label>
                    </div>
                `;
            }).join('');
        }

        function closeAssignmentModal() {
            document.getElementById('assignment-modal').classList.remove('active');
            document.getElementById('assignment-form').reset();
            // Reset UI elements
            document.getElementById('assignment-room-info').style.display = 'none';
            document.getElementById('assignment-guests-group').style.display = 'none';
            document.getElementById('assignment-teams-cards').style.display = 'grid';
            document.getElementById('assignment-team').style.display = 'none';
            // Clear selections
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        async function saveAssignment(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üíæ saveAssignment called');
            
            // Get team ID from either select dropdown or selected card
            let teamId = null;
            
            // First try to get from select dropdown (multi-room assignment)
            const teamSelect = document.getElementById('assignment-team');
            if (teamSelect && teamSelect.value) {
                teamId = parseInt(teamSelect.value);
                console.log('üìã Team ID from select:', teamId);
            }
            
            // If no team from select, try to get from selected card (single room assignment)
            if (!teamId) {
                const selectedCard = document.querySelector('.team-card.selected');
                if (selectedCard) {
                    teamId = parseInt(selectedCard.getAttribute('data-team-id'));
                    console.log('üé¥ Team ID from selected card:', teamId);
                }
            }
            
            if (!teamId || isNaN(teamId)) {
                console.error('‚ùå No team selected');
                showAlert('L√ºtfen bir takƒ±m se√ßin', 'error');
                return;
            }
            
            // Check if single room assignment
            const selectedRoomNumber = document.getElementById('assignment-selected-room-number').value;
            const selectedCheckinDate = document.getElementById('assignment-selected-checkin-date').value;
            const selectedGuestUniqueId = document.getElementById('assignment-selected-guest-unique-id')?.value || '';
            
            let selectedGuests = [];
            
            if (selectedGuestUniqueId) {
                // Single room assignment by guest_unique_id
                console.log('üè® Single room assignment by guest_unique_id:', selectedGuestUniqueId);
                
                // Load room data - try by guest_unique_id first, then by room_number + checkin_date
                let room = null;
                try {
                    const roomsUrl = '/api/rooms';
                    const roomsRes = await fetch(roomsUrl);
                    const rooms = await roomsRes.json();
                    
                    // Try to find by guest_unique_id first
                    room = rooms.find(r => r.guest_unique_id === selectedGuestUniqueId);
                    
                    // If not found, try to find by room_number + checkin_date (in case guest_unique_id not yet updated in backend)
                    if (!room && selectedRoomNumber && selectedCheckinDate) {
                        room = rooms.find(r => r.room_number === selectedRoomNumber && r.checkin_date === selectedCheckinDate);
                        console.log('üîç Room not found by guest_unique_id, trying room_number + checkin_date:', !!room);
                    }
                } catch (error) {
                    console.error('Error loading room by guest_unique_id:', error);
                }
                
                if (room) {
                selectedGuests = [{ 
                        guest_unique_id: selectedGuestUniqueId,
                        room_number: room.room_number || selectedRoomNumber || null, 
                        checkin_date: room.checkin_date || selectedCheckinDate || null,
                        checkout_date: room.checkout_date || null,
                        guest_name: room.guest_name || '',
                        guest_surname: room.guest_surname || ''
                    }];
                    console.log('‚úÖ Selected guest data:', selectedGuests[0]);
                } else {
                    showAlert('Misafir bilgisi bulunamadƒ±', 'error');
                    return;
                }
            } else if (selectedRoomNumber && selectedCheckinDate) {
                // Single room assignment - get guest info from room details (legacy)
                console.log('üè® Single room assignment:', selectedRoomNumber, selectedCheckinDate);
                
                // Get guest info from room details element
                const roomDetailsEl = document.getElementById('assignment-room-details');
                let guestName = '';
                let guestSurname = '';
                
                // Try to extract guest name from room details
                if (roomDetailsEl) {
                    const guestText = roomDetailsEl.textContent;
                    const guestMatch = guestText.match(/Misafir:\s*([^\n]+)/);
                    if (guestMatch) {
                        const fullName = guestMatch[1].trim();
                        const nameParts = fullName.split(' ');
                        guestName = nameParts[0] || '';
                        guestSurname = nameParts.slice(1).join(' ') || '';
                    }
                }
                
                // If room details not available, try to get from room data
                if (!guestName && selectedRoomNumber) {
                    try {
                        const roomsUrl = `/api/rooms?start_date=${selectedCheckinDate}&end_date=${selectedCheckinDate}`;
                        const roomsRes = await fetch(roomsUrl);
                        const rooms = await roomsRes.json();
                        const room = rooms.find(r => r.room_number === selectedRoomNumber && r.checkin_date === selectedCheckinDate);
                        if (room) {
                            guestName = room.guest_name || '';
                            guestSurname = room.guest_surname || '';
                        }
                    } catch (error) {
                        console.error('Error loading room for guest info:', error);
                    }
                }
                
                selectedGuests = [{ 
                    room_number: selectedRoomNumber || null, 
                    checkin_date: selectedCheckinDate || null,
                    guest_name: guestName,
                    guest_surname: guestSurname
                }];
            } else {
                // Multi-room assignment (from checkboxes)
                const checkedBoxes = document.querySelectorAll('#assignment-guests-checkboxes input:checked');
                console.log('üìã Multi-room assignment, checked boxes:', checkedBoxes.length);
                
                selectedGuests = Array.from(checkedBoxes)
                    .map(cb => {
                        const [roomNumber, date] = cb.value.split('|');
                        if (!date) {
                            throw new Error('Misafir se√ßiminde check-in tarihi bulunamadƒ±');
                        }
                        return { room_number: roomNumber, checkin_date: date };
                    });
                
                if (selectedGuests.length === 0) {
                    showAlert('L√ºtfen en az bir misafir se√ßin', 'error');
                    return;
                }
            }
            
            console.log('üíæ Saving assignment:', { teamId, selectedGuests });

            try {
                const requestBody = {
                    team_id: teamId,
                    assignments: selectedGuests
                };
                
                console.log('üì° Sending request to /api/team-assignments:', requestBody);
                
                const response = await fetch('/api/team-assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('üì° Response status:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Assignment saved successfully:', result);
                    closeAssignmentModal();
                    
                    // Wait a bit for backend to update room table
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Reload both lists
                    await Promise.all([
                        loadAssignments(),
                        loadUnassignedRooms()
                    ]);
                    
                    showAlert('E≈üle≈ütirme ba≈üarƒ±yla yapƒ±ldƒ±', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', response.status, errorText);
                    showAlert('Hata: ' + errorText, 'error');
                }
            } catch (error) {
                console.error('‚ùå Exception in saveAssignment:', error);
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function deleteAssignment(id) {
            if (!confirm('Bu e≈üle≈ütirmeyi kaldƒ±rmak istediƒüinize emin misiniz?')) return;

            try {
                const response = await fetch(`/api/team-assignments/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAssignments();
                    showAlert('E≈üle≈ütirme kaldƒ±rƒ±ldƒ±', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        // Load all rooms for selected date (not just assignments)
        async function loadAllRoomsForDate() {
            try {
                const dateFilter = document.getElementById('checkin-date-filter').value;
                if (!dateFilter) {
                    showAlert('L√ºtfen bir tarih se√ßin', 'error');
                    return;
                }
                
                console.log('üè® Loading all rooms for date:', dateFilter);
                const url = `/api/rooms?start_date=${dateFilter}&end_date=${dateFilter}`;
                console.log('üîó Fetching from URL:', url);
                
                const response = await fetch(url);
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const rooms = await response.json();
                console.log('‚úÖ Rooms received:', rooms.length, rooms);
                
                const listEl = document.getElementById('assignments-list');
                if (rooms.length === 0) {
                    console.log('‚ÑπÔ∏è No rooms found for date:', dateFilter);
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"><i data-lucide="building-2" class="icon icon-xl"></i></div>
                            <p>${dateFilter} tarihi i√ßin check-in bulunamadƒ±</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni E≈üle≈ütirme</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Oda No</th>
                                <th>Avatar</th>
                                <th>Misafir</th>
                                <th>Check-in Tarihi</th>
                                <th>Yeti≈ükin</th>
                                <th>√áocuk</th>
                                <th>√úlke</th>
                                <th>Acente</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rooms.map(r => `
                                <tr>
                                    <td>${r.room_number}</td>
                                    <td>
                                        ${r.profile_photo ? `
                                            <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                        `}
                                    </td>
                                    <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                    <td>${r.checkin_date || '-'}</td>
                                    <td>${r.adult_count || '-'}</td>
                                    <td>${r.child_count || '-'}</td>
                                    <td>${r.country || '-'}</td>
                                    <td>${r.agency || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading rooms:', error);
                document.getElementById('assignments-list').innerHTML = `
                    <div class="alert alert-error">Odalar y√ºklenirken hata olu≈ütu: ${error.message}</div>
                `;
            }
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alert.textContent = message;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.tabs'));
            setTimeout(() => alert.remove(), 3000);
        }

        // Format date to DD.MM.YYYY
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            } catch (e) {
                return dateStr;
            }
        }

        // Load unassigned rooms
        async function loadUnassignedRooms() {
            try {
                const dateFilter = document.getElementById('unassigned-date-filter').value;
                console.log('‚ö†Ô∏è Loading unassigned rooms with filter:', dateFilter || 'all dates');
                
                const listEl = document.getElementById('unassigned-list');
                listEl.innerHTML = '<div class="loading">Y√ºkleniyor...</div>';
                
                // Load all assignments to find which rooms are assigned
                const assignmentsResponse = await fetch('/api/team-assignments');
                if (!assignmentsResponse.ok) {
                    throw new Error(`Failed to load assignments: ${assignmentsResponse.status}`);
                }
                const assignments = await assignmentsResponse.json();
                console.log('‚úÖ Assignments loaded:', assignments.length);
                
                // Create sets of assigned room keys (room_number + checkin_date) and guest_unique_ids
                const assignedKeys = new Set(
                    assignments.filter(a => a.room_number && a.checkin_date)
                        .map(a => `${a.room_number}_${a.checkin_date}`)
                );
                const assignedGuestIds = new Set(
                    assignments.filter(a => a.guest_unique_id)
                        .map(a => a.guest_unique_id)
                );
                console.log('üîë Assigned room keys:', Array.from(assignedKeys).slice(0, 10), '...');
                console.log('üîë Assigned guest IDs:', Array.from(assignedGuestIds).slice(0, 10), '...');
                
                // Load all rooms (next 30 days or filtered date)
                let roomsUrl = '/api/rooms';
                if (dateFilter) {
                    roomsUrl = `/api/rooms?start_date=${dateFilter}&end_date=${dateFilter}`;
                } else {
                    // Load next 30 days
                    const today = new Date();
                    const endDate = new Date(today);
                    endDate.setDate(today.getDate() + 30);
                    const startDateStr = today.toISOString().split('T')[0];
                    const endDateStr = endDate.toISOString().split('T')[0];
                    roomsUrl = `/api/rooms?start_date=${startDateStr}&end_date=${endDateStr}`;
                }
                
                console.log('üè® Fetching rooms from:', roomsUrl);
                const roomsResponse = await fetch(roomsUrl);
                if (!roomsResponse.ok) {
                    throw new Error(`Failed to load rooms: ${roomsResponse.status}`);
                }
                const rooms = await roomsResponse.json();
                console.log('üè® Total rooms found:', rooms.length);
                
                // Filter unassigned rooms (by room_number+checkin_date OR guest_unique_id)
                const unassignedRooms = rooms.filter(r => {
                    const roomKey = r.room_number && r.checkin_date ? `${r.room_number}_${r.checkin_date}` : null;
                    const isAssignedByRoom = roomKey && assignedKeys.has(roomKey);
                    const isAssignedByGuest = r.guest_unique_id && assignedGuestIds.has(r.guest_unique_id);
                    return !isAssignedByRoom && !isAssignedByGuest;
                });
                
                console.log('‚ö†Ô∏è Unassigned rooms:', unassignedRooms.length);
                
                if (unassignedRooms.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚úÖ</div>
                            <p>${dateFilter ? dateFilter + ' tarihi i√ßin' : 'T√ºm'} e≈üle≈ümemi≈ü oda bulunamadƒ±. T√ºm odalar e≈üle≈ütirilmi≈ü!</p>
                        </div>
                    `;
                    return;
                }
                
                // Group by date for better organization
                const roomsByDate = {};
                unassignedRooms.forEach(r => {
                    const date = r.checkin_date || 'Tarih Yok';
                    if (!roomsByDate[date]) {
                        roomsByDate[date] = [];
                    }
                    roomsByDate[date].push(r);
                });
                
                const sortedDates = Object.keys(roomsByDate).sort();
                
                let html = `
                    <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <strong>‚ö†Ô∏è Toplam ${unassignedRooms.length} e≈üle≈ümemi≈ü oda bulundu</strong>
                    </div>
                `;
                
                sortedDates.forEach(date => {
                    const dateRooms = roomsByDate[date];
                    html += `
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 12px; color: #ff9800; font-size: 16px; padding: 8px; background: white; border-radius: 6px;">
                                üìÖ ${formatDate(date)} - ${dateRooms.length} Oda
                            </h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Unique ID</th>
                                        <th>Avatar</th>
                                        <th>Misafir</th>
                                        <th>Check-in Tarihi</th>
                                        <th>Check-out Tarihi</th>
                                        <th>Yeti≈ükin</th>
                                        <th>√áocuk</th>
                                        <th>√úlke</th>
                                        <th>Acente</th>
                                        <th>ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dateRooms.map(r => `
                                        <tr style="background: white; cursor: pointer;" onclick="openAssignmentModalForRoomByGuestId('${r.guest_unique_id || ''}', '${r.room_number || ''}', '${r.checkin_date || ''}')">
                                            <td style="font-family: monospace; font-size: 11px;"><strong>${r.guest_unique_id || '-'}</strong></td>
                                            <td>
                                                ${r.profile_photo ? `
                                                    <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                                ` : `
                                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                                `}
                                            </td>
                                            <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                            <td>${formatDate(r.checkin_date)}</td>
                                            <td>${formatDate(r.checkout_date)}</td>
                                            <td>${r.adult_count || '-'}</td>
                                            <td>${r.child_count || '-'}</td>
                                            <td>${r.country || '-'}</td>
                                            <td>${r.agency || '-'}</td>
                                            <td>
                                                <button class="btn btn-primary" onclick="event.stopPropagation(); openAssignmentModalForRoomByGuestId('${r.guest_unique_id || ''}', '${r.room_number || ''}', '${r.checkin_date || ''}')" style="padding: 6px 12px; font-size: 12px;">E≈üle≈ütir</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                listEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading unassigned rooms:', error);
                document.getElementById('unassigned-list').innerHTML = `
                    <div class="alert alert-error">E≈üle≈ümemi≈ü odalar y√ºklenirken hata olu≈ütu: ${error.message}</div>
                `;
            }
        }


        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alert.textContent = message;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.tabs'));
            setTimeout(() => alert.remove(), 3000);
        }

        // ============================================
        // Activities Management
        // ============================================

        async function loadActivities() {
            try {
                const response = await fetch('/api/admin/activities', {
                    credentials: 'include'
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to load activities' }));
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to load activities`);
                }
                const activities = await response.json();
                
                const listEl = document.getElementById('activities-list');
                if (activities.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>Hen√ºz hikaye eklenmemi≈ü</p>
                        </div>
                    `;
                    return;
                }
                
                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ba≈ülƒ±k</th>
                                <th>ƒ∞kon</th>
                                <th>Foto/Video</th>
                                <th>Sƒ±ra</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities.map(a => `
                                <tr>
                                    <td><strong>${a.title || '-'}</strong></td>
                                    <td>${a.icon || '-'}</td>
                                    <td>
                                        ${a.image_url ? `<img src="${a.image_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" alt="Image">` : ''}
                                        ${a.video_url ? `<video src="${a.video_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" controls></video>` : ''}
                                        ${!a.image_url && !a.video_url ? '<span style="color: #999;">Yok</span>' : ''}
                                    </td>
                                    <td>${a.display_order || 0}</td>
                                    <td>${a.is_active ? '<span style="color: green;">‚úì Aktif</span>' : '<span style="color: red;">‚úó Pasif</span>'}</td>
                                    <td>
                                        <button class="btn btn-primary" onclick="openActivityUploadModal(${a.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">üì∑ Foto/Video Ekle</button>
                                        <button class="btn btn-primary" onclick="editActivity(${a.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">D√ºzenle</button>
                                        <button class="btn btn-danger" onclick="deleteActivity(${a.id})" style="padding: 6px 12px; font-size: 12px;">Sil</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading activities:', error);
                document.getElementById('activities-list').innerHTML = `
                    <div class="alert alert-error">Hikayeler y√ºklenirken hata olu≈ütu: ${error.message}</div>
                `;
            }
        }

        function openActivityModal(id = null) {
            currentActivityId = id;
            document.getElementById('activity-modal-title').textContent = id ? 'Hikaye D√ºzenle' : 'Yeni Hikaye';
            document.getElementById('activity-modal').classList.add('active');
            
            if (id) {
                fetch(`/api/admin/activities/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('activity-title').value = data.title || '';
                        document.getElementById('activity-icon').value = data.icon || '';
                        document.getElementById('activity-date').value = data.activity_date ? String(data.activity_date).split('T')[0] : '';
                        document.getElementById('activity-start-time').value = data.start_time ? String(data.start_time).slice(0,5) : '';
                        document.getElementById('activity-end-time').value = data.end_time ? String(data.end_time).slice(0,5) : '';
                        document.getElementById('activity-category').value = data.category || '';
                        document.getElementById('activity-type').value = data.type || '';
                        document.getElementById('activity-location').value = data.location || '';
                        document.getElementById('activity-description').value = data.description || '';
                        document.getElementById('activity-instructor').value = data.instructor_name || '';
                        document.getElementById('activity-age-group').value = data.age_group || '';
                        document.getElementById('activity-capacity').value = data.capacity ?? '';
                        document.getElementById('activity-lat').value = data.map_latitude ?? '';
                        document.getElementById('activity-lng').value = data.map_longitude ?? '';
                        document.getElementById('activity-featured').checked = data.featured === true;
                        document.getElementById('activity-image-url').value = data.image_url || '';
                        document.getElementById('activity-video-url').value = data.video_url || '';
                        document.getElementById('activity-display-order').value = data.display_order || 0;
                        document.getElementById('activity-is-active').checked = data.is_active !== false;
                    });
            } else {
                document.getElementById('activity-form').reset();
                document.getElementById('activity-display-order').value = 0;
                document.getElementById('activity-is-active').checked = true;
                document.getElementById('activity-featured').checked = false;
            }
        }

        function closeActivityModal() {
            document.getElementById('activity-modal').classList.remove('active');
            currentActivityId = null;
        }

        async function saveActivity(e) {
            e.preventDefault();
            
            const title = document.getElementById('activity-title').value.trim();
            const icon = document.getElementById('activity-icon').value.trim();
            const activity_date = document.getElementById('activity-date').value || null;
            const start_time = document.getElementById('activity-start-time').value || null;
            const end_time = document.getElementById('activity-end-time').value || null;
            const category = document.getElementById('activity-category').value.trim() || null;
            const type = document.getElementById('activity-type').value.trim() || null;
            const location = document.getElementById('activity-location').value.trim() || null;
            const description = document.getElementById('activity-description').value.trim() || null;
            const instructor_name = document.getElementById('activity-instructor').value.trim() || null;
            const age_group = document.getElementById('activity-age-group').value.trim() || null;
            const capacityRaw = document.getElementById('activity-capacity').value;
            const capacity = capacityRaw === '' ? null : parseInt(capacityRaw, 10);
            const mapLatRaw = document.getElementById('activity-lat').value;
            const mapLngRaw = document.getElementById('activity-lng').value;
            const map_latitude = mapLatRaw === '' ? null : parseFloat(mapLatRaw);
            const map_longitude = mapLngRaw === '' ? null : parseFloat(mapLngRaw);
            const featured = document.getElementById('activity-featured').checked;
            const image_url_raw = document.getElementById('activity-image-url').value.trim();
            const video_url_raw = document.getElementById('activity-video-url').value.trim();
            const image_url = video_url_raw ? null : (image_url_raw || null);
            const video_url = video_url_raw || null;
            const display_order = parseInt(document.getElementById('activity-display-order').value) || 0;
            const is_active = document.getElementById('activity-is-active').checked;
            
            if (!title) {
                showAlert('Ba≈ülƒ±k gereklidir', 'error');
                return;
            }
            
            try {
                const url = currentActivityId 
                    ? `/api/admin/activities/${currentActivityId}`
                    : '/api/admin/activities';
                const method = currentActivityId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        title,
                        icon,
                        display_order,
                        is_active,
                        activity_date,
                        start_time,
                        end_time,
                        description,
                        category,
                        type,
                        location,
                        instructor_name,
                        age_group,
                        capacity,
                        featured,
                        map_latitude,
                        map_longitude,
                        image_url,
                        video_url
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save activity');
                
                closeActivityModal();
                loadActivities();
                showAlert('Hikaye ba≈üarƒ±yla kaydedildi', 'success');
            } catch (error) {
                console.error('Error saving activity:', error);
                showAlert('Hikaye kaydedilirken hata olu≈ütu', 'error');
            }
        }

        async function deleteActivity(id) {
            if (!confirm('Bu hikayeyi silmek istediƒüinize emin misiniz?')) return;
            
            try {
                const response = await fetch(`/api/admin/activities/${id}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to delete activity');
                
                loadActivities();
                showAlert('Hikaye silindi', 'success');
            } catch (error) {
                console.error('Error deleting activity:', error);
                showAlert('Hikaye silinirken hata olu≈ütu', 'error');
            }
        }

        async function editActivity(id) {
            openActivityModal(id);
        }

        function openActivityUploadModal(activityId) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 500px;
                width: 100%;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">Fotoƒüraf veya Video Y√ºkle</div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fotoƒüraf (URL veya Base64)</label>
                    <input type="text" id="activity-image-url" class="form-input" placeholder="https://... veya data:image/...">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Video (URL veya Base64)</label>
                    <input type="text" id="activity-video-url" class="form-input" placeholder="https://... veya data:video/...">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="cancel-upload-btn" class="btn btn-secondary" style="flex: 1;">ƒ∞ptal</button>
                    <button id="upload-activity-btn" class="btn btn-primary" style="flex: 1;">Y√ºkle</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            document.getElementById('cancel-upload-btn').onclick = () => modal.remove();
            document.getElementById('upload-activity-btn').onclick = async () => {
                const imageUrl = document.getElementById('activity-image-url').value.trim();
                const videoUrl = document.getElementById('activity-video-url').value.trim();
                
                if (!imageUrl && !videoUrl) {
                    alert('Fotoƒüraf veya video URL\'si gerekli');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/admin/activities/${activityId}/upload`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ 
                            image_url: imageUrl || null,
                            video_url: videoUrl || null,
                            file_type: imageUrl ? 'image' : 'video'
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to upload');
                    
                    modal.remove();
                    loadActivities();
                    showAlert('Medya ba≈üarƒ±yla y√ºklendi', 'success');
                } catch (error) {
                    console.error('Error uploading:', error);
                    alert('Y√ºkleme ba≈üarƒ±sƒ±z: ' + error.message);
                }
            };
        }

        // ============================================
        // Posts Management
        // ============================================

        async function loadPosts() {
            try {
                const response = await fetch('/api/admin/info-posts');
                if (!response.ok) throw new Error('Failed to load posts');
                const posts = await response.json();
                
                const listEl = document.getElementById('posts-list');
                if (posts.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>Hen√ºz post eklenmemi≈ü</p>
                        </div>
                    `;
                    return;
                }
                
                listEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 24px;">
                        ${posts.map(p => `
                            <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e4e6e9;">
                                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                                    ${p.video_url ? `
                                        <video src="${p.video_url}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px;" controls></video>
                                    ` : p.image_url ? `
                                        <img src="${p.image_url}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px;" alt="Post Image">
                                    ` : `
                                        <div style="width: 120px; height: 120px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999;">
                                            Fotoƒüraf Yok
                                        </div>
                                    `}
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 8px 0; color: var(--voyage-navy);">${p.title || '-'}</h3>
                                        <p style="margin: 0 0 8px 0; color: #667781; font-size: 14px;"><strong>Post ID:</strong> ${p.post_id || '-'}</p>
                                        <p style="margin: 0 0 8px 0; color: #667781; font-size: 14px;"><strong>Lokasyon:</strong> ${p.location || '-'}</p>
                                        <p style="margin: 0 0 8px 0; color: #667781; font-size: 14px;"><strong>ƒ∞kon:</strong> ${p.icon || '-'}</p>
                                        ${p.caption ? `<p style="margin: 8px 0; color: #667781; font-size: 14px;">${p.caption}</p>` : ''}
                                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                                            <span style="padding: 4px 8px; background: ${p.is_active ? '#d4edda' : '#f8d7da'}; color: ${p.is_active ? '#155724' : '#721c24'}; border-radius: 4px; font-size: 12px;">
                                                ${p.is_active ? '‚úì Aktif' : '‚úó Pasif'}
                                            </span>
                                            <span style="padding: 4px 8px; background: #e7f3ff; color: #0056b3; border-radius: 4px; font-size: 12px;">
                                                Sƒ±ra: ${p.display_order || 0}
                                            </span>
                                            <span style="padding: 4px 8px; background: #fff3cd; color: #856404; border-radius: 4px; font-size: 12px;">
                                                ‚ù§Ô∏è ${p.likes_count || 0}
                                            </span>
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button class="btn btn-primary" onclick="editPost(${p.id})" style="padding: 8px 16px; font-size: 14px;">D√ºzenle</button>
                                        <button class="btn btn-danger" onclick="deletePost(${p.id})" style="padding: 8px 16px; font-size: 14px;">Sil</button>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid #e4e6e9; padding-top: 16px; margin-top: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--voyage-navy);">Fotoƒüraf/Video Ekle</label>
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <input type="text" id="post-image-url-${p.id}" class="form-input" placeholder="Fotoƒüraf URL veya Base64" style="flex: 1;">
                                        <button class="btn btn-primary" onclick="uploadPostMedia(${p.id}, 'image')" style="padding: 8px 16px;">üì∑ Foto Y√ºkle</button>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="text" id="post-video-url-${p.id}" class="form-input" placeholder="Video URL" style="flex: 1;">
                                        <button class="btn btn-primary" onclick="uploadPostMedia(${p.id}, 'video')" style="padding: 8px 16px;">üé¨ Video Y√ºkle</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading posts:', error);
                document.getElementById('posts-list').innerHTML = `
                    <div class="alert alert-error">Postlar y√ºklenirken hata olu≈ütu: ${error.message}</div>
                `;
            }
        }

        function openPostModal(id = null) {
            currentPostId = id;
            document.getElementById('post-modal-title').textContent = id ? 'Post D√ºzenle' : 'Yeni Post';
            document.getElementById('post-modal').classList.add('active');
            
            if (id) {
                fetch(`/api/admin/info-posts/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('post-post-id').value = data.post_id || '';
                        document.getElementById('post-post-id').disabled = true; // Don't allow changing post_id
                        document.getElementById('post-title').value = data.title || '';
                        document.getElementById('post-icon').value = data.icon || '';
                        document.getElementById('post-location').value = data.location || '';
                        document.getElementById('post-caption').value = data.caption || '';
                        document.getElementById('post-image-url').value = data.image_url || '';
                        document.getElementById('post-video-url').value = data.video_url || '';
                        document.getElementById('post-display-order').value = data.display_order || 0;
                        document.getElementById('post-is-active').checked = data.is_active !== false;
                    });
            } else {
                document.getElementById('post-form').reset();
                document.getElementById('post-post-id').disabled = false;
                document.getElementById('post-display-order').value = 0;
                document.getElementById('post-is-active').checked = true;
            }
        }

        function closePostModal() {
            document.getElementById('post-modal').classList.remove('active');
            currentPostId = null;
        }

        async function savePost(e) {
            e.preventDefault();
            
            const post_id = document.getElementById('post-post-id').value.trim();
            const title = document.getElementById('post-title').value.trim();
            const icon = document.getElementById('post-icon').value.trim();
            const location = document.getElementById('post-location').value.trim();
            const caption = document.getElementById('post-caption').value.trim();
            const image_url_raw = document.getElementById('post-image-url').value.trim();
            const video_url_raw = document.getElementById('post-video-url').value.trim();
            const image_url = video_url_raw ? null : (image_url_raw || null);
            const video_url = video_url_raw || null;
            const display_order = parseInt(document.getElementById('post-display-order').value) || 0;
            const is_active = document.getElementById('post-is-active').checked;
            
            if (!post_id || !title) {
                showAlert('Post ID ve ba≈ülƒ±k gereklidir', 'error');
                return;
            }
            
            try {
                const url = currentPostId 
                    ? `/api/admin/info-posts/${currentPostId}`
                    : '/api/admin/info-posts';
                const method = currentPostId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ post_id, title, icon, location, caption, image_url, video_url, display_order, is_active })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save post');
                }
                
                closePostModal();
                loadPosts();
                showAlert('Post ba≈üarƒ±yla kaydedildi', 'success');
            } catch (error) {
                console.error('Error saving post:', error);
                showAlert('Post kaydedilirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        async function deletePost(id) {
            if (!confirm('Bu postu silmek istediƒüinize emin misiniz?')) return;
            
            try {
                const response = await fetch(`/api/admin/info-posts/${id}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to delete post');
                
                loadPosts();
                showAlert('Post silindi', 'success');
            } catch (error) {
                console.error('Error deleting post:', error);
                showAlert('Post silinirken hata olu≈ütu', 'error');
            }
        }

        async function editPost(id) {
            openPostModal(id);
        }

        async function uploadPostMedia(postId, type) {
            const imageUrlInput = document.getElementById(`post-image-url-${postId}`);
            const videoUrlInput = document.getElementById(`post-video-url-${postId}`);
            const imageUrl = imageUrlInput ? imageUrlInput.value.trim() : '';
            const videoUrl = videoUrlInput ? videoUrlInput.value.trim() : '';

            if (type === 'video') {
                if (!videoUrl) {
                    alert('Video URL gerekli');
                    return;
                }
            } else {
                if (!imageUrl) {
                    alert('Fotoƒüraf URL gerekli');
                    return;
                }
            }
            
            try {
                const response = await fetch(`/api/admin/info-posts/${postId}/upload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(type === 'video' ? { video_url: videoUrl } : { image_url: imageUrl })
                });
                
                if (!response.ok) throw new Error('Failed to upload');
                
                if (imageUrlInput) imageUrlInput.value = '';
                if (videoUrlInput) videoUrlInput.value = '';
                loadPosts();
                showAlert('Fotoƒüraf ba≈üarƒ±yla y√ºklendi', 'success');
            } catch (error) {
                console.error('Error uploading:', error);
                alert('Y√ºkleme ba≈üarƒ±sƒ±z: ' + error.message);
            }
        }

        // Initialize
        // Initialize Lucide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAssistants();
            
            // Ensure form submit handlers are attached
            const assistantForm = document.getElementById('assistant-form');
            if (assistantForm) {
                assistantForm.addEventListener('submit', saveAssistant);
                console.log('‚úÖ Assistant form submit handler attached');
            }
            
            const teamForm = document.getElementById('team-form');
            if (teamForm) {
                teamForm.addEventListener('submit', saveTeam);
                console.log('‚úÖ Team form submit handler attached');
            }
            
            const assignmentForm = document.getElementById('assignment-form');
            if (assignmentForm) {
                assignmentForm.addEventListener('submit', saveAssignment);
                console.log('‚úÖ Assignment form submit handler attached');
            }
            
            const activityForm = document.getElementById('activity-form');
            if (activityForm) {
                activityForm.addEventListener('submit', saveActivity);
                console.log('‚úÖ Activity form submit handler attached');
            }
            
            const postForm = document.getElementById('post-form');
            if (postForm) {
                postForm.addEventListener('submit', savePost);
                console.log('‚úÖ Post form submit handler attached');
            }
        });
    </script>
</body>
</html>

