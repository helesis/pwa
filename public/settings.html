<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>Ayarlar - Voyage Assistant</title>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    
    <!-- FullCalendar CSS - using unpkg -->
    <link href="https://unpkg.com/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- FullCalendar JS - using unpkg global bundle -->
    <script src="https://unpkg.com/fullcalendar@6.1.10/index.global.min.js"></script>
    <!-- FullCalendar Turkish Locale -->
    <script src="https://unpkg.com/fullcalendar@6.1.10/locales/tr.global.min.js"></script>
    <!-- RRule Library - using unpkg -->
    <script src="https://unpkg.com/rrule@2.8.1/dist/es5/rrule.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Lucide Icons Styling */
        .icon {
            width: 1em;
            height: 1em;
            stroke-width: 2;
            display: inline-block;
            vertical-align: middle;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .icon-md {
            width: 20px;
            height: 20px;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
        }

        .icon-xl {
            width: 32px;
            height: 32px;
        }

        :root {
            --voyage-navy: #1A4D6D;
            --voyage-blue: #2C6E8F;
            --voyage-light-blue: #E8F1F5;
            --voyage-gold: #C9A961;
            --text-dark: #2C3E50;
            --text-light: #6C757D;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --border: #dee2e6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: white;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--voyage-navy);
            font-size: 24px;
            font-weight: 700;
        }

        .nav-link {
            color: var(--voyage-navy);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .nav-link:hover {
            background: var(--voyage-light-blue);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tab.active {
            background: var(--voyage-navy);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--voyage-light-blue);
            color: var(--voyage-navy);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .restaurant-subtab-content {
            display: none;
        }

        .restaurant-subtab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--voyage-light-blue);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--voyage-navy);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--voyage-navy);
            color: white;
        }

        .btn-primary:hover {
            background: var(--voyage-blue);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--text-light);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--voyage-navy);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--voyage-navy);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            background: var(--voyage-light-blue);
            font-weight: 600;
            color: var(--voyage-navy);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tr:hover {
            background: white;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--voyage-light-blue);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--voyage-navy);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: var(--voyage-light-blue);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--voyage-navy);
            background: var(--voyage-light-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--voyage-navy);
            overflow: hidden;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload input[type="file"] {
            display: none;
        }

        .avatar-upload-btn {
            padding: 8px 16px;
            background: var(--voyage-navy);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .avatar-upload-btn:hover {
            background: var(--voyage-blue);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
        }

        .team-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .team-card {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .team-card:hover {
            border-color: var(--voyage-navy);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .team-card.selected {
            border-color: var(--voyage-navy);
            background: var(--voyage-light-blue);
        }

        .team-card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--voyage-navy);
            margin-bottom: 8px;
        }

        .team-card-description {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: var(--voyage-light-blue);
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .assignment-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid var(--voyage-light-blue);
        }

        .date-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .date-filter .form-group {
            margin-bottom: 0;
            flex: 1;
        }

        /* FullCalendar Custom Styling */
        #activities-fullcalendar {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .fc {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .fc-header-toolbar {
            margin-bottom: 20px;
        }

        .fc-button {
            background: var(--voyage-blue) !important;
            border: none !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            font-weight: 500 !important;
            text-transform: none !important;
        }

        .fc-button:hover {
            background: var(--voyage-navy) !important;
        }

        .fc-button-active {
            background: var(--voyage-navy) !important;
        }

        .fc-today-button {
            background: var(--voyage-gold) !important;
        }

        .fc-today-button:hover {
            background: #b89a4f !important;
        }

        .fc-daygrid-event {
            border-radius: 4px !important;
            padding: 2px 4px !important;
            font-size: 12px !important;
        }

        .fc-event-title {
            font-weight: 500 !important;
        }

        .fc-day-today {
            background: var(--voyage-light-blue) !important;
        }

        .fc-col-header-cell {
            background: var(--voyage-light-blue);
            padding: 10px 0;
            font-weight: 600;
            color: var(--voyage-navy);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i data-lucide="settings" class="icon icon-lg"></i> Ayarlar</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('assistants')"><i data-lucide="users" class="icon icon-md"></i> Assistant'lar</button>
            <button class="tab" onclick="switchTab('teams')"><i data-lucide="users-round" class="icon icon-md"></i> TakÄ±mlar</button>
            <button class="tab" onclick="switchTab('assignments')"><i data-lucide="link" class="icon icon-md"></i> EÅŸleÅŸtirmeler</button>
            <button class="tab" onclick="switchTab('unassigned')"><i data-lucide="alert-triangle" class="icon icon-md"></i> EÅŸleÅŸmemiÅŸ Odalar</button>
            <button class="tab" onclick="switchTab('activities')"><i data-lucide="sparkles" class="icon icon-md"></i> Hikayeler</button>
            <button class="tab" onclick="switchTab('activities-calendar')"><i data-lucide="calendar" class="icon icon-md"></i> Aktiviteler Takvimi</button>
            <button class="tab" onclick="switchTab('posts')"><i data-lucide="image" class="icon icon-md"></i> Postlar</button>
            <button class="tab" onclick="switchTab('restaurants')"><i data-lucide="utensils-crossed" class="icon icon-md"></i> A'la Carte Rezervasyonlar</button>
        </div>

        <!-- Assistants Tab -->
        <div id="assistants-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Assistant YÃ¶netimi</h2>
                    <button class="btn btn-primary" onclick="openAssistantModal()">+ Yeni Assistant</button>
                </div>
                <div id="assistants-list">
                    <div class="loading">YÃ¼kleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Teams Tab -->
        <div id="teams-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">TakÄ±m YÃ¶netimi</h2>
                    <button class="btn btn-primary" onclick="openTeamModal()">+ Yeni TakÄ±m</button>
                </div>
                <div id="teams-list">
                    <div class="loading">YÃ¼kleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Assignments Tab -->
        <div id="assignments-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">TakÄ±m-Misafir EÅŸleÅŸtirmeleri</h2>
                    <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni EÅŸleÅŸtirme</button>
                </div>
                <div class="date-filter">
                    <div class="form-group">
                        <label class="form-label">Check-in Tarihi</label>
                        <input type="date" id="checkin-date-filter" class="form-input" onchange="loadAssignments()">
                    </div>
                    <button class="btn btn-primary" onclick="loadAssignments()">Filtrele</button>
                    <button class="btn btn-secondary" onclick="loadAllRoomsForDate()">O Tarihte TÃ¼m OdalarÄ± GÃ¶ster</button>
                </div>
                <div id="assignments-list">
                    <div class="loading">YÃ¼kleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Unassigned Rooms Tab -->
        <div id="unassigned-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">EÅŸleÅŸmemiÅŸ Odalar</h2>
                    <button class="btn btn-primary" onclick="loadUnassignedRooms()">ðŸ”„ Yenile</button>
                </div>
                <div class="date-filter">
                    <div class="form-group">
                        <label class="form-label">Check-in Tarihi (Opsiyonel)</label>
                        <input type="date" id="unassigned-date-filter" class="form-input" onchange="loadUnassignedRooms()">
                    </div>
                    <button class="btn btn-primary" onclick="loadUnassignedRooms()">Filtrele</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('unassigned-date-filter').value = ''; loadUnassignedRooms();">Filtreyi Temizle</button>
                </div>
                <div id="unassigned-list">
                    <div class="loading">YÃ¼kleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Activities Tab -->
        <div id="activities-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Hikaye YÃ¶netimi (Story Tray)</h2>
                    <button class="btn btn-primary" onclick="openActivityModal()">+ Yeni Hikaye</button>
                </div>
                <div id="activities-list">
                    <div class="loading">YÃ¼kleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Activities Calendar Tab -->
        <div id="activities-calendar-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Aktiviteler Takvimi</h2>
                    <button class="btn btn-primary" onclick="openActivityCalendarModal()">+ Yeni Aktivite</button>
                </div>
                <div id="activities-calendar-container" style="padding: 20px;">
                    <div id="activities-fullcalendar"></div>
                </div>
            </div>
        </div>

        <!-- Posts Tab -->
        <div id="posts-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Post YÃ¶netimi</h2>
                    <button class="btn btn-primary" onclick="openPostModal()">+ Yeni Post</button>
                </div>
                <div id="posts-list">
                    <div class="loading">YÃ¼kleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Restaurants Tab -->
        <div id="restaurants-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">A'la Carte Rezervasyon YÃ¶netimi</h2>
                </div>
                
                <!-- Sub-tabs for restaurant management -->
                <div class="tabs" style="margin-top: 20px; border-bottom: 2px solid var(--border);">
                    <button class="tab active" onclick="switchRestaurantSubTab('restaurants-list')" id="restaurants-list-tab-btn">
                        <i data-lucide="utensils" class="icon icon-md"></i> Restoranlar
                    </button>
                    <button class="tab" onclick="switchRestaurantSubTab('sessions')" id="sessions-tab-btn">
                        <i data-lucide="clock" class="icon icon-md"></i> Seanslar
                    </button>
                    <button class="tab" onclick="switchRestaurantSubTab('table-setup')" id="table-setup-tab-btn">
                        <i data-lucide="table" class="icon icon-md"></i> Masa Kurulumu
                    </button>
                    <button class="tab" onclick="switchRestaurantSubTab('calendar')" id="calendar-tab-btn">
                        <i data-lucide="calendar" class="icon icon-md"></i> Takvim
                    </button>
                    <button class="tab" onclick="switchRestaurantSubTab('pricing-rules')" id="pricing-rules-tab-btn">
                        <i data-lucide="dollar-sign" class="icon icon-md"></i> Fiyat & Kurallar
                    </button>
                </div>

                <!-- Restaurants List Sub-tab -->
                <div id="restaurants-list-subtab" class="restaurant-subtab-content active">
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="openRestaurantModal()">+ Yeni Restoran</button>
                    </div>
                    <div id="restaurants-list" style="margin-top: 20px;">
                        <div class="loading">YÃ¼kleniyor...</div>
                    </div>
                </div>

                <!-- Sessions Sub-tab -->
                <div id="sessions-subtab" class="restaurant-subtab-content">
                    <div style="margin-top: 20px;">
                        <div class="form-group" style="max-width: 300px; margin-bottom: 15px;">
                            <label class="form-label">Restoran SeÃ§</label>
                            <select id="sessions-restaurant-select" class="form-input" onchange="loadSessionTemplates()">
                                <option value="">-- Restoran SeÃ§in --</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="openSessionTemplateModal()" id="new-session-btn" disabled>+ Yeni Seans Åžablonu</button>
                    </div>
                    <div id="session-templates-list" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Ã–nce bir restoran seÃ§in</p>
                        </div>
                    </div>
                </div>

                <!-- Table Setup Sub-tab -->
                <div id="table-setup-subtab" class="restaurant-subtab-content">
                    <div style="margin-top: 20px;">
                        <div class="form-group" style="max-width: 300px; margin-bottom: 15px;">
                            <label class="form-label">Restoran SeÃ§</label>
                            <select id="table-setup-restaurant-select" class="form-input" onchange="loadTableSetupSessions()">
                                <option value="">-- Restoran SeÃ§in --</option>
                            </select>
                        </div>
                        <div class="form-group" style="max-width: 300px; margin-bottom: 15px;">
                            <label class="form-label">Seans Åžablonu SeÃ§</label>
                            <select id="table-setup-session-select" class="form-input" onchange="loadTableDefaults()" disabled>
                                <option value="">-- Ã–nce restoran seÃ§in --</option>
                            </select>
                        </div>
                    </div>
                    <div id="table-setup-form" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Ã–nce restoran ve seans ÅŸablonu seÃ§in</p>
                        </div>
                    </div>
                </div>

                <!-- Calendar Sub-tab -->
                <div id="calendar-subtab" class="restaurant-subtab-content">
                    <div style="margin-top: 20px;">
                        <div class="form-group" style="max-width: 300px; margin-bottom: 15px; display: inline-block; margin-right: 15px;">
                            <label class="form-label">Restoran SeÃ§</label>
                            <select id="calendar-restaurant-select" class="form-input" onchange="loadCalendar()">
                                <option value="">-- Restoran SeÃ§in --</option>
                            </select>
                        </div>
                        <div class="form-group" style="max-width: 200px; margin-bottom: 15px; display: inline-block; margin-right: 15px;">
                            <label class="form-label">BaÅŸlangÄ±Ã§ Tarihi</label>
                            <input type="date" id="calendar-from-date" class="form-input" onchange="loadCalendar()">
                        </div>
                        <div class="form-group" style="max-width: 200px; margin-bottom: 15px; display: inline-block; margin-right: 15px;">
                            <label class="form-label">BitiÅŸ Tarihi</label>
                            <input type="date" id="calendar-to-date" class="form-input" onchange="loadCalendar()">
                        </div>
                        <button class="btn btn-primary" onclick="generateSessionInstances()">SeanslarÄ± OluÅŸtur</button>
                    </div>
                    <div id="calendar-instances-list" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Ã–nce bir restoran seÃ§in ve tarih aralÄ±ÄŸÄ± belirleyin</p>
                        </div>
                    </div>
                </div>

                <!-- Pricing & Rules Sub-tab -->
                <div id="pricing-rules-subtab" class="restaurant-subtab-content">
                    <div style="margin-top: 20px;">
                        <div class="form-group" style="max-width: 300px; margin-bottom: 15px;">
                            <label class="form-label">Restoran SeÃ§</label>
                            <select id="pricing-restaurant-select" class="form-input" onchange="loadPricingRules()">
                                <option value="">-- Restoran SeÃ§in --</option>
                            </select>
                        </div>
                    </div>
                    <div id="pricing-rules-form" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Ã–nce bir restoran seÃ§in</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assistant Modal -->
    <div id="assistant-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="assistant-modal-title">Yeni Assistant</h3>
                <button class="close-btn" onclick="closeAssistantModal()">&times;</button>
            </div>
            <form id="assistant-form" onsubmit="saveAssistant(event)">
                <div class="form-group">
                    <label class="form-label">Avatar</label>
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="assistant-avatar-preview">
                            <i data-lucide="user" class="icon icon-lg"></i>
                        </div>
                        <input type="file" id="assistant-avatar-input" accept="image/*" onchange="handleAssistantAvatarChange(event)">
                        <button type="button" class="avatar-upload-btn" onclick="document.getElementById('assistant-avatar-input').click()">
                            FotoÄŸraf SeÃ§
                        </button>
                        <input type="hidden" id="assistant-avatar-data">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Assistant AdÄ± *</label>
                    <input type="text" id="assistant-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Assistant SoyadÄ± *</label>
                    <input type="text" id="assistant-surname" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email (Opsiyonel)</label>
                    <input type="email" id="assistant-email" class="form-input">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAssistantModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="team-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="team-modal-title">Yeni TakÄ±m</h3>
                <button class="close-btn" onclick="closeTeamModal()">&times;</button>
            </div>
            <form id="team-form" onsubmit="saveTeam(event)">
                <div class="form-group">
                    <label class="form-label">Avatar</label>
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="team-avatar-preview">
                            <span>ðŸ‘¥</span>
                        </div>
                        <input type="file" id="team-avatar-input" accept="image/*" onchange="handleTeamAvatarChange(event)">
                        <button type="button" class="avatar-upload-btn" onclick="document.getElementById('team-avatar-input').click()">
                            FotoÄŸraf SeÃ§
                        </button>
                        <input type="hidden" id="team-avatar-data">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">TakÄ±m AdÄ± *</label>
                    <input type="text" id="team-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">AÃ§Ä±klama</label>
                    <textarea id="team-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Assistant'lar</label>
                    <div id="team-assistants-checkboxes" class="checkbox-group">
                        <div class="loading">YÃ¼kleniyor...</div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTeamModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team QR Modal -->
    <div id="team-qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="team-qr-modal-title">TakÄ±m QR Kodu</h3>
                <button class="close-btn" onclick="closeTeamQRModal()">&times;</button>
            </div>
            <div style="text-align: center;">
                <img id="team-qr-code-image" src="" alt="QR Code" style="max-width: 300px; width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 20px 0;">
                <div class="qr-link" id="team-qr-link" style="margin-top: 20px; padding: 12px; background: white; border-radius: 8px; word-break: break-all; font-size: 12px; color: #667781;"></div>
                <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 8px; font-size: 14px; color: #1976d2;">
                    <strong><i data-lucide="info" class="icon icon-sm"></i> Bilgi:</strong> Bu QR kodu okutan assistant otomatik olarak takÄ±ma katÄ±lacaktÄ±r.
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeTeamQRModal()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div id="assignment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">TakÄ±m-Misafir EÅŸleÅŸtirmesi</h3>
                <button class="close-btn" onclick="closeAssignmentModal()">&times;</button>
            </div>
            <form id="assignment-form" onsubmit="saveAssignment(event)">
                <!-- Oda Bilgileri (tek oda iÃ§in eÅŸleÅŸtirme yapÄ±ldÄ±ÄŸÄ±nda gÃ¶sterilir) -->
                <div id="assignment-room-info" class="form-group" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 12px; color: var(--voyage-navy);">Oda Bilgileri</h4>
                    <div id="assignment-room-details" style="font-size: 14px; line-height: 1.8;">
                        <!-- Oda bilgileri buraya eklenecek -->
                    </div>
                </div>

                <!-- TakÄ±m SeÃ§imi - Kartlar (tek oda iÃ§in) -->
                <div class="form-group">
                    <label class="form-label">TakÄ±m SeÃ§in *</label>
                    <select id="assignment-team" class="form-select" style="display: none;">
                        <option value="">TakÄ±m SeÃ§in</option>
                    </select>
                    <div id="assignment-teams-cards" class="team-cards-container">
                        <div class="loading">YÃ¼kleniyor...</div>
                    </div>
                </div>

                <!-- Eski checkbox grubu (Ã§oklu oda seÃ§imi iÃ§in - gizli) -->
                <div class="form-group" id="assignment-guests-group" style="display: none;">
                    <label class="form-label">Misafirler (Room Number - Guest Name)</label>
                    <div id="assignment-guests-checkboxes" class="checkbox-group">
                        <div class="loading">YÃ¼kleniyor...</div>
                    </div>
                </div>

                <!-- Hidden input for selected room (tek oda eÅŸleÅŸtirmesi iÃ§in) -->
                <input type="hidden" id="assignment-selected-room-number">
                <input type="hidden" id="assignment-selected-checkin-date">
                <input type="hidden" id="assignment-selected-guest-unique-id">

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAssignmentModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">EÅŸleÅŸtir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activity-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="activity-modal-title">Yeni Hikaye</h3>
                <button class="close-btn" onclick="closeActivityModal()">&times;</button>
            </div>
            <form id="activity-form" onsubmit="saveActivity(event)">
                <div class="form-group">
                    <label class="form-label">BaÅŸlÄ±k *</label>
                    <input type="text" id="activity-title" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ä°kon (opsiyonel)</label>
                    <input type="text" id="activity-icon" class="form-input" placeholder="Ã–rn: activity-1">
                </div>
                <div class="form-group">
                    <label class="form-label">Tarih</label>
                    <input type="date" id="activity-date" class="form-input">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label">BaÅŸlangÄ±Ã§ Saati</label>
                        <input type="time" id="activity-start-time" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">BitiÅŸ Saati</label>
                        <input type="time" id="activity-end-time" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Kategori</label>
                    <input type="text" id="activity-category" class="form-input" placeholder="Ã–rn: Sabah / Ã–ÄŸle / AkÅŸam">
                </div>
                <div class="form-group">
                    <label class="form-label">TÃ¼r</label>
                    <select id="activity-type" class="form-input">
                        <option value="">SeÃ§iniz</option>
                        <option value="Kids" data-i18n="kids">Ã‡ocuk</option>
                        <option value="Adult" data-i18n="adult">YetiÅŸkin</option>
                        <option value="All Ages" data-i18n="allAges">TÃ¼m YaÅŸlar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Lokasyon</label>
                    <input type="text" id="activity-location" class="form-input" placeholder="Ã–rn: Ana Sahne / Havuz">
                </div>
                <div class="form-group">
                    <label class="form-label">AÃ§Ä±klama</label>
                    <textarea id="activity-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label">EÄŸitmen</label>
                        <input type="text" id="activity-instructor" class="form-input" placeholder="Opsiyonel">
                    </div>
                    <div>
                        <label class="form-label">YaÅŸ Grubu</label>
                        <input type="text" id="activity-age-group" class="form-input" placeholder="Ã–rn: Kids / Adults / All">
                    </div>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label">Kapasite</label>
                        <input type="number" id="activity-capacity" class="form-input" min="0" step="1">
                    </div>
                    <div>
                        <label class="form-label">Enlem</label>
                        <input type="number" id="activity-lat" class="form-input" step="0.00000001">
                    </div>
                    <div>
                        <label class="form-label">Boylam</label>
                        <input type="number" id="activity-lng" class="form-input" step="0.00000001">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="activity-featured"> Ã–ne Ã‡Ä±kan
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Medya (Foto/Video URL)</label>
                    <input type="text" id="activity-image-url" class="form-input" placeholder="FotoÄŸraf URL (opsiyonel)">
                    <div style="height: 8px;"></div>
                    <input type="text" id="activity-video-url" class="form-input" placeholder="Video URL (opsiyonel)">
                    <div style="font-size: 12px; color: #667781; margin-top: 6px;">
                        Not: Video URL girerseniz fotoÄŸraf alanÄ± otomatik boÅŸaltÄ±lÄ±r (ve tersi).
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">SÄ±ra (opsiyonel)</label>
                    <input type="number" id="activity-display-order" class="form-input" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="activity-is-active" checked> Aktif
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeActivityModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Activity Calendar Modal -->
    <div id="activity-calendar-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="activity-calendar-modal-title">Yeni Aktivite</h3>
                <button class="close-btn" onclick="closeActivityCalendarModal()">&times;</button>
            </div>
            <form id="activity-calendar-form" onsubmit="saveActivityCalendar(event)">
                <div class="form-group">
                    <label class="form-label">BaÅŸlÄ±k *</label>
                    <input type="text" id="calendar-activity-title" class="form-input" required>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label">BaÅŸlangÄ±Ã§ Tarihi *</label>
                        <input type="date" id="calendar-activity-start-date" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">BitiÅŸ Tarihi</label>
                        <input type="date" id="calendar-activity-end-date" class="form-input">
                    </div>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label">BaÅŸlangÄ±Ã§ Saati</label>
                        <input type="time" id="calendar-activity-start-time" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">BitiÅŸ Saati</label>
                        <input type="time" id="calendar-activity-end-time" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Kategori</label>
                    <input type="text" id="calendar-activity-category" class="form-input" placeholder="Ã–rn: Sabah / Ã–ÄŸle / AkÅŸam">
                </div>
                <div class="form-group">
                    <label class="form-label">TÃ¼r</label>
                    <select id="calendar-activity-type" class="form-input">
                        <option value="">SeÃ§iniz</option>
                        <option value="Kids" data-i18n="kids">Ã‡ocuk</option>
                        <option value="Adult" data-i18n="adult">YetiÅŸkin</option>
                        <option value="All Ages" data-i18n="allAges">TÃ¼m YaÅŸlar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Lokasyon</label>
                    <input type="text" id="calendar-activity-location" class="form-input" placeholder="Ã–rn: Ana Sahne / Havuz">
                </div>
                <div class="form-group">
                    <label class="form-label">AÃ§Ä±klama</label>
                    <textarea id="calendar-activity-description" class="form-input" rows="3"></textarea>
                </div>
                
                <!-- FotoÄŸraf ve Video YÃ¼kleme -->
                <div class="form-group" style="border-top: 2px solid var(--voyage-light-blue); padding-top: 16px; margin-top: 16px;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">FotoÄŸraf veya Video</label>
                    <div class="form-group">
                        <label class="form-label">Dosya YÃ¼kle</label>
                        <input type="file" id="calendar-activity-file" class="form-input" accept="image/*,video/*" onchange="handleActivityFileChange(event)">
                        <div id="calendar-activity-file-preview" style="margin-top: 10px;"></div>
                    </div>
                    <div class="form-group" style="margin-top: 12px;">
                        <label class="form-label">veya URL ile ekle</label>
                        <input type="text" id="calendar-activity-image-url" class="form-input" placeholder="FotoÄŸraf URL (opsiyonel)">
                        <input type="text" id="calendar-activity-video-url" class="form-input" style="margin-top: 8px;" placeholder="Video URL (opsiyonel)">
                        <div style="font-size: 12px; color: #667781; margin-top: 6px;">
                            Not: Video URL girerseniz fotoÄŸraf alanÄ± otomatik boÅŸaltÄ±lÄ±r (ve tersi).
                        </div>
                    </div>
                </div>
                
                <!-- Tekrar SeÃ§enekleri (RRule) -->
                <div class="form-group" style="border-top: 2px solid var(--voyage-light-blue); padding-top: 16px; margin-top: 16px;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Tekrar SeÃ§enekleri</label>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="radio" name="recurring-type" id="recurring-none" value="none" checked onchange="toggleRecurringOptions()">
                            Tek seferlik (tekrar yok)
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="radio" name="recurring-type" id="recurring-daily" value="daily" onchange="toggleRecurringOptions()">
                            Her gÃ¼n
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="radio" name="recurring-type" id="recurring-weekly" value="weekly" onchange="toggleRecurringOptions()">
                            Her hafta (aynÄ± gÃ¼n)
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="radio" name="recurring-type" id="recurring-biweekly" value="biweekly" onchange="toggleRecurringOptions()">
                            Her 14 gÃ¼nde 1
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="radio" name="recurring-type" id="recurring-monthly" value="monthly" onchange="toggleRecurringOptions()">
                            Her ay (aynÄ± gÃ¼n)
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="radio" name="recurring-type" id="recurring-custom" value="custom" onchange="toggleRecurringOptions()">
                            Ã–zel RRule (GeliÅŸmiÅŸ)
                        </label>
                    </div>
                    <div class="form-group" id="recurring-custom-group" style="display: none;">
                        <label class="form-label">RRule String</label>
                        <input type="text" id="recurring-rrule-string" class="form-input" placeholder="Ã–rn: FREQ=WEEKLY;BYDAY=MO,WE,FR">
                        <div style="font-size: 12px; color: #667781; margin-top: 4px;">
                            RRule formatÄ±: FREQ=DAILY|WEEKLY|MONTHLY|YEARLY;INTERVAL=2;BYDAY=MO,WE,FR;UNTIL=20241231T000000Z
                        </div>
                    </div>
                    <div class="form-group" id="recurring-until-group" style="display: none;">
                        <label class="form-label">Tekrar Son Tarihi (Opsiyonel)</label>
                        <input type="date" id="recurring-until-date" class="form-input">
                        <div style="font-size: 12px; color: #667781; margin-top: 4px;">
                            BoÅŸ bÄ±rakÄ±lÄ±rsa seÃ§ilen yÄ±lÄ±n sonuna kadar tekrar eder
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeActivityCalendarModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Post Modal -->
    <div id="post-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="post-modal-title">Yeni Post</h3>
                <button class="close-btn" onclick="closePostModal()">&times;</button>
            </div>
            <form id="post-form" onsubmit="savePost(event)">
                <div class="form-group">
                    <label class="form-label">Post ID *</label>
                    <input type="text" id="post-post-id" class="form-input" required placeholder="Ã–rn: post-1">
                </div>
                <div class="form-group">
                    <label class="form-label">BaÅŸlÄ±k *</label>
                    <input type="text" id="post-title" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ä°kon (opsiyonel)</label>
                    <input type="text" id="post-icon" class="form-input" placeholder="Ã–rn: activity-1">
                </div>
                <div class="form-group">
                    <label class="form-label">Lokasyon</label>
                    <input type="text" id="post-location" class="form-input" placeholder="Ã–rn: Voyage Sorgun / Lobby">
                </div>
                <div class="form-group">
                    <label class="form-label">AÃ§Ä±klama (opsiyonel)</label>
                    <textarea id="post-caption" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">FotoÄŸraflar</label>
                    <input type="file" id="post-image-files" class="form-input" accept="image/*" multiple style="padding: 8px;">
                    <div style="height: 8px;"></div>
                    <div id="post-image-urls-container" style="margin-top: 8px;">
                        <input type="text" class="form-input post-image-url-input" placeholder="FotoÄŸraf URL (opsiyonel)" style="margin-bottom: 4px;">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addImageUrlInput()" style="margin-top: 4px; padding: 6px 12px; font-size: 12px;">+ URL Ekle</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Videolar</label>
                    <input type="file" id="post-video-files" class="form-input" accept="video/*" multiple style="padding: 8px;">
                    <div style="height: 8px;"></div>
                    <div id="post-video-urls-container" style="margin-top: 8px;">
                        <input type="text" class="form-input post-video-url-input" placeholder="Video URL (opsiyonel)" style="margin-bottom: 4px;">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addVideoUrlInput()" style="margin-top: 4px; padding: 6px 12px; font-size: 12px;">+ URL Ekle</button>
                </div>
                <div class="form-group">
                    <label class="form-label">SÄ±ra (opsiyonel)</label>
                    <input type="number" id="post-display-order" class="form-input" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="post-is-active" checked> Aktif
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePostModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Restaurant Modal -->
    <div id="restaurant-modal" class="modal" onclick="if(event.target === this) closeRestaurantModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="restaurant-modal-title">Yeni Restoran</h3>
                <button class="close-btn" onclick="closeRestaurantModal()">&times;</button>
            </div>
            <form id="restaurant-form" onsubmit="saveRestaurant(event)">
                <div class="form-group">
                    <label class="form-label">Restoran AdÄ± *</label>
                    <input type="text" id="restaurant-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">AÃ§Ä±klama</label>
                    <textarea id="restaurant-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">FotoÄŸraflar</label>
                    <div id="restaurant-photos-preview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;"></div>
                    <input type="file" id="restaurant-photos-input" accept="image/*" multiple onchange="handleRestaurantPhotosChange(event)">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('restaurant-photos-input').click()" style="margin-top: 10px;">
                        FotoÄŸraf Ekle
                    </button>
                    <input type="hidden" id="restaurant-photos-data">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="restaurant-active" checked> Aktif
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">KiÅŸi BaÅŸÄ±na Fiyat *</label>
                    <input type="number" id="restaurant-price-per-person" class="form-input" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Para Birimi *</label>
                    <select id="restaurant-currency" class="form-input" required>
                        <option value="TRY">TRY (â‚º)</option>
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (â‚¬)</option>
                    </select>
                </div>
                
                <!-- Rules Section (Collapsible) -->
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" onclick="toggleRestaurantRules()" style="width: 100%; margin-bottom: 10px;">
                        <i data-lucide="settings" class="icon icon-md"></i> Kurallar ve Ayarlar
                    </button>
                    <div id="restaurant-rules-section" style="display: none; padding: 15px; background: var(--voyage-light-blue); border-radius: 8px;">
                        <div class="form-group">
                            <label class="form-label">Oda BaÅŸÄ±na GÃ¼nlÃ¼k Maksimum Rezervasyon</label>
                            <input type="number" id="restaurant-max-per-room-per-day" class="form-input" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Konaklama BaÅŸÄ±na Maksimum Rezervasyon (Opsiyonel)</label>
                            <input type="number" id="restaurant-max-per-stay" class="form-input" min="1" placeholder="SÄ±nÄ±rsÄ±z iÃ§in boÅŸ bÄ±rakÄ±n">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rezervasyon KapanÄ±ÅŸ SÃ¼resi (Dakika)</label>
                            <input type="number" id="restaurant-cutoff-minutes" class="form-input" min="0" value="120">
                            <small style="color: var(--text-light);">Seans baÅŸlangÄ±cÄ±ndan kaÃ§ dakika Ã¶nce rezervasyon kapanÄ±r</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ä°ptal Son Tarih (Dakika)</label>
                            <input type="number" id="restaurant-cancellation-deadline-minutes" class="form-input" min="0" value="240">
                            <small style="color: var(--text-light);">Seans baÅŸlangÄ±cÄ±ndan kaÃ§ dakika Ã¶nce iptal edilebilir</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ã‡ocuk FiyatlandÄ±rma PolitikasÄ±</label>
                            <select id="restaurant-child-pricing-policy" class="form-input">
                                <option value="free_under_12">12 YaÅŸ AltÄ± Ãœcretsiz</option>
                                <option value="half_price">YarÄ±m Fiyat</option>
                                <option value="full_price">Tam Fiyat</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="restaurant-allow-mix-table"> Masa KarÄ±ÅŸtÄ±rmaya Ä°zin Ver
                            </label>
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">Birden fazla masaya bÃ¶lÃ¼nmÃ¼ÅŸ rezervasyonlara izin ver</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="restaurant-deposit-required"> Depozito Gerekli
                            </label>
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">(Gelecek Ã¶zellik)</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="restaurant-ask-table-preference"> Masa/Alan Tercihi Sor
                            </label>
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">Rezervasyon yaparken misafirlere sigara/sigarasÄ±z alan tercihi sorulsun</small>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRestaurantModal()">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentAssistantId = null;
        let currentTeamId = null;
        let currentActivityId = null;
        let currentPostId = null;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'assistants') loadAssistants();
            if (tabName === 'teams') loadTeams();
            if (tabName === 'assignments') loadAssignments();
            if (tabName === 'unassigned') loadUnassignedRooms();
            if (tabName === 'activities') loadActivities();
            if (tabName === 'activities-calendar') {
                if (!calendar) {
                    initFullCalendar();
                } else {
                    loadActivitiesCalendar();
                }
            }
            if (tabName === 'posts') loadPosts();
            if (tabName === 'restaurants') {
                loadRestaurants();
                switchRestaurantSubTab('restaurants-list');
            }
        }

        // Restaurant sub-tab switching
        function switchRestaurantSubTab(subTabName) {
            // Remove active from all sub-tab buttons
            document.querySelectorAll('#restaurants-tab .tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all sub-tab contents
            document.querySelectorAll('.restaurant-subtab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Add active to clicked button
            const btnId = `${subTabName}-tab-btn`;
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.classList.add('active');
            }
            
            // Add active to corresponding content
            const contentId = `${subTabName}-subtab`;
            const content = document.getElementById(contentId);
            if (content) {
                content.classList.add('active');
            }
            
            // Load data based on sub-tab
            if (subTabName === 'restaurants-list') {
                loadRestaurants();
            } else if (subTabName === 'sessions') {
                loadRestaurantsForSelect('sessions-restaurant-select');
            } else if (subTabName === 'table-setup') {
                loadRestaurantsForSelect('table-setup-restaurant-select');
            } else if (subTabName === 'calendar') {
                loadRestaurantsForSelect('calendar-restaurant-select');
                // Set default date range (next 14 days)
                const today = new Date();
                const toDate = new Date();
                toDate.setDate(today.getDate() + 14);
                document.getElementById('calendar-from-date').value = today.toISOString().split('T')[0];
                document.getElementById('calendar-to-date').value = toDate.toISOString().split('T')[0];
            } else if (subTabName === 'pricing-rules') {
                loadRestaurantsForSelect('pricing-restaurant-select');
            }
        }

        // Load assistants
        async function loadAssistants() {
            try {
                const response = await fetch('/api/assistants');
                const assistants = await response.json();
                
                const listEl = document.getElementById('assistants-list');
                if (assistants.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ‘¥</div>
                            <p>HenÃ¼z assistant eklenmemiÅŸ</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Asistan ID</th>
                                <th>Avatar</th>
                                <th>Ad</th>
                                <th>Soyad</th>
                                <th>TakÄ±m</th>
                                <th>Durum</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assistants.map(a => {
                                // Use name and surname directly from database
                                const firstName = a.name || '';
                                const lastName = a.surname || '';
                                
                                return `
                                <tr>
                                    <td>${a.id}</td>
                                    <td>
                                        ${a.avatar ? `
                                            <img src="${a.avatar}" alt="${a.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="user" class="icon icon-lg"></i></div>
                                        `}
                                    </td>
                                    <td>${firstName}</td>
                                    <td>${lastName || '-'}</td>
                                    <td>
                                        ${a.teams ? `
                                            <span class="badge badge-success">${a.teams}</span>
                                        ` : `
                                            <span style="color: #999; font-style: italic;">TakÄ±m yok</span>
                                        `}
                                    </td>
                                    <td>
                                        <span class="badge ${a.is_active ? 'badge-success' : 'badge-danger'}">
                                            ${a.is_active ? 'Aktif' : 'Pasif'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editAssistant(${a.id})" style="padding: 6px 12px; font-size: 12px;">DÃ¼zenle</button>
                                        <button class="btn btn-danger" onclick="deleteAssistant(${a.id})" style="padding: 6px 12px; font-size: 12px;">Sil</button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading assistants:', error);
                document.getElementById('assistants-list').innerHTML = `
                    <div class="alert alert-error">Assistant'lar yÃ¼klenirken hata oluÅŸtu</div>
                `;
            }
        }

        // Load teams
        async function loadTeams() {
            try {
                const response = await fetch('/api/teams');
                const teams = await response.json();
                
                const listEl = document.getElementById('teams-list');
                if (teams.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div>
                            <p>HenÃ¼z takÄ±m oluÅŸturulmamÄ±ÅŸ</p>
                        </div>
                    `;
                    return;
                }

                // Load assistants for each team
                const teamsWithData = await Promise.all(teams.map(async (team) => {
                    const assistantsRes = await fetch(`/api/teams/${team.id}/assistants`);
                    const assistants = await assistantsRes.json();
                    
                    return { ...team, assistants };
                }));

                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Avatar</th>
                                <th>TakÄ±m AdÄ±</th>
                                <th>AÃ§Ä±klama</th>
                                <th>Assistant'lar</th>
                                <th>Aktif Oda SayÄ±sÄ±</th>
                                <th>Durum</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${teamsWithData.map(t => `
                                <tr>
                                    <td>${t.id}</td>
                                    <td>
                                        ${t.avatar ? `
                                            <img src="${t.avatar}" alt="${t.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);">ðŸ‘¥</div>
                                        `}
                                    </td>
                                    <td>${t.name}</td>
                                    <td>${t.description || '-'}</td>
                                    <td>${t.assistants.map(a => a.name).join(', ') || '-'}</td>
                                    <td>
                                        <span class="badge badge-success">${t.active_room_count || 0} Oda</span>
                                    </td>
                                    <td>
                                        <span class="badge ${t.is_active ? 'badge-success' : 'badge-danger'}">
                                            ${t.is_active ? 'Aktif' : 'Pasif'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editTeam(${t.id})" style="padding: 6px 12px; font-size: 12px;">DÃ¼zenle</button>
                                        <button class="btn btn-danger" onclick="deleteTeam(${t.id})" style="padding: 6px 12px; font-size: 12px;">Sil</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading teams:', error);
                document.getElementById('teams-list').innerHTML = `
                    <div class="alert alert-error">TakÄ±mlar yÃ¼klenirken hata oluÅŸtu</div>
                `;
            }
        }

        // Load assignments
        async function loadAssignments() {
            try {
                const dateFilter = document.getElementById('checkin-date-filter').value;
                console.log('ðŸ“… Loading assignments with filter:', dateFilter);
                
                const listEl = document.getElementById('assignments-list');
                
                // If date filter is set, show both assigned and unassigned rooms
                if (dateFilter) {
                    console.log('ðŸ” Date filter active, loading both assignments and rooms');
                    
                    // Load assignments for this date
                    const assignmentsUrl = `/api/team-assignments?checkin_date=${dateFilter}`;
                    console.log('ðŸ”— Fetching assignments from:', assignmentsUrl);
                    
                    const assignmentsResponse = await fetch(assignmentsUrl);
                    if (!assignmentsResponse.ok) {
                        throw new Error(`Failed to load assignments: ${assignmentsResponse.status}`);
                    }
                    const assignments = await assignmentsResponse.json();
                    console.log('âœ… Assignments received:', assignments.length, assignments);
                    
                    // Load all rooms for this date
                    const roomsUrl = `/api/rooms?start_date=${dateFilter}&end_date=${dateFilter}`;
                    console.log('ðŸ¨ Fetching rooms from:', roomsUrl);
                    
                    const roomsResponse = await fetch(roomsUrl);
                    if (!roomsResponse.ok) {
                        throw new Error(`Failed to load rooms: ${roomsResponse.status}`);
                    }
                    const rooms = await roomsResponse.json();
                    console.log('ðŸ¨ Rooms found:', rooms.length, rooms);
                    
                    if (rooms.length === 0) {
                        listEl.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">ðŸ”—</div>
                                <p>${dateFilter} tarihi iÃ§in check-in bulunamadÄ±</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Create a set of assigned room keys (room_number + checkin_date)
                    const assignedKeys = new Set(
                        assignments.map(a => `${a.room_number}_${a.checkin_date}`)
                    );
                    console.log('ðŸ”‘ Assigned room keys:', Array.from(assignedKeys));
                    
                    // Separate assigned and unassigned rooms
                    const assignedRooms = rooms.filter(r => 
                        assignedKeys.has(`${r.room_number}_${r.checkin_date}`)
                    );
                    const unassignedRooms = rooms.filter(r => 
                        !assignedKeys.has(`${r.room_number}_${r.checkin_date}`)
                    );
                    
                    console.log('âœ… Assigned rooms:', assignedRooms.length);
                    console.log('âŒ Unassigned rooms:', unassignedRooms.length);
                    
                    // Create assignment map for quick lookup
                    const assignmentMap = new Map();
                    assignments.forEach(a => {
                        const key = `${a.room_number}_${a.checkin_date}`;
                        if (!assignmentMap.has(key)) {
                            assignmentMap.set(key, []);
                        }
                        assignmentMap.get(key).push(a);
                    });
                    
                    let html = `
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni EÅŸleÅŸtirme</button>
                        </div>
                    `;
                    
                    // Show assigned rooms section
                    if (assignedRooms.length > 0) {
                        html += `
                            <div style="margin-bottom: 24px;">
                                <h3 style="margin-bottom: 12px; color: #25D366; font-size: 16px;">
                                    âœ… EÅŸleÅŸtirilmiÅŸ Odalar (${assignedRooms.length})
                                </h3>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>TakÄ±m</th>
                                            <th>Unique ID</th>
                                            <th>Avatar</th>
                                            <th>Misafir</th>
                                            <th>Check-in Tarihi</th>
                                            <th>YetiÅŸkin</th>
                                            <th>Ã‡ocuk</th>
                                            <th>Ãœlke</th>
                                            <th>Acente</th>
                                            <th>Ä°ÅŸlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${assignedRooms.map(r => {
                                            const key = `${r.room_number}_${r.checkin_date}`;
                                            const roomAssignments = assignmentMap.get(key) || [];
                                            return roomAssignments.map(a => `
                                                <tr style="background: white;">
                                                    <td>${a.team_name}</td>
                                                    <td style="font-family: monospace; font-size: 11px;">${r.guest_unique_id || '-'}</td>
                                                    <td>
                                                        ${r.profile_photo ? `
                                                            <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                                        ` : `
                                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                                        `}
                                                    </td>
                                                    <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                                    <td>${r.checkin_date || '-'}</td>
                                                    <td>${r.adult_count || '-'}</td>
                                                    <td>${r.child_count || '-'}</td>
                                                    <td>${r.country || '-'}</td>
                                                    <td>${r.agency || '-'}</td>
                                                    <td>
                                                        <button class="btn btn-danger" onclick="deleteAssignment(${a.id})" style="padding: 6px 12px; font-size: 12px;">KaldÄ±r</button>
                                                    </td>
                                                </tr>
                                            `).join('');
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    // Show unassigned rooms section
                    if (unassignedRooms.length > 0) {
                        html += `
                            <div style="margin-bottom: 24px;">
                                <h3 style="margin-bottom: 12px; color: #ff9800; font-size: 16px;">
                                    âš ï¸ EÅŸleÅŸtirilmemiÅŸ Odalar (${unassignedRooms.length})
                                </h3>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Unique ID</th>
                                            <th>Avatar</th>
                                            <th>Misafir</th>
                                            <th>Check-in Tarihi</th>
                                            <th>YetiÅŸkin</th>
                                            <th>Ã‡ocuk</th>
                                            <th>Ãœlke</th>
                                            <th>Acente</th>
                                            <th>Ä°ÅŸlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${unassignedRooms.map(r => `
                                            <tr style="background: white;">
                                                <td style="font-family: monospace; font-size: 11px;">${r.guest_unique_id || '-'}</td>
                                                <td>
                                                    ${r.profile_photo ? `
                                                        <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                                    ` : `
                                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                                    `}
                                                </td>
                                                <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                                <td>${r.checkin_date || '-'}</td>
                                                <td>${r.adult_count || '-'}</td>
                                                <td>${r.child_count || '-'}</td>
                                                <td>${r.country || '-'}</td>
                                                <td>${r.agency || '-'}</td>
                                                <td>
                                                    <button class="btn btn-primary" onclick="openAssignmentModalForRoomByGuestId('${r.guest_unique_id || ''}', '${r.room_number || ''}', '${r.checkin_date || ''}')" style="padding: 6px 12px; font-size: 12px;">EÅŸleÅŸtir</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    if (assignedRooms.length === 0 && unassignedRooms.length === 0) {
                        html = `
                            <div class="empty-state">
                                <div class="empty-state-icon">ðŸ”—</div>
                                <p>${dateFilter} tarihi iÃ§in check-in bulunamadÄ±</p>
                            </div>
                        `;
                    }
                    
                    listEl.innerHTML = html;
                    return;
                }
                
                // No date filter - show all assignments
                const url = '/api/team-assignments';
                console.log('ðŸ”— Fetching from URL:', url);
                
                const response = await fetch(url);
                console.log('ðŸ“¡ Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API Error:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const assignments = await response.json();
                console.log('âœ… Assignments received:', assignments.length, assignments);
                
                if (assignments.length === 0) {
                    console.log('â„¹ï¸ No assignments found');
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ”—</div>
                            <p>HenÃ¼z eÅŸleÅŸtirme yapÄ±lmamÄ±ÅŸ. LÃ¼tfen bir tarih seÃ§ip filtreleyin.</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni EÅŸleÅŸtirme</button>
                    </div>
                    <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <strong><i data-lucide="info" class="icon icon-sm"></i> Bilgi:</strong> TÃ¼m eÅŸleÅŸtirmeler gÃ¶steriliyor. Belirli bir tarih iÃ§in filtrelemek iÃ§in tarih seÃ§in.
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>TakÄ±m</th>
                                <th>Oda No</th>
                                <th>Avatar</th>
                                <th>Misafir</th>
                                <th>Check-in Tarihi</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assignments.map(a => `
                                <tr>
                                    <td>${a.team_name}</td>
                                    <td style="font-family: monospace; font-size: 11px;">${a.guest_unique_id || a.room_number || '-'}</td>
                                    <td>
                                        ${a.profile_photo ? `
                                            <img src="${a.profile_photo}" alt="${a.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                        `}
                                    </td>
                                    <td>${a.guest_name || '-'} ${a.guest_surname || ''}</td>
                                    <td>${a.checkin_date}</td>
                                    <td>
                                        <button class="btn btn-danger" onclick="deleteAssignment(${a.id})" style="padding: 6px 12px; font-size: 12px;">KaldÄ±r</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('assignments-list').innerHTML = `
                    <div class="alert alert-error">EÅŸleÅŸtirmeler yÃ¼klenirken hata oluÅŸtu: ${error.message}</div>
                `;
            }
        }

        // Resize image to optimal size for avatar
        function resizeImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions while maintaining aspect ratio
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to base64
                        const resizedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(resizedDataUrl);
                    };
                    img.onerror = function() {
                        reject(new Error('Resim yÃ¼klenirken hata oluÅŸtu'));
                    };
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    reject(new Error('Dosya okunurken hata oluÅŸtu'));
                };
                reader.readAsDataURL(file);
            });
        }

        // Avatar handling functions
        async function handleAssistantAvatarChange(event) {
            const file = event.target.files[0];
            console.log('ðŸ“¸ Avatar file selected:', file ? file.name : 'none');
            
            if (file) {
                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert('LÃ¼tfen bir resim dosyasÄ± seÃ§in.');
                    event.target.value = ''; // Clear selection
                    return;
                }
                
                const preview = document.getElementById('assistant-avatar-preview');
                const avatarDataInput = document.getElementById('assistant-avatar-data');
                
                if (!preview || !avatarDataInput) {
                    console.error('âŒ Avatar preview or data input not found');
                    return;
                }
                
                // Show loading state
                preview.innerHTML = '<span style="font-size: 14px;">YÃ¼kleniyor...</span>';
                
                try {
                    // Resize image to 400x400 max (avatar size) with 0.9 quality
                    const originalSize = (file.size / 1024 / 1024).toFixed(2);
                    console.log('ðŸ“¸ Original file size:', originalSize, 'MB');
                    
                    const resizedData = await resizeImage(file, 400, 400, 0.9);
                    const resizedSize = (resizedData.length / 1024 / 1024).toFixed(2);
                    console.log('ðŸ“¸ Resized data size:', resizedSize, 'MB');
                    console.log('ðŸ“¸ Compression ratio:', ((1 - resizedData.length / (file.size * 1.33)) * 100).toFixed(1) + '%'); // base64 is ~33% larger
                    
                    preview.innerHTML = `<img src="${resizedData}" alt="Avatar">`;
                    avatarDataInput.value = resizedData;
                    
                    console.log('âœ… Avatar resized and saved to hidden input');
                } catch (error) {
                    console.error('âŒ Error processing avatar:', error);
                    alert('FotoÄŸraf iÅŸlenirken bir hata oluÅŸtu: ' + error.message);
                    preview.innerHTML = '<i data-lucide="user" class="icon icon-xl"></i>';
                    event.target.value = ''; // Clear selection
                }
            } else {
                console.log('âš ï¸ No file selected');
            }
        }

        async function handleTeamAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert('LÃ¼tfen bir resim dosyasÄ± seÃ§in.');
                    event.target.value = ''; // Clear selection
                    return;
                }
                
                    const preview = document.getElementById('team-avatar-preview');
                const avatarDataInput = document.getElementById('team-avatar-data');
                
                if (!preview || !avatarDataInput) {
                    console.error('âŒ Team avatar preview or data input not found');
                    return;
                }
                
                // Show loading state
                preview.innerHTML = '<span style="font-size: 14px;">YÃ¼kleniyor...</span>';
                
                try {
                    // Resize image to 400x400 max (avatar size) with 0.9 quality
                    const originalSize = (file.size / 1024 / 1024).toFixed(2);
                    console.log('ðŸ“¸ Team avatar - Original file size:', originalSize, 'MB');
                    
                    const resizedData = await resizeImage(file, 400, 400, 0.9);
                    const resizedSize = (resizedData.length / 1024 / 1024).toFixed(2);
                    console.log('ðŸ“¸ Team avatar - Resized data size:', resizedSize, 'MB');
                    console.log('ðŸ“¸ Team avatar - Compression ratio:', ((1 - resizedData.length / (file.size * 1.33)) * 100).toFixed(1) + '%');
                    
                    preview.innerHTML = `<img src="${resizedData}" alt="Avatar">`;
                    avatarDataInput.value = resizedData;
                    
                    console.log('âœ… Team avatar resized and saved to hidden input');
                } catch (error) {
                    console.error('âŒ Error processing team avatar:', error);
                    alert('FotoÄŸraf iÅŸlenirken bir hata oluÅŸtu: ' + error.message);
                    preview.innerHTML = '<span>ðŸ‘¥</span>';
                    event.target.value = ''; // Clear selection
                }
            }
        }

        // Assistant modal functions
        function openAssistantModal(id = null) {
            currentAssistantId = id;
            document.getElementById('assistant-modal-title').textContent = id ? 'Assistant DÃ¼zenle' : 'Yeni Assistant';
            document.getElementById('assistant-modal').classList.add('active');
            
            if (id) {
                fetch(`/api/assistants/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('assistant-name').value = data.name || '';
                        document.getElementById('assistant-surname').value = data.surname || '';
                        document.getElementById('assistant-email').value = data.email || '';
                        const preview = document.getElementById('assistant-avatar-preview');
                        if (data.avatar) {
                            preview.innerHTML = `<img src="${data.avatar}" alt="Avatar">`;
                            document.getElementById('assistant-avatar-data').value = data.avatar;
                        } else {
                            preview.innerHTML = '<i data-lucide="user" class="icon icon-xl"></i>';
                            document.getElementById('assistant-avatar-data').value = '';
                        }
                    });
            } else {
                document.getElementById('assistant-form').reset();
                document.getElementById('assistant-avatar-preview').innerHTML = '<span>ðŸ‘¤</span>';
                document.getElementById('assistant-avatar-data').value = '';
            }
        }

        function closeAssistantModal() {
            document.getElementById('assistant-modal').classList.remove('active');
            currentAssistantId = null;
        }

        async function saveAssistant(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ðŸ’¾ saveAssistant called');
            
            try {
                const nameInput = document.getElementById('assistant-name');
                const surnameInput = document.getElementById('assistant-surname');
                const emailInput = document.getElementById('assistant-email');
                const avatarDataInput = document.getElementById('assistant-avatar-data');
                
                if (!nameInput || !surnameInput || !avatarDataInput) {
                    console.error('âŒ Form elements not found');
                    showAlert('Form elemanlarÄ± bulunamadÄ±', 'error');
                    return;
                }
                
                const name = nameInput.value.trim();
                const surname = surnameInput.value.trim();
                
                if (!name) {
                    showAlert('Assistant adÄ± gereklidir', 'error');
                    return;
                }
                
                if (!surname) {
                    showAlert('Assistant soyadÄ± gereklidir', 'error');
                    return;
                }
                
                const avatarData = avatarDataInput.value || null;
            const data = {
                    name: name,
                    surname: surname,
                    email: emailInput ? (emailInput.value.trim() || null) : null,
                    avatar: avatarData || null
                };

                console.log('ðŸ’¾ Saving assistant:', { 
                    id: currentAssistantId,
                    name: data.name,
                    email: data.email,
                    avatar: avatarData ? `base64 (${avatarData.length} chars)` : 'null' 
                });

                const url = currentAssistantId 
                    ? `/api/assistants/${currentAssistantId}`
                    : '/api/assistants';
                const method = currentAssistantId ? 'PUT' : 'POST';

                console.log('ðŸ“¡ Sending request:', method, url);

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                console.log('ðŸ“¡ Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… Assistant saved successfully:', result);
                    closeAssistantModal();
                    loadAssistants();
                    showAlert('Assistant baÅŸarÄ±yla kaydedildi', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Error response:', response.status, errorText);
                    showAlert('Hata: ' + errorText, 'error');
                }
            } catch (error) {
                console.error('âŒ Exception in saveAssistant:', error);
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function deleteAssistant(id) {
            if (!confirm('Bu assistant\'Ä± silmek istediÄŸinize emin misiniz?')) return;

            try {
                const response = await fetch(`/api/assistants/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAssistants();
                    showAlert('Assistant silindi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function editAssistant(id) {
            openAssistantModal(id);
        }

        // Team modal functions
        async function openTeamModal(id = null) {
            currentTeamId = id;
            document.getElementById('team-modal-title').textContent = id ? 'TakÄ±m DÃ¼zenle' : 'Yeni TakÄ±m';
            document.getElementById('team-modal').classList.add('active');
            
            // Load assistants for checkboxes
            const assistantsRes = await fetch('/api/assistants');
            const assistants = await assistantsRes.json();
            
            let selectedAssistants = [];
            if (id) {
                const teamRes = await fetch(`/api/teams/${id}`);
                const team = await teamRes.json();
                document.getElementById('team-name').value = team.name;
                document.getElementById('team-description').value = team.description || '';
                const preview = document.getElementById('team-avatar-preview');
                if (team.avatar) {
                    preview.innerHTML = `<img src="${team.avatar}" alt="Avatar">`;
                    document.getElementById('team-avatar-data').value = team.avatar;
                } else {
                    preview.innerHTML = '<span>ðŸ‘¥</span>';
                    document.getElementById('team-avatar-data').value = '';
                }
                
                const teamAssistantsRes = await fetch(`/api/teams/${id}/assistants`);
                selectedAssistants = await teamAssistantsRes.json();
            } else {
                document.getElementById('team-form').reset();
                document.getElementById('team-avatar-preview').innerHTML = '<span>ðŸ‘¥</span>';
                document.getElementById('team-avatar-data').value = '';
            }

            const checkboxesEl = document.getElementById('team-assistants-checkboxes');
            checkboxesEl.innerHTML = assistants.map(a => `
                <div class="checkbox-item">
                    <input type="checkbox" id="assistant-${a.id}" value="${a.id}" 
                        ${selectedAssistants.some(sa => sa.id === a.id) ? 'checked' : ''}>
                    <label for="assistant-${a.id}">${a.name}</label>
                </div>
            `).join('');
        }

        function closeTeamModal() {
            document.getElementById('team-modal').classList.remove('active');
            currentTeamId = null;
        }

        async function saveTeam(e) {
            e.preventDefault();
            const selectedAssistants = Array.from(document.querySelectorAll('#team-assistants-checkboxes input:checked'))
                .map(cb => parseInt(cb.value));

            const data = {
                name: document.getElementById('team-name').value,
                description: document.getElementById('team-description').value || null,
                assistant_ids: selectedAssistants,
                avatar: document.getElementById('team-avatar-data').value || null
            };

            try {
                const url = currentTeamId 
                    ? `/api/teams/${currentTeamId}`
                    : '/api/teams';
                const method = currentTeamId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeTeamModal();
                    loadTeams();
                    showAlert('TakÄ±m baÅŸarÄ±yla kaydedildi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function deleteTeam(id) {
            if (!confirm('Bu takÄ±mÄ± silmek istediÄŸinize emin misiniz?')) return;

            try {
                const response = await fetch(`/api/teams/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadTeams();
                    showAlert('TakÄ±m silindi', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function editTeam(id) {
            openTeamModal(id);
        }

        // Generate guest unique ID (same algorithm as backend)
        async function generateGuestUniqueId(guestName, guestSurname, checkinDate, checkoutDate) {
            if (!checkinDate) {
                return null;
            }
            
            // Normalize function for Turkish locale and Unicode
            function normalizeText(text) {
                if (!text) return '';
                // Unicode normalization (NFC) - handles composed characters
                let normalized = text.normalize('NFC');
                // Turkish locale-aware lowercase conversion
                normalized = normalized.toLocaleLowerCase('tr-TR');
                // Replace multiple spaces with single space, then with underscore
                normalized = normalized.trim().replace(/\s+/g, '_');
                // Remove any remaining special characters except underscore
                normalized = normalized.replace(/[^a-z0-9_ÄŸÃ¼ÅŸÄ±Ã¶Ã§]/gi, '');
                return normalized;
            }
            
            // Normalize inputs - use 'Guest' if name is not provided
            const name = normalizeText(guestName || guestSurname || 'Guest');
            const surname = normalizeText(guestSurname || '');
            
            // Normalize dates
            let checkin = '';
            if (checkinDate instanceof Date) {
                checkin = checkinDate.toISOString().split('T')[0];
            } else if (checkinDate) {
                checkin = String(checkinDate).split('T')[0];
            }
            
            let checkout = '';
            if (checkoutDate instanceof Date) {
                checkout = checkoutDate.toISOString().split('T')[0];
            } else if (checkoutDate) {
                checkout = String(checkoutDate).split('T')[0];
            }
            
            // Create unique ID: name_surname_checkin_checkout (hash for uniqueness)
            const combined = checkout 
                ? `${name}_${surname}_${checkin}_${checkout}`
                : `${name}_${surname}_${checkin}`;
            
            // Use Web Crypto API to create SHA256 hash (same as backend)
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(combined);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
                
                return checkout 
                    ? `${name}_${surname}_${checkin}_${checkout}_${hash}`
                    : `${name}_${surname}_${checkin}_${hash}`;
            } catch (error) {
                console.error('Error generating hash:', error);
                // Fallback to simple hash if crypto API fails
                function simpleHash(str) {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        const char = str.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return Math.abs(hash).toString(16).substring(0, 16);
                }
                const hash = simpleHash(combined);
                return checkout 
                    ? `${name}_${surname}_${checkin}_${checkout}_${hash}`
                    : `${name}_${surname}_${checkin}_${hash}`;
            }
        }

        // Open assignment modal for specific room by guest_unique_id (or room_number + checkin_date)
        async function openAssignmentModalForRoomByGuestId(guestUniqueId, roomNumber = null, checkinDate = null) {
            console.log('ðŸ“‚ Opening assignment modal for guest_unique_id:', guestUniqueId, 'roomNumber:', roomNumber, 'checkinDate:', checkinDate);
            
            // Hide guest checkboxes, show room info
            document.getElementById('assignment-room-info').style.display = 'block';
            document.getElementById('assignment-guests-group').style.display = 'none';
            
            // Load room details - try by guest_unique_id first, then by room_number + checkin_date
            let room = null;
            let actualGuestUniqueId = guestUniqueId;
            
            try {
                const roomsUrl = '/api/rooms';
                const roomsRes = await fetch(roomsUrl);
                const rooms = await roomsRes.json();
                
                // If guestUniqueId is provided and not empty, try to find by it
                if (guestUniqueId && guestUniqueId.trim() !== '') {
                    room = rooms.find(r => r.guest_unique_id === guestUniqueId);
                    console.log('ðŸ” Searched by guest_unique_id:', guestUniqueId, 'Found:', !!room);
                }
                
                // If not found and we have room_number and checkin_date, try to find by them
                if (!room && roomNumber && checkinDate) {
                    room = rooms.find(r => r.room_number === roomNumber && r.checkin_date === checkinDate);
                    console.log('ðŸ” Searched by room_number + checkin_date:', roomNumber, checkinDate, 'Found:', !!room);
                }
            } catch (error) {
                console.error('Error loading room details:', error);
            }
            
            // If room not found, show error
            if (!room) {
                showAlert('Misafir bilgisi bulunamadÄ±', 'error');
                return;
            }
            
            // If room found but guest_unique_id is missing, generate it
            if (room && (!room.guest_unique_id || room.guest_unique_id.trim() === '')) {
                console.log('ðŸ”§ Room found but guest_unique_id is missing, generating...');
                if (room.guest_name && room.checkin_date && room.checkout_date) {
                    actualGuestUniqueId = await generateGuestUniqueId(
                        room.guest_name, 
                        room.guest_surname, 
                        room.checkin_date, 
                        room.checkout_date
                    );
                    console.log('âœ… Generated guest_unique_id:', actualGuestUniqueId);
                    
                    // Update room object
                    room.guest_unique_id = actualGuestUniqueId;
                    
                    // Note: guest_unique_id will be updated in backend when assignment is saved
                } else {
                    console.error('âŒ Cannot generate guest_unique_id: missing required info', {
                        guest_name: room.guest_name,
                        checkin_date: room.checkin_date,
                        checkout_date: room.checkout_date
                    });
                    showAlert('Misafir bilgisi eksik. Unique ID oluÅŸturulamadÄ±.', 'error');
                    return;
                }
            }
            
            // Store selected guest unique id
            const guestUniqueIdEl = document.getElementById('assignment-selected-guest-unique-id');
            if (guestUniqueIdEl) {
                guestUniqueIdEl.value = actualGuestUniqueId || room.guest_unique_id || '';
            }
            
            // Store room info for saveAssignment
            document.getElementById('assignment-selected-room-number').value = room.room_number || '';
            document.getElementById('assignment-selected-checkin-date').value = room.checkin_date || '';
            
            // Use room data
            const displayRoomNumber = room.room_number || 'HenÃ¼z atanmadÄ±';
            const displayGuestName = room.guest_name || '';
            const displayGuestSurname = room.guest_surname || '';
            const displayCheckinDate = room.checkin_date || '';
            const displayCheckoutDate = room.checkout_date || '';
            const displayUniqueId = actualGuestUniqueId || room.guest_unique_id || '';
            
                    // Show room info
                    const roomDetailsEl = document.getElementById('assignment-room-details');
                    roomDetailsEl.innerHTML = `
                <div><strong>Unique ID:</strong> ${displayUniqueId}</div>
                <div><strong>Oda No:</strong> ${displayRoomNumber}</div>
                <div><strong>Misafir:</strong> ${displayGuestName} ${displayGuestSurname}</div>
                <div><strong>Check-in:</strong> ${displayCheckinDate ? formatDate(displayCheckinDate) : '-'}</div>
                ${displayCheckoutDate ? `<div><strong>Check-out:</strong> ${formatDate(displayCheckoutDate)}</div>` : ''}
                        ${room.adult_count ? `<div><strong>YetiÅŸkin:</strong> ${room.adult_count}</div>` : ''}
                        ${room.child_count ? `<div><strong>Ã‡ocuk:</strong> ${room.child_count}</div>` : ''}
                        ${room.country ? `<div><strong>Ãœlke:</strong> ${room.country}</div>` : ''}
                        ${room.agency ? `<div><strong>Acente:</strong> ${room.agency}</div>` : ''}
                    `;
            
            // Hide dropdown, show team cards
            document.getElementById('assignment-team').style.display = 'none';
            document.getElementById('assignment-teams-cards').style.display = 'grid';
            
            // Load teams as cards
            await loadTeamsForAssignment();
            
            // Show modal
            document.getElementById('assignment-modal').classList.add('active');
        }

        // Open assignment modal for specific room (legacy function, kept for backward compatibility)
        async function openAssignmentModalForRoom(roomNumber, checkinDate, guestName = null, guestSurname = null) {
            console.log('ðŸ“‚ Opening assignment modal for room:', roomNumber, checkinDate, guestName, guestSurname);
            
            // Store selected room info
            document.getElementById('assignment-selected-room-number').value = roomNumber || '';
            document.getElementById('assignment-selected-checkin-date').value = checkinDate || '';
            
            // Hide guest checkboxes, show room info
            document.getElementById('assignment-room-info').style.display = 'block';
            document.getElementById('assignment-guests-group').style.display = 'none';
            
            // Load room details if room_number exists, otherwise use provided guest info
            let room = null;
            if (roomNumber && checkinDate) {
                try {
                    const roomsUrl = `/api/rooms?start_date=${checkinDate}&end_date=${checkinDate}`;
                    const roomsRes = await fetch(roomsUrl);
                    const rooms = await roomsRes.json();
                    room = rooms.find(r => r.room_number === roomNumber && r.checkin_date === checkinDate);
            } catch (error) {
                console.error('Error loading room details:', error);
                }
            }
            
            // Use room data if available, otherwise use provided guest info
            const displayRoomNumber = room?.room_number || roomNumber || 'HenÃ¼z atanmadÄ±';
            const displayGuestName = room?.guest_name || guestName || '';
            const displayGuestSurname = room?.guest_surname || guestSurname || '';
            const displayCheckinDate = room?.checkin_date || checkinDate || '';
            const displayCheckoutDate = room?.checkout_date || '';
            
            // Show room info
            const roomDetailsEl = document.getElementById('assignment-room-details');
            roomDetailsEl.innerHTML = `
                <div><strong>Oda No:</strong> ${displayRoomNumber}</div>
                <div><strong>Misafir:</strong> ${displayGuestName} ${displayGuestSurname}</div>
                <div><strong>Check-in:</strong> ${displayCheckinDate ? formatDate(displayCheckinDate) : '-'}</div>
                ${displayCheckoutDate ? `<div><strong>Check-out:</strong> ${formatDate(displayCheckoutDate)}</div>` : ''}
                ${room?.adult_count ? `<div><strong>YetiÅŸkin:</strong> ${room.adult_count}</div>` : ''}
                ${room?.child_count ? `<div><strong>Ã‡ocuk:</strong> ${room.child_count}</div>` : ''}
                ${room?.country ? `<div><strong>Ãœlke:</strong> ${room.country}</div>` : ''}
                ${room?.agency ? `<div><strong>Acente:</strong> ${room.agency}</div>` : ''}
            `;
            
            // Hide dropdown, show team cards
            document.getElementById('assignment-team').style.display = 'none';
            document.getElementById('assignment-teams-cards').style.display = 'grid';
            
            // Load teams as cards
            await loadTeamsForAssignment();
            
            // Open modal
            document.getElementById('assignment-modal').classList.add('active');
        }

        // Load teams as cards for selection
        async function loadTeamsForAssignment() {
            try {
                const teamsRes = await fetch('/api/teams');
                const teams = await teamsRes.json();
                
                const cardsContainer = document.getElementById('assignment-teams-cards');
                
                if (teams.length === 0) {
                    cardsContainer.innerHTML = '<div class="empty-state">HenÃ¼z takÄ±m oluÅŸturulmamÄ±ÅŸ</div>';
                    return;
                }
                
                cardsContainer.innerHTML = teams
                    .filter(t => t.is_active)
                    .map(team => `
                        <div class="team-card" onclick="selectTeamCard(${team.id})" data-team-id="${team.id}">
                            <div class="team-card-title">${team.name}</div>
                            ${team.description ? `<div class="team-card-description">${team.description}</div>` : '<div class="team-card-description" style="color: #999; font-style: italic;">AÃ§Ä±klama yok</div>'}
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Error loading teams:', error);
                document.getElementById('assignment-teams-cards').innerHTML = 
                    '<div class="alert alert-error">TakÄ±mlar yÃ¼klenirken hata oluÅŸtu</div>';
            }
        }

        // Select team card
        function selectTeamCard(teamId) {
            console.log('ðŸŽ´ selectTeamCard called with teamId:', teamId);
            
            // Remove previous selection
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select clicked card
            const card = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
            if (card) {
                card.classList.add('selected');
                console.log('âœ… Team card selected:', teamId);
                
                // Also update the hidden select element (for compatibility)
                const teamSelect = document.getElementById('assignment-team');
                if (teamSelect) {
                    teamSelect.value = teamId;
                    console.log('âœ… Team select value updated:', teamId);
                }
            } else {
                console.error('âŒ Team card not found for teamId:', teamId);
            }
        }

        // Assignment modal functions (for multi-room assignment)
        async function openAssignmentModal() {
            console.log('ðŸ“‚ Opening assignment modal (multi-room)');
            document.getElementById('assignment-modal').classList.add('active');
            
            // Hide room info, show guest checkboxes
            document.getElementById('assignment-room-info').style.display = 'none';
            document.getElementById('assignment-guests-group').style.display = 'block';
            
            // Clear selected room
            document.getElementById('assignment-selected-room-number').value = '';
            const guestUniqueIdEl = document.getElementById('assignment-selected-guest-unique-id');
            if (guestUniqueIdEl) {
                guestUniqueIdEl.value = '';
            }
            document.getElementById('assignment-selected-checkin-date').value = '';
            
            // Hide team cards, show dropdown
            document.getElementById('assignment-teams-cards').style.display = 'none';
            document.getElementById('assignment-team').style.display = 'block';
            
            // Load teams
            console.log('ðŸ‘¥ Loading teams...');
            const teamsRes = await fetch('/api/teams');
            console.log('ðŸ‘¥ Teams response status:', teamsRes.status);
            const teams = await teamsRes.json();
            console.log('ðŸ‘¥ Teams loaded:', teams.length, teams);
            
            const teamSelect = document.getElementById('assignment-team');
            teamSelect.style.display = 'block';
            teamSelect.innerHTML = '<option value="">TakÄ±m SeÃ§in</option>' + 
                teams.filter(t => t.is_active).map(t => `<option value="${t.id}">${t.name}</option>`).join('');

            // Load guests (rooms) - next 10 days
            const today = new Date();
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 10);
            const startDateStr = today.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            console.log('ðŸ¨ Loading rooms from', startDateStr, 'to', endDateStr);
            const roomsUrl = `/api/rooms?start_date=${startDateStr}&end_date=${endDateStr}`;
            console.log('ðŸ”— Rooms URL:', roomsUrl);
            
            const roomsRes = await fetch(roomsUrl);
            console.log('ðŸ¨ Rooms response status:', roomsRes.status);
            
            if (!roomsRes.ok) {
                const errorText = await roomsRes.text();
                console.error('âŒ Error loading rooms:', errorText);
                document.getElementById('assignment-guests-checkboxes').innerHTML = 
                    `<div class="alert alert-error">Odalar yÃ¼klenirken hata: ${errorText}</div>`;
                return;
            }
            
            const rooms = await roomsRes.json();
            console.log('ðŸ¨ Rooms loaded:', rooms.length, rooms);
            
            const guestsEl = document.getElementById('assignment-guests-checkboxes');
            
            if (rooms.length === 0) {
                console.log('â„¹ï¸ No rooms found for next 10 days');
                guestsEl.innerHTML = '<div class="empty-state">Ã–nÃ¼mÃ¼zdeki 10 gÃ¼n iÃ§in check-in bulunamadÄ±</div>';
                return;
            }
            
            guestsEl.innerHTML = rooms.map(r => {
                const guestInfo = `${r.guest_name || 'Misafir'} ${r.guest_surname || ''}`.trim();
                const guestDetails = [
                    guestInfo || 'Ä°simsiz',
                    r.adult_count ? `${r.adult_count} YetiÅŸkin` : '',
                    r.child_count ? `${r.child_count} Ã‡ocuk` : '',
                    r.country || '',
                    r.agency || ''
                ].filter(Boolean).join(' â€¢ ');
                
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" id="guest-${r.room_number}-${r.checkin_date}" 
                            value="${r.room_number}|${r.checkin_date}">
                        <label for="guest-${r.room_number}-${r.checkin_date}" style="flex: 1;">
                            <strong>Oda ${r.room_number}</strong> - ${guestDetails}
                            <br><small style="color: #667781;">Check-in: ${r.checkin_date || 'Tarih yok'}</small>
                        </label>
                    </div>
                `;
            }).join('');
        }

        function closeAssignmentModal() {
            document.getElementById('assignment-modal').classList.remove('active');
            document.getElementById('assignment-form').reset();
            // Reset UI elements
            document.getElementById('assignment-room-info').style.display = 'none';
            document.getElementById('assignment-guests-group').style.display = 'none';
            document.getElementById('assignment-teams-cards').style.display = 'grid';
            document.getElementById('assignment-team').style.display = 'none';
            // Clear selections
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        async function saveAssignment(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ðŸ’¾ saveAssignment called');
            
            // Get team ID from either select dropdown or selected card
            let teamId = null;
            
            // First try to get from select dropdown (multi-room assignment)
            const teamSelect = document.getElementById('assignment-team');
            if (teamSelect && teamSelect.value) {
                teamId = parseInt(teamSelect.value);
                console.log('ðŸ“‹ Team ID from select:', teamId);
            }
            
            // If no team from select, try to get from selected card (single room assignment)
            if (!teamId) {
                const selectedCard = document.querySelector('.team-card.selected');
                if (selectedCard) {
                    teamId = parseInt(selectedCard.getAttribute('data-team-id'));
                    console.log('ðŸŽ´ Team ID from selected card:', teamId);
                }
            }
            
            if (!teamId || isNaN(teamId)) {
                console.error('âŒ No team selected');
                showAlert('LÃ¼tfen bir takÄ±m seÃ§in', 'error');
                return;
            }
            
            // Check if single room assignment
            const selectedRoomNumber = document.getElementById('assignment-selected-room-number').value;
            const selectedCheckinDate = document.getElementById('assignment-selected-checkin-date').value;
            const selectedGuestUniqueId = document.getElementById('assignment-selected-guest-unique-id')?.value || '';
            
            let selectedGuests = [];
            
            if (selectedGuestUniqueId) {
                // Single room assignment by guest_unique_id
                console.log('ðŸ¨ Single room assignment by guest_unique_id:', selectedGuestUniqueId);
                
                // Load room data - try by guest_unique_id first, then by room_number + checkin_date
                let room = null;
                try {
                    const roomsUrl = '/api/rooms';
                    const roomsRes = await fetch(roomsUrl);
                    const rooms = await roomsRes.json();
                    
                    // Try to find by guest_unique_id first
                    room = rooms.find(r => r.guest_unique_id === selectedGuestUniqueId);
                    
                    // If not found, try to find by room_number + checkin_date (in case guest_unique_id not yet updated in backend)
                    if (!room && selectedRoomNumber && selectedCheckinDate) {
                        room = rooms.find(r => r.room_number === selectedRoomNumber && r.checkin_date === selectedCheckinDate);
                        console.log('ðŸ” Room not found by guest_unique_id, trying room_number + checkin_date:', !!room);
                    }
                } catch (error) {
                    console.error('Error loading room by guest_unique_id:', error);
                }
                
                if (room) {
                selectedGuests = [{ 
                        guest_unique_id: selectedGuestUniqueId,
                        room_number: room.room_number || selectedRoomNumber || null, 
                        checkin_date: room.checkin_date || selectedCheckinDate || null,
                        checkout_date: room.checkout_date || null,
                        guest_name: room.guest_name || '',
                        guest_surname: room.guest_surname || ''
                    }];
                    console.log('âœ… Selected guest data:', selectedGuests[0]);
                } else {
                    showAlert('Misafir bilgisi bulunamadÄ±', 'error');
                    return;
                }
            } else if (selectedRoomNumber && selectedCheckinDate) {
                // Single room assignment - get guest info from room details (legacy)
                console.log('ðŸ¨ Single room assignment:', selectedRoomNumber, selectedCheckinDate);
                
                // Get guest info from room details element
                const roomDetailsEl = document.getElementById('assignment-room-details');
                let guestName = '';
                let guestSurname = '';
                
                // Try to extract guest name from room details
                if (roomDetailsEl) {
                    const guestText = roomDetailsEl.textContent;
                    const guestMatch = guestText.match(/Misafir:\s*([^\n]+)/);
                    if (guestMatch) {
                        const fullName = guestMatch[1].trim();
                        const nameParts = fullName.split(' ');
                        guestName = nameParts[0] || '';
                        guestSurname = nameParts.slice(1).join(' ') || '';
                    }
                }
                
                // If room details not available, try to get from room data
                if (!guestName && selectedRoomNumber) {
                    try {
                        const roomsUrl = `/api/rooms?start_date=${selectedCheckinDate}&end_date=${selectedCheckinDate}`;
                        const roomsRes = await fetch(roomsUrl);
                        const rooms = await roomsRes.json();
                        const room = rooms.find(r => r.room_number === selectedRoomNumber && r.checkin_date === selectedCheckinDate);
                        if (room) {
                            guestName = room.guest_name || '';
                            guestSurname = room.guest_surname || '';
                        }
                    } catch (error) {
                        console.error('Error loading room for guest info:', error);
                    }
                }
                
                selectedGuests = [{ 
                    room_number: selectedRoomNumber || null, 
                    checkin_date: selectedCheckinDate || null,
                    guest_name: guestName,
                    guest_surname: guestSurname
                }];
            } else {
                // Multi-room assignment (from checkboxes)
                const checkedBoxes = document.querySelectorAll('#assignment-guests-checkboxes input:checked');
                console.log('ðŸ“‹ Multi-room assignment, checked boxes:', checkedBoxes.length);
                
                selectedGuests = Array.from(checkedBoxes)
                    .map(cb => {
                        const [roomNumber, date] = cb.value.split('|');
                        if (!date) {
                            throw new Error('Misafir seÃ§iminde check-in tarihi bulunamadÄ±');
                        }
                        return { room_number: roomNumber, checkin_date: date };
                    });
                
                if (selectedGuests.length === 0) {
                    showAlert('LÃ¼tfen en az bir misafir seÃ§in', 'error');
                    return;
                }
            }
            
            console.log('ðŸ’¾ Saving assignment:', { teamId, selectedGuests });

            try {
                const requestBody = {
                    team_id: teamId,
                    assignments: selectedGuests
                };
                
                console.log('ðŸ“¡ Sending request to /api/team-assignments:', requestBody);
                
                const response = await fetch('/api/team-assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('ðŸ“¡ Response status:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… Assignment saved successfully:', result);
                    closeAssignmentModal();
                    
                    // Wait a bit for backend to update room table
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Reload both lists
                    await Promise.all([
                        loadAssignments(),
                        loadUnassignedRooms()
                    ]);
                    
                    showAlert('EÅŸleÅŸtirme baÅŸarÄ±yla yapÄ±ldÄ±', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Error response:', response.status, errorText);
                    showAlert('Hata: ' + errorText, 'error');
                }
            } catch (error) {
                console.error('âŒ Exception in saveAssignment:', error);
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        async function deleteAssignment(id) {
            if (!confirm('Bu eÅŸleÅŸtirmeyi kaldÄ±rmak istediÄŸinize emin misiniz?')) return;

            try {
                const response = await fetch(`/api/team-assignments/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAssignments();
                    showAlert('EÅŸleÅŸtirme kaldÄ±rÄ±ldÄ±', 'success');
                } else {
                    showAlert('Hata: ' + (await response.text()), 'error');
                }
            } catch (error) {
                showAlert('Hata: ' + error.message, 'error');
            }
        }

        // Load all rooms for selected date (not just assignments)
        async function loadAllRoomsForDate() {
            try {
                const dateFilter = document.getElementById('checkin-date-filter').value;
                if (!dateFilter) {
                    showAlert('LÃ¼tfen bir tarih seÃ§in', 'error');
                    return;
                }
                
                console.log('ðŸ¨ Loading all rooms for date:', dateFilter);
                const url = `/api/rooms?start_date=${dateFilter}&end_date=${dateFilter}`;
                console.log('ðŸ”— Fetching from URL:', url);
                
                const response = await fetch(url);
                console.log('ðŸ“¡ Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API Error:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const rooms = await response.json();
                console.log('âœ… Rooms received:', rooms.length, rooms);
                
                const listEl = document.getElementById('assignments-list');
                if (rooms.length === 0) {
                    console.log('â„¹ï¸ No rooms found for date:', dateFilter);
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"><i data-lucide="building-2" class="icon icon-xl"></i></div>
                            <p>${dateFilter} tarihi iÃ§in check-in bulunamadÄ±</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="openAssignmentModal()">+ Yeni EÅŸleÅŸtirme</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Oda No</th>
                                <th>Avatar</th>
                                <th>Misafir</th>
                                <th>Check-in Tarihi</th>
                                <th>YetiÅŸkin</th>
                                <th>Ã‡ocuk</th>
                                <th>Ãœlke</th>
                                <th>Acente</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rooms.map(r => `
                                <tr>
                                    <td>${r.room_number}</td>
                                    <td>
                                        ${r.profile_photo ? `
                                            <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                        ` : `
                                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                        `}
                                    </td>
                                    <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                    <td>${r.checkin_date || '-'}</td>
                                    <td>${r.adult_count || '-'}</td>
                                    <td>${r.child_count || '-'}</td>
                                    <td>${r.country || '-'}</td>
                                    <td>${r.agency || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading rooms:', error);
                document.getElementById('assignments-list').innerHTML = `
                    <div class="alert alert-error">Odalar yÃ¼klenirken hata oluÅŸtu: ${error.message}</div>
                `;
            }
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alert.textContent = message;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.tabs'));
            setTimeout(() => alert.remove(), 3000);
        }

        // Format date to DD.MM.YYYY
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            } catch (e) {
                return dateStr;
            }
        }

        // Load unassigned rooms
        async function loadUnassignedRooms() {
            try {
                const dateFilter = document.getElementById('unassigned-date-filter').value;
                console.log('âš ï¸ Loading unassigned rooms with filter:', dateFilter || 'all dates');
                
                const listEl = document.getElementById('unassigned-list');
                listEl.innerHTML = '<div class="loading">YÃ¼kleniyor...</div>';
                
                // Load all assignments to find which rooms are assigned
                const assignmentsResponse = await fetch('/api/team-assignments');
                if (!assignmentsResponse.ok) {
                    throw new Error(`Failed to load assignments: ${assignmentsResponse.status}`);
                }
                const assignments = await assignmentsResponse.json();
                console.log('âœ… Assignments loaded:', assignments.length);
                
                // Create sets of assigned room keys (room_number + checkin_date) and guest_unique_ids
                const assignedKeys = new Set(
                    assignments.filter(a => a.room_number && a.checkin_date)
                        .map(a => `${a.room_number}_${a.checkin_date}`)
                );
                const assignedGuestIds = new Set(
                    assignments.filter(a => a.guest_unique_id)
                        .map(a => a.guest_unique_id)
                );
                console.log('ðŸ”‘ Assigned room keys:', Array.from(assignedKeys).slice(0, 10), '...');
                console.log('ðŸ”‘ Assigned guest IDs:', Array.from(assignedGuestIds).slice(0, 10), '...');
                
                // Load all rooms (next 30 days or filtered date)
                let roomsUrl = '/api/rooms';
                if (dateFilter) {
                    roomsUrl = `/api/rooms?start_date=${dateFilter}&end_date=${dateFilter}`;
                } else {
                    // Load next 30 days
                    const today = new Date();
                    const endDate = new Date(today);
                    endDate.setDate(today.getDate() + 30);
                    const startDateStr = today.toISOString().split('T')[0];
                    const endDateStr = endDate.toISOString().split('T')[0];
                    roomsUrl = `/api/rooms?start_date=${startDateStr}&end_date=${endDateStr}`;
                }
                
                console.log('ðŸ¨ Fetching rooms from:', roomsUrl);
                const roomsResponse = await fetch(roomsUrl);
                if (!roomsResponse.ok) {
                    throw new Error(`Failed to load rooms: ${roomsResponse.status}`);
                }
                const rooms = await roomsResponse.json();
                console.log('ðŸ¨ Total rooms found:', rooms.length);
                
                // Filter unassigned rooms (by room_number+checkin_date OR guest_unique_id)
                const unassignedRooms = rooms.filter(r => {
                    const roomKey = r.room_number && r.checkin_date ? `${r.room_number}_${r.checkin_date}` : null;
                    const isAssignedByRoom = roomKey && assignedKeys.has(roomKey);
                    const isAssignedByGuest = r.guest_unique_id && assignedGuestIds.has(r.guest_unique_id);
                    return !isAssignedByRoom && !isAssignedByGuest;
                });
                
                console.log('âš ï¸ Unassigned rooms:', unassignedRooms.length);
                
                if (unassignedRooms.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âœ…</div>
                            <p>${dateFilter ? dateFilter + ' tarihi iÃ§in' : 'TÃ¼m'} eÅŸleÅŸmemiÅŸ oda bulunamadÄ±. TÃ¼m odalar eÅŸleÅŸtirilmiÅŸ!</p>
                        </div>
                    `;
                    return;
                }
                
                // Group by date for better organization
                const roomsByDate = {};
                unassignedRooms.forEach(r => {
                    const date = r.checkin_date || 'Tarih Yok';
                    if (!roomsByDate[date]) {
                        roomsByDate[date] = [];
                    }
                    roomsByDate[date].push(r);
                });
                
                const sortedDates = Object.keys(roomsByDate).sort();
                
                let html = `
                    <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <strong>âš ï¸ Toplam ${unassignedRooms.length} eÅŸleÅŸmemiÅŸ oda bulundu</strong>
                    </div>
                `;
                
                sortedDates.forEach(date => {
                    const dateRooms = roomsByDate[date];
                    html += `
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 12px; color: #ff9800; font-size: 16px; padding: 8px; background: white; border-radius: 6px;">
                                ðŸ“… ${formatDate(date)} - ${dateRooms.length} Oda
                            </h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Unique ID</th>
                                        <th>Avatar</th>
                                        <th>Misafir</th>
                                        <th>Check-in Tarihi</th>
                                        <th>Check-out Tarihi</th>
                                        <th>YetiÅŸkin</th>
                                        <th>Ã‡ocuk</th>
                                        <th>Ãœlke</th>
                                        <th>Acente</th>
                                        <th>Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dateRooms.map(r => `
                                        <tr style="background: white; cursor: pointer;" onclick="openAssignmentModalForRoomByGuestId('${r.guest_unique_id || ''}', '${r.room_number || ''}', '${r.checkin_date || ''}')">
                                            <td style="font-family: monospace; font-size: 11px;"><strong>${r.guest_unique_id || '-'}</strong></td>
                                            <td>
                                                ${r.profile_photo ? `
                                                    <img src="${r.profile_photo}" alt="${r.guest_name || 'Misafir'}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--voyage-navy);">
                                                ` : `
                                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--voyage-light-blue); display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid var(--voyage-navy);"><i data-lucide="building-2" class="icon icon-lg"></i></div>
                                                `}
                                            </td>
                                            <td>${r.guest_name || '-'} ${r.guest_surname || ''}</td>
                                            <td>${formatDate(r.checkin_date)}</td>
                                            <td>${formatDate(r.checkout_date)}</td>
                                            <td>${r.adult_count || '-'}</td>
                                            <td>${r.child_count || '-'}</td>
                                            <td>${r.country || '-'}</td>
                                            <td>${r.agency || '-'}</td>
                                            <td>
                                                <button class="btn btn-primary" onclick="event.stopPropagation(); openAssignmentModalForRoomByGuestId('${r.guest_unique_id || ''}', '${r.room_number || ''}', '${r.checkin_date || ''}')" style="padding: 6px 12px; font-size: 12px;">EÅŸleÅŸtir</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                listEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading unassigned rooms:', error);
                document.getElementById('unassigned-list').innerHTML = `
                    <div class="alert alert-error">EÅŸleÅŸmemiÅŸ odalar yÃ¼klenirken hata oluÅŸtu: ${error.message}</div>
                `;
            }
        }


        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alert.textContent = message;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.tabs'));
            setTimeout(() => alert.remove(), 3000);
        }

        // ============================================
        // Activities Management
        // ============================================

        async function loadActivities() {
            try {
                const response = await fetch('/api/admin/story-tray-items', {
                    credentials: 'include'
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to load activities' }));
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to load activities`);
                }
                const activities = await response.json();
                
                const listEl = document.getElementById('activities-list');
                if (activities.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>HenÃ¼z hikaye eklenmemiÅŸ</p>
                        </div>
                    `;
                    return;
                }
                
                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>BaÅŸlÄ±k</th>
                                <th>Ä°kon</th>
                                <th>Foto/Video</th>
                                <th>SÄ±ra</th>
                                <th>Durum</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities.map(a => `
                                <tr>
                                    <td><strong>${a.title || '-'}</strong></td>
                                    <td>${a.icon || '-'}</td>
                                    <td>
                                        ${a.image_url ? `<img src="${a.image_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" alt="Image">` : ''}
                                        ${a.video_url ? `<video src="${a.video_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" controls></video>` : ''}
                                        ${!a.image_url && !a.video_url ? '<span style="color: #999;">Yok</span>' : ''}
                                    </td>
                                    <td>${a.display_order || 0}</td>
                                    <td>${a.is_active ? '<span style="color: green;">âœ“ Aktif</span>' : '<span style="color: red;">âœ— Pasif</span>'}</td>
                                    <td>
                                        <button class="btn btn-primary" onclick="openActivityUploadModal(${a.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">ðŸ“· Foto/Video Ekle</button>
                                        <button class="btn btn-primary" onclick="editActivity(${a.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">DÃ¼zenle</button>
                                        <button class="btn btn-danger" onclick="deleteActivity(${a.id})" style="padding: 6px 12px; font-size: 12px;">Sil</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading activities:', error);
                document.getElementById('activities-list').innerHTML = `
                    <div class="alert alert-error">Hikayeler yÃ¼klenirken hata oluÅŸtu: ${error.message}</div>
                `;
            }
        }

        function openActivityModal(id = null) {
            currentActivityId = id;
            document.getElementById('activity-modal-title').textContent = id ? 'Hikaye DÃ¼zenle' : 'Yeni Hikaye';
            document.getElementById('activity-modal').classList.add('active');
            
            if (id) {
                fetch(`/api/admin/story-tray-items/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('activity-title').value = data.title || '';
                        document.getElementById('activity-icon').value = data.icon || '';
                        // Story tray items only have: title, icon, image_url, video_url, display_order, is_active
                        const imageUrlEl = document.getElementById('activity-image-url');
                        const videoUrlEl = document.getElementById('activity-video-url');
                        if (imageUrlEl) imageUrlEl.value = data.image_url || '';
                        if (videoUrlEl) videoUrlEl.value = data.video_url || '';
                        document.getElementById('activity-display-order').value = data.display_order || 0;
                        document.getElementById('activity-is-active').checked = data.is_active !== false;
                    });
            } else {
                document.getElementById('activity-form').reset();
                document.getElementById('activity-display-order').value = 0;
                document.getElementById('activity-is-active').checked = true;
            }
        }

        function closeActivityModal() {
            document.getElementById('activity-modal').classList.remove('active');
            currentActivityId = null;
        }

        async function saveActivity(e) {
            e.preventDefault();
            
            const title = document.getElementById('activity-title').value.trim();
            const icon = document.getElementById('activity-icon').value.trim();
            const activity_date = document.getElementById('activity-date').value || null;
            const start_time = document.getElementById('activity-start-time').value || null;
            const end_time = document.getElementById('activity-end-time').value || null;
            const category = document.getElementById('activity-category').value.trim() || null;
            const type = document.getElementById('activity-type').value.trim() || null;
            const location = document.getElementById('activity-location').value.trim() || null;
            const description = document.getElementById('activity-description').value.trim() || null;
            const instructor_name = document.getElementById('activity-instructor').value.trim() || null;
            const age_group = document.getElementById('activity-age-group').value.trim() || null;
            const capacityRaw = document.getElementById('activity-capacity').value;
            const capacity = capacityRaw === '' ? null : parseInt(capacityRaw, 10);
            const mapLatRaw = document.getElementById('activity-lat').value;
            const mapLngRaw = document.getElementById('activity-lng').value;
            const map_latitude = mapLatRaw === '' ? null : parseFloat(mapLatRaw);
            const map_longitude = mapLngRaw === '' ? null : parseFloat(mapLngRaw);
            const featured = document.getElementById('activity-featured').checked;
            const image_url_raw = document.getElementById('activity-image-url').value.trim();
            const video_url_raw = document.getElementById('activity-video-url').value.trim();
            const image_url = video_url_raw ? null : (image_url_raw || null);
            const video_url = video_url_raw || null;
            const display_order = parseInt(document.getElementById('activity-display-order').value) || 0;
            const is_active = document.getElementById('activity-is-active').checked;
            
            if (!title) {
                showAlert('BaÅŸlÄ±k gereklidir', 'error');
                return;
            }
            
            try {
                const url = currentActivityId 
                    ? `/api/admin/story-tray-items/${currentActivityId}`
                    : '/api/admin/story-tray-items';
                const method = currentActivityId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        title,
                        icon,
                        display_order,
                        is_active,
                        image_url,
                        video_url
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save activity');
                
                closeActivityModal();
                loadActivities();
                showAlert('Hikaye baÅŸarÄ±yla kaydedildi', 'success');
            } catch (error) {
                console.error('Error saving activity:', error);
                showAlert('Hikaye kaydedilirken hata oluÅŸtu', 'error');
            }
        }

        async function deleteActivity(id) {
            if (!confirm('Bu hikayeyi silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                const response = await fetch(`/api/admin/story-tray-items/${id}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to delete activity');
                
                loadActivities();
                showAlert('Hikaye silindi', 'success');
            } catch (error) {
                console.error('Error deleting activity:', error);
                showAlert('Hikaye silinirken hata oluÅŸtu', 'error');
            }
        }

        async function editActivity(id) {
            openActivityModal(id);
        }

        function openActivityUploadModal(activityId) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 500px;
                width: 100%;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">FotoÄŸraf veya Video YÃ¼kle</div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">FotoÄŸraf DosyasÄ±</label>
                    <input type="file" id="activity-image-file" accept="image/*" class="form-input" style="padding: 8px;">
                    <div style="font-size: 12px; color: #667781; margin-top: 4px;">veya</div>
                    <input type="text" id="activity-image-url" class="form-input" placeholder="FotoÄŸraf URL (opsiyonel)" style="margin-top: 8px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Video DosyasÄ±</label>
                    <input type="file" id="activity-video-file" accept="video/*" class="form-input" style="padding: 8px;">
                    <div style="font-size: 12px; color: #667781; margin-top: 4px;">veya</div>
                    <input type="text" id="activity-video-url" class="form-input" placeholder="Video URL (opsiyonel)" style="margin-top: 8px;">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="cancel-upload-btn" class="btn btn-secondary" style="flex: 1;">Ä°ptal</button>
                    <button id="upload-activity-btn" class="btn btn-primary" style="flex: 1;">YÃ¼kle</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            document.getElementById('cancel-upload-btn').onclick = () => modal.remove();
            document.getElementById('upload-activity-btn').onclick = async () => {
                const imageFile = document.getElementById('activity-image-file').files[0];
                const videoFile = document.getElementById('activity-video-file').files[0];
                const imageUrl = document.getElementById('activity-image-url').value.trim();
                const videoUrl = document.getElementById('activity-video-url').value.trim();
                
                if (!imageFile && !videoFile && !imageUrl && !videoUrl) {
                    alert('FotoÄŸraf veya video dosyasÄ±/URL\'si gerekli');
                    return;
                }
                
                try {
                    const formData = new FormData();
                    
                    // Add file if selected
                    if (imageFile) {
                        formData.append('file', imageFile);
                    } else if (videoFile) {
                        formData.append('file', videoFile);
                    }
                    
                    // Add URL if provided (as fallback or alternative)
                    if (imageUrl && !imageFile) {
                        formData.append('image_url', imageUrl);
                    }
                    if (videoUrl && !videoFile) {
                        formData.append('video_url', videoUrl);
                    }
                    
                    const response = await fetch(`/api/admin/story-tray-items/${activityId}/upload`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Failed to upload' }));
                        throw new Error(errorData.error || 'Failed to upload');
                    }
                    
                    modal.remove();
                    loadActivities();
                    showAlert('Medya baÅŸarÄ±yla yÃ¼klendi', 'success');
                } catch (error) {
                    console.error('Error uploading:', error);
                    alert('YÃ¼kleme baÅŸarÄ±sÄ±z: ' + error.message);
                }
            };
        }

        // ============================================
        // Posts Management
        // ============================================

        async function loadPosts() {
            try {
                const response = await fetch('/api/admin/info-posts', {
                    credentials: 'include'
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to load posts' }));
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to load posts`);
                }
                const posts = await response.json();
                
                const listEl = document.getElementById('posts-list');
                if (posts.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>HenÃ¼z post eklenmemiÅŸ</p>
                        </div>
                    `;
                    return;
                }
                
                listEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 24px;">
                        ${posts.map(p => {
                            const imageUrls = Array.isArray(p.image_url) ? p.image_url : (p.image_url ? [p.image_url] : []);
                            const videoUrls = Array.isArray(p.video_url) ? p.video_url : (p.video_url ? [p.video_url] : []);
                            const hasMedia = imageUrls.length > 0 || videoUrls.length > 0;
                            
                            return `
                            <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e4e6e9;">
                                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                                    ${hasMedia ? `
                                        <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 8px; min-width: 200px;">
                                            ${imageUrls.map((url, idx) => `
                                                <div style="position: relative; width: 120px; height: 120px; flex-shrink: 0;">
                                                    <img src="${url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #e4e6e9;" alt="Post Image ${idx + 1}">
                                                    <button onclick="removePostMedia(${p.id}, 'image', ${idx})" style="position: absolute; top: 4px; right: 4px; background: rgba(255,0,0,0.9); color: white; border: none; border-radius: 50%; width: 26px; height: 26px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,0,0,1)'" onmouseout="this.style.background='rgba(255,0,0,0.9)'" title="Sil">Ã—</button>
                                                </div>
                                            `).join('')}
                                            ${videoUrls.map((url, idx) => `
                                                <div style="position: relative; width: 120px; height: 120px; flex-shrink: 0;">
                                                    <video src="${url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #e4e6e9;" controls></video>
                                                    <button onclick="removePostMedia(${p.id}, 'video', ${idx})" style="position: absolute; top: 4px; right: 4px; background: rgba(255,0,0,0.9); color: white; border: none; border-radius: 50%; width: 26px; height: 26px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,0,0,1)'" onmouseout="this.style.background='rgba(255,0,0,0.9)'" title="Sil">Ã—</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div style="width: 120px; height: 120px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999;">
                                            FotoÄŸraf Yok
                                        </div>
                                    `}
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 8px 0; color: var(--voyage-navy);">${p.title || '-'}</h3>
                                        <p style="margin: 0 0 8px 0; color: #667781; font-size: 14px;"><strong>Post ID:</strong> ${p.post_id || '-'}</p>
                                        <p style="margin: 0 0 8px 0; color: #667781; font-size: 14px;"><strong>Lokasyon:</strong> ${p.location || '-'}</p>
                                        <p style="margin: 0 0 8px 0; color: #667781; font-size: 14px;"><strong>Ä°kon:</strong> ${p.icon || '-'}</p>
                                        ${p.caption ? `<p style="margin: 8px 0; color: #667781; font-size: 14px;">${p.caption}</p>` : ''}
                                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                                            <span style="padding: 4px 8px; background: ${p.is_active ? '#d4edda' : '#f8d7da'}; color: ${p.is_active ? '#155724' : '#721c24'}; border-radius: 4px; font-size: 12px;">
                                                ${p.is_active ? 'âœ“ Aktif' : 'âœ— Pasif'}
                                            </span>
                                            <span style="padding: 4px 8px; background: #e7f3ff; color: #0056b3; border-radius: 4px; font-size: 12px;">
                                                SÄ±ra: ${p.display_order || 0}
                                            </span>
                                            <span style="padding: 4px 8px; background: #fff3cd; color: #856404; border-radius: 4px; font-size: 12px;">
                                                â¤ï¸ ${p.likes_count || 0}
                                            </span>
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button class="btn btn-primary" onclick="editPost(${p.id})" style="padding: 8px 16px; font-size: 14px;">DÃ¼zenle</button>
                                        <button class="btn btn-danger" onclick="deletePost(${p.id})" style="padding: 8px 16px; font-size: 14px;">Sil</button>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid #e4e6e9; padding-top: 16px; margin-top: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--voyage-navy);">FotoÄŸraf/Video Ekle</label>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #667781;">FotoÄŸraf DosyasÄ±</label>
                                        <input type="file" id="post-image-file-${p.id}" accept="image/*" class="form-input" style="padding: 8px; margin-bottom: 4px;">
                                        <div style="font-size: 11px; color: #999; margin-bottom: 8px;">veya</div>
                                        <input type="text" id="post-image-url-${p.id}" class="form-input" placeholder="FotoÄŸraf URL (opsiyonel)" style="margin-bottom: 8px;">
                                        <button class="btn btn-primary" onclick="uploadPostMedia(${p.id}, 'image')" style="padding: 8px 16px; width: 100%;">ðŸ“· Foto YÃ¼kle</button>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #667781;">Video DosyasÄ±</label>
                                        <input type="file" id="post-video-file-${p.id}" accept="video/*" class="form-input" style="padding: 8px; margin-bottom: 4px;">
                                        <div style="font-size: 11px; color: #999; margin-bottom: 8px;">veya</div>
                                        <input type="text" id="post-video-url-${p.id}" class="form-input" placeholder="Video URL (opsiyonel)" style="margin-bottom: 8px;">
                                        <button class="btn btn-primary" onclick="uploadPostMedia(${p.id}, 'video')" style="padding: 8px 16px; width: 100%;">ðŸŽ¬ Video YÃ¼kle</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading posts:', error);
                document.getElementById('posts-list').innerHTML = `
                    <div class="alert alert-error">Postlar yÃ¼klenirken hata oluÅŸtu: ${error.message}</div>
                `;
            }
        }

        function addImageUrlInput() {
            const container = document.getElementById('post-image-urls-container');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-input post-image-url-input';
            input.placeholder = 'FotoÄŸraf URL (opsiyonel)';
            input.style.marginBottom = '4px';
            container.appendChild(input);
        }

        function addVideoUrlInput() {
            const container = document.getElementById('post-video-urls-container');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-input post-video-url-input';
            input.placeholder = 'Video URL (opsiyonel)';
            input.style.marginBottom = '4px';
            container.appendChild(input);
        }

        function openPostModal(id = null) {
            currentPostId = id;
            document.getElementById('post-modal-title').textContent = id ? 'Post DÃ¼zenle' : 'Yeni Post';
            document.getElementById('post-modal').classList.add('active');
            
            // Reset form
            document.getElementById('post-image-files').value = '';
            document.getElementById('post-video-files').value = '';
            document.getElementById('post-image-urls-container').innerHTML = '<input type="text" class="form-input post-image-url-input" placeholder="FotoÄŸraf URL (opsiyonel)" style="margin-bottom: 4px;">';
            document.getElementById('post-video-urls-container').innerHTML = '<input type="text" class="form-input post-video-url-input" placeholder="Video URL (opsiyonel)" style="margin-bottom: 4px;">';
            
            if (id) {
                fetch(`/api/admin/info-posts/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('post-post-id').value = data.post_id || '';
                        document.getElementById('post-post-id').disabled = true;
                        document.getElementById('post-title').value = data.title || '';
                        document.getElementById('post-icon').value = data.icon || '';
                        document.getElementById('post-location').value = data.location || '';
                        document.getElementById('post-caption').value = data.caption || '';
                        
                        // Handle arrays for images
                        const imageUrls = Array.isArray(data.image_url) ? data.image_url : (data.image_url ? [data.image_url] : []);
                        const imageContainer = document.getElementById('post-image-urls-container');
                        imageContainer.innerHTML = '';
                        imageUrls.forEach(url => {
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.className = 'form-input post-image-url-input';
                            input.placeholder = 'FotoÄŸraf URL (opsiyonel)';
                            input.value = url;
                            input.style.marginBottom = '4px';
                            imageContainer.appendChild(input);
                        });
                        if (imageUrls.length === 0) {
                            addImageUrlInput();
                        }
                        
                        // Handle arrays for videos
                        const videoUrls = Array.isArray(data.video_url) ? data.video_url : (data.video_url ? [data.video_url] : []);
                        const videoContainer = document.getElementById('post-video-urls-container');
                        videoContainer.innerHTML = '';
                        videoUrls.forEach(url => {
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.className = 'form-input post-video-url-input';
                            input.placeholder = 'Video URL (opsiyonel)';
                            input.value = url;
                            input.style.marginBottom = '4px';
                            videoContainer.appendChild(input);
                        });
                        if (videoUrls.length === 0) {
                            addVideoUrlInput();
                        }
                        
                        document.getElementById('post-display-order').value = data.display_order || 0;
                        document.getElementById('post-is-active').checked = data.is_active !== false;
                    });
            } else {
                document.getElementById('post-form').reset();
                document.getElementById('post-post-id').disabled = false;
                document.getElementById('post-display-order').value = 0;
                document.getElementById('post-is-active').checked = true;
            }
        }

        function closePostModal() {
            document.getElementById('post-modal').classList.remove('active');
            currentPostId = null;
        }

        async function savePost(e) {
            e.preventDefault();
            
            const post_id = document.getElementById('post-post-id').value.trim();
            const title = document.getElementById('post-title').value.trim();
            const icon = document.getElementById('post-icon').value.trim();
            const location = document.getElementById('post-location').value.trim();
            const caption = document.getElementById('post-caption').value.trim();
            const display_order = parseInt(document.getElementById('post-display-order').value) || 0;
            const is_active = document.getElementById('post-is-active').checked;
            
            if (!post_id || !title) {
                showAlert('Post ID ve baÅŸlÄ±k gereklidir', 'error');
                return;
            }
            
            try {
                // Collect image URLs from inputs
                const imageUrlInputs = document.querySelectorAll('.post-image-url-input');
                const imageUrls = Array.from(imageUrlInputs)
                    .map(input => input.value.trim())
                    .filter(url => url);
                
                // Collect video URLs from inputs
                const videoUrlInputs = document.querySelectorAll('.post-video-url-input');
                const videoUrls = Array.from(videoUrlInputs)
                    .map(input => input.value.trim())
                    .filter(url => url);
                
                // Upload image files first (get URLs)
                const imageFiles = document.getElementById('post-image-files').files;
                const uploadedImageUrls = [];
                for (let file of imageFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    // For new posts, upload to a temporary endpoint or use a generic upload
                    const uploadUrl = currentPostId 
                        ? `/api/admin/info-posts/${currentPostId}/upload`
                        : '/api/admin/upload'; // We'll need to create this or handle differently
                    
                    try {
                        if (currentPostId) {
                            const uploadResponse = await fetch(uploadUrl, {
                                method: 'POST',
                                credentials: 'include',
                                body: formData
                            });
                            if (uploadResponse.ok) {
                                const result = await uploadResponse.json();
                                if (result.image_url) {
                                    const urls = Array.isArray(result.image_url) ? result.image_url : [result.image_url];
                                    uploadedImageUrls.push(...urls);
                                }
                            }
                        } else {
                            // For new posts, we'll upload files after creating the post
                            // Store file for later upload
                            uploadedImageUrls.push(file);
                        }
                    } catch (e) {
                        console.warn('File upload failed, will use URL only:', e);
                    }
                }
                
                // Upload video files
                const videoFiles = document.getElementById('post-video-files').files;
                const uploadedVideoUrls = [];
                for (let file of videoFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    const uploadUrl = currentPostId 
                        ? `/api/admin/info-posts/${currentPostId}/upload`
                        : '/api/admin/upload';
                    
                    try {
                        if (currentPostId) {
                            const uploadResponse = await fetch(uploadUrl, {
                                method: 'POST',
                                credentials: 'include',
                                body: formData
                            });
                            if (uploadResponse.ok) {
                                const result = await uploadResponse.json();
                                if (result.video_url) {
                                    const urls = Array.isArray(result.video_url) ? result.video_url : [result.video_url];
                                    uploadedVideoUrls.push(...urls);
                                }
                            }
                        } else {
                            uploadedVideoUrls.push(file);
                        }
                    } catch (e) {
                        console.warn('File upload failed, will use URL only:', e);
                    }
                }
                
                // For new posts, create post first, then upload files
                let postId = currentPostId;
                if (!currentPostId) {
                    // Create post first with URLs only
                    const createResponse = await fetch('/api/admin/info-posts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ 
                            post_id, 
                            title, 
                            icon, 
                            location, 
                            caption, 
                            image_url: imageUrls.length > 0 ? imageUrls : null,
                            video_url: videoUrls.length > 0 ? videoUrls : null,
                            display_order, 
                            is_active 
                        })
                    });
                    
                    if (!createResponse.ok) {
                        const error = await createResponse.json();
                        throw new Error(error.error || 'Failed to create post');
                    }
                    
                    const createdPost = await createResponse.json();
                    postId = createdPost.id;
                    
                    // Now upload files to the newly created post
                    for (let file of imageFiles) {
                        const formData = new FormData();
                        formData.append('file', file);
                        try {
                            const uploadResponse = await fetch(`/api/admin/info-posts/${postId}/upload`, {
                                method: 'POST',
                                credentials: 'include',
                                body: formData
                            });
                            if (uploadResponse.ok) {
                                const result = await uploadResponse.json();
                                if (result.image_url) {
                                    const urls = Array.isArray(result.image_url) ? result.image_url : [result.image_url];
                                    uploadedImageUrls.push(...urls);
                                }
                            }
                        } catch (e) {
                            console.warn('File upload failed:', e);
                        }
                    }
                    
                    for (let file of videoFiles) {
                        const formData = new FormData();
                        formData.append('file', file);
                        try {
                            const uploadResponse = await fetch(`/api/admin/info-posts/${postId}/upload`, {
                                method: 'POST',
                                credentials: 'include',
                                body: formData
                            });
                            if (uploadResponse.ok) {
                                const result = await uploadResponse.json();
                                if (result.video_url) {
                                    const urls = Array.isArray(result.video_url) ? result.video_url : [result.video_url];
                                    uploadedVideoUrls.push(...urls);
                                }
                            }
                        } catch (e) {
                            console.warn('File upload failed:', e);
                        }
                    }
                    
                    // Update post with all URLs (uploaded + manual)
                    const allImageUrls = [...uploadedImageUrls.filter(url => typeof url === 'string'), ...imageUrls].filter((v, i, a) => a.indexOf(v) === i);
                    const allVideoUrls = [...uploadedVideoUrls.filter(url => typeof url === 'string'), ...videoUrls].filter((v, i, a) => a.indexOf(v) === i);
                    
                    if (allImageUrls.length > 0 || allVideoUrls.length > 0) {
                        await fetch(`/api/admin/info-posts/${postId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ 
                                image_url: allImageUrls.length > 0 ? allImageUrls : null,
                                video_url: allVideoUrls.length > 0 ? allVideoUrls : null
                            })
                        });
                    }
                } else {
                    // Update existing post
                    const allImageUrls = [...uploadedImageUrls.filter(url => typeof url === 'string'), ...imageUrls].filter((v, i, a) => a.indexOf(v) === i);
                    const allVideoUrls = [...uploadedVideoUrls.filter(url => typeof url === 'string'), ...videoUrls].filter((v, i, a) => a.indexOf(v) === i);
                    
                    const response = await fetch(`/api/admin/info-posts/${currentPostId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ 
                            post_id, 
                            title, 
                            icon, 
                            location, 
                            caption, 
                            image_url: allImageUrls.length > 0 ? allImageUrls : null,
                            video_url: allVideoUrls.length > 0 ? allVideoUrls : null,
                            display_order, 
                            is_active 
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to update post');
                    }
                }
                
                closePostModal();
                loadPosts();
                showAlert('Post baÅŸarÄ±yla kaydedildi', 'success');
            } catch (error) {
                console.error('Error saving post:', error);
                showAlert('Post kaydedilirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }

        async function deletePost(id) {
            if (!confirm('Bu postu silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                const response = await fetch(`/api/admin/info-posts/${id}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to delete post');
                
                loadPosts();
                showAlert('Post silindi', 'success');
            } catch (error) {
                console.error('Error deleting post:', error);
                showAlert('Post silinirken hata oluÅŸtu', 'error');
            }
        }

        async function editPost(id) {
            openPostModal(id);
        }

        async function removePostMedia(postId, type, index) {
            if (!confirm(`${type === 'image' ? 'FotoÄŸrafÄ±' : 'Videoyu'} silmek istediÄŸinize emin misiniz?`)) return;
            
            try {
                // Get current post data
                const response = await fetch(`/api/admin/info-posts/${postId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to fetch post');
                
                const post = await response.json();
                
                // Parse arrays (handle both JSON string and array)
                let imageUrls = [];
                if (post.image_url) {
                    if (Array.isArray(post.image_url)) {
                        imageUrls = [...post.image_url];
                    } else if (typeof post.image_url === 'string') {
                        try {
                            imageUrls = JSON.parse(post.image_url);
                        } catch (e) {
                            imageUrls = [post.image_url];
                        }
                    }
                }
                
                let videoUrls = [];
                if (post.video_url) {
                    if (Array.isArray(post.video_url)) {
                        videoUrls = [...post.video_url];
                    } else if (typeof post.video_url === 'string') {
                        try {
                            videoUrls = JSON.parse(post.video_url);
                        } catch (e) {
                            videoUrls = [post.video_url];
                        }
                    }
                }
                
                // Remove item from array
                if (type === 'image' && index < imageUrls.length) {
                    imageUrls.splice(index, 1);
                } else if (type === 'video' && index < videoUrls.length) {
                    videoUrls.splice(index, 1);
                }
                
                // Update post
                const updateResponse = await fetch(`/api/admin/info-posts/${postId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        image_url: imageUrls.length > 0 ? imageUrls : null,
                        video_url: videoUrls.length > 0 ? videoUrls : null
                    })
                });
                
                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.error || 'Failed to remove media');
                }
                
                loadPosts();
                showAlert(`${type === 'image' ? 'FotoÄŸraf' : 'Video'} baÅŸarÄ±yla silindi`, 'success');
            } catch (error) {
                console.error('Error removing media:', error);
                showAlert('Medya silinirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }

        async function uploadPostMedia(postId, type) {
            const imageFileInput = document.getElementById(`post-image-file-${postId}`);
            const videoFileInput = document.getElementById(`post-video-file-${postId}`);
            const imageUrlInput = document.getElementById(`post-image-url-${postId}`);
            const videoUrlInput = document.getElementById(`post-video-url-${postId}`);
            
            const imageFile = imageFileInput?.files[0];
            const videoFile = videoFileInput?.files[0];
            const imageUrl = imageUrlInput?.value.trim() || '';
            const videoUrl = videoUrlInput?.value.trim() || '';
            
            if (type === 'image' && !imageFile && !imageUrl) {
                alert('FotoÄŸraf dosyasÄ± veya URL gerekli');
                return;
            }
            
            if (type === 'video' && !videoFile && !videoUrl) {
                alert('Video dosyasÄ± veya URL gerekli');
                return;
            }
            
            try {
                const formData = new FormData();
                
                if (type === 'image') {
                    if (imageFile) {
                        formData.append('file', imageFile);
                    } else if (imageUrl) {
                        formData.append('image_url', imageUrl);
                    }
                } else if (type === 'video') {
                    if (videoFile) {
                        formData.append('file', videoFile);
                    } else if (videoUrl) {
                        formData.append('video_url', videoUrl);
                    }
                }
                
                const response = await fetch(`/api/admin/info-posts/${postId}/upload`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to upload' }));
                    throw new Error(errorData.error || 'Failed to upload');
                }
                
                // Clear inputs
                if (imageFileInput) imageFileInput.value = '';
                if (videoFileInput) videoFileInput.value = '';
                if (imageUrlInput) imageUrlInput.value = '';
                if (videoUrlInput) videoUrlInput.value = '';
                loadPosts();
                showAlert('FotoÄŸraf baÅŸarÄ±yla yÃ¼klendi', 'success');
            } catch (error) {
                console.error('Error uploading:', error);
                alert('YÃ¼kleme baÅŸarÄ±sÄ±z: ' + error.message);
            }
        }

        // Initialize
        // Initialize Lucide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check if required libraries are loaded
            if (typeof FullCalendar === 'undefined') {
                console.error('âŒ FullCalendar library not loaded');
            } else {
                console.log('âœ… FullCalendar library loaded');
            }
            // Check RRule availability once
            if (typeof RRule === 'undefined') {
                console.warn('âš ï¸ RRule library not loaded (optional - will use simple generation)');
                rruleAvailable = false;
            } else {
                console.log('âœ… RRule library loaded');
                rruleAvailable = true;
            }
            
            loadAssistants();
            
            // Ensure form submit handlers are attached
            const assistantForm = document.getElementById('assistant-form');
            if (assistantForm) {
                assistantForm.addEventListener('submit', saveAssistant);
                console.log('âœ… Assistant form submit handler attached');
            }
            
            const teamForm = document.getElementById('team-form');
            if (teamForm) {
                teamForm.addEventListener('submit', saveTeam);
                console.log('âœ… Team form submit handler attached');
            }
            
            const assignmentForm = document.getElementById('assignment-form');
            if (assignmentForm) {
                assignmentForm.addEventListener('submit', saveAssignment);
                console.log('âœ… Assignment form submit handler attached');
            }
            
            const activityForm = document.getElementById('activity-form');
            if (activityForm) {
                activityForm.addEventListener('submit', saveActivity);
                console.log('âœ… Activity form submit handler attached');
            }
            
            const postForm = document.getElementById('post-form');
            if (postForm) {
                postForm.addEventListener('submit', savePost);
                console.log('âœ… Post form submit handler attached');
            }
            
            const activityCalendarForm = document.getElementById('activity-calendar-form');
            if (activityCalendarForm) {
                activityCalendarForm.addEventListener('submit', saveActivityCalendar);
                console.log('âœ… Activity calendar form submit handler attached');
            }
        });

        // ============================================
        // Activities Calendar Management (FullCalendar)
        // ============================================

        let currentCalendarActivityId = null;
        let calendar = null;
        let activityFileToUpload = null;
        let rruleAvailable = null; // Cache RRule availability check

        // Initialize FullCalendar
        function initFullCalendar() {
            const calendarEl = document.getElementById('activities-fullcalendar');
            if (!calendarEl) {
                console.warn('âš ï¸ Calendar element not found');
                return;
            }

            // Check if FullCalendar is loaded
            if (typeof FullCalendar === 'undefined') {
                console.error('âŒ FullCalendar library not loaded. Waiting...');
                setTimeout(() => {
                    if (typeof FullCalendar !== 'undefined') {
                        initFullCalendar();
                    } else {
                        console.error('âŒ FullCalendar still not loaded after timeout');
                        calendarEl.innerHTML = '<div class="alert alert-error">FullCalendar kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.</div>';
                    }
                }, 500);
                return;
            }

            try {
                calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'tr',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                editable: true,
                droppable: false,
                selectable: true,
                dayMaxEvents: true,
                select: function(info) {
                    // Open modal when date is clicked
                    const dateStr = info.startStr.split('T')[0];
                    openActivityCalendarModal(dateStr);
                },
                eventClick: function(info) {
                    // Edit activity when clicked
                    const activityId = info.event.id;
                    editCalendarActivity(activityId);
                },
                eventDrop: async function(info) {
                    // Handle drag and drop
                    const activityId = info.event.id;
                    const newDate = info.event.start;
                    const newTime = info.event.startStr.includes('T') 
                        ? info.event.startStr.split('T')[1].substring(0, 5)
                        : null;
                    
                    try {
                        const response = await fetch(`/api/admin/activities/${activityId}/move`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                activity_date: newDate.toISOString().split('T')[0],
                                start_time: newTime
                            })
                        });
                        
                if (!response.ok) {
                            throw new Error('Failed to move activity');
                        }
                        
                        showAlert('Aktivite baÅŸarÄ±yla taÅŸÄ±ndÄ±', 'success');
                    } catch (error) {
                        console.error('Error moving activity:', error);
                        info.revert();
                        showAlert('Aktivite taÅŸÄ±nÄ±rken hata oluÅŸtu', 'error');
                    }
                },
                eventResize: async function(info) {
                    // Handle event resize (duration change)
                    const activityId = info.event.id;
                    const newEnd = info.event.end || info.event.start;
                    const endTime = info.event.endStr && info.event.endStr.includes('T')
                        ? info.event.endStr.split('T')[1].substring(0, 5)
                        : null;
                    
                    try {
                        const response = await fetch(`/api/admin/activities/${activityId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                end_time: endTime
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to update activity');
                        }
                        
                        showAlert('Aktivite baÅŸarÄ±yla gÃ¼ncellendi', 'success');
                    } catch (error) {
                        console.error('Error updating activity:', error);
                        info.revert();
                        showAlert('Aktivite gÃ¼ncellenirken hata oluÅŸtu', 'error');
                    }
                },
                eventContent: function(info) {
                    // Custom event rendering
                    const activity = info.event.extendedProps;
                    const hasMedia = activity.image_url || activity.video_url;
                    const isRecurring = activity.rrule || activity.recurring_rule;
                    
                    return {
                        html: `
                            <div style="padding: 2px 4px; font-size: 12px;">
                                ${isRecurring ? 'ðŸ”„ ' : ''}${hasMedia ? 'ðŸ“· ' : ''}
                                ${info.event.title}
                                ${info.event.extendedProps.start_time ? '<br><small>' + info.event.extendedProps.start_time + '</small>' : ''}
                            </div>
                        `
                    };
                }
                });

                calendar.render();
                console.log('âœ… FullCalendar initialized successfully');
                loadActivitiesCalendar();
            } catch (error) {
                console.error('âŒ Error initializing FullCalendar:', error);
                calendarEl.innerHTML = `<div class="alert alert-error">Takvim baÅŸlatÄ±lÄ±rken hata oluÅŸtu: ${error.message}</div>`;
            }
        }

        // Load activities calendar
        async function loadActivitiesCalendar() {
            if (!calendar) {
                initFullCalendar();
                return;
            }

            try {
                const response = await fetch('/api/activities?all=true', {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error('Failed to load activities');
                }
                const activities = await response.json();
                
                // Convert activities to FullCalendar events
                const events = [];
                
                for (const activity of activities) {
                    if (!activity.activity_date) continue;
                    
                    const startDate = new Date(activity.activity_date);
                    if (activity.start_time) {
                        const [hours, minutes] = activity.start_time.split(':');
                        startDate.setHours(parseInt(hours), parseInt(minutes));
                    }
                    
                    let endDate = null;
                    if (activity.end_date) {
                        endDate = new Date(activity.end_date);
                        if (activity.end_time) {
                            const [hours, minutes] = activity.end_time.split(':');
                            endDate.setHours(parseInt(hours), parseInt(minutes));
                        }
                    } else if (activity.end_time) {
                        endDate = new Date(startDate);
                        const [hours, minutes] = activity.end_time.split(':');
                        endDate.setHours(parseInt(hours), parseInt(minutes));
                    }
                    
                    const event = {
                        id: activity.id.toString(),
                        title: activity.title,
                        start: startDate.toISOString(),
                        end: endDate ? endDate.toISOString() : null,
                        allDay: !activity.start_time,
                        extendedProps: {
                            description: activity.description,
                            category: activity.category,
                            type: activity.type,
                            location: activity.location,
                            image_url: activity.image_url,
                            video_url: activity.video_url,
                            start_time: activity.start_time,
                            end_time: activity.end_time,
                            rrule: activity.rrule,
                            recurring_rule: activity.recurring_rule,
                            recurring_until: activity.recurring_until
                        },
                        backgroundColor: activity.category === 'Sabah' ? '#FFD700' : 
                                       activity.category === 'Ã–ÄŸle' ? '#FF6347' : 
                                       activity.category === 'AkÅŸam' ? '#4B0082' : '#2C6E8F',
                        borderColor: activity.category === 'Sabah' ? '#FFA500' : 
                                   activity.category === 'Ã–ÄŸle' ? '#FF4500' : 
                                   activity.category === 'AkÅŸam' ? '#6A0DAD' : '#1A4D6D'
                    };
                    
                    // Add RRule if exists (FullCalendar RRule plugin expects string)
                    if (activity.rrule) {
                        event.rrule = activity.rrule;
                    }
                    
                    events.push(event);
                }
                
                calendar.removeAllEvents();
                calendar.addEventSource(events);
            } catch (error) {
                console.error('Error loading activities calendar:', error);
                showAlert('Aktiviteler yÃ¼klenirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }

        // Open activity calendar modal
        function openActivityCalendarModal(dateStr = null) {
            currentCalendarActivityId = null;
            activityFileToUpload = null;
            document.getElementById('activity-calendar-modal-title').textContent = 'Yeni Aktivite';
            document.getElementById('activity-calendar-modal').classList.add('active');
            document.getElementById('activity-calendar-form').reset();
            document.getElementById('calendar-activity-file-preview').innerHTML = '';
            
            if (dateStr) {
                document.getElementById('calendar-activity-start-date').value = dateStr;
            } else {
                // Set default to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('calendar-activity-start-date').value = today;
            }
            
            // Reset recurring options
            document.getElementById('recurring-none').checked = true;
            toggleRecurringOptions();
        }

        // Close activity calendar modal
        function closeActivityCalendarModal() {
            document.getElementById('activity-calendar-modal').classList.remove('active');
            currentCalendarActivityId = null;
        }

        // Toggle recurring options visibility
        function toggleRecurringOptions() {
            const recurringType = document.querySelector('input[name="recurring-type"]:checked').value;
            const untilGroup = document.getElementById('recurring-until-group');
            const customGroup = document.getElementById('recurring-custom-group');
            
            if (recurringType === 'none') {
                untilGroup.style.display = 'none';
                customGroup.style.display = 'none';
            } else if (recurringType === 'custom') {
                untilGroup.style.display = 'block';
                customGroup.style.display = 'block';
            } else {
                untilGroup.style.display = 'block';
                customGroup.style.display = 'none';
            }
        }

        // Handle activity file change
        function handleActivityFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            activityFileToUpload = file;
            const preview = document.getElementById('calendar-activity-file-preview');
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                        <div style="margin-top: 8px; font-size: 12px; color: #667781;">${file.name}</div>
                    `;
                };
                reader.readAsDataURL(file);
            } else if (file.type.startsWith('video/')) {
                preview.innerHTML = `
                    <video controls style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                        <source src="${URL.createObjectURL(file)}" type="${file.type}">
                    </video>
                    <div style="margin-top: 8px; font-size: 12px; color: #667781;">${file.name}</div>
                `;
            }
        }

        // Edit calendar activity
        async function editCalendarActivity(id) {
            try {
                const response = await fetch(`/api/admin/activities/${id}`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load activity');
                const activity = await response.json();
                
                currentCalendarActivityId = id;
                document.getElementById('activity-calendar-modal-title').textContent = 'Aktivite DÃ¼zenle';
                document.getElementById('activity-calendar-modal').classList.add('active');
                
                // Fill form
                document.getElementById('calendar-activity-title').value = activity.title || '';
                document.getElementById('calendar-activity-start-date').value = activity.activity_date || '';
                document.getElementById('calendar-activity-end-date').value = activity.end_date || '';
                document.getElementById('calendar-activity-start-time').value = activity.start_time || '';
                document.getElementById('calendar-activity-end-time').value = activity.end_time || '';
                document.getElementById('calendar-activity-category').value = activity.category || '';
                document.getElementById('calendar-activity-type').value = activity.type || '';
                document.getElementById('calendar-activity-location').value = activity.location || '';
                document.getElementById('calendar-activity-description').value = activity.description || '';
                
                // Set media URLs
                document.getElementById('calendar-activity-image-url').value = activity.image_url || '';
                document.getElementById('calendar-activity-video-url').value = activity.video_url || '';
                
                // Set recurring type
                if (activity.rrule) {
                    document.getElementById('recurring-custom').checked = true;
                    document.getElementById('recurring-rrule-string').value = activity.rrule;
                } else {
                const recurringType = activity.recurring_rule || 'none';
                const recurringRadio = document.getElementById(`recurring-${recurringType}`);
                if (recurringRadio) {
                    recurringRadio.checked = true;
                    }
                }
                if (activity.recurring_until) {
                    document.getElementById('recurring-until-date').value = activity.recurring_until;
                }
                toggleRecurringOptions();
            } catch (error) {
                console.error('Error loading activity:', error);
                showAlert('Aktivite yÃ¼klenirken hata oluÅŸtu', 'error');
            }
        }

        // Save activity calendar (with recurring support and file upload)
        async function saveActivityCalendar(event) {
            event.preventDefault();
            
            const title = document.getElementById('calendar-activity-title').value.trim();
            const startDate = document.getElementById('calendar-activity-start-date').value;
            const endDate = document.getElementById('calendar-activity-end-date').value || null;
            const startTime = document.getElementById('calendar-activity-start-time').value || null;
            const endTime = document.getElementById('calendar-activity-end-time').value || null;
            const category = document.getElementById('calendar-activity-category').value.trim() || null;
            const type = document.getElementById('calendar-activity-type').value.trim() || null;
            const location = document.getElementById('calendar-activity-location').value.trim() || null;
            const description = document.getElementById('calendar-activity-description').value.trim() || null;
            const imageUrl = document.getElementById('calendar-activity-image-url').value.trim() || null;
            const videoUrl = document.getElementById('calendar-activity-video-url').value.trim() || null;
            const recurringType = document.querySelector('input[name="recurring-type"]:checked').value;
            const recurringUntil = document.getElementById('recurring-until-date').value || null;
            const customRrule = document.getElementById('recurring-rrule-string').value.trim() || null;
            
            if (!title || !startDate) {
                showAlert('BaÅŸlÄ±k ve baÅŸlangÄ±Ã§ tarihi gereklidir', 'error');
                return;
            }
            
            try {
                let rruleString = null;
                if (recurringType === 'custom' && customRrule) {
                    rruleString = customRrule;
                } else if (recurringType !== 'none') {
                    // Generate RRule string from simple recurring type
                    const untilDate = recurringUntil || new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0];
                    rruleString = generateRRuleString(recurringType, startDate, untilDate);
                }
                
                // If editing single activity, update it directly
                if (currentCalendarActivityId) {
                    // Update activity
                    let response = await fetch(`/api/admin/activities/${currentCalendarActivityId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            title,
                            activity_date: startDate,
                            end_date: endDate,
                            start_time: startTime,
                            end_time: endTime,
                            category,
                            type,
                            location,
                            description,
                            image_url: imageUrl,
                            video_url: videoUrl,
                            recurring_rule: recurringType !== 'none' ? recurringType : null,
                            recurring_until: recurringType !== 'none' ? (recurringUntil || new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0]) : null,
                            rrule: rruleString,
                            is_active: true
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to update activity');
                    }
                    
                    const updatedActivity = await response.json();
                    
                    // Upload file if exists
                    if (activityFileToUpload) {
                        const formData = new FormData();
                        formData.append('file', activityFileToUpload);
                        if (updatedActivity.image_url) {
                            formData.append('image_url', updatedActivity.image_url);
                        }
                        if (updatedActivity.video_url) {
                            formData.append('video_url', updatedActivity.video_url);
                        }
                        
                        await fetch(`/api/admin/activities/${currentCalendarActivityId}/upload`, {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });
                    }
                    
                    closeActivityCalendarModal();
                    loadActivitiesCalendar();
                    showAlert('Aktivite baÅŸarÄ±yla gÃ¼ncellendi', 'success');
                    return;
                }
                
                // Create new activity/activities
                const year = new Date().getFullYear();
                const recurringUntilDate = recurringUntil ? recurringUntil : `${year}-12-31`;
                
                // Generate dates if recurring
                let dates = [startDate];
                if (recurringType !== 'none' && !rruleString) {
                    dates = generateRecurringDates(startDate, recurringType, recurringUntilDate);
                } else if (rruleString) {
                    // Parse RRule and generate dates
                    try {
                        // Check RRule availability once and cache it
                        if (rruleAvailable === null) {
                            rruleAvailable = typeof RRule !== 'undefined';
                            if (!rruleAvailable) {
                                console.warn('âš ï¸ RRule library not loaded, using simple generation for all recurring events');
                            }
                        }
                        
                        if (!rruleAvailable) {
                            dates = generateRecurringDates(startDate, recurringType, recurringUntilDate);
                        } else {
                            const rruleObj = RRule.fromString(rruleString);
                        const startDateTime = new Date(startDate);
                        if (startTime) {
                            const [hours, minutes] = startTime.split(':');
                            startDateTime.setHours(parseInt(hours), parseInt(minutes));
                        }
                        rruleObj.options.dtstart = startDateTime;
                        if (recurringUntilDate) {
                            rruleObj.options.until = new Date(recurringUntilDate + 'T23:59:59');
                        }
                            const allDates = rruleObj.all();
                            dates = allDates.map(d => d.toISOString().split('T')[0]);
                        }
                    } catch (e) {
                        console.warn('Error parsing RRule, using simple generation:', e);
                        dates = generateRecurringDates(startDate, recurringType, recurringUntilDate);
                    }
                }
                
                // Save each date as a separate activity
                const savedActivities = [];
                for (const date of dates) {
                    const response = await fetch('/api/admin/activities', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            title,
                            activity_date: date,
                            end_date: endDate,
                            start_time: startTime,
                            end_time: endTime,
                            category,
                            type,
                            location,
                            description,
                            image_url: imageUrl,
                            video_url: videoUrl,
                            recurring_rule: recurringType !== 'none' ? recurringType : null,
                            recurring_until: recurringType !== 'none' ? recurringUntilDate : null,
                            rrule: rruleString,
                            is_story: false,
                            is_active: true
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to save activity');
                    }
                    
                    const savedActivity = await response.json();
                    savedActivities.push(savedActivity);
                }
                
                // Upload file to first activity if exists
                if (activityFileToUpload && savedActivities.length > 0) {
                    const formData = new FormData();
                    formData.append('file', activityFileToUpload);
                    
                    await fetch(`/api/admin/activities/${savedActivities[0].id}/upload`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                }
                
                closeActivityCalendarModal();
                loadActivitiesCalendar();
                showAlert(`Aktivite${dates.length > 1 ? 'ler' : ''} baÅŸarÄ±yla kaydedildi (${dates.length} adet)`, 'success');
            } catch (error) {
                console.error('Error saving activity:', error);
                showAlert('Aktivite kaydedilirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }

        // Generate RRule string from simple recurring type
        function generateRRuleString(recurringType, startDate, untilDate) {
            const start = new Date(startDate);
            const dayOfWeek = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'][start.getDay()];
            
            switch (recurringType) {
                case 'daily':
                    return `FREQ=DAILY;UNTIL=${untilDate.replace(/-/g, '')}T235959Z`;
                case 'weekly':
                    return `FREQ=WEEKLY;BYDAY=${dayOfWeek};UNTIL=${untilDate.replace(/-/g, '')}T235959Z`;
                case 'biweekly':
                    return `FREQ=WEEKLY;INTERVAL=2;BYDAY=${dayOfWeek};UNTIL=${untilDate.replace(/-/g, '')}T235959Z`;
                case 'monthly':
                    return `FREQ=MONTHLY;BYMONTHDAY=${start.getDate()};UNTIL=${untilDate.replace(/-/g, '')}T235959Z`;
                default:
                    return null;
            }
        }

        // Generate recurring dates
        function generateRecurringDates(startDate, recurringType, untilDate) {
            if (recurringType === 'none') {
                return [startDate];
            }
            
            const dates = [];
            const start = new Date(startDate);
            const until = new Date(untilDate);
            const current = new Date(start);
            
            while (current <= until) {
                dates.push(current.toISOString().split('T')[0]);
                
                switch (recurringType) {
                    case 'daily':
                        current.setDate(current.getDate() + 1);
                        break;
                    case 'weekly':
                        current.setDate(current.getDate() + 7);
                        break;
                    case 'biweekly':
                        current.setDate(current.getDate() + 14);
                        break;
                    case 'monthly':
                        current.setMonth(current.getMonth() + 1);
                        break;
                    default:
                        current.setDate(current.getDate() + 1);
                }
            }
            
            return dates;
        }

        // ============================================
        // RESTAURANT RESERVATIONS FUNCTIONS
        // ============================================

        let currentRestaurantId = null;
        let currentSessionTemplateId = null;

        // Load restaurants list
        async function loadRestaurants() {
            try {
                const response = await fetch('/admin/restaurants');
                const result = await response.json();
                
                // Handle both {success: true, data: [...]} and direct array responses
                let restaurants = [];
                if (result.success && result.data) {
                    restaurants = result.data;
                } else if (Array.isArray(result)) {
                    restaurants = result;
                } else if (!result.success) {
                    throw new Error(result.error || 'Restoranlar yÃ¼klenemedi');
                }
                const listEl = document.getElementById('restaurants-list');
                
                if (restaurants.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ½ï¸</div>
                            <p>HenÃ¼z restoran eklenmemiÅŸ</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ad</th>
                                <th>AÃ§Ä±klama</th>
                                <th>Fiyat</th>
                                <th>Durum</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${restaurants.map(restaurant => `
                                <tr>
                                    <td>${restaurant.name}</td>
                                    <td>${restaurant.description ? (restaurant.description.substring(0, 50) + '...') : '-'}</td>
                                    <td>${restaurant.price_per_person} ${restaurant.currency}</td>
                                    <td>
                                        <span class="badge ${restaurant.active ? 'badge-success' : 'badge-danger'}">
                                            ${restaurant.active ? 'Aktif' : 'Pasif'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="editRestaurant(${restaurant.id})">DÃ¼zenle</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteRestaurant(${restaurant.id})">Sil</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading restaurants:', error);
                document.getElementById('restaurants-list').innerHTML = `
                    <div class="empty-state">
                        <p style="color: var(--danger);">Hata: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Load restaurants for select dropdowns
        async function loadRestaurantsForSelect(selectId) {
            try {
                const response = await fetch('/admin/restaurants');
                const result = await response.json();
                
                // Handle both {success: true, data: [...]} and direct array responses
                let restaurants = [];
                if (result.success && result.data) {
                    restaurants = result.data;
                } else if (Array.isArray(result)) {
                    restaurants = result;
                } else if (!result.success) {
                    throw new Error(result.error || 'Restoranlar yÃ¼klenemedi');
                }
                const selectEl = document.getElementById(selectId);
                
                selectEl.innerHTML = '<option value="">-- Restoran SeÃ§in --</option>';
                restaurants.forEach(restaurant => {
                    const option = document.createElement('option');
                    option.value = restaurant.id;
                    option.textContent = restaurant.name;
                    selectEl.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading restaurants for select:', error);
            }
        }

        // Load session templates for selected restaurant
        async function loadSessionTemplates() {
            const restaurantId = document.getElementById('sessions-restaurant-select').value;
            const listEl = document.getElementById('session-templates-list');
            const newSessionBtn = document.getElementById('new-session-btn');

            if (!restaurantId) {
                listEl.innerHTML = '<div class="empty-state"><p>Ã–nce bir restoran seÃ§in</p></div>';
                newSessionBtn.disabled = true;
                return;
            }

            newSessionBtn.disabled = false;

            try {
                // TODO: Implement API endpoint
                // const response = await fetch(`/admin/restaurants/${restaurantId}/session-templates`);
                // const result = await response.json();
                
                listEl.innerHTML = `
                    <div class="empty-state">
                        <p>API endpoint henÃ¼z implement edilmedi</p>
                        <p>Restoran ID: ${restaurantId}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading session templates:', error);
                listEl.innerHTML = `
                    <div class="empty-state">
                        <p style="color: var(--danger);">Hata: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Load table setup sessions
        async function loadTableSetupSessions() {
            const restaurantId = document.getElementById('table-setup-restaurant-select').value;
            const sessionSelect = document.getElementById('table-setup-session-select');

            if (!restaurantId) {
                sessionSelect.disabled = true;
                sessionSelect.innerHTML = '<option value="">-- Ã–nce restoran seÃ§in --</option>';
                document.getElementById('table-setup-form').innerHTML = '<div class="empty-state"><p>Ã–nce restoran ve seans ÅŸablonu seÃ§in</p></div>';
                return;
            }

            sessionSelect.disabled = false;
            // TODO: Load session templates for this restaurant
            sessionSelect.innerHTML = '<option value="">-- Seans ÅŸablonu seÃ§in --</option>';
        }

        // Load table defaults
        async function loadTableDefaults() {
            const sessionTemplateId = document.getElementById('table-setup-session-select').value;
            const formEl = document.getElementById('table-setup-form');

            if (!sessionTemplateId) {
                formEl.innerHTML = '<div class="empty-state"><p>Ã–nce restoran ve seans ÅŸablonu seÃ§in</p></div>';
                return;
            }

            // TODO: Load and display table defaults form
            formEl.innerHTML = `
                <div class="empty-state">
                    <p>Masa kurulumu formu henÃ¼z implement edilmedi</p>
                    <p>Seans Åžablonu ID: ${sessionTemplateId}</p>
                </div>
            `;
        }

        // Load calendar
        async function loadCalendar() {
            const restaurantId = document.getElementById('calendar-restaurant-select').value;
            const fromDate = document.getElementById('calendar-from-date').value;
            const toDate = document.getElementById('calendar-to-date').value;
            const listEl = document.getElementById('calendar-instances-list');

            if (!restaurantId || !fromDate || !toDate) {
                listEl.innerHTML = '<div class="empty-state"><p>Ã–nce bir restoran seÃ§in ve tarih aralÄ±ÄŸÄ± belirleyin</p></div>';
                return;
            }

            // TODO: Implement API endpoint
            listEl.innerHTML = `
                <div class="empty-state">
                    <p>Takvim gÃ¶rÃ¼nÃ¼mÃ¼ henÃ¼z implement edilmedi</p>
                    <p>Restoran ID: ${restaurantId}</p>
                    <p>Tarih AralÄ±ÄŸÄ±: ${fromDate} - ${toDate}</p>
                </div>
            `;
        }

        // Generate session instances
        async function generateSessionInstances() {
            const restaurantId = document.getElementById('calendar-restaurant-select').value;
            const fromDate = document.getElementById('calendar-from-date').value;
            const toDate = document.getElementById('calendar-to-date').value;

            if (!restaurantId || !fromDate || !toDate) {
                showAlert('LÃ¼tfen restoran ve tarih aralÄ±ÄŸÄ± seÃ§in', 'error');
                return;
            }

            if (!confirm(`${fromDate} ile ${toDate} arasÄ±ndaki seanslarÄ± oluÅŸturmak istediÄŸinize emin misiniz?`)) {
                return;
            }

            try {
                // TODO: Implement API endpoint
                // const response = await fetch('/admin/session-instances/generate', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ restaurant_id: restaurantId, from_date: fromDate, to_date: toDate })
                // });
                
                showAlert('Seans oluÅŸturma API endpoint henÃ¼z implement edilmedi', 'warning');
            } catch (error) {
                console.error('Error generating session instances:', error);
                showAlert('Seanslar oluÅŸturulurken hata oluÅŸtu', 'error');
            }
        }

        // Load pricing and rules
        async function loadPricingRules() {
            const restaurantId = document.getElementById('pricing-restaurant-select').value;
            const formEl = document.getElementById('pricing-rules-form');

            if (!restaurantId) {
                formEl.innerHTML = '<div class="empty-state"><p>Ã–nce bir restoran seÃ§in</p></div>';
                return;
            }

            // TODO: Load restaurant pricing and rules
            formEl.innerHTML = `
                <div class="empty-state">
                    <p>Fiyat ve kurallar formu henÃ¼z implement edilmedi</p>
                    <p>Restoran ID: ${restaurantId}</p>
                </div>
            `;
        }

        // Open restaurant modal
        async function openRestaurantModal(restaurantId = null) {
            currentRestaurantId = restaurantId;
            const modal = document.getElementById('restaurant-modal');
            const title = document.getElementById('restaurant-modal-title');
            const form = document.getElementById('restaurant-form');
            
            // Reset form
            form.reset();
            document.getElementById('restaurant-photos-preview').innerHTML = '';
            document.getElementById('restaurant-photos-data').value = '';
            document.getElementById('restaurant-active').checked = true;
            document.getElementById('restaurant-rules-section').style.display = 'none';
            
            // Set default values
            document.getElementById('restaurant-max-per-room-per-day').value = 1;
            document.getElementById('restaurant-cutoff-minutes').value = 120;
            document.getElementById('restaurant-cancellation-deadline-minutes').value = 240;
            document.getElementById('restaurant-child-pricing-policy').value = 'free_under_12';
            document.getElementById('restaurant-allow-mix-table').checked = false;
            document.getElementById('restaurant-deposit-required').checked = false;
            document.getElementById('restaurant-ask-table-preference').checked = false;
            
            if (restaurantId) {
                title.textContent = 'Restoran DÃ¼zenle';
                // Load restaurant data
                try {
                    const response = await fetch(`/admin/restaurants/${restaurantId}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        const restaurant = result.data;
                        document.getElementById('restaurant-name').value = restaurant.name || '';
                        document.getElementById('restaurant-description').value = restaurant.description || '';
                        document.getElementById('restaurant-active').checked = restaurant.active !== false;
                        document.getElementById('restaurant-price-per-person').value = restaurant.price_per_person || '';
                        document.getElementById('restaurant-currency').value = restaurant.currency || 'TRY';
                        
                        // Load photos
                        if (restaurant.photos && Array.isArray(restaurant.photos) && restaurant.photos.length > 0) {
                            displayRestaurantPhotos(restaurant.photos);
                        }
                        
                        // Load rules
                        if (restaurant.rules_json) {
                            const rules = restaurant.rules_json;
                            document.getElementById('restaurant-max-per-room-per-day').value = rules.max_reservation_per_room_per_day || 1;
                            document.getElementById('restaurant-max-per-stay').value = rules.max_reservation_per_stay || '';
                            document.getElementById('restaurant-cutoff-minutes').value = rules.cutoff_minutes || 120;
                            document.getElementById('restaurant-cancellation-deadline-minutes').value = rules.cancellation_deadline_minutes || 240;
                            document.getElementById('restaurant-child-pricing-policy').value = rules.child_pricing_policy || 'free_under_12';
                            document.getElementById('restaurant-allow-mix-table').checked = rules.allow_mix_table || false;
                            document.getElementById('restaurant-deposit-required').checked = rules.deposit_required || false;
                            document.getElementById('restaurant-ask-table-preference').checked = rules.ask_table_preference || false;
                        }
                    }
                } catch (error) {
                    console.error('Error loading restaurant:', error);
                    showAlert('Restoran yÃ¼klenirken hata oluÅŸtu', 'error');
                }
            } else {
                title.textContent = 'Yeni Restoran';
            }
            
            modal.classList.add('active');
            setTimeout(() => lucide.createIcons(), 100);
        }

        // Close restaurant modal
        function closeRestaurantModal() {
            const modal = document.getElementById('restaurant-modal');
            modal.classList.remove('active');
            currentRestaurantId = null;
        }

        // Save restaurant
        async function saveRestaurant(event) {
            event.preventDefault();
            
            const name = document.getElementById('restaurant-name').value.trim();
            const description = document.getElementById('restaurant-description').value.trim();
            const active = document.getElementById('restaurant-active').checked;
            const pricePerPerson = parseFloat(document.getElementById('restaurant-price-per-person').value);
            const currency = document.getElementById('restaurant-currency').value;
            
            if (!name || !pricePerPerson || pricePerPerson < 0) {
                showAlert('LÃ¼tfen tÃ¼m gerekli alanlarÄ± doldurun', 'error');
                return;
            }
            
            // Get photos (stored as JSON array in hidden input)
            const photosData = document.getElementById('restaurant-photos-data').value;
            let photos = [];
            if (photosData) {
                try {
                    photos = JSON.parse(photosData);
                } catch (e) {
                    console.error('Error parsing photos:', e);
                }
            }
            
            // Build rules JSON
            const rules = {
                max_reservation_per_room_per_day: parseInt(document.getElementById('restaurant-max-per-room-per-day').value) || 1,
                max_reservation_per_stay: document.getElementById('restaurant-max-per-stay').value ? parseInt(document.getElementById('restaurant-max-per-stay').value) : null,
                cutoff_minutes: parseInt(document.getElementById('restaurant-cutoff-minutes').value) || 120,
                cancellation_deadline_minutes: parseInt(document.getElementById('restaurant-cancellation-deadline-minutes').value) || 240,
                child_pricing_policy: document.getElementById('restaurant-child-pricing-policy').value || 'free_under_12',
                allow_mix_table: document.getElementById('restaurant-allow-mix-table').checked || false,
                deposit_required: document.getElementById('restaurant-deposit-required').checked || false,
                ask_table_preference: document.getElementById('restaurant-ask-table-preference').checked || false
            };
            
            const restaurantData = {
                name,
                description: description || null,
                photos,
                active,
                price_per_person: pricePerPerson,
                currency,
                rules_json: rules
            };
            
            try {
                let response;
                if (currentRestaurantId) {
                    // Update
                    response = await fetch(`/admin/restaurants/${currentRestaurantId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(restaurantData)
                    });
                } else {
                    // Create
                    response = await fetch('/admin/restaurants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(restaurantData)
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(currentRestaurantId ? 'Restoran gÃ¼ncellendi' : 'Restoran oluÅŸturuldu', 'success');
                    closeRestaurantModal();
                    loadRestaurants();
                } else {
                    showAlert(result.error || 'Restoran kaydedilemedi', 'error');
                }
            } catch (error) {
                console.error('Error saving restaurant:', error);
                showAlert('Restoran kaydedilirken hata oluÅŸtu', 'error');
            }
        }

        // Handle restaurant photos change
        function handleRestaurantPhotosChange(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const photos = [];
            const previewEl = document.getElementById('restaurant-photos-preview');
            
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const photoData = e.target.result;
                        photos.push(photoData);
                        
                        // Display preview
                        const photoDiv = document.createElement('div');
                        photoDiv.style.position = 'relative';
                        photoDiv.style.width = '100px';
                        photoDiv.style.height = '100px';
                        photoDiv.style.borderRadius = '8px';
                        photoDiv.style.overflow = 'hidden';
                        photoDiv.style.border = '2px solid var(--border)';
                        
                        const img = document.createElement('img');
                        img.src = photoData;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'Ã—';
                        removeBtn.style.position = 'absolute';
                        removeBtn.style.top = '5px';
                        removeBtn.style.right = '5px';
                        removeBtn.style.background = 'var(--danger)';
                        removeBtn.style.color = 'white';
                        removeBtn.style.border = 'none';
                        removeBtn.style.borderRadius = '50%';
                        removeBtn.style.width = '24px';
                        removeBtn.style.height = '24px';
                        removeBtn.style.cursor = 'pointer';
                        removeBtn.onclick = () => {
                            photos.splice(photos.indexOf(photoData), 1);
                            photoDiv.remove();
                            updateRestaurantPhotosData();
                        };
                        
                        photoDiv.appendChild(img);
                        photoDiv.appendChild(removeBtn);
                        previewEl.appendChild(photoDiv);
                        
                        updateRestaurantPhotosData();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Display existing restaurant photos
        function displayRestaurantPhotos(photos) {
            const previewEl = document.getElementById('restaurant-photos-preview');
            previewEl.innerHTML = '';
            
            photos.forEach((photoUrl, index) => {
                const photoDiv = document.createElement('div');
                photoDiv.style.position = 'relative';
                photoDiv.style.width = '100px';
                photoDiv.style.height = '100px';
                photoDiv.style.borderRadius = '8px';
                photoDiv.style.overflow = 'hidden';
                photoDiv.style.border = '2px solid var(--border)';
                
                const img = document.createElement('img');
                img.src = photoUrl;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Ã—';
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '5px';
                removeBtn.style.right = '5px';
                removeBtn.style.background = 'var(--danger)';
                removeBtn.style.color = 'white';
                removeBtn.style.border = 'none';
                removeBtn.style.borderRadius = '50%';
                removeBtn.style.width = '24px';
                removeBtn.style.height = '24px';
                removeBtn.style.cursor = 'pointer';
                removeBtn.onclick = () => {
                    photos.splice(index, 1);
                    photoDiv.remove();
                    updateRestaurantPhotosData();
                };
                
                photoDiv.appendChild(img);
                photoDiv.appendChild(removeBtn);
                previewEl.appendChild(photoDiv);
            });
            
            document.getElementById('restaurant-photos-data').value = JSON.stringify(photos);
        }

        // Update restaurant photos data
        function updateRestaurantPhotosData() {
            const previewEl = document.getElementById('restaurant-photos-preview');
            const photos = [];
            previewEl.querySelectorAll('img').forEach(img => {
                photos.push(img.src);
            });
            document.getElementById('restaurant-photos-data').value = JSON.stringify(photos);
        }

        // Toggle restaurant rules section
        function toggleRestaurantRules() {
            const section = document.getElementById('restaurant-rules-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        // Edit restaurant
        function editRestaurant(restaurantId) {
            openRestaurantModal(restaurantId);
        }

        // Delete restaurant
        async function deleteRestaurant(restaurantId) {
            if (!confirm('Bu restoranÄ± silmek istediÄŸinize emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch(`/admin/restaurants/${restaurantId}`, { 
                    method: 'DELETE' 
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Restoran silindi', 'success');
                    loadRestaurants();
                } else {
                    showAlert(result.error || 'Restoran silinemedi', 'error');
                }
            } catch (error) {
                console.error('Error deleting restaurant:', error);
                showAlert('Restoran silinirken hata oluÅŸtu', 'error');
            }
        }

        // Open session template modal
        function openSessionTemplateModal(templateId = null) {
            currentSessionTemplateId = templateId;
            // TODO: Implement session template modal
            alert('Seans ÅŸablonu modal henÃ¼z implement edilmedi');
        }
    </script>
</body>
</html>

