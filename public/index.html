<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Voyage Sorgun">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Voyage Sorgun Chat</title>
    
    <link rel="manifest" href="/manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Mapbox GL CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --voyage-navy: #1A4D6D;
            --voyage-blue: #2C6E8F;
            --voyage-light-blue: #E8F1F5;
            --voyage-gold: #C9A961;
            --voyage-sand: #F5F1E8;
            --text-dark: #2C3E50;
            --text-light: #6C757D;
            --shadow: 0 2px 12px rgba(26, 77, 109, 0.08);
            --shadow-hover: 0 4px 20px rgba(26, 77, 109, 0.12);
            /* Safe area insets - JavaScript ile güncellenecek */
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            --safe-area-inset-right: env(safe-area-inset-right);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: white;
            color: #111b21;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile browsers */
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            position: relative;
            margin: 0;
            padding: 0;
        }

        /* Safe area dışındaki üst alanı header rengiyle renklendir (Dynamic Island) */
        /* Bu bölüm navigation bar'dan bağımsız olarak sabit kalacak */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            /* Safe area top + status bar alanı (tüm üst alan) */
            height: calc(var(--safe-area-inset-top, env(safe-area-inset-top)) + 4px);
            min-height: calc(var(--safe-area-inset-top, env(safe-area-inset-top)) + 4px);
            background: white !important; /* Chat header beyaz rengi - Dynamic Island için */
            z-index: 10001; /* Navigation bar'ın üstünde sabit kalacak */
            pointer-events: none;
        }
        
        /* Safe area dışındaki alt alanı bottom nav rengiyle renklendir */
        body::after {
            content: '';
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(84px + var(--safe-area-inset-bottom, env(safe-area-inset-bottom))); /* Navigation bar height + safe area */
            background: white;
            z-index: 999; /* Navigation bar'ın altında ama body background'unun üstünde */
            pointer-events: none;
        }

        .app-container {
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile browsers */
            display: flex;
            flex-direction: column;
            background: white;
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            padding-left: var(--safe-area-inset-left, env(safe-area-inset-left));
            padding-right: var(--safe-area-inset-right, env(safe-area-inset-right));
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* Ensure bottom-nav is not clipped by app-container overflow */
        .app-container .bottom-nav {
            position: fixed !important;
            z-index: 10000 !important;
        }

        /* WhatsApp tarzı section header */
        .section-header {
            background: white;
            color: #111b21;
            padding: 16px;
            padding-left: calc(16px + var(--safe-area-inset-left, env(safe-area-inset-left)));
            padding-right: calc(16px + var(--safe-area-inset-right, env(safe-area-inset-right)));
            padding-top: 0;
            padding-bottom: 16px;
            position: sticky;
            top: calc(var(--safe-area-inset-top, env(safe-area-inset-top)) + 4px);
            z-index: 10002; /* body::before'un üstünde olmalı */
            width: 100%;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-top: -10px; /* 10px yukarı kaydır */
        }

        .section-header-title {
            font-size: 24px;
            font-weight: 600;
            line-height: 32px;
            color: #111b21;
            margin: 0;
        }

        .section-header-subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
            line-height: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .header {
            background: white;
            color: #111b21;
            padding: 10px 16px;
            padding-left: calc(16px + var(--safe-area-inset-left, env(safe-area-inset-left)));
            padding-right: calc(16px + var(--safe-area-inset-right, env(safe-area-inset-right)));
            padding-top: 10px;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: sticky;
            top: calc(var(--safe-area-inset-top, env(safe-area-inset-top)) + 4px);
            z-index: 100;
            width: 100%;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hotel-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Lucide Icons Styling */
        .icon {
            width: 1em;
            height: 1em;
            stroke-width: 2;
            display: inline-block;
            vertical-align: middle;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .icon-md {
            width: 20px;
            height: 20px;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
        }

        .icon-xl {
            width: 32px;
            height: 32px;
        }

        .guest-profile-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .guest-profile-photo:hover {
            border-color: rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .guest-profile-photo.has-photo {
            background: transparent;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            flex: 1;
            margin-left: 12px;
        }

        .hotel-name {
            font-size: 16px;
            font-weight: 500;
            line-height: 21px;
        }

        .header-subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
            line-height: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }


        .connection-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        .connection-status.disconnected {
            background: #F44336;
        }


        .notification-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            color: white;
            font-size: 20px;
        }

        .notification-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .notification-btn:active {
            background: rgba(255,255,255,0.15);
        }

        .logout-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            color: white;
            font-size: 20px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .logout-btn:active {
            background: rgba(255,255,255,0.15);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            background: var(--voyage-gold);
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--voyage-navy);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px 16px;
            padding-left: calc(16px + var(--safe-area-inset-left, env(safe-area-inset-left)));
            padding-right: calc(16px + var(--safe-area-inset-right, env(safe-area-inset-right)));
            padding-top: 16px;
            padding-bottom: calc(16px + 143px); /* Space for input container */
            background: white;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            min-height: 0; /* Allow flex shrinking */
            box-sizing: border-box;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 4px;
            display: flex;
            gap: 8px;
            animation: messageSlide 0.2s ease;
            align-items: flex-end;
            justify-content: flex-start;
            width: 100%;
            position: relative;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            flex-direction: row-reverse;
            justify-content: flex-end;
            margin-left: auto;
            margin-right: 0;
            align-self: flex-end;
            width: 100%;
        }

        /* iOS Safari için özel düzeltme */
        @supports (-webkit-touch-callout: none) {
            .message.sent {
                margin-left: auto !important;
                margin-right: 0 !important;
                align-self: flex-end !important;
            }
            
            .message.sent .message-content {
                margin-left: auto;
                margin-right: 0;
            }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #54656f;
            font-size: 14px;
            flex-shrink: 0;
            font-weight: 500;
            object-fit: cover;
            overflow: hidden;
        }

        .message-avatar .voyage-logo {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-avatar .voyage-logo svg {
            width: 28px;
            height: 28px;
        }

        .message.sent .message-avatar {
            display: flex;
        }

        .message.sent .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            max-width: 70%;
            min-width: 120px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .message.sent .message-content {
            align-items: flex-end;
            margin-left: auto;
        }

        .message:not(.sent) .message-content {
            align-items: flex-start;
        }

        .message-bubble {
            background: #ffffff;
            padding: 6px 12px 8px 12px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }

        .message.sent .message-bubble {
            background: #d9fdd3;
            border-bottom-right-radius: 2px;
        }

        .message:not(.sent) .message-bubble {
            background: #ffffff;
            border-bottom-left-radius: 2px;
        }

        .message-text {
            font-size: 14.2px;
            line-height: 19px;
            word-wrap: break-word;
            color: #111b21;
        }

        .message.sent .message-text {
            color: #111b21;
        }

        .message-time {
            font-size: 11px;
            color: #667781;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
            justify-content: flex-start;
        }

        .message.sent .message-time {
            color: #667781;
            justify-content: flex-end;
        }

        /* Message Status Ticks (WhatsApp style) */
        .message-status {
            display: inline-flex;
            align-items: center;
            margin-left: 4px;
            font-size: 14px;
            line-height: 1;
        }

        .message-status.sent {
            color: #667781; /* Grey single tick */
        }

        .message-status.delivered {
            color: #667781; /* Grey double tick */
        }

        .message-status.read {
            color: #34B7F1; /* Blue double tick - WhatsApp blue */
        }

        /* WhatsApp style tick icons */
        .message-status {
            display: inline-flex;
            align-items: center;
            margin-left: 4px;
            font-size: 14px;
            line-height: 1;
        }
        
        .message-status.sent {
            color: #667781; /* Grey */
        }
        
        .message-status.delivered {
            color: #667781; /* Grey */
        }
        
        .message-status.read {
            color: #34B7F1; /* WhatsApp blue */
        }
        
        .message-status-icon {
            display: inline-block;
            position: relative;
            width: 18px;
            height: 14px;
            line-height: 1;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-weight: normal;
            vertical-align: middle;
        }

        /* Single tick (sent) */
        .message-status.sent .message-status-icon::after {
            content: '✓';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 16px;
            line-height: 1;
            color: #667781;
        }

        /* Double tick (delivered) - Two ticks overlapped */
        .message-status.delivered .message-status-icon::before {
            content: '✓';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 16px;
            line-height: 1;
            color: #667781;
        }
        
        .message-status.delivered .message-status-icon::after {
            content: '✓';
            position: absolute;
            left: 7px;
            top: 0;
            font-size: 16px;
            line-height: 1;
            color: #667781;
        }

        /* Double tick (read) - Two ticks overlapped, blue color */
        .message-status.read .message-status-icon::before {
            content: '✓';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 16px;
            line-height: 1;
            color: #34B7F1;
        }
        
        .message-status.read .message-status-icon::after {
            content: '✓';
            position: absolute;
            left: 7px;
            top: 0;
            font-size: 16px;
            line-height: 1;
            color: #34B7F1;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            margin: 16px 0;
            padding: 0 10px;
        }

        .typing-indicator.active {
            display: flex;
            animation: messageSlide 0.3s ease;
        }

        .typing-dots {
            background: #ffffff;
            padding: 12px 16px;
            border-radius: 16px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #667781;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        /* Guest Login Page Styles */
        .guest-login-container {
            display: none !important; /* Geçici olarak devre dışı - tasarım görmek için */
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh;
            background: white;
            padding: 20px;
        }

        .guest-login-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .guest-login-box h1 {
            color: #1A4D6D;
            font-size: 28px;
            margin-bottom: 8px;
            text-align: center;
        }

        .guest-login-box p {
            color: #667781;
            text-align: center;
            margin-bottom: 32px;
            font-size: 14px;
        }

        .guest-login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .guest-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .guest-form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #111b21;
        }

        .guest-form-group input {
            padding: 12px 16px;
            border: 1px solid #e4e6e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .guest-form-group input:focus {
            outline: none;
            border-color: #008069;
        }

        .guest-login-btn {
            background: white;
            color: #111b21;
            border: 1px solid #e4e6e9;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .guest-login-btn:hover {
            background: white;
        }

        .guest-login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .guest-login-error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .guest-login-error.show {
            display: block;
        }

        .input-container {
            padding: 10px 16px;
            padding-left: calc(16px + var(--safe-area-inset-left, env(safe-area-inset-left)));
            padding-right: calc(16px + var(--safe-area-inset-right, env(safe-area-inset-right)));
            padding-bottom: calc(10px + 60px + var(--safe-area-inset-bottom, env(safe-area-inset-bottom))); /* Navigation bar + safe area */
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 8px;
            align-items: flex-start; /* Yukarıdan hizalama için */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1001; /* Above chat content but below bottom nav */
            flex-shrink: 0;
            width: 100%;
            min-height: 143px;
            box-sizing: border-box;
        }
        
        /* Only show input container when chat section is active */
        #chatSection:not(.active) .input-container {
            display: none !important;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1); /* Sürekli görünür border */
            border-radius: 21px;
            padding: 9px 16px;
            transition: all 0.2s ease;
            min-height: 42px;
            max-width: calc(100% - 50px); /* Button için yer bırak (42px button + 8px gap) */
        }

        .input-wrapper:focus-within {
            background: white;
            border-color: rgba(0, 0, 0, 0.2); /* Focus olduğunda border daha belirgin */
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
        }

        #messageInput {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 100px;
            font-family: inherit;
            color: #111b21;
            line-height: 20px;
        }

        #messageInput::placeholder {
            color: #667781;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: flex-start; /* Button'u yukarıdan hizala */
            flex-shrink: 0; /* Button genişliğini sabit tut */
        }


        .send-btn {
            width: 42px;
            height: 42px;
            background: white;
            border: 1px solid #e4e6e9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #111b21;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .send-btn:active {
            transform: scale(0.95);
            background: white;
        }

        .send-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #b0b0b0;
        }


        @media (min-width: 768px) {
            .app-container {
                max-width: 480px;
                height: calc(90vh - var(--safe-area-inset-top, env(safe-area-inset-top)) - var(--safe-area-inset-bottom, env(safe-area-inset-bottom)));
                margin: calc(5vh + var(--safe-area-inset-top, env(safe-area-inset-top))) auto calc(5vh + var(--safe-area-inset-bottom, env(safe-area-inset-bottom)));
                margin-left: max(var(--safe-area-inset-left, env(safe-area-inset-left)), auto);
                margin-right: max(var(--safe-area-inset-right, env(safe-area-inset-right)), auto);
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.15);
                overflow: hidden;
            }

            .header {
                border-radius: 20px 20px 0 0;
            }

            /* Desktop'ta safe area pseudo-elementlerini gizle */
            body::before,
            body::after {
                display: none;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Photo Selection Modal */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .photo-modal.active {
            display: flex;
        }

        .photo-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 300px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .photo-modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #111b21;
        }

        .photo-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .photo-modal-btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .photo-modal-btn.camera {
            background: white;
            color: #111b21;
            border: 1px solid #e4e6e9;
        }

        .photo-modal-btn.camera:hover {
            background: white;
        }

        .photo-modal-btn.gallery {
            background: white;
            color: #111b21;
        }

        .photo-modal-btn.gallery:hover {
            background: white;
        }

        .photo-modal-btn.cancel {
            background: transparent;
            color: #667781;
            border: 1px solid #e4e6e9;
        }

        .photo-modal-btn.cancel:hover {
            background: white;
        }

        .hidden-input {
            display: none;
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            background: white;
            border-top: 1px solid #e4e6e9;
            display: flex !important;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            padding-left: var(--safe-area-inset-left, env(safe-area-inset-left));
            padding-right: var(--safe-area-inset-right, env(safe-area-inset-right));
            padding-bottom: calc(20px + var(--safe-area-inset-bottom, env(safe-area-inset-bottom)));
            z-index: 10000 !important; /* Increased to ensure it stays above chat section */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            min-height: 56px; /* WhatsApp iOS standardı */
            height: 84px;
            max-height: 84px; /* WhatsApp Web'e yakın */
            visibility: visible !important;
            opacity: 1 !important;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #667781;
            text-decoration: none;
            border: none;
            background: none;
            font-size: 11px;
            gap: 2px;
        }

        .nav-item:hover {
            background: white;
        }

        .nav-item.active {
            color: #008069;
        }

        .nav-item-icon {
            font-size: 24px;
            line-height: 1;
        }

        .nav-item-label {
            font-size: 11px;
            font-weight: 500;
            margin-top: 2px;
        }

        .nav-item.hidden {
            display: none !important;
        }

        /* Content sections */
        .content-section {
            display: none !important; /* Force hide when not active */
            flex: 1;
            overflow: hidden; /* Tüm section'lar için viewport'a göre sticky çalışması için */
            padding: 16px;
            padding-bottom: calc(80px + var(--safe-area-inset-bottom, env(safe-area-inset-bottom))); /* Bottom nav height + safe area */
            position: relative;
        }
        
        #chatSection {
            padding: 0;
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow: hidden; /* Keep overflow hidden for chat-container scroll */
            position: relative;
            flex: 1;
            min-height: 0;
        }
        
        /* Ensure bottom-nav stays visible when chat section is active */
        #chatSection.active {
            padding-bottom: calc(84px + var(--safe-area-inset-bottom, env(safe-area-inset-bottom))); /* Space for bottom-nav */
        }

        .content-section.active {
            display: flex !important; /* Force show when active */
            flex-direction: column;
        }
        
        /* Ensure chat section elements are only visible when chat section is active */
        #chatSection:not(.active) .header,
        #chatSection:not(.active) .chat-container,
        #chatSection:not(.active) .typing-indicator,
        #chatSection:not(.active) .input-container {
            display: none !important;
        }

        /* Ensure chat section elements are visible when chat section is active */
        #chatSection.active .chat-container {
            display: flex !important;
        }
        
        #chatSection.active .input-container {
            display: flex !important;
        }
        
        #chatSection.active .input-wrapper {
            display: flex !important;
        }
        
        #chatSection.active .send-btn {
            display: flex !important;
        }
        
        #chatSection.active .action-buttons {
            display: flex !important;
        }


        /* Info Section */
        .info-section {
            gap: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Scroll özelliği eklendi */
            overflow-x: hidden;
            flex: 1;
            min-height: 0; /* Flex container'da scroll için gerekli */
        }

        /* Reservations Section */
        #reservationsSection .info-section {
            padding-top: 0; /* Header eklendi, padding-top gerek yok */
        }

        /* Map Section */
        #mapSection .map-section {
            gap: 16px; /* Container'lar arası boşluk */
            padding: 0; /* Tüm padding kaldırıldı */
            display: flex;
            flex-direction: column;
            padding-top: 0; /* Header eklendi, padding-top gerek yok */
            overflow-y: auto; /* Scroll özelliği eklendi */
            flex: 1;
            min-height: 0; /* Flex container'da scroll için gerekli */
        }

        /* Map Section - Info card sağ ve sol padding kaldırıldı */
        #mapSection .info-card {
            padding-left: 0;
            padding-right: 0;
        }

        .map-search {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .map-search-label {
            font-size: 13px;
            color: #667781;
        }

        .map-search-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .map-search-input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 999px;
            border: 1px solid #e4e6e9;
            font-size: 14px;
            outline: none;
        }

        .map-search-input:focus {
            border-color: #cfd1d4;
        }

        .map-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .map-chip {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #e4e6e9;
            background: #f0f2f5;
            font-size: 12px;
            color: #667781;
            cursor: pointer;
        }

        .map-chip:active {
            background: #e4e6e9;
        }

        .map-container {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background: #f0f0f0;
            min-height: 500px;
            height: 500px; /* Fixed height for Mapbox */
            position: relative;
            z-index: 1;
        }
        
        @media (max-height: 800px) {
            .map-container {
                height: 400px;
                min-height: 400px;
            }
        }
        
        .map-container #mapContainer {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            position: relative;
        }

        /* Location Permission Banner */
        .location-permission-banner {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e4e6e9;
        }

        .location-permission-banner.hidden {
            display: none !important;
        }

        /* Accuracy Circle */
        .accuracy-circle {
            position: absolute;
            border: 2px solid rgba(0, 128, 105, 0.3);
            border-radius: 50%;
            background: rgba(0, 128, 105, 0.1);
            pointer-events: none;
            z-index: 0;
        }

        /* Mapbox map needs explicit height */
        #mapContainer .mapboxgl-map {
            width: 100% !important;
            height: 100% !important;
        }

        /* Mapbox specific styles */
        .mapboxgl-ctrl-logo {
            display: none !important;
        }

        .mapboxgl-ctrl-attrib {
            display: none !important;
        }

        /* User marker pulse animation */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .user-marker-pulse {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(52, 183, 241, 0.3);
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            pointer-events: none;
        }

        .map-location-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999999;
            transition: all 0.2s ease;
            pointer-events: auto;
            touch-action: manipulation;
        }

        .map-location-button:hover {
            background: #f5f5f5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }

        .map-location-button:active {
            transform: scale(0.95);
        }

        .map-location-button i {
            color: #34B7F1;
            width: 24px;
            height: 24px;
        }

        /* Settings Section - İlk elementin aynı yükseklikten başlaması için */
        #settingsSection .settings-section {
            padding-top: 0; /* Header eklendi, padding-top gerek yok */
            padding-left: 0; /* Sağ ve sol padding kaldırıldı */
            padding-right: 0;
        }

        /* Avatar Selection */
        .avatar-selection {
            padding: 16px;
            background: white;
        }

        .avatar-selection-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #111b21;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .avatar-item {
            aspect-ratio: 1;
            border-radius: 50%;
            border: 3px solid #e4e6e9;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            background: #f0f2f5;
        }

        .avatar-item:hover {
            transform: scale(1.05);
            border-color: #008069;
        }

        .avatar-item.selected {
            border-color: #008069;
            border-width: 4px;
            box-shadow: 0 0 0 2px rgba(0, 128, 105, 0.2);
        }

        .avatar-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-style-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding: 4px 0;
            -webkit-overflow-scrolling: touch;
        }

        .avatar-style-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e4e6e9;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .avatar-style-btn.active {
            background: #008069;
            color: white;
            border-color: #008069;
        }

        .avatar-preview-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 16px;
            border: 3px solid #008069;
            overflow: hidden;
            background: #f0f2f5;
        }

        .avatar-preview-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Activities Section */
        #activitiesSection {
            display: none;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
            position: relative;
            flex: 1;
            min-height: 0;
        }

        #activitiesSection.active {
            display: flex;
        }

        .activities-section {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: calc(80px + var(--safe-area-inset-bottom, env(safe-area-inset-bottom)));
            background: #f0f2f5;
        }

        /* Now Playing Banner */
        .now-playing-banner {
            background: linear-gradient(135deg, #008069 0%, #06cf9c 100%);
            color: white;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 128, 105, 0.3);
            display: none;
        }

        .now-playing-banner.active {
            display: block;
        }

        .now-playing-banner-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .now-playing-banner-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .now-playing-banner-time {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Date Navigation */
        .date-navigation {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 0 4px;
        }

        .date-nav-btn {
            flex: 1;
            padding: 12px;
            background: white;
            border: 1px solid #e4e6e9;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #111b21;
        }

        .date-nav-btn.active {
            background: #008069;
            color: white;
            border-color: #008069;
        }

        /* Category Filters */
        .category-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding: 0 4px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .category-filters::-webkit-scrollbar {
            display: none;
        }

        .category-filter-chip {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e4e6e9;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #667781;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .category-filter-chip.active {
            background: #008069;
            color: white;
            border-color: #008069;
        }

        /* Timeline */
        .timeline-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .time-period {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .time-period-header {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #667781;
            letter-spacing: 0.5px;
            padding: 0 4px;
            margin-bottom: 4px;
        }

        .activity-card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            gap: 12px;
            transition: all 0.2s;
            position: relative;
        }

        .activity-card.past {
            opacity: 0.5;
        }

        .activity-card.current {
            border: 2px solid #008069;
            box-shadow: 0 2px 8px rgba(0, 128, 105, 0.2);
        }

        .activity-card-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667781;
        }

        .activity-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .activity-card-content {
            flex: 1;
            min-width: 0;
        }

        .activity-card-time {
            font-size: 16px;
            font-weight: 700;
            color: #111b21;
            margin-bottom: 4px;
        }

        .activity-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #111b21;
            margin-bottom: 4px;
        }

        .activity-card-location {
            font-size: 13px;
            color: #667781;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .activity-card-type {
            display: inline-block;
            padding: 2px 8px;
            background: #e4e6e9;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #667781;
            margin-top: 4px;
        }

        .activity-card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .activity-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #667781;
        }

        .activity-action-btn.active {
            background: #fff3cd;
            color: #ff9800;
        }

        .activity-card-countdown {
            font-size: 12px;
            color: #008069;
            font-weight: 500;
            margin-top: 4px;
        }

        .empty-timeline {
            text-align: center;
            padding: 48px 16px;
            color: #667781;
        }

        .empty-timeline-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-timeline-text {
            font-size: 15px;
        }

        /* Instagram Story Tray Style Activity Notifications */
        .activity-stories-tray {
            display: flex;
            gap: 12px;
            padding: 16px;
            padding-top: 40px;
            padding-bottom: 0;
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            flex-shrink: 0;
            min-height: fit-content;
        }

        .activity-stories-tray::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .activity-story {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 70px;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .activity-story:active {
            transform: scale(0.95);
        }

        .story-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .story-video {
            position: absolute;
            top: 2px;
            left: 2px;
            width: calc(100% - 4px);
            height: calc(100% - 4px);
            object-fit: cover;
            border-radius: 50%;
            display: none;
            z-index: 2;
        }

        .story-video.active {
            display: block;
        }

        .story-avatar-placeholder {
            width: calc(100% - 4px);
            height: calc(100% - 4px);
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            position: relative;
            z-index: 1;
            flex-shrink: 0;
        }
        
        .story-avatar img {
            position: absolute;
            top: 2px;
            left: 2px;
            width: calc(100% - 4px);
            height: calc(100% - 4px);
            object-fit: cover;
            border-radius: 50%;
            z-index: 2;
        }

        .story-label {
            font-size: 11px;
            color: #111b21;
            text-align: center;
            font-weight: 500;
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Story Viewer Modal */
        .story-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 10000;
            touch-action: pan-y;
        }

        .story-viewer-modal.active {
            display: flex;
            flex-direction: column;
        }

        .story-viewer-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }

        .story-viewer-close {
            width: 32px;
            height: 32px;
            background: rgba(0,0,0,0.5);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-viewer-title {
            color: white;
            font-size: 16px;
            font-weight: 500;
            flex: 1;
        }

        .story-viewer-content {
            flex: 1;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .story-viewer-content::-webkit-scrollbar {
            display: none;
        }

        .story-viewer-item {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: start;
            position: relative;
        }

        .story-viewer-item img,
        .story-viewer-item video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .story-viewer-item video {
            background: #000;
        }

        .story-viewer-indicators {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            padding: 8px 16px;
            display: flex;
            gap: 4px;
            justify-content: center;
            z-index: 10001;
        }

        .story-indicator {
            flex: 1;
            height: 2px;
            background: rgba(255,255,255,0.3);
            border-radius: 1px;
            max-width: 40px;
        }

        .story-indicator.active {
            background: rgba(255,255,255,0.9);
        }

        /* Instagram Post Format */
        .info-posts-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 0 0 16px; /* Sağdan ve soldan padding kaldırıldı */
            margin-top: 0;
        }

        .info-post {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .post-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 12px;
            border-bottom: 1px solid #efefef;
        }

        .post-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }

        .post-avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .post-header-info {
            flex: 1;
        }

        .post-username {
            font-size: 14px;
            font-weight: 600;
            color: #262626;
        }

        .post-location {
            font-size: 12px;
            color: #8e8e8e;
        }

        .post-more {
            font-size: 20px;
            color: #262626;
            cursor: pointer;
        }

        .post-image {
            width: 100%;
            aspect-ratio: 1;
            background: #efefef;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .post-image img,
        .post-image video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: relative;
            z-index: 1;
        }

        .post-media-carousel {
            width: 100%;
            height: 100%;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: relative;
        }

        .post-media-carousel::-webkit-scrollbar {
            display: none;
        }

        .post-media-item {
            min-width: 100%;
            width: 100%;
            height: 100%;
            scroll-snap-align: start;
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .post-media-item img,
        .post-media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .post-media-indicators {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            z-index: 10;
        }

        .post-media-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transition: background 0.3s;
        }

        .post-media-indicator.active {
            background: rgba(255,255,255,0.9);
        }

        .post-image-placeholder {
            font-size: 48px;
            color: #dbdbdb;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        .post-actions {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 16px;
        }

        .post-action {
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .post-action:active {
            transform: scale(0.9);
        }

        .post-action.liked i {
            color: #ed4956 !important;
            fill: #ed4956 !important;
        }

        .post-action.bookmarked i {
            fill: #111b21 !important;
        }

        .post-action.save {
            margin-left: auto;
        }

        .post-likes {
            padding: 0 16px;
            font-size: 14px;
            font-weight: 600;
            color: #262626;
            margin-bottom: 8px;
        }

        .post-caption {
            padding: 0 16px;
            font-size: 14px;
            color: #262626;
            margin-bottom: 8px;
        }

        .post-caption-username {
            font-weight: 600;
            margin-right: 4px;
        }

        .post-comments {
            padding: 0 16px 12px;
            font-size: 14px;
            color: #8e8e8e;
        }

        .post-time {
            padding: 0 16px 16px;
            font-size: 10px;
            color: #8e8e8e;
            text-transform: uppercase;
        }

        .info-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .info-card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #111b21;
        }

        .info-card-content {
            font-size: 14px;
            color: #667781;
            line-height: 1.5;
        }

        /* Profile Section */
        .profile-section {
            gap: 16px; /* Container'lar arası boşluk */
            padding: 16px;
            display: flex;
            flex-direction: column;
            /* Yeşil panel yüksekliği: safe-area-inset-top + 44px (status bar) */
            padding-top: calc(var(--safe-area-inset-top, env(safe-area-inset-top)) + 44px + 40px); /* Story bölümüyle aynı yükseklik için 40px */
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            overflow: hidden;
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            color: #111b21;
        }

        .profile-info {
            font-size: 14px;
            color: #667781;
        }

        /* Settings Section */
        .settings-section {
            gap: 16px; /* Container'lar arası boşluk */
            padding: 16px;
            display: flex;
            flex-direction: column;
            /* Yeşil panel yüksekliği: safe-area-inset-top + 44px (status bar) */
            padding-top: calc(var(--safe-area-inset-top, env(safe-area-inset-top)) + 44px + 40px); /* Story bölümüyle aynı yükseklik için 40px */
            overflow-y: auto; /* Scroll özelliği eklendi */
            flex: 1;
            min-height: 0; /* Flex container'da scroll için gerekli */
        }

        .settings-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s;
        }

        .settings-item:hover {
            background: white;
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-item-icon {
            font-size: 20px;
        }

        .settings-item-label {
            font-size: 16px;
            font-weight: 500;
            color: #111b21;
        }

        .settings-item-right {
            color: #667781;
            font-size: 20px;
            display: flex;
            align-items: center;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: white;
            border: 1px solid #e4e6e9;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* SPA Booking Wizard Styles */
        .spa-booking-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .spa-booking-modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }

        .spa-booking-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
            padding: 0 20px;
        }

        .spa-booking-progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e4e6e9;
            transition: background 0.3s;
        }

        .spa-booking-progress-dot.active {
            background: #1A4D6D;
        }

        .spa-booking-step {
            min-height: 200px;
        }

        .spa-service-item,
        .spa-time-slot,
        .spa-therapist-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: white;
            border: 1px solid #e4e6e9;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spa-service-item:hover,
        .spa-time-slot:hover,
        .spa-therapist-item:hover {
            background: #f8f9fa;
            border-color: #1A4D6D;
        }

        .spa-time-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .spa-time-slot.disabled:hover {
            background: #f8f9fa;
            border-color: #e4e6e9;
        }

        .spa-calendar-day {
            position: relative;
            width: 70px;
            height: 80px;
            padding: 12px 8px;
            background: white;
            border: 2px solid #e4e6e9;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spa-calendar-day:hover {
            border-color: #1A4D6D;
            background: #f8f9fa;
        }

        .spa-calendar-day.selected {
            border-color: #1A4D6D;
            background: #E8F1F5;
        }

        .spa-calendar-day.heat-green {
            border-left: 4px solid #28a745;
        }

        .spa-calendar-day.heat-yellow {
            border-left: 4px solid #ffc107;
        }

        .spa-calendar-day.heat-red {
            border-left: 4px solid #dc3545;
        }

        .spa-earliest-btn {
            width: 100%;
            padding: 12px;
            background: #1A4D6D;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .spa-earliest-btn:hover {
            background: #2C6E8F;
        }

        .spa-therapist-tag {
            display: inline-block;
            background: #E8F1F5;
            color: #1A4D6D;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .spa-new-request-btn {
            width: 100%;
            padding: 12px;
            background: #1A4D6D;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .spa-new-request-btn:hover {
            background: #2C6E8F;
        }

        .spa-request-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: white;
            border: 1px solid #e4e6e9;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spa-request-item:hover {
            background: #f8f9fa;
            border-color: #1A4D6D;
        }

        .spa-status-badge {
            display: inline-block;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .spa-request-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

    </style>
</head>
<body>
    <!-- Guest Login Page -->
    <div class="guest-login-container" id="guestLoginContainer">
        <div class="guest-login-box">
            <h1>👋 Misafir Girişi</h1>
            <p>Lütfen giriş bilgilerinizi girin</p>
            <div class="guest-login-error" id="guestLoginError"></div>
            <form class="guest-login-form" id="guestLoginForm" onsubmit="handleGuestLogin(event)">
                <div class="guest-form-group">
                    <label for="guestName">Ad</label>
                    <input type="text" id="guestName" name="guestName" placeholder="Adınız" required>
                </div>
                <div class="guest-form-group">
                    <label for="guestSurname">Soyad</label>
                    <input type="text" id="guestSurname" name="guestSurname" placeholder="Soyadınız" required>
                </div>
                <div class="guest-form-group">
                    <label for="checkinDate">Giriş Tarihi</label>
                    <input type="date" id="checkinDate" name="checkinDate" required>
                </div>
                <div class="guest-form-group">
                    <label for="checkoutDate">Çıkış Tarihi</label>
                    <input type="date" id="checkoutDate" name="checkoutDate" required>
                </div>
                <button type="submit" class="guest-login-btn" id="guestLoginBtn">Giriş Yap</button>
            </form>
        </div>
    </div>

    <!-- Chat App (hidden until login) -->
    <div class="app-container" id="appContainer" style="display: flex;"> <!-- Geçici olarak görünür - tasarım görmek için -->
        <!-- Content Sections -->
        <div class="content-section" id="chatSection">
            <!-- Chat Header -->
            <div class="section-header">
                <h1 class="section-header-title" data-i18n="chat">Sohbetler</h1>
                <div class="section-header-subtitle">
                    <span class="connection-status" id="connectionStatus"></span>
                    <span id="statusText" data-i18n="connecting">Bağlanıyor...</span>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer">
                <!-- Messages will be loaded here -->
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar">
                        <div class="voyage-logo">
                            <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2" y="2" width="116" height="56" fill="none" stroke="#8B0000" stroke-width="1.5" rx="2"/>
                                <text x="60" y="22" font-family="Arial, sans-serif" font-size="18" font-weight="600" fill="#8B0000" text-anchor="middle" letter-spacing="1">VOYAGE</text>
                                <text x="60" y="42" font-family="Arial, sans-serif" font-size="10" font-weight="500" fill="#8B0000" text-anchor="middle" letter-spacing="0.5">HOTELS</text>
                                <line x1="30" y1="38" x2="35" y2="38" stroke="#8B0000" stroke-width="1"/>
                                <line x1="85" y1="38" x2="90" y2="38" stroke="#8B0000" stroke-width="1"/>
                            </svg>
                        </div>
                    </div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>

            <!-- Input Container (moved outside chat-container) -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="Mesajınızı yazın..."
                        data-i18n-placeholder="typeMessage"
                        rows="1"
                        onkeypress="handleKeyPress(event)"
                        oninput="handleInputChange()"
                    ></textarea>
                </div>
                <div class="action-buttons">
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <i data-lucide="send" class="icon icon-md"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="content-section" id="reservationsSection">
            <div class="section-header">
                <h1 class="section-header-title" data-i18n="reservations">Rezervasyonlar</h1>
            </div>
            <div class="info-section">
                <div class="info-card">
                    <div class="info-card-title"><i data-lucide="calendar" class="icon icon-md"></i> <span data-i18n="myReservations">Rezervasyonlarım</span></div>
                    <div class="info-card-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; font-size: 14px;">
                        <div style="display: flex; flex-direction: column;">
                            <span style="color: #667781; font-size: 12px; margin-bottom: 2px;" data-i18n="room">Oda</span>
                            <span id="reservationRoomNumber" style="font-weight: 500;">-</span>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <span style="color: #667781; font-size: 12px; margin-bottom: 2px;" data-i18n="checkinDate">Giriş Tarihi</span>
                            <span id="reservationCheckinDate" style="font-weight: 500;">-</span>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <span style="color: #667781; font-size: 12px; margin-bottom: 2px;" data-i18n="checkoutDate">Çıkış Tarihi</span>
                            <span id="reservationCheckoutDate" style="font-weight: 500;">-</span>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <span style="color: #667781; font-size: 12px; margin-bottom: 2px;" data-i18n="adult">Yetişkin</span>
                            <span id="reservationAdultCount" style="font-weight: 500;">-</span>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <span style="color: #667781; font-size: 12px; margin-bottom: 2px;" data-i18n="kids">Çocuk</span>
                            <span id="reservationChildCount" style="font-weight: 500;">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-card-title"><i data-lucide="utensils-crossed" class="icon icon-md"></i> <span data-i18n="restaurantReservations">A'la Carte Restoran Rezervasyonları</span></div>
                    <div class="info-card-content" id="restaurantReservations">
                        <div style="text-align: center; padding: 20px; color: #667781;" data-i18n="noRestaurantReservations">
                            Henüz restoran rezervasyonunuz bulunmamaktadır.
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-card-title"><i data-lucide="sparkles" class="icon icon-md"></i> <span data-i18n="mySpaReservations">Spa Rezervasyonlarım</span></div>
                    <div class="info-card-content" id="mySpaReservations">
                        <div style="text-align: center; padding: 20px; color: #667781;">
                            Yükleniyor...
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-card-title"><i data-lucide="utensils-crossed" class="icon icon-md"></i> <span data-i18n="availableRestaurants">Bugün Açık Restoranlar</span></div>
                    <div class="info-card-content" id="availableRestaurants" style="min-height: 100px;">
                        <div style="text-align: center; padding: 20px; color: #667781;">
                            <div class="loading">Yükleniyor...</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-card-title"><i data-lucide="sparkles" class="icon icon-md"></i> <span data-i18n="spaReservations">Spa Rezervasyonları</span></div>
                    <div class="info-card-content" id="spaReservations">
                        <div style="text-align: center; padding: 20px; color: #667781;" data-i18n="noSpaReservations">
                            Henüz spa rezervasyonunuz bulunmamaktadır.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section active" id="infoSection">
            <div class="section-header">
                <h1 class="section-header-title" data-i18n="info">Hotel Info</h1>
            </div>
            <div class="info-section">
                <!-- Instagram Story Tray Style Activity Notifications -->
                <div class="activity-stories-tray" id="activityStoriesTray">
                    <!-- Stories will be loaded dynamically from database -->
                </div>
                
                <!-- Instagram Post Format Sections -->
                <div class="info-posts-container" id="infoPostsContainer">
                    <!-- Posts will be loaded dynamically from database -->
                            </div>
                            </div>
                    </div>

        <!-- Activities Section -->
        <div class="content-section" id="activitiesSection">
            <div class="section-header">
                <h1 class="section-header-title" data-i18n="activities">Aktiviteler</h1>
                            </div>
            <div class="activities-section">
                <!-- Now Playing Banner -->
                <div class="now-playing-banner" id="nowPlayingBanner">
                    <div class="now-playing-banner-header">
                        <div style="width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse 2s infinite;"></div>
                        <span data-i18n="nowPlaying">ŞİMDİ OYNANIYOR</span>
                            </div>
                    <div class="now-playing-banner-title" id="nowPlayingTitle"></div>
                    <div class="now-playing-banner-time" id="nowPlayingTime"></div>
                    </div>

                <!-- Date Selection -->
                <div class="date-navigation" style="display: flex; align-items: center; justify-content: center; padding: 12px 16px; gap: 12px;">
                    <label for="activity-date-selector" style="font-size: 14px; font-weight: 500; color: #111b21; white-space: nowrap;">Tarih:</label>
                    <input 
                        type="date" 
                        id="activity-date-selector" 
                        class="form-input" 
                        style="flex: 1; max-width: 200px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px; background: white;"
                        onchange="switchActivityDate(this.value)"
                    />
                </div>

                <!-- Category Filters -->
                <div class="category-filters">
                    <button class="category-filter-chip active" onclick="filterByCategory(this)" data-category="All" data-i18n="all">Tümü</button>
                    <button class="category-filter-chip" onclick="filterByCategory(this)" data-category="Kids" data-i18n="kids">Çocuk</button>
                    <button class="category-filter-chip" onclick="filterByCategory(this)" data-category="Adult" data-i18n="adult">Yetişkin</button>
                    <button class="category-filter-chip" onclick="filterByCategory(this)" data-category="All Ages" data-i18n="allAges">Tüm Yaşlar</button>
                    </div>

                <!-- Timeline -->
                <div class="timeline-container" id="timelineContainer">
                    <div class="empty-timeline">
                        <div class="empty-timeline-icon">📅</div>
                        <div class="empty-timeline-text" data-i18n="activitiesLoading">Aktiviteler yükleniyor...</div>
                            </div>
                            </div>
                        </div>
                    </div>

        <div class="content-section" id="mapSection">
            <div class="section-header">
                <h1 class="section-header-title" data-i18n="map">Harita</h1>
                            </div>
            <div class="map-section">
                <!-- Permission Banner (shown when permission not yet asked or denied) -->
                <div id="locationPermissionBanner" class="location-permission-banner" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <i data-lucide="map-pin" class="icon icon-lg"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 14px; margin-bottom: 4px;" id="permissionBannerTitle">
                                Konumunuza ihtiyacımız var
                            </div>
                            <div style="font-size: 12px; color: #667781;" id="permissionBannerMessage">
                                Haritada konumunuzu göstermek için konum iznine ihtiyacımız var.
                        </div>
                        </div>
                        </div>
                    <button id="permissionBannerBtn" onclick="handlePermissionBannerClick()" style="
                        padding: 8px 16px;
                        background: #008069;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        white-space: nowrap;
                    ">
                        Konum Ver
                    </button>
                    </div>

                <div class="info-card">
                    <div class="info-card-title" data-i18n="map">Harita</div>
                    <div class="info-card-content">
                        <div class="map-search">
                            <div class="map-search-label" data-i18n="mapSearchLabel">Gitmek istediğiniz yer</div>
                            <div class="map-search-input-wrapper">
                                <input
                                    type="text"
                                    id="mapSearchInput"
                                    class="map-search-input"
                                    placeholder="Oda numarası veya alan adı yazın"
                                    data-i18n-placeholder="mapSearchPlaceholder"
                                />
                            </div>
                            <div class="map-suggestions" id="mapSuggestions">
                                <!-- Map chips will be loaded dynamically from database -->
                            </div>
                        </div>
                        <div class="map-container" style="height: 500px; min-height: 500px;">
                            <div id="mapContainer" style="width: 100%; height: 100%; position: relative;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; text-align: center; color: #667781; z-index: 1;" data-i18n="mapLoading">Harita yükleniyor...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section" id="settingsSection">
            <div class="section-header">
                <h1 class="section-header-title" data-i18n="settings">Ayarlar</h1>
            </div>
            
            <!-- Login Screen (shown when not authenticated) -->
            <div class="settings-section" id="loginScreen">
                <div style="padding: 40px 20px; text-align: center;">
                    <div style="width: 56px; height: 56px; margin: 0 auto 20px; border-radius: 16px; background: rgba(0, 128, 105, 0.12); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="building" class="icon icon-xl" style="color: #008069;"></i>
                    </div>
                    <h2 style="font-size: 24px; font-weight: 600; color: #111b21; margin-bottom: 8px;">Voyage Sorgun</h2>
                    <p style="font-size: 14px; color: #667781; margin-bottom: 32px;">Hoş geldiniz! Devam etmek için giriş yapın.</p>
                    
                    <div class="info-card" style="text-align: left;">
                        <div class="info-card-title">Giriş Yap</div>
                        <div class="info-card-content">
                            <form id="loginForm" onsubmit="handleLogin(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-size: 14px; font-weight: 500; color: #111b21; margin-bottom: 8px;">Ad</label>
                                    <input 
                                        type="text" 
                                        id="loginFirstName" 
                                        placeholder="Adınız" 
                                        required
                                        style="
                                            width: 100%;
                                            padding: 12px;
                                            border: 1px solid #e4e6e9;
                                            border-radius: 8px;
                                            font-size: 14px;
                                            box-sizing: border-box;
                                        "
                                    />
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; font-size: 14px; font-weight: 500; color: #111b21; margin-bottom: 8px;">Soyad</label>
                                    <input 
                                        type="text" 
                                        id="loginLastName" 
                                        placeholder="Soyadınız" 
                                        required
                                        style="
                                            width: 100%;
                                            padding: 12px;
                                            border: 1px solid #e4e6e9;
                                            border-radius: 8px;
                                            font-size: 14px;
                                            box-sizing: border-box;
                                        "
                                    />
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-size: 14px; font-weight: 500; color: #111b21; margin-bottom: 8px;">Giriş Tarihi</label>
                                    <input 
                                        type="date" 
                                        id="loginCheckinDate"
                                        required
                                        style="
                                            width: 100%;
                                            padding: 12px;
                                            border: 1px solid #e4e6e9;
                                            border-radius: 8px;
                                            font-size: 14px;
                                            box-sizing: border-box;
                                        "
                                    />
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; font-size: 14px; font-weight: 500; color: #111b21; margin-bottom: 8px;">Çıkış Tarihi</label>
                                    <input 
                                        type="date" 
                                        id="loginCheckoutDate"
                                        required
                                        style="
                                            width: 100%;
                                            padding: 12px;
                                            border: 1px solid #e4e6e9;
                                            border-radius: 8px;
                                            font-size: 14px;
                                            box-sizing: border-box;
                                        "
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    id="loginSubmitBtn"
                                    style="
                                        width: 100%;
                                        padding: 14px;
                                        background: #008069;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-size: 16px;
                                        font-weight: 600;
                                        cursor: pointer;
                                    "
                                >
                                    Giriş Yap
                                </button>
                            </form>
                            
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e4e6e9; text-align: center;">
                                <button 
                                    onclick="continueAsGuest()"
                                    style="
                                        background: none;
                                        border: none;
                                        color: #008069;
                                        font-size: 14px;
                                        font-weight: 500;
                                        cursor: pointer;
                                        text-decoration: underline;
                                    "
                                >
                                    Misafir olarak devam et
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Content (shown when authenticated) -->
            <div class="settings-section" id="settingsContent" style="display: none;">
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profileAvatarLarge">
                        <i data-lucide="user" class="icon icon-xl"></i>
                    </div>
                    <div>
                        <div class="profile-name" id="profileName">Misafir</div>
                        <div class="profile-info" id="profileInfo">Oda bilgisi yükleniyor...</div>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card-title" data-i18n="personalInfo">Kişisel Bilgiler</div>
                    <div class="info-card-content">
                        <div style="margin-bottom: 8px;"><strong data-i18n="name">Ad:</strong> <span id="profileGuestName">-</span></div>
                        <div style="margin-bottom: 8px;"><strong data-i18n="surname">Soyad:</strong> <span id="profileGuestSurname">-</span></div>
                        <div style="margin-bottom: 8px;"><strong data-i18n="room">Oda:</strong> <span id="profileRoomNumber">-</span></div>
                        <div style="margin-bottom: 16px;"><strong data-i18n="checkinDate">Giriş Tarihi:</strong> <span id="profileCheckinDate">-</span></div>
                    </div>
                </div>
                <!-- Avatar & Harita Section -->
                <div class="info-card">
                    <div class="info-card-title">Avatar & Harita</div>
                    <div class="info-card-content">
                        <div class="avatar-selection">
                            <div class="avatar-preview-large">
                                <img id="currentAvatarPreview" src="" alt="Avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; font-size: 32px;" id="avatarPreviewPlaceholder">👤</div>
                            </div>
                            
                            <!-- Avatar style selector removed - only avataaars style available -->
                            
                            <div class="avatar-grid" id="avatarGrid">
                                <!-- Avatars will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-item" onclick="toggleGhostMode()">
                    <div class="settings-item-left">
                        <div class="settings-item-icon"><i data-lucide="ghost" class="icon icon-lg"></i></div>
                        <div class="settings-item-label" data-i18n="ghostMode">Hayalet Modu</div>
                    </div>
                    <div class="settings-item-right">
                        <label class="toggle-switch">
                            <input type="checkbox" id="ghostModeToggle" onchange="handleGhostModeToggle()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- Konum Durumu Kartı -->
                <div class="info-card" style="margin-top: 16px;">
                    <div class="info-card-title" data-i18n="location">Konum</div>
                    <div class="info-card-content">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 14px; color: #667781;" data-i18n="status">Durum:</span>
                                <span id="locationPermissionStatus" style="font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                                    <i data-lucide="clock" class="icon icon-sm"></i>
                                    <span data-i18n="checking">Kontrol ediliyor...</span>
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 14px; color: #667781;" data-i18n="lastUpdate">Son güncelleme:</span>
                                <span id="locationLastUpdate" style="font-size: 14px; color: #667781;">-</span>
                            </div>
                            <button id="locationSettingsBtn" onclick="openLocationSettingsGuide()" style="
                                width: 100%;
                                padding: 12px;
                                background: #f0f2f5;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 500;
                                color: #008069;
                                cursor: pointer;
                                margin-top: 8px;
                            " data-i18n="changeSettings">
                                Ayarları Değiştir
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="settings-item" onclick="showPhotoModal()">
                    <div class="settings-item-left">
                        <div class="settings-item-icon"><i data-lucide="camera" class="icon icon-lg"></i></div>
                        <div class="settings-item-label" data-i18n="changeProfilePhoto">Profil Fotoğrafı Değiştir</div>
                    </div>
                    <div class="settings-item-right">›</div>
                </div>
                <div class="settings-item" onclick="toggleNotifications()">
                    <div class="settings-item-left">
                        <div class="settings-item-icon"><i data-lucide="bell" class="icon icon-lg"></i></div>
                        <div class="settings-item-label" data-i18n="notifications">Bildirimler</div>
                    </div>
                    <div class="settings-item-right">
                        <label class="toggle-switch">
                            <input type="checkbox" id="notificationToggle" onchange="handleNotificationToggle()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <!-- Konum İzni butonu gizlendi (kafa karıştırıcı) -->
                <!--
                <div class="settings-item" onclick="requestLocationPermission()">
                    <div class="settings-item-left">
                        <div class="settings-item-icon"><i data-lucide="map-pin" class="icon icon-lg"></i></div>
                        <div class="settings-item-label" data-i18n="locationPermission">Konum İzni</div>
                    </div>
                    <div class="settings-item-right">
                        <span id="locationPermissionStatus" style="font-size: 12px; color: #667781;" data-i18n="locationPermissionStatus">İzin ver</span> ›
                    </div>
                </div>
                -->
                <div class="settings-item" onclick="openLanguageSelector()">
                    <div class="settings-item-left">
                        <div class="settings-item-icon"><i data-lucide="languages" class="icon icon-lg"></i></div>
                        <div class="settings-item-label" data-i18n="language">Dil</div>
                    </div>
                    <div class="settings-item-right">
                        <span id="currentLanguageDisplay">Türkçe</span> ›
                    </div>
                </div>
                <div class="settings-item" onclick="forceUpdateApp()">
                    <div class="settings-item-left">
                        <div class="settings-item-icon"><i data-lucide="refresh-cw" class="icon icon-lg"></i></div>
                        <div class="settings-item-label" data-i18n="updateApp">Uygulamayı Güncelle</div>
                    </div>
                    <div class="settings-item-right">›</div>
                </div>
                <div class="settings-item" id="logoutBtn" onclick="handleLogout()" style="display: none;">
                    <div class="settings-item-left">
                        <div class="settings-item-icon"><i data-lucide="log-out" class="icon icon-lg"></i></div>
                        <div class="settings-item-label" data-i18n="logout">Çıkış Yap</div>
                    </div>
                    <div class="settings-item-right">›</div>
                </div>
                </div>
            </div>
        </div>

        <!-- Language Selector Modal -->
        <div class="photo-modal" id="languageModal">
            <div class="photo-modal-content">
                <div class="photo-modal-title" data-i18n="selectLanguage">Dil Seçin</div>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;">
                    <button class="photo-modal-btn" onclick="changeLanguage('tr')" style="justify-content: space-between;">
                        <span>🇹🇷 Türkçe</span>
                        <span id="langCheckTr" style="display: none;">✓</span>
                    </button>
                    <button class="photo-modal-btn" onclick="changeLanguage('en')" style="justify-content: space-between;">
                        <span>🇬🇧 English</span>
                        <span id="langCheckEn" style="display: none;">✓</span>
                    </button>
                    <button class="photo-modal-btn" onclick="changeLanguage('de')" style="justify-content: space-between;">
                        <span>🇩🇪 Deutsch</span>
                        <span id="langCheckDe" style="display: none;">✓</span>
                    </button>
                    <button class="photo-modal-btn" onclick="changeLanguage('ru')" style="justify-content: space-between;">
                        <span>🇷🇺 Русский</span>
                        <span id="langCheckRu" style="display: none;">✓</span>
                    </button>
                </div>
                <button class="photo-modal-btn cancel" onclick="closeLanguageSelector()" style="margin-top: 20px;" data-i18n="cancel">İptal</button>
            </div>
        </div>

    </div>
    
    <!-- Bottom Navigation Bar (moved outside app-container to prevent overflow clipping) -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchSection('info')" data-section="info">
            <div class="nav-item-icon"><i data-lucide="info" class="icon icon-lg"></i></div>
            <div class="nav-item-label" data-i18n="info">Info</div>
        </button>
        <button class="nav-item" onclick="switchSection('activities')" data-section="activities">
            <div class="nav-item-icon"><i data-lucide="calendar-clock" class="icon icon-lg"></i></div>
            <div class="nav-item-label" data-i18n="activities">Aktiviteler</div>
        </button>
        <button class="nav-item" onclick="switchSection('reservations')" data-section="reservations">
            <div class="nav-item-icon"><i data-lucide="calendar" class="icon icon-lg"></i></div>
            <div class="nav-item-label" data-i18n="reservations">Rezervasyonlar</div>
        </button>
        <button class="nav-item" onclick="switchSection('chat')" data-section="chat">
            <div class="nav-item-icon"><i data-lucide="message-circle" class="icon icon-lg"></i></div>
            <div class="nav-item-label" data-i18n="chat">Chat</div>
        </button>
        <button class="nav-item" onclick="switchSection('map')" data-section="map">
            <div class="nav-item-icon"><i data-lucide="map" class="icon icon-lg"></i></div>
            <div class="nav-item-label" data-i18n="map">Harita</div>
        </button>
        <button class="nav-item" onclick="switchSection('settings')" data-section="settings">
            <div class="nav-item-icon"><i data-lucide="settings" class="icon icon-lg"></i></div>
            <div class="nav-item-label" data-i18n="settings">Settings</div>
        </button>
    </div>

    <!-- Photo Selection Modal -->
    <div class="photo-modal" id="photoModal" onclick="closePhotoModal(event)">
        <div class="photo-modal-content" onclick="event.stopPropagation()">
            <div class="photo-modal-title">Profil Fotoğrafı Seç</div>
            <div class="photo-modal-buttons">
                <button class="photo-modal-btn camera" onclick="event.stopPropagation(); takePhoto();">
                    <i data-lucide="camera" class="icon icon-md"></i> Fotoğraf Çek
                </button>
                <button class="photo-modal-btn gallery" onclick="event.stopPropagation(); selectFromGallery();">
                    <i data-lucide="image" class="icon icon-md"></i> Galeriden Seç
                </button>
                <button class="photo-modal-btn cancel" onclick="closePhotoModal()">
                    İptal
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden-input">
    <input type="file" id="galleryInput" accept="image/*" class="hidden-input">

    <script>
        // Configuration
        let ROOM_NUMBER = null;
        let GUEST_NAME = 'Misafir';
        let GUEST_SURNAME = null;
        let GUEST_UNIQUE_ID = null;
        let CHECKIN_DATE = null;
        let IS_AUTHENTICATED = false; // Session state
        let CHECKOUT_DATE = null;
        let TEAM_ID = null;
        const SERVER_URL = window.location.origin;

        // Check guest authentication
        async function checkGuestAuth() {
            try {
                const response = await fetch('/api/guest/me', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.guest) {
                        // Guest is logged in
                        GUEST_UNIQUE_ID = data.guest.guest_unique_id;
                        GUEST_NAME = data.guest.guest_name;
                        GUEST_SURNAME = data.guest.guest_surname;
                        CHECKIN_DATE = data.guest.checkin_date;
                        CHECKOUT_DATE = data.guest.checkout_date;
                        ROOM_NUMBER = data.guest.room_number;
                        TEAM_ID = data.guest.team_id;
                        
                        // Save to localStorage as backup
                        localStorage.setItem('guest_unique_id', GUEST_UNIQUE_ID);
                        localStorage.setItem('guest_name', GUEST_NAME);
                        localStorage.setItem('guest_surname', GUEST_SURNAME);
                        localStorage.setItem('checkin_date', CHECKIN_DATE);
                        localStorage.setItem('checkout_date', CHECKOUT_DATE);
                        if (ROOM_NUMBER) localStorage.setItem('room_number', ROOM_NUMBER);
                        if (TEAM_ID) localStorage.setItem('team_id', TEAM_ID);
                        
                        // Hide login, show app
                        document.getElementById('guestLoginContainer').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'flex';
                        
                        // Load guest info and initialize
                        await loadGuestInfo();
                        await initializeSocket();
                        return true;
                    }
                }
                
                // Not logged in (silently fail - this is expected on first load)
                document.getElementById('guestLoginContainer').style.display = 'flex';
                // document.getElementById('appContainer').style.display = 'none'; // Geçici olarak devre dışı - tasarım görmek için
                return false;
            } catch (error) {
                console.error('Auth check error:', error);
                document.getElementById('guestLoginContainer').style.display = 'flex';
                // document.getElementById('appContainer').style.display = 'none'; // Geçici olarak devre dışı - tasarım görmek için
                return false;
            }
        }

        // Handle guest login
        async function handleGuestLogin(event) {
            event.preventDefault();
            
            const name = document.getElementById('guestName').value.trim();
            const surname = document.getElementById('guestSurname').value.trim();
            const checkinDate = document.getElementById('checkinDate').value;
            const checkoutDate = document.getElementById('checkoutDate').value;
            const loginBtn = document.getElementById('guestLoginBtn');
            const loginError = document.getElementById('guestLoginError');
            
            // Clear previous error
            loginError.classList.remove('show');
            loginError.textContent = '';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Giriş yapılıyor...';
            
            try {
                const response = await fetch('/api/guest/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        surname: surname,
                        checkin_date: checkinDate,
                        checkout_date: checkoutDate
                    })
                });
                
                const data = await response.json();
                
                console.log('📋 Login response:', data);
                
                if (response.ok && data.success) {
                    // Login successful
                    IS_AUTHENTICATED = true;
                    GUEST_NAME = data.guest_name || name || 'Misafir';
                    GUEST_SURNAME = data.guest_surname || surname;
                    CHECKIN_DATE = data.checkin_date || checkinDate;
                    CHECKOUT_DATE = data.checkout_date || checkoutDate;
                    ROOM_NUMBER = data.room_number || null;
                    TEAM_ID = data.team_id || null;
                    
                    // Get or generate guest_unique_id
                    GUEST_UNIQUE_ID = data.guest_unique_id;
                    if (!GUEST_UNIQUE_ID) {
                        // Generate unique ID using the same algorithm as backend
                        console.log('🔧 Backend did not return guest_unique_id, generating...');
                        GUEST_UNIQUE_ID = await generateGuestUniqueId(GUEST_NAME, GUEST_SURNAME, CHECKIN_DATE, CHECKOUT_DATE);
                        console.log('✅ Generated GUEST_UNIQUE_ID:', GUEST_UNIQUE_ID);
                    } else {
                        console.log('✅ Guest Unique ID from backend:', GUEST_UNIQUE_ID);
                    }
                    
                    // Save to localStorage
                    if (GUEST_UNIQUE_ID) {
                        localStorage.setItem('guest_unique_id', GUEST_UNIQUE_ID);
                    }
                    localStorage.setItem('guest_name', GUEST_NAME);
                    localStorage.setItem('guest_surname', GUEST_SURNAME);
                    localStorage.setItem('checkin_date', CHECKIN_DATE);
                    localStorage.setItem('checkout_date', CHECKOUT_DATE);
                    if (ROOM_NUMBER) localStorage.setItem('room_number', ROOM_NUMBER);
                    if (TEAM_ID) localStorage.setItem('team_id', TEAM_ID);
                    
                    // Update navigation visibility
                    updateNavigationVisibility();
                    
                    // Hide login, show app
                    document.getElementById('guestLoginContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'flex';
                    
                    // Load guest info and initialize
                    await loadGuestInfo();
                    
                    // Initialize socket connection after guest info is loaded
                    await initializeSocket();
                } else {
                    // Login failed
                    loginError.textContent = data.error || 'Giriş başarısız. Lütfen bilgilerinizi kontrol edin.';
                    loginError.classList.add('show');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Giriş Yap';
                        }
                    } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'Bir hata oluştu. Lütfen tekrar deneyin.';
                loginError.classList.add('show');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Giriş Yap';
            }
        }

        // Generate guest unique ID (same algorithm as backend)
        async function generateGuestUniqueId(guestName, guestSurname, checkinDate, checkoutDate) {
            if (!checkinDate) {
                return null;
            }
            
            // Normalize inputs - use 'Guest' if name is not provided
            const name = (guestName || guestSurname || 'Guest').trim().toLowerCase().replace(/\s+/g, '_');
            const surname = (guestSurname || '').trim().toLowerCase().replace(/\s+/g, '_');
            
            // Normalize dates
            let checkin = '';
            if (checkinDate instanceof Date) {
                checkin = checkinDate.toISOString().split('T')[0];
            } else if (checkinDate) {
                checkin = String(checkinDate).split('T')[0];
            }
            
            let checkout = '';
            if (checkoutDate instanceof Date) {
                checkout = checkoutDate.toISOString().split('T')[0];
            } else if (checkoutDate) {
                checkout = String(checkoutDate).split('T')[0];
            }
            
            // Create unique ID: name_surname_checkin_checkout (hash for uniqueness)
            const combined = checkout 
                ? `${name}_${surname}_${checkin}_${checkout}`
                : `${name}_${surname}_${checkin}`;
            
            // Use Web Crypto API to create SHA256 hash (same as backend)
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(combined);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
                
                return checkout 
                    ? `${name}_${surname}_${checkin}_${checkout}_${hash}`
                    : `${name}_${surname}_${checkin}_${hash}`;
            } catch (error) {
                console.error('Error generating hash:', error);
                // Fallback to simple hash if crypto API fails
                function simpleHash(str) {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        const char = str.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return Math.abs(hash).toString(16).substring(0, 16);
                }
                const hash = simpleHash(combined);
                return checkout 
                    ? `${name}_${surname}_${checkin}_${checkout}_${hash}`
                    : `${name}_${surname}_${checkin}_${hash}`;
            }
        }

        // Load guest info after login
        let guestInfoLoaded = false;
        
        async function loadGuestInfo() {
            console.log('🔍 Loading guest info...', { GUEST_UNIQUE_ID, GUEST_NAME, GUEST_SURNAME, CHECKIN_DATE, CHECKOUT_DATE });
            
            // If GUEST_UNIQUE_ID is null but we have other info, generate it
            if (!GUEST_UNIQUE_ID && GUEST_NAME && CHECKIN_DATE) {
                console.log('🔧 GUEST_UNIQUE_ID is null, generating from available info...');
                
                // Try to get from localStorage first
                const storedId = localStorage.getItem('guest_unique_id');
                if (storedId) {
                    GUEST_UNIQUE_ID = storedId;
                    console.log('✅ Restored GUEST_UNIQUE_ID from localStorage:', GUEST_UNIQUE_ID);
                } else {
                    // Generate unique ID using the same algorithm as backend
                    GUEST_UNIQUE_ID = await generateGuestUniqueId(GUEST_NAME, GUEST_SURNAME, CHECKIN_DATE, CHECKOUT_DATE);
                    if (GUEST_UNIQUE_ID) {
                        console.log('✅ Generated GUEST_UNIQUE_ID:', GUEST_UNIQUE_ID);
                        localStorage.setItem('guest_unique_id', GUEST_UNIQUE_ID);
                    } else {
                        console.error('❌ Failed to generate GUEST_UNIQUE_ID');
                    }
                }
            }
            
            if (!GUEST_UNIQUE_ID || !CHECKIN_DATE) {
                console.error('❌ Missing guest info:', { GUEST_UNIQUE_ID, CHECKIN_DATE });
                return false;
            }
            
            try {
                // Update header with guest info
                updateGuestHeader();
                
                // Load profile photo (uses GUEST_UNIQUE_ID)
                await loadProfilePhoto();
                
                // Load team avatar if team ID exists
                if (TEAM_ID) {
                    await loadTeamAvatar();
                }
                
                guestInfoLoaded = true;
                return true;
            } catch (error) {
                console.error('❌ Error loading guest info:', error);
                return false;
            }
        }

        // Update guest header with info
        function updateGuestHeader() {
            const hotelName = document.querySelector('.hotel-name');
            const statusText = document.getElementById('statusText');
            const headerPhoto = document.getElementById('headerProfilePhoto');
            const headerHotelIcon = document.querySelector('.header-left .hotel-icon'); // New: Select the hotel icon
            
            if (hotelName) {
                hotelName.textContent = `${GUEST_NAME} ${GUEST_SURNAME || ''}`.trim() || 'Misafir';
            }
            
            if (statusText) {
                statusText.textContent = GUEST_UNIQUE_ID ? `ID: ${GUEST_UNIQUE_ID.substring(0, 16)}...` : t('connecting');
            }
            
            // Update header hotel icon with team avatar if available
            if (teamAvatar && headerHotelIcon) {
                headerHotelIcon.innerHTML = `<img src="${teamAvatar}" alt="Takım" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                headerHotelIcon.style.background = 'transparent'; // Remove default background
            } else if (headerHotelIcon) {
                headerHotelIcon.innerHTML = '<i data-lucide="building-2" class="icon icon-md"></i>'; // Default icon
                headerHotelIcon.style.background = ''; // Restore default background
            }
            
            // Update header profile photo: prioritize guest profile photo, fallback to team avatar
            if (headerPhoto) {
                // Remove existing click listeners
                const newHeaderPhoto = headerPhoto.cloneNode(true);
                headerPhoto.parentNode.replaceChild(newHeaderPhoto, headerPhoto);
                const updatedHeaderPhoto = document.getElementById('headerProfilePhoto');
                
                if (guestProfilePhoto) {
                    // Show guest's own profile photo
                    updatedHeaderPhoto.innerHTML = `<img src="${guestProfilePhoto}" alt="Profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    updatedHeaderPhoto.classList.add('has-photo');
                    updatedHeaderPhoto.setAttribute('onclick', 'showPhotoModal()');
                    updatedHeaderPhoto.title = 'Profil fotoğrafı değiştir';
                    updatedHeaderPhoto.style.cursor = 'pointer';
                } else if (teamAvatar) {
                    // Fallback to team avatar if guest has no profile photo
                    updatedHeaderPhoto.innerHTML = `<img src="${teamAvatar}" alt="Takım" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    updatedHeaderPhoto.classList.add('has-photo');
                    updatedHeaderPhoto.setAttribute('onclick', 'showPhotoModal()');
                    updatedHeaderPhoto.title = 'Profil fotoğrafı değiştir';
                    updatedHeaderPhoto.style.cursor = 'pointer';
                } else {
                    // Default icon
                    updatedHeaderPhoto.innerHTML = '<i data-lucide="user" class="icon icon-md"></i>';
                    updatedHeaderPhoto.classList.remove('has-photo');
                    updatedHeaderPhoto.setAttribute('onclick', 'showPhotoModal()');
                    updatedHeaderPhoto.title = 'Profil fotoğrafı değiştir';
                    updatedHeaderPhoto.style.cursor = 'pointer';
                }
            }
        }

        // Profile Photo Management
        let guestProfilePhoto = null;
        let teamAvatar = null;

        // Load profile photo from backend
        async function loadProfilePhoto() {
            if (!GUEST_UNIQUE_ID) {
                console.warn('⚠️ Cannot load profile photo: GUEST_UNIQUE_ID not set');
                return;
            }
            
            // Use guest-specific localStorage key
            const storageKey = `guestProfilePhoto_${GUEST_UNIQUE_ID}`;
            
            try {
                console.log('📸 Loading profile photo for guest:', GUEST_UNIQUE_ID);
                // First try backend - use guest_unique_id
                const response = await fetch(`/api/guests/${GUEST_UNIQUE_ID}/profile-photo`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.profilePhoto) {
                        guestProfilePhoto = data.profilePhoto;
                        // Save to localStorage with guest-specific key
                        localStorage.setItem(storageKey, guestProfilePhoto);
                        updateProfilePhotoDisplay();
                        console.log('✅ Profile photo loaded from backend');
                        return;
                    } else {
                        console.log('ℹ️ No profile photo for this room');
                        // Clear any old cached photo for this guest
                        localStorage.removeItem(storageKey);
                    }
                } else {
                    console.warn('⚠️ Profile photo response not OK:', response.status);
                }
                
                // Fallback to localStorage (guest-specific key)
                const savedPhoto = localStorage.getItem(storageKey);
                if (savedPhoto) {
                    guestProfilePhoto = savedPhoto;
                    updateProfilePhotoDisplay();
                    console.log('✅ Profile photo loaded from localStorage');
                } else {
                    // Clear guestProfilePhoto variable if no photo found
                    guestProfilePhoto = null;
                    updateProfilePhotoDisplay();
                }
            } catch (error) {
                console.warn('⚠️ Error loading profile photo (non-critical):', error.message);
                // Fallback to localStorage (guest-specific key)
                const savedPhoto = localStorage.getItem(storageKey);
                if (savedPhoto) {
                    guestProfilePhoto = savedPhoto;
                    updateProfilePhotoDisplay();
                } else {
                    guestProfilePhoto = null;
                    updateProfilePhotoDisplay();
                }
            }
        }

        // Save profile photo to backend
        async function saveProfilePhotoToBackend(photoData) {
            try {
                // Ensure GUEST_UNIQUE_ID is set
                let guestUniqueId = GUEST_UNIQUE_ID;
                if (!guestUniqueId) {
                    // Try to restore from localStorage
                    guestUniqueId = localStorage.getItem('guest_unique_id');
                    if (guestUniqueId) {
                        GUEST_UNIQUE_ID = guestUniqueId;
                        console.log('✅ Restored GUEST_UNIQUE_ID from localStorage:', guestUniqueId);
                    } else if (GUEST_NAME && CHECKIN_DATE) {
                        // Generate unique ID if we have the required info
                        guestUniqueId = await generateGuestUniqueId(GUEST_NAME, GUEST_SURNAME, CHECKIN_DATE, CHECKOUT_DATE);
                        if (guestUniqueId) {
                            GUEST_UNIQUE_ID = guestUniqueId;
                            localStorage.setItem('guest_unique_id', guestUniqueId);
                            console.log('✅ Generated GUEST_UNIQUE_ID for profile photo:', guestUniqueId);
                        }
                    }
                }
                
                if (!guestUniqueId) {
                    console.error('❌ Cannot save profile photo: GUEST_UNIQUE_ID is not set');
                    return false;
                }
                
                console.log('📤 Saving profile photo to backend for guest:', guestUniqueId);
                console.log('📤 Photo data size:', photoData ? photoData.length : 0, 'bytes');
                
                const response = await fetch(`/api/guests/${guestUniqueId}/profile-photo`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ profilePhoto: photoData })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Profile photo saved to backend:', result);
                    return true;
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('❌ Failed to save profile photo to backend:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: errorData
                    });
                    return false;
                }
            } catch (error) {
                console.error('❌ Error saving profile photo to backend:', error);
                console.error('❌ Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                return false;
            }
        }

        // Load team avatar from backend
        async function loadTeamAvatar() {
            if (!TEAM_ID) {
                console.warn('⚠️ Cannot load team avatar: TEAM_ID not set');
                return;
            }
            
            try {
                console.log('📸 Loading team avatar for team:', TEAM_ID);
                const response = await fetch(`${SERVER_URL}/api/teams/${TEAM_ID}`);
                
                if (!response.ok) {
                    console.warn('⚠️ Failed to load team avatar:', response.status);
                    return;
                }
                
                const team = await response.json();
                if (team.avatar) {
                    teamAvatar = team.avatar;
                    console.log('✅ Team avatar loaded:', teamAvatar);
                    
                    // Update header with team avatar
                    updateGuestHeader();
                    
                    // Update all received message avatars
                    updateTeamAvatarDisplay();
            } else {
                    console.log('ℹ️ Team has no avatar');
                }
            } catch (error) {
                console.error('❌ Error loading team avatar:', error);
            }
        }
        
        // Update team avatar display in messages
        function updateTeamAvatarDisplay() {
            if (!teamAvatar) return;
            
            // Update all received message avatars (not sent messages)
            const receivedMessages = document.querySelectorAll('.message:not(.sent) .message-avatar');
            receivedMessages.forEach(avatar => {
                avatar.innerHTML = `<img src="${teamAvatar}" alt="Takım" style="width:100%;height:100%;object-fit:cover;">`;
            });
        }

        // Update profile photo display in header and messages
        function updateProfilePhotoDisplay() {
            // Update header using updateGuestHeader which handles both guest photo and team avatar
            updateGuestHeader();
            
            // Update all sent message avatars
            const sentAvatars = document.querySelectorAll('.message.sent .message-avatar');
            sentAvatars.forEach(avatar => {
                if (guestProfilePhoto) {
                    avatar.innerHTML = `<img src="${guestProfilePhoto}" alt="Profil" style="width:100%;height:100%;object-fit:cover;">`;
                } else {
                    avatar.innerHTML = '<i data-lucide="user" class="icon icon-md"></i>';
                }
            });
            
            // Update profile section avatar
            const profileAvatarLargeEl = document.getElementById('profileAvatarLarge');
            if (profileAvatarLargeEl) {
                if (guestProfilePhoto) {
                    profileAvatarLargeEl.innerHTML = `<img src="${guestProfilePhoto}" alt="Profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    profileAvatarLargeEl.innerHTML = '<i data-lucide="user" class="icon icon-xl"></i>';
                }
            }
            
            console.log('✅ Profile photo display updated');
        }

        // Show photo selection modal
        function showPhotoModal() {
            document.getElementById('photoModal').classList.add('active');
        }

        // Close photo modal
        function closePhotoModal(event) {
            if (!event || event.target.id === 'photoModal') {
                document.getElementById('photoModal').classList.remove('active');
            }
        }

        // Take photo from camera
        function takePhoto() {
            const input = document.getElementById('cameraInput');
            if (input) {
                // Close modal first
                const modal = document.getElementById('photoModal');
                if (modal) {
                    modal.classList.remove('active');
                }
                // Use requestAnimationFrame to ensure modal is closed before opening camera
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        input.click();
                    });
                });
            }
        }

        // Select from gallery
        function selectFromGallery() {
            const input = document.getElementById('galleryInput');
            if (input) {
                console.log('🖼️ Opening gallery...');
                // Close modal first
                const modal = document.getElementById('photoModal');
                if (modal) {
                    modal.classList.remove('active');
                }
                // Use requestAnimationFrame to ensure modal is closed before opening file picker
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        try {
                            input.click();
                            console.log('✅ Gallery input clicked');
                        } catch (error) {
                            console.error('❌ Error opening gallery:', error);
                        }
                    });
                });
            } else {
                console.error('❌ Gallery input element not found');
            }
        }

        // Resize image to optimal size for profile photo
        function resizeImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to base64
                        const resizedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(resizedDataUrl);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Handle photo selection
        async function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                try {
                    // Ensure GUEST_UNIQUE_ID is set before saving
                    if (!GUEST_UNIQUE_ID) {
                        const storedId = localStorage.getItem('guest_unique_id');
                        if (storedId) {
                            GUEST_UNIQUE_ID = storedId;
                            console.log('✅ Restored GUEST_UNIQUE_ID from localStorage:', storedId);
                        } else {
                            console.error('❌ Cannot save profile photo: Guest not logged in');
                            alert('Profil fotoğrafı kaydedilemedi. Lütfen önce giriş yapın.');
                            return;
                        }
                    }
                    
                    // Resize image to 400x400 max (profile photo size)
                    const resizedPhoto = await resizeImage(file, 400, 400, 0.9);
                    guestProfilePhoto = resizedPhoto;
                    
                    // Save to localStorage with guest-specific key
                    if (GUEST_UNIQUE_ID) {
                        localStorage.setItem(`guestProfilePhoto_${GUEST_UNIQUE_ID}`, guestProfilePhoto);
                    }
                    
                    // Save to backend
                    const saved = await saveProfilePhotoToBackend(resizedPhoto);
                    if (!saved) {
                        console.warn('⚠️ Failed to save to backend, using localStorage only');
                    }
                    
                    updateProfilePhotoDisplay();
                    closePhotoModal();
                    console.log('✅ Profile photo updated');
                } catch (error) {
                    console.error('❌ Error processing photo:', error);
                    alert('Fotoğraf işlenirken bir hata oluştu. Lütfen tekrar deneyin.');
                }
            }
            // Reset input
            event.target.value = '';
        }

        // Socket.IO Connection - Wait for guest info to load first
        let socket = null;
        let isTyping = false;
        let typingTimeout;

        // Initialize socket after guest info is loaded
        async function initializeSocket() {
            console.log('🚀 ========== SOCKET INITIALIZATION START ==========');
            
            // Ensure guest is authenticated
            if (!GUEST_UNIQUE_ID) {
                console.log('ℹ️ Guest not authenticated, cannot initialize socket');
                return;
            }
            
            console.log('📋 Step 1: Guest info loaded');
            console.log('📋 Guest Unique ID:', GUEST_UNIQUE_ID);
            console.log('📋 Room Number:', ROOM_NUMBER);
            console.log('📋 Guest Name:', GUEST_NAME);
            console.log('📋 Team ID:', TEAM_ID);
            
            if (!CHECKIN_DATE) {
                console.error('❌ Check-in date not available');
                return;
            }
            
            // If GUEST_UNIQUE_ID is null, try to get from localStorage or generate from available info
            if (!GUEST_UNIQUE_ID) {
                const storedId = localStorage.getItem('guest_unique_id');
                if (storedId) {
                    GUEST_UNIQUE_ID = storedId;
                    console.log('✅ Restored GUEST_UNIQUE_ID from localStorage:', GUEST_UNIQUE_ID);
                } else {
                    console.warn('⚠️ GUEST_UNIQUE_ID is null, but continuing with socket connection');
                }
            }
            
            console.log('🔌 Step 3: Initializing socket');
            console.log('🔌 Room:', ROOM_NUMBER);
            console.log('🔌 Server URL:', SERVER_URL);
            console.log('🔌 User Agent:', navigator.userAgent);
            
            // Detect mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            console.log('📱 Step 4: Device detection');
            console.log('📱 Is mobile device:', isMobile);
            console.log('📱 Screen size:', window.innerWidth + 'x' + window.innerHeight);
            
            // Now create socket connection
            // Mobile devices: prefer polling, then websocket
            // Desktop: prefer websocket, then polling
            const socketOptions = {
                transports: isMobile ? ['polling', 'websocket'] : ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 10,
                timeout: 20000,
                forceNew: false,
                upgrade: true
            };
            console.log('📱 Socket options:', JSON.stringify(socketOptions, null, 2));
            
            console.log('🔌 Step 5: Creating socket connection...');
            socket = io(SERVER_URL, socketOptions);
            console.log('🔌 Socket object created:', !!socket);
            
            // Connection Events
            socket.on('connect', () => {
                console.log('✅ ========== CONNECTION SUCCESS ==========');
                console.log('✅ Socket ID:', socket.id);
                console.log('✅ Transport:', socket.io.engine.transport.name);
                console.log('✅ Engine ID:', socket.io.engine.id);
                console.log('✅ Connected at:', new Date().toISOString());
                
                const statusText = document.getElementById('statusText');
                if (statusText) {
                    statusText.textContent = t('online');
                }
                
                // Initialize message observer for read status
                setTimeout(() => {
                    initMessageObserver();
                }, 500);
                
                // Önceki join_room'u kontrol et - duplicate join'leri önle
                if (!socket._hasJoinedRoom) {
                    console.log('📤 Step 6: Emitting join_room');
                    console.log('📤 Guest Unique ID:', GUEST_UNIQUE_ID);
                    socket.emit('join_room', {
                        guestUniqueId: GUEST_UNIQUE_ID
                    });
                    socket._hasJoinedRoom = true;
                    console.log('📤 join_room event emitted');
                } else {
                    console.log('ℹ️ Already joined room, skipping duplicate join');
                }
            });

            // Connection attempt started
            socket.on('connect_attempt', (attemptNumber) => {
                console.log('🔄 ========== CONNECTION ATTEMPT ==========');
                console.log('🔄 Attempt number:', attemptNumber || 1);
                console.log('🔄 Time:', new Date().toISOString());
                console.log('🔄 Server URL:', SERVER_URL);
                const statusText = document.getElementById('statusText');
                if (statusText) {
                    statusText.textContent = t('connecting');
                }
            });

            socket.on('disconnect', (reason) => {
                console.log('❌ Disconnected from server, reason:', reason);
                // Disconnect olduğunda join flag'ini sıfırla
                if (socket) {
                    socket._hasJoinedRoom = false;
                }
                const statusText = document.getElementById('statusText');
                if (statusText) {
                    if (reason === 'io server disconnect') {
                        statusText.textContent = t('serverDisconnected');
                    } else if (reason === 'io client disconnect') {
                        statusText.textContent = t('connectionLost');
                    } else {
                        statusText.textContent = t('reconnecting');
                    }
                }
            });

            socket.on('connect_error', (error) => {
                console.error('❌ ========== CONNECTION ERROR ==========');
                console.error('❌ Error object:', error);
                console.error('❌ Error type:', error.type);
                console.error('❌ Error message:', error.message);
                console.error('❌ Error description:', error.description);
                console.error('❌ Error context:', error.context);
                console.error('❌ Time:', new Date().toISOString());
                console.error('❌ Server URL:', SERVER_URL);
                console.error('❌ Socket connected:', socket.connected);
                console.error('❌ Socket disconnected:', socket.disconnected);
                
                const statusText = document.getElementById('statusText');
                if (statusText) {
                    statusText.textContent = `${t('connectionError')}: ${error.message || t('unknownError')}`;
                }
            });

            socket.on('reconnect', (attemptNumber) => {
                console.log('🔄 Reconnected after', attemptNumber, 'attempts');
                const statusText = document.getElementById('statusText');
                if (statusText) {
                    statusText.textContent = t('online');
                }
                socket.emit('join_room', {
                    guestUniqueId: GUEST_UNIQUE_ID
                });
            });

            socket.on('reconnect_error', (error) => {
                console.error('❌ Reconnection error:', error);
            });

            socket.on('reconnect_failed', () => {
                console.error('❌ Reconnection failed');
                const statusText = document.getElementById('statusText');
                if (statusText) {
                    statusText.textContent = t('connectionFailed');
                }
            });

            // Timeout kontrolü - 20 saniye içinde bağlanmazsa hata göster (mobil için daha uzun)
            let connectionTimeout = setTimeout(() => {
                if (socket && !socket.connected) {
                    console.error('❌ Connection timeout - socket not connected after 20 seconds');
                    const statusText = document.getElementById('statusText');
                    if (statusText) {
                        statusText.textContent = t('connectionTimeout');
                    }
                    // Retry connection
                    console.log('🔄 Retrying connection...');
                    socket.connect();
                }
            }, 20000);

            // Bağlantı başarılı olunca timeout'u temizle
            socket.once('connect', () => {
                clearTimeout(connectionTimeout);
            });

            // Load chat history
            socket.on('chat_history', (messages) => {
                console.log('📜 ========== CHAT HISTORY RECEIVED ==========');
                console.log('📜 Message count:', messages.length);
                console.log('📜 Time:', new Date().toISOString());
                if (messages.length > 0) {
                    console.log('📜 First message:', {
                        sender: messages[0].senderName,
                        type: messages[0].senderType,
                        preview: messages[0].message.substring(0, 50)
                    });
                }
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = '';
                
                // Ensure profile photo is loaded before displaying messages
                if (!guestProfilePhoto) {
                    loadProfilePhoto();
                }
                
                if (messages.length === 0) {
                    // Show welcome message
                    addWelcomeMessage();
                    oldestMessageTimestamp = null;
                    
                    // Initialize observer after welcome message
                    setTimeout(() => {
                        initMessageObserver();
                    }, 300);
                } else {
                    messages.forEach(msg => {
                        // Verify senderType is correct
                        const senderType = (msg.senderType || '').toString().toLowerCase().trim();
                        const isSent = senderType === 'guest';
                        console.log('📨 Loading message:', {
                            senderType: msg.senderType,
                            normalized: senderType,
                            isSent: isSent,
                            status: msg.status,
                            preview: msg.message.substring(0, 20)
                        });
                        displayMessage(msg, isSent);
                    });
                    
                    // Set oldest message timestamp for pagination
                    oldestMessageTimestamp = messages[0].timestamp;
                    
                    // Initialize observer after messages loaded
                    setTimeout(() => {
                        initMessageObserver();
                    }, 300);
                    
                    // Fix alignment for all messages after loading - use multiple checks
                    setTimeout(() => {
                        fixMessageAlignment();
                    }, 50);
                    
                    // Double-check after a bit more time (for slow rendering)
                    setTimeout(() => {
                        fixMessageAlignment();
                    }, 300);
                    
                    // Final check after scroll
                    setTimeout(() => {
                        scrollToBottom();
                        fixMessageAlignment();
                    }, 500);
                }
                
                scrollToBottom();
                
                // Setup scroll listener for loading older messages
                setupScrollListener();
            });

            // New message from server
            socket.on('new_message', (data) => {
                console.log('📨 New message:', data);
                
                // Check if this message already exists (optimistic update)
                const existingMessage = document.querySelector(`[data-message-id="${data.id}"]`);
                const isSent = (data.senderType || '').toString().toLowerCase().trim() === 'guest';
                
                // If this is a message we sent, check if we already showed it optimistically
                if (isSent) {
                    // Find temp message with same content
                    const tempMessages = document.querySelectorAll(`[data-message-id^="temp_"]`);
                    let tempMessageEl = null;
                    
                    for (const tempMsg of tempMessages) {
                        const messageText = tempMsg.querySelector('.message-text')?.textContent || '';
                        if (messageText.includes(data.message.substring(0, 20))) {
                            tempMessageEl = tempMsg;
                            break;
                        }
                    }
                    
                    if (tempMessageEl && !existingMessage) {
                        // Update the temp message with real ID
                        tempMessageEl.setAttribute('data-message-id', data.id);
                        
                        // Update status - use data.status if available, otherwise default to 'sent'
                        const status = data.status || 'sent';
                        const statusEl = tempMessageEl.querySelector('.message-status');
                        if (statusEl) {
                            statusEl.classList.remove('sent', 'delivered', 'read');
                            statusEl.classList.add(status);
                            console.log('✅ Updated temp message status to:', status);
                        }
                        
                        // Don't mark as delivered here - this is our own message
                        return; // Don't add duplicate message
                    }
                }
                
                // If message doesn't exist, add it
                if (!existingMessage) {
                    // If this is a message we RECEIVED (not sent), mark it as delivered
                    if (!isSent) {
                        console.log('📬 Guest received message, emitting message_delivered:', data.id);
                        socket.emit('message_delivered', { messageId: data.id });
                    }
                    
                    displayMessage(data, !isSent);
                    scrollToBottom();
                }
                
                // Send notification if message is from staff/hotel and page is not visible
                if (data.senderType !== 'guest' && document.hidden) {
                    sendNotification(data);
                } else if (data.senderType !== 'guest') {
                    // Even if page is visible, show notification if permission granted
                    if (Notification.permission === 'granted') {
                        sendNotification(data);
                    }
                }
            });
            
            // Message sent confirmation
            socket.on('message_sent', (data) => {
                updateMessageStatus(data.messageId, 'sent');
            });
            
            // Message status update (delivered/read)
            socket.on('message_status_update', (data) => {
                console.log('📬 ========== message_status_update received ==========');
                console.log('📬 Full data:', JSON.stringify(data, null, 2));
                
                if (data.messageIds && Array.isArray(data.messageIds)) {
                    // Multiple messages (read status)
                    console.log('📬 Updating multiple messages to read:', data.messageIds);
                    data.messageIds.forEach(msgId => {
                        updateMessageStatus(msgId, data.status);
                    });
                } else if (data.messageId) {
                    // Single message (delivered status)
                    console.log('📬 Updating single message to delivered:', data.messageId);
                    updateMessageStatus(data.messageId, data.status);
                } else {
                    console.error('⚠️ message_status_update: No messageId or messageIds found:', data);
                }
                
                console.log('📬 ========== message_status_update handling complete ==========');
            });

            // Typing indicators
            socket.on('user_typing', (data) => {
                const indicator = document.getElementById('typingIndicator');
                indicator.classList.add('active');
            });

            socket.on('user_stopped_typing', () => {
                const indicator = document.getElementById('typingIndicator');
                indicator.classList.remove('active');
            });

            // Handle older messages from server
            socket.on('older_messages', (messages) => {
                console.log('📜 ========== OLDER MESSAGES RECEIVED ==========');
                console.log('📜 Message count:', messages.length);
                const chatContainerEl = document.getElementById('chatContainer');
                const loadingIndicator = document.getElementById('loadingOlder');
                
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }

                if (messages.length === 0) {
                    isLoadingOlderMessages = false;
                    // Show "No more messages" indicator
                    const noMoreIndicator = document.createElement('div');
                    noMoreIndicator.style.textAlign = 'center';
                    noMoreIndicator.style.padding = '10px';
                    noMoreIndicator.style.color = '#667781';
                    noMoreIndicator.textContent = 'Daha eski mesaj yok';
                    if (chatContainerEl) {
                        chatContainerEl.insertBefore(noMoreIndicator, chatContainerEl.firstChild);
                    }
                    return;
                }

                // Store previous scroll height before adding messages
                const previousScrollHeight = chatContainerEl ? chatContainerEl.scrollHeight : 0;

                // Add messages to the top
                messages.forEach(msg => {
                    displayMessage(msg, false);
                });

                // Restore scroll position
                if (chatContainerEl) {
                    const newScrollHeight = chatContainerEl.scrollHeight;
                    chatContainerEl.scrollTop = newScrollHeight - previousScrollHeight;
                }

                // Update oldest message timestamp
                if (messages.length > 0) {
                    oldestMessageTimestamp = messages[0].timestamp;
                }
                isLoadingOlderMessages = false;
                console.log('✅ Loaded', messages.length, 'older messages');
            });
        }

        // Fix message alignment - ensure all sent messages have correct class and alignment
        function fixMessageAlignment() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            const allMessages = chatContainer.querySelectorAll('.message');
            let fixedCount = 0;

            allMessages.forEach((messageEl) => {
                // Get senderType from data attribute (most reliable)
                const senderType = messageEl.getAttribute('data-sender-type') || '';
                const isSentAttr = messageEl.getAttribute('data-is-sent');
                const isSent = isSentAttr === 'true' || senderType.toLowerCase().trim() === 'guest';
                
                if (isSent) {
                    // This is a sent message - must be right-aligned
                    if (!messageEl.classList.contains('sent')) {
                        messageEl.classList.add('sent');
                        fixedCount++;
                    }
                    // Force right alignment
                    messageEl.style.setProperty('margin-left', 'auto', 'important');
                    messageEl.style.setProperty('margin-right', '0', 'important');
                    messageEl.style.setProperty('justify-content', 'flex-end', 'important');
                    messageEl.style.setProperty('flex-direction', 'row-reverse', 'important');
                } else {
                    // This is a received message - must be left-aligned
                    if (messageEl.classList.contains('sent')) {
                        messageEl.classList.remove('sent');
                        fixedCount++;
                    }
                    // Force left alignment
                    messageEl.style.setProperty('margin-left', '0', 'important');
                    messageEl.style.setProperty('margin-right', 'auto', 'important');
                    messageEl.style.setProperty('justify-content', 'flex-start', 'important');
                    messageEl.style.setProperty('flex-direction', 'row', 'important');
                }
            });

            if (fixedCount > 0) {
                console.log(`✅ Fixed alignment for ${fixedCount} messages`);
            }
        }

        // Display message
        function displayMessage(data, animate) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) {
                console.error('Chat container not found');
                return;
            }
            
            // Ensure senderType is correctly identified - normalize to lowercase and trim
            const senderType = (data.senderType || '').toString().toLowerCase().trim();
            const isSent = senderType === 'guest';
            
            // Debug: Log senderType to help troubleshoot
            if (data.senderType !== senderType) {
                console.warn('⚠️ senderType normalized:', data.senderType, '→', senderType);
            }
            const time = formatTime(data.timestamp);
            
            // Debug log for troubleshooting
            if (isSent) {
                console.log('✅ Sent message detected:', data.message.substring(0, 30));
            }
            
            // Get avatar HTML - use current guestProfilePhoto variable
            let avatarHTML = '';
            if (isSent) {
                // Use current guestProfilePhoto (loaded from backend or localStorage)
                if (guestProfilePhoto) {
                    avatarHTML = `<div class="message-avatar"><img src="${guestProfilePhoto}" alt="Profil" style="width:100%;height:100%;object-fit:cover;"></div>`;
                } else {
                    avatarHTML = '<div class="message-avatar"><i data-lucide="user" class="icon icon-md"></i></div>';
                }
            } else {
                // Not sent - it's from hotel/staff - prioritize assistant avatar, then team avatar, then VOYAGE HOTELS logo
                if (data.assistantAvatar) {
                    // Use assistant's specific avatar if provided
                    avatarHTML = `<div class="message-avatar"><img src="${data.assistantAvatar}" alt="Asistan" style="width:100%;height:100%;object-fit:cover;"></div>`;
                } else if (teamAvatar) {
                    // Fallback to team avatar if assistant avatar not available
                    avatarHTML = `<div class="message-avatar"><img src="${teamAvatar}" alt="Takım" style="width:100%;height:100%;object-fit:cover;"></div>`;
                } else {
                    // Final fallback to VOYAGE HOTELS logo
                avatarHTML = `<div class="message-avatar">
                    <div class="voyage-logo">
                        <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                            <rect x="2" y="2" width="116" height="56" fill="none" stroke="#8B0000" stroke-width="1.5" rx="2"/>
                            <text x="60" y="22" font-family="Arial, sans-serif" font-size="18" font-weight="600" fill="#8B0000" text-anchor="middle" letter-spacing="1">VOYAGE</text>
                            <text x="60" y="42" font-family="Arial, sans-serif" font-size="10" font-weight="500" fill="#8B0000" text-anchor="middle" letter-spacing="0.5">HOTELS</text>
                            <line x1="30" y1="38" x2="35" y2="38" stroke="#8B0000" stroke-width="1"/>
                            <line x1="85" y1="38" x2="90" y2="38" stroke="#8B0000" stroke-width="1"/>
                        </svg>
                    </div>
                </div>`;
                }
            }
            
            // Ensure 'sent' class is applied correctly
            const sentClass = isSent ? 'sent' : '';
            
            // Build inline style for alignment
            let inlineStyle = '';
            if (isSent) {
                inlineStyle = 'margin-left: auto !important; margin-right: 0 !important;';
            } else {
                inlineStyle = 'margin-left: 0 !important; margin-right: auto !important;';
            }
            
            if (animate) {
                inlineStyle += ' animation: messageSlide 0.3s ease;';
            }
            
            // Status HTML (ONLY for sent messages - WhatsApp style)
            let statusHTML = '';
            if (isSent) {
                const status = data.status || 'sent';
                const statusClass = status === 'read' ? 'read' : 
                                   status === 'delivered' ? 'delivered' : 'sent';
                
                statusHTML = `
                    <span class="message-status ${statusClass}">
                        <span class="message-status-icon"></span>
                    </span>
                `;
            }
            
            // Add data attribute to track senderType for reliable alignment fixing
            const messageHTML = `
                <div class="message ${sentClass}" style="${inlineStyle}" data-sender-type="${senderType}" data-is-sent="${isSent}" data-message-id="${data.id}">
                    ${avatarHTML}
                    <div class="message-content">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(data.message)}</div>
                        </div>
                        <div class="message-time">${time}${statusHTML}</div>
                    </div>
                </div>
            `;
            
            // prepend parameter: true = add to top, false = add to bottom
            const prepend = arguments[2] || false;
            
            if (prepend) {
                // Insert at the beginning (for older messages)
                chatContainer.insertAdjacentHTML('afterbegin', messageHTML);
            } else {
                // Insert at the end (for new messages)
                chatContainer.insertAdjacentHTML('beforeend', messageHTML);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // Observe new message for read status
            if (messageObserver) {
                const messageEl = chatContainer.querySelector(`[data-message-id="${data.id}"]`);
                if (messageEl) {
                    messageObserver.observe(messageEl);
                }
            }
            
            // Double-check the message was added with correct class and alignment
            // Use requestAnimationFrame to ensure DOM is ready
            requestAnimationFrame(() => {
                const addedMessage = prepend ? chatContainer.firstElementChild : chatContainer.lastElementChild;
                if (addedMessage) {
                    // Verify data attributes are set
                    if (addedMessage.getAttribute('data-sender-type') !== senderType) {
                        addedMessage.setAttribute('data-sender-type', senderType);
                    }
                    if (addedMessage.getAttribute('data-is-sent') !== String(isSent)) {
                        addedMessage.setAttribute('data-is-sent', String(isSent));
                    }
                    
                    if (isSent) {
                        if (!addedMessage.classList.contains('sent')) {
                            console.warn('⚠️ Sent message missing "sent" class, fixing...');
                            addedMessage.classList.add('sent');
                        }
                        // Force right alignment with !important
                        addedMessage.style.setProperty('margin-left', 'auto', 'important');
                        addedMessage.style.setProperty('margin-right', '0', 'important');
                        addedMessage.style.setProperty('justify-content', 'flex-end', 'important');
                        addedMessage.style.setProperty('flex-direction', 'row-reverse', 'important');
                    } else {
                        // Ensure received messages don't have sent class
                        if (addedMessage.classList.contains('sent')) {
                            addedMessage.classList.remove('sent');
                        }
                        addedMessage.style.setProperty('margin-left', '0', 'important');
                        addedMessage.style.setProperty('margin-right', 'auto', 'important');
                        addedMessage.style.setProperty('justify-content', 'flex-start', 'important');
                        addedMessage.style.setProperty('flex-direction', 'row', 'important');
                    }
                }
            });
        }

        // Update message status
        function updateMessageStatus(messageId, status, retryCount = 0) {
            console.log('🔄 Updating message status:', { messageId, status, retryCount });
            
            // Önce chat container içinde ara
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) {
                console.error('❌ Chat container not found');
                return;
            }
            
            const messageEl = chatContainer.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageEl) {
                if (retryCount < 10) { // Retry sayısını artır
                    // Retry after a short delay (message might not be in DOM yet)
                    console.log(`⏳ Message element not found, retrying... (${retryCount + 1}/10)`);
                    setTimeout(() => {
                        updateMessageStatus(messageId, status, retryCount + 1);
                    }, 300); // Delay'i biraz artır
                } else {
                    console.error('⚠️ Message element not found for ID after retries:', messageId);
                    // Tüm mesajları listele debug için
                    const allMessages = chatContainer.querySelectorAll('.message[data-message-id]');
                    console.log('📋 Available message IDs:', Array.from(allMessages).map(m => m.getAttribute('data-message-id')));
                }
                return;
            }
            
            const statusEl = messageEl.querySelector('.message-status');
            if (!statusEl) {
                console.warn('⚠️ Status element not found for message:', messageId);
                // Eğer status elementi yoksa, mesaj gönderilmiş bir mesaj mı kontrol et
                const isSent = messageEl.getAttribute('data-is-sent') === 'true';
                if (isSent) {
                    console.log('🔧 Status element missing for sent message, creating it...');
                    
                    // message-time is a sibling of message-bubble, not inside it
                    // So we should search directly in messageEl or message-content
                    let messageTime = messageEl.querySelector('.message-time');
                    if (!messageTime) {
                        // If message-time doesn't exist (shouldn't happen, but just in case)
                        console.log('🔧 message-time missing, creating it...');
                        const messageContent = messageEl.querySelector('.message-content');
                        if (messageContent) {
                            const time = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                            messageTime = document.createElement('div');
                            messageTime.className = 'message-time';
                            messageTime.textContent = time;
                            messageContent.appendChild(messageTime);
                        } else {
                            console.error('⚠️ message-content not found');
                            return;
                        }
                    }
                    
                    // Create status element
                    const newStatusEl = document.createElement('span');
                    newStatusEl.className = `message-status ${status}`;
                    newStatusEl.innerHTML = '<span class="message-status-icon"></span>';
                    messageTime.appendChild(newStatusEl);
                    console.log('✅ Status element created');
                    return;
                }
                return;
            }
            
            // Remove old status classes
            statusEl.classList.remove('sent', 'delivered', 'read');
            // Add new status class
            statusEl.classList.add(status);
            console.log('✅ Status updated to:', status, 'Classes:', statusEl.className);
        }
        
        // Intersection Observer for read status
        let messageObserver = null;
        
        function initMessageObserver() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const observerOptions = {
                root: chatContainer,
                rootMargin: '0px',
                threshold: 0.5 // Message is considered read when 50% visible
            };
            
            messageObserver = new IntersectionObserver((entries) => {
                const assistantMessageIds = []; // Assistant messages we read (to notify assistant)
                
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const messageEl = entry.target;
                        const messageId = messageEl.getAttribute('data-message-id');
                        const isSent = messageEl.getAttribute('data-is-sent') === 'true';
                        
                        // Track messages from ASSISTANT (isSent=false) that we read
                        // This notifies assistant that we read their messages (so they see blue ticks)
                        if (!isSent && messageId && !messageId.startsWith('temp_')) {
                            if (!assistantMessageIds.includes(messageId)) {
                                assistantMessageIds.push(messageId);
                                console.log('📖 Guest: Assistant message we read:', messageId);
                            }
                        }
                        
                        // Note: We don't track our own sent messages here because
                        // the read status for our messages comes from server via message_status_update
                        // when assistant reads our messages
                    }
                });
                
                // Send read status for assistant messages we read
                // This will make assistant see blue ticks on their messages
                if (assistantMessageIds.length > 0) {
                    console.log('📤 Guest side: Emitting message_read for', assistantMessageIds.length, 'assistant messages we read:', assistantMessageIds);
                    socket.emit('message_read', { messageIds: assistantMessageIds });
                }
            }, observerOptions);
            
            // Observe all existing messages
            const existingMessages = chatContainer.querySelectorAll('.message[data-message-id]');
            existingMessages.forEach(msg => {
                messageObserver.observe(msg);
            });
        }
        
        // Add welcome message
        function addWelcomeMessage() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="message">
                    <div class="message-avatar">
                        <div class="voyage-logo">
                            <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2" y="2" width="116" height="56" fill="none" stroke="#8B0000" stroke-width="1.5" rx="2"/>
                                <text x="60" y="22" font-family="Arial, sans-serif" font-size="18" font-weight="600" fill="#8B0000" text-anchor="middle" letter-spacing="1">VOYAGE</text>
                                <text x="60" y="42" font-family="Arial, sans-serif" font-size="10" font-weight="500" fill="#8B0000" text-anchor="middle" letter-spacing="0.5">HOTELS</text>
                                <line x1="30" y1="38" x2="35" y2="38" stroke="#8B0000" stroke-width="1"/>
                                <line x1="85" y1="38" x2="90" y2="38" stroke="#8B0000" stroke-width="1"/>
                            </svg>
                        </div>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <div class="message-text">
                                Hoş geldiniz ${GUEST_NAME}! 🌅<br><br>
                                Voyage Sorgun ekibi size yardımcı olmak için burada. Nasıl yardımcı olabiliriz?
                            </div>
                        </div>
                        <div class="message-time">${formatTime(new Date())}</div>
                    </div>
                </div>
            `;
        }

        // Send message
        async function sendMessage() {
            if (!socket) {
                console.error('❌ Socket not initialized');
                alert('Bağlantı kurulamadı. Lütfen sayfayı yenileyin.');
                return;
            }
            
            // Ensure GUEST_UNIQUE_ID is available
            let guestUniqueId = GUEST_UNIQUE_ID;
            if (!guestUniqueId) {
                console.log('🔧 GUEST_UNIQUE_ID is null, trying to restore or generate...');
                // Try to restore from localStorage
                guestUniqueId = localStorage.getItem('guest_unique_id');
                if (guestUniqueId) {
                    GUEST_UNIQUE_ID = guestUniqueId;
                    console.log('✅ Restored GUEST_UNIQUE_ID from localStorage:', guestUniqueId);
                } else if (GUEST_NAME && CHECKIN_DATE && CHECKOUT_DATE) {
                    // Generate if we have all required info
                    console.log('🔧 Generating GUEST_UNIQUE_ID from available info...');
                    guestUniqueId = await generateGuestUniqueId(GUEST_NAME, GUEST_SURNAME, CHECKIN_DATE, CHECKOUT_DATE);
                    if (guestUniqueId) {
                        GUEST_UNIQUE_ID = guestUniqueId;
                        localStorage.setItem('guest_unique_id', guestUniqueId);
                        console.log('✅ Generated GUEST_UNIQUE_ID:', guestUniqueId);
                    } else {
                        console.error('❌ Failed to generate GUEST_UNIQUE_ID');
                        alert('Misafir bilgisi yüklenemedi. Lütfen sayfayı yenileyin.');
                return;
                    }
                } else {
                    console.error('❌ Guest unique ID not available and cannot generate:', {
                        hasName: !!GUEST_NAME,
                        hasCheckin: !!CHECKIN_DATE,
                        hasCheckout: !!CHECKOUT_DATE
                    });
                    alert('Misafir bilgisi yüklenemedi. Lütfen sayfayı yenileyin.');
                    return;
                }
            }
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            console.log('📤 Sending message:', { guestUniqueId: GUEST_UNIQUE_ID, checkinDate: CHECKIN_DATE, message: message.substring(0, 30) });
            
            // Create temporary message ID for optimistic update
            const tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Optimistic update - show message immediately
            const optimisticMessage = {
                id: tempId,
                roomNumber: ROOM_NUMBER,
                checkinDate: CHECKIN_DATE,
                senderType: 'guest',
                senderName: GUEST_NAME,
                message: message,
                timestamp: new Date().toISOString(),
                status: 'sent'
            };
            
            // Display message immediately
            displayMessage(optimisticMessage, true);
            scrollToBottom();
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Stop typing indicator
            if (isTyping && socket) {
                socket.emit('stop_typing', { 
                    guestUniqueId: GUEST_UNIQUE_ID
                });
                isTyping = false;
            }
            
            // Send to server
            console.log('📤 ========== GUEST SENDING MESSAGE ==========');
            console.log('📤 GUEST_UNIQUE_ID:', GUEST_UNIQUE_ID);
            console.log('📤 CHECKIN_DATE:', CHECKIN_DATE);
            console.log('📤 GUEST_NAME:', GUEST_NAME);
            console.log('📤 Message:', message);
            console.log('📤 Time:', new Date().toISOString());
            
            socket.emit('send_message', {
                guestUniqueId: GUEST_UNIQUE_ID,
                senderType: 'guest',
                senderName: GUEST_NAME,
                message: message
            });
            
            console.log('📤 send_message event emitted');
            
            // When real message arrives, replace the temporary one
            const replaceTempMessage = (realMessage) => {
                const tempMessageEl = document.querySelector(`[data-message-id="${tempId}"]`);
                if (tempMessageEl) {
                    // Update the message ID
                    tempMessageEl.setAttribute('data-message-id', realMessage.id);
                    
                    // Update status if needed
                    if (realMessage.status) {
                        const statusEl = tempMessageEl.querySelector('.message-status');
                        if (statusEl) {
                            statusEl.classList.remove('sent', 'delivered', 'read');
                            statusEl.classList.add(realMessage.status);
                        }
                    }
                }
            };
            
            // Listen for the real message once
            socket.once('new_message', (realMessage) => {
                if (realMessage.message === message && realMessage.senderType === 'guest') {
                    replaceTempMessage(realMessage);
                }
            });
        }

        // Handle input change (typing indicator)
        function handleInputChange() {
            const input = document.getElementById('messageInput');
            
            // Auto-resize
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            
            // Typing indicator
            if (input.value.trim() && !isTyping && socket && GUEST_UNIQUE_ID) {
                isTyping = true;
                socket.emit('typing', {
                    guestUniqueId: GUEST_UNIQUE_ID,
                    senderName: GUEST_NAME,
                    senderType: 'guest'
                });
            }
            
            // Clear typing timeout
            clearTimeout(typingTimeout);
            
            // Set new timeout
            if (input.value.trim()) {
                typingTimeout = setTimeout(() => {
                    if (isTyping && socket && GUEST_UNIQUE_ID) {
                        socket.emit('stop_typing', { 
                            guestUniqueId: GUEST_UNIQUE_ID,
                            checkinDate: CHECKIN_DATE
                        });
                        isTyping = false;
                    }
                }, 2000);
            }
        }

        // Handle Enter key
        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }


        // iOS detection
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        // Check if running as PWA (standalone mode)
        function isStandalone() {
            return window.navigator.standalone === true || 
                   window.matchMedia('(display-mode: standalone)').matches;
        }

        // Send notification
        function sendNotification(messageData) {
            if (!('Notification' in window)) {
                return;
            }
            
            if (Notification.permission === 'granted') {
                const senderName = messageData.senderName || 'Voyage Sorgun';
                const messageText = messageData.message.length > 50 
                    ? messageData.message.substring(0, 50) + '...' 
                    : messageData.message;
                
                new Notification(`${senderName}`, {
                    body: messageText,
                    icon: '/icon-192.png',
                    badge: '/icon-192.png',
                    tag: 'voyage-chat-message',
                    requireInteraction: false,
                    vibrate: [200, 100, 200]
                });
                
                console.log('🔔 Notification sent:', messageText);
            }
        }

        // Notification Permission
        async function requestNotificationPermission() {
            // iOS kontrolü
            if (isIOS()) {
                if (!isStandalone()) {
                    alert('iOS\'ta bildirimler için uygulamayı ana ekrana eklemeniz gerekiyor.\n\n📱 Adımlar:\n1. Safari menüsünden "Ana Ekrana Ekle" seçin\n2. Uygulamayı ana ekrandan açın\n3. Tekrar bildirim butonuna tıklayın\n\n💡 PWA olarak açıldığında bildirimler çalışacaktır.');
                    return 'denied';
                }
                
                // iOS 16.4+ kontrolü (bildirim desteği için)
                const iOSVersion = parseFloat((navigator.userAgent.match(/OS (\d+)_(\d+)/) || [0, 0, 0]).slice(1).join('.'));
                if (iOSVersion < 16.4) {
                    alert('Bildirimler iOS 16.4 ve üzeri sürümlerde çalışır.\n\nLütfen iOS\'unuzu güncelleyin.');
                    return 'denied';
                }
            }
            
            if (!('Notification' in window)) {
                alert('Bu tarayıcı bildirim desteklemiyor');
                return 'denied';
            }
            
            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                new Notification('Voyage Sorgun', {
                    body: 'Bildirimler başarıyla açıldı! 🔔',
                    icon: '/icon-192.png',
                    badge: '/icon-192.png'
                });
                
                // Update toggle
                updateNotificationToggle();
            } else if (permission === 'denied') {
                alert('Bildirim izni reddedildi. Tarayıcı ayarlarından izin verebilirsiniz.');
                // Update toggle
                updateNotificationToggle();
            }
            
            return permission;
        }
        
        // Check if page becomes visible/hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('📱 Page hidden - notifications will be shown');
            } else {
                console.log('👁️ Page visible');
            }
        });

        // Utility functions
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Load older messages when scrolling to top
        let isLoadingOlderMessages = false;
        let oldestMessageTimestamp = null;

        function setupScrollListener() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            chatContainer.addEventListener('scroll', () => {
                // Check if scrolled near the top (within 100px)
                if (chatContainer.scrollTop < 100 && !isLoadingOlderMessages && oldestMessageTimestamp) {
                    loadOlderMessages();
                }
            });
        }

        async function loadOlderMessages() {
            if (isLoadingOlderMessages || !oldestMessageTimestamp || !socket) return;

            isLoadingOlderMessages = true;
            const chatContainer = document.getElementById('chatContainer');
            const previousScrollHeight = chatContainer.scrollHeight;

            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'loadingOlder';
            loadingIndicator.style.textAlign = 'center';
            loadingIndicator.style.padding = '10px';
            loadingIndicator.style.color = '#667781';
            loadingIndicator.innerHTML = '⏳ Eski mesajlar yükleniyor...';
            chatContainer.insertBefore(loadingIndicator, chatContainer.firstChild);

            socket.emit('load_older_messages', {
                roomNumber: ROOM_NUMBER,
                beforeTimestamp: oldestMessageTimestamp,
                limit: 50
            });
        }

        // Service Worker Registration (PWA) with Auto-Update
        if ('serviceWorker' in navigator) {
            let refreshing = false;

            // Register service worker
            window.addEventListener('load', () => {
                // Add cache busting query parameter to service worker URL
                const swUrl = '/service-worker.js?v=' + Date.now();
                
                navigator.serviceWorker.register('/service-worker.js', {
                    updateViaCache: 'none' // Always check for updates
                })
                    .then((registration) => {
                        console.log('✅ Service Worker registered:', registration.scope);

                        // Check for updates immediately
                        registration.update().catch(err => console.error('Update check failed:', err));

                        // Listen for service worker updates
                        registration.addEventListener('updatefound', () => {
                            console.log('🔄 New service worker found, installing...');
                            const newWorker = registration.installing;

                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    console.log('Service Worker state:', newWorker.state);
                                    if (newWorker.state === 'installed') {
                                        if (navigator.serviceWorker.controller) {
                                            // New service worker is ready
                                            console.log('✅ New service worker installed');
                                            
                                            // Show update notification
                                            if (confirm('Yeni güncelleme mevcut! Uygulamayı yenilemek ister misiniz?')) {
                                                // User wants to update
                                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                                                setTimeout(() => {
                                                    window.location.reload();
                                                }, 100);
                                            }
                                        } else {
                                            console.log('✅ Service Worker installed for the first time');
                                        }
                                    }
                                });
                            }
                        });

                        // Periodic update check (every 15 seconds)
                        setInterval(() => {
                            registration.update().catch(err => console.error('Periodic update check failed:', err));
                        }, 15 * 1000);

                        // Listen for controller change (service worker activated)
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            if (!refreshing) {
                                refreshing = true;
                                console.log('🔄 Service worker updated, reloading...');
                                window.location.reload();
                            }
                        });
                    })
                    .catch((error) => {
                        console.log('❌ Service Worker registration failed:', error);
                    });
            });

            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SW_UPDATED') {
                    console.log('🔄 Service worker updated:', event.data.version);
                    if (!refreshing) {
                        refreshing = true;
                        // Auto-reload after 1 second
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                }
            });

            // Check for updates when page becomes visible (iOS/Android compatibility)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'CHECK_UPDATE' });
                    navigator.serviceWorker.getRegistration().then((registration) => {
                        if (registration) {
                            registration.update();
                        }
                    });
                }
            });
        }


        // PWA Fullscreen Support - Hide Safari UI
        function setupPWAFullscreen() {
            // Set body height to viewport height (handles Safari address bar)
            const setHeight = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // For iOS standalone mode
                if (isStandalone() || isIOS()) {
                    document.body.style.height = `${window.innerHeight}px`;
                    const appContainer = document.querySelector('.app-container');
                    if (appContainer) {
                        appContainer.style.height = `${window.innerHeight}px`;
                    }
                }
            };
            
            // Set initial height
            setHeight();
            
            // Update on resize (handles Safari address bar show/hide)
            window.addEventListener('resize', setHeight);
            window.addEventListener('orientationchange', () => {
                setTimeout(setHeight, 100);
            });
            
            // Prevent zoom on double tap (iOS)
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        // Handle guest logout
        async function handleGuestLogout() {
            if (!confirm('Çıkış yapmak istediğinize emin misiniz?')) {
                return;
            }
            
            try {
                // Call logout endpoint
                await fetch('/api/guest/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Clear all guest data
            IS_AUTHENTICATED = false;
            const oldGuestUniqueId = GUEST_UNIQUE_ID; // Store for cleanup
            GUEST_UNIQUE_ID = null;
            GUEST_NAME = null;
            GUEST_SURNAME = null;
            CHECKIN_DATE = null;
            CHECKOUT_DATE = null;
            ROOM_NUMBER = null;
            TEAM_ID = null;
            guestProfilePhoto = null;
            
            // Clear localStorage
            localStorage.removeItem('guest_unique_id');
            localStorage.removeItem('guest_name');
            localStorage.removeItem('guest_surname');
            localStorage.removeItem('checkin_date');
            localStorage.removeItem('checkout_date');
            localStorage.removeItem('room_number');
            localStorage.removeItem('team_id');
            // Remove guest-specific profile photo from localStorage
            if (oldGuestUniqueId) {
                localStorage.removeItem(`guestProfilePhoto_${oldGuestUniqueId}`);
            }
            // Also remove old global key for backward compatibility
            localStorage.removeItem('guestProfilePhoto');
            
            // Update navigation visibility
            updateNavigationVisibility();
            
            // Disconnect socket if connected
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            // Hide app, show login
            // document.getElementById('appContainer').style.display = 'none'; // Geçici olarak devre dışı - tasarım görmek için
            document.getElementById('guestLoginContainer').style.display = 'flex';
            
            // Clear form
            document.getElementById('guestLoginForm').reset();
            
            console.log('✅ Guest logged out');
        }

        // ============================================
        // Settings Session Management (Login in Settings)
        // Must use existing guest_unique_id format (name+surname+checkin+checkout+sha256)
        // ============================================

        async function checkAuthStatus() {
            const loginScreen = document.getElementById('loginScreen');
            const settingsContent = document.getElementById('settingsContent');
            const logoutBtn = document.getElementById('logoutBtn');

            try {
                const resp = await fetch('/api/guest/me', { credentials: 'include' });
                if (resp.ok) {
                    const data = await resp.json();
                    if (data?.success && data?.guest?.guest_unique_id) {
                        IS_AUTHENTICATED = true;
                        GUEST_UNIQUE_ID = data.guest.guest_unique_id;
                        GUEST_NAME = data.guest.guest_name || 'Misafir';
                        GUEST_SURNAME = data.guest.guest_surname || null;
                        CHECKIN_DATE = data.guest.checkin_date || null;
                        CHECKOUT_DATE = data.guest.checkout_date || null;
                        ROOM_NUMBER = data.guest.room_number || null;
                        TEAM_ID = data.guest.team_id || null;

                        if (loginScreen) loginScreen.style.display = 'none';
                        if (settingsContent) settingsContent.style.display = 'block';
                        if (logoutBtn) logoutBtn.style.display = 'flex';
                        
                        // Update navigation visibility
                        updateNavigationVisibility();
                        
                        return true;
                    }
                }
            } catch (e) {
                console.error('Auth status check failed:', e);
            }

            IS_AUTHENTICATED = false;
            if (loginScreen) loginScreen.style.display = 'block';
            if (settingsContent) settingsContent.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'none';
            
            // Update navigation visibility
            updateNavigationVisibility();
            
            return false;
        }

        async function handleLogin(event) {
            event.preventDefault();

            const firstName = document.getElementById('loginFirstName')?.value?.trim();
            const lastName = document.getElementById('loginLastName')?.value?.trim();
            const checkinDate = document.getElementById('loginCheckinDate')?.value;
            const checkoutDate = document.getElementById('loginCheckoutDate')?.value;
            const submitBtn = document.getElementById('loginSubmitBtn');

            if (!firstName || !lastName || !checkinDate || !checkoutDate) {
                alert('Lütfen ad, soyad, giriş tarihi ve çıkış tarihini girin.');
                return;
            }

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Giriş yapılıyor...';
            }

            try {
                // IMPORTANT: Backend generates guest_unique_id using generateGuestUniqueId + sha256
                const response = await fetch('/api/guest/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        name: firstName,
                        surname: lastName,
                        checkin_date: checkinDate,
                        checkout_date: checkoutDate
                    })
                });

                const data = await response.json();
                if (!response.ok || !data?.success) {
                    alert(data?.error || 'Giriş başarısız. Lütfen bilgilerinizi kontrol edin.');
                    return;
                }

                // Session vars
                IS_AUTHENTICATED = true;
                GUEST_UNIQUE_ID = data.guest_unique_id;
                GUEST_NAME = data.guest_name || firstName || 'Misafir';
                GUEST_SURNAME = data.guest_surname || lastName || null;
                CHECKIN_DATE = data.checkin_date || checkinDate;
                CHECKOUT_DATE = data.checkout_date || checkoutDate;
                ROOM_NUMBER = data.room_number || null;
                TEAM_ID = data.team_id || null;

                // Backup to localStorage
                localStorage.setItem('guest_unique_id', GUEST_UNIQUE_ID);
                localStorage.setItem('guest_name', GUEST_NAME);
                localStorage.setItem('guest_surname', GUEST_SURNAME || '');
                localStorage.setItem('checkin_date', CHECKIN_DATE);
                localStorage.setItem('checkout_date', CHECKOUT_DATE);
                if (ROOM_NUMBER) localStorage.setItem('room_number', ROOM_NUMBER);
                if (TEAM_ID) localStorage.setItem('team_id', TEAM_ID);

                // Update settings UI + profile
                await checkAuthStatus();
                updateProfileInfo();

                showWelcomePopup(`${GUEST_NAME} ${GUEST_SURNAME || ''}`.trim());
                setTimeout(() => switchSection('info'), 600);

                // Start socket (chat)
                try {
                    await initializeSocket();
                } catch (e) {
                    console.warn('Socket init skipped/failed:', e);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Giriş sırasında bir hata oluştu. Lütfen tekrar deneyin.');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Giriş Yap';
                }
            }
        }

        function continueAsGuest() {
            IS_AUTHENTICATED = false;
            switchSection('info');
            alert('Misafir modu: İçerikleri görüntüleyebilirsiniz, ancak beğeni/yorum/kaydet gibi işlemler için giriş yapmanız gerekiyor.');
        }

        async function handleLogout() {
            if (!confirm('Çıkış yapmak istediğinize emin misiniz?')) return;

            try {
                await fetch('/api/guest/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (e) {
                console.warn('Logout request failed:', e);
            }

            // Clear session vars
            IS_AUTHENTICATED = false;
            const oldGuestUniqueId = GUEST_UNIQUE_ID; // Store for cleanup
            GUEST_UNIQUE_ID = null;
            GUEST_NAME = 'Misafir';
            GUEST_SURNAME = null;
            CHECKIN_DATE = null;
            CHECKOUT_DATE = null;
            ROOM_NUMBER = null;
            TEAM_ID = null;

            // Clear localStorage backup
            localStorage.removeItem('guest_unique_id');
            localStorage.removeItem('guest_name');
            localStorage.removeItem('guest_surname');
            localStorage.removeItem('checkin_date');
            localStorage.removeItem('checkout_date');
            localStorage.removeItem('room_number');
            localStorage.removeItem('team_id');

            // Clear guest-specific profile photo from localStorage
            if (oldGuestUniqueId) {
                localStorage.removeItem(`guestProfilePhoto_${oldGuestUniqueId}`);
            }
            // Also remove old global key for backward compatibility
            localStorage.removeItem('guestProfilePhoto');

            // Clear avatar
            guestProfilePhoto = null;
            teamAvatar = null;
            updateProfilePhotoDisplay();

            // Clear restaurant reservations
            const restaurantReservationsContainer = document.getElementById('restaurantReservations');
            if (restaurantReservationsContainer) {
                restaurantReservationsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #667781;" data-i18n="noRestaurantReservations">
                        Henüz restoran rezervasyonunuz bulunmamaktadır.
                    </div>
                `;
            }

            // Clear SPA reservations if exists
            const spaReservationsContainer = document.getElementById('spaReservations');
            if (spaReservationsContainer) {
                spaReservationsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #667781;">
                        Henüz SPA rezervasyonunuz bulunmamaktadır.
                    </div>
                `;
            }

            // Clear my SPA reservations
            const mySpaReservationsContainer = document.getElementById('mySpaReservations');
            if (mySpaReservationsContainer) {
                mySpaReservationsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #667781;">
                        Yükleniyor...
                    </div>
                `;
            }

            // Clear chat messages
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.innerHTML = '';
            }

            // Clear messages array and related state
            messages = [];
            oldestMessageTimestamp = null;

            // Disconnect socket if connected
            if (socket) {
                socket.disconnect();
                socket = null;
            }

            await checkAuthStatus();
            
            // Update navigation visibility after logout
            updateNavigationVisibility();
            
            // Switch to info section (which is always available)
            switchSection('info');
        }

        function requireAuth() {
            if (!IS_AUTHENTICATED || !GUEST_UNIQUE_ID) {
                alert('Bu işlem için giriş yapmanız gerekiyor. (Ayarlar > Giriş Yap)');
                switchSection('settings');
                return false;
            }
            return true;
        }

        function showWelcomePopup(displayName) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.35);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 340px;
                width: 100%;
                box-shadow: 0 8px 24px rgba(0,0,0,0.25);
                text-align: center;
            `;
            content.innerHTML = `
                <div style="font-size: 40px; margin-bottom: 12px;">👋</div>
                <div style="font-size: 18px; font-weight: 700; color: #111b21; margin-bottom: 6px;">Hoş Geldiniz!</div>
                <div style="font-size: 14px; color: #667781; margin-bottom: 16px;">${displayName}</div>
                <div style="font-size: 13px; color: #667781; line-height: 1.5;">
                    Aktiviteler, harita ve otel duyuruları için uygulamayı keşfedin.
                </div>
            `;
            modal.appendChild(content);
            document.body.appendChild(modal);
            setTimeout(() => modal.remove(), 1200);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Initialize on load
        // Check authentication on page load
        // Update navigation visibility based on login status
        function updateNavigationVisibility() {
            const isAuthenticated = IS_AUTHENTICATED && GUEST_UNIQUE_ID;
            
            // Sections that require authentication
            const authRequiredSections = ['reservations', 'chat', 'map'];
            
            authRequiredSections.forEach(section => {
                const navItem = document.querySelector(`[data-section="${section}"]`);
                if (navItem) {
                    if (isAuthenticated) {
                        navItem.classList.remove('hidden');
                    } else {
                        navItem.classList.add('hidden');
                    }
                }
            });
        }

        // Navigation functions
        function switchSection(section) {
            // Check if section requires authentication
            const authRequiredSections = ['reservations', 'chat', 'map'];
            if (authRequiredSections.includes(section) && (!IS_AUTHENTICATED || !GUEST_UNIQUE_ID)) {
                // Redirect to settings for login
                alert('Bu bölümü kullanmak için giriş yapmanız gerekiyor. (Ayarlar > Giriş Yap)');
                switchSection('settings');
                return;
            }

            // Check for service worker updates (Safari-like refresh mechanism)
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CHECK_UPDATE' });
                navigator.serviceWorker.getRegistration().then((registration) => {
                    if (registration) {
                        registration.update().catch(err => console.error('Update check failed:', err));
                        
                        // Force cache refresh by fetching index.html with cache bypass
                        fetch('/index.html?t=' + Date.now(), { 
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        }).then(response => {
                            if (response.ok) {
                                // Update cache with fresh content
                                caches.open('voyage-chat-v4.2').then(cache => {
                                    cache.put('/index.html', response.clone());
                                });
                            }
                        }).catch(err => console.error('Cache refresh failed:', err));
                    }
                });
            }
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const sectionEl = document.getElementById(section + 'Section');
            if (sectionEl) {
                sectionEl.classList.add('active');
            }
            
            // Add active class to selected nav item
            const navItem = document.querySelector(`[data-section="${section}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            // Update profile info when switching to settings section
            if (section === 'settings') {
                checkAuthStatus(); // Check auth state first
                if (IS_AUTHENTICATED) {
                updateProfileInfo();
                }
            }
            
            // Update reservations info when switching to reservations section
            if (section === 'reservations') {
                updateReservationsInfo();
                loadMySpaReservations();
                loadAvailableRestaurants();
                loadRestaurantReservations();
            }
            
            // Load activity stories when switching to info section
            if (section === 'info') {
                loadActivityStories();
                loadInfoPosts();
                setupPostActions();
            }
            
            // Load activities timeline when switching to activities section
            if (section === 'activities') {
                // Ensure date picker is initialized with current date
                const datePicker = document.getElementById('activity-date-selector');
                if (datePicker && !datePicker.value) {
                    datePicker.value = currentActivityDate;
                }
                loadActivitiesTimeline();
            }
            
            // Initialize map when switching to map section
            if (section === 'map') {
                initMap();
                loadMapChips(); // Load map chips from database
                setupMapSearch(); // Setup map search functionality
                updatePermissionBanner(); // Update banner based on permission state
                startLocationTracking(); // Start tracking when map opens
            } else {
                stopLocationTracking(); // Stop tracking when leaving map
            }
            
            // Update notification toggle when switching to settings section
            if (section === 'settings') {
                updateNotificationToggle();
                updateLocationPermissionStatus();
                loadAvatarSelection();
                updateGhostModeToggle();
            }
            
            // Scroll to top when switching sections
            if (sectionEl) {
                sectionEl.scrollTop = 0;
            }
        }

        // Toggle notifications
        function toggleNotifications() {
            // Just prevent default click behavior, toggle is handled by checkbox
        }

        // Handle notification toggle
        async function handleNotificationToggle() {
            const toggle = document.getElementById('notificationToggle');
            if (!toggle) return;

            if (toggle.checked) {
                // Request permission
                const permission = await requestNotificationPermission();
                if (permission !== 'granted') {
                    toggle.checked = false;
                } else {
                    // Save preference
                    localStorage.setItem('notificationsEnabled', 'true');
                }
            } else {
                // Disable notifications (just save preference, can't revoke permission)
                localStorage.setItem('notificationsEnabled', 'false');
            }
        }

        // Update notification toggle state
        function updateNotificationToggle() {
            const toggle = document.getElementById('notificationToggle');
            if (!toggle) return;

            // Check if notifications are enabled in localStorage
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') !== 'false';
            const permissionGranted = Notification.permission === 'granted';

            toggle.checked = notificationsEnabled && permissionGranted;
            toggle.disabled = Notification.permission === 'denied';
        }

        // Request location permission
        // Request location permission - shows modal
        async function requestLocationPermission() {
            showLocationPermissionModal();
        }

        // Check permission state
        async function checkPermissionState() {
            if (!navigator.geolocation) {
                permissionState = 'not-supported';
                return permissionState;
            }

            try {
                // Try to get permission state (if supported)
                if ('permissions' in navigator) {
                    const result = await navigator.permissions.query({ name: 'geolocation' });
                    permissionState = result.state; // 'granted', 'denied', 'prompt'
                    return permissionState;
                } else {
                    // Fallback: try to get position
                    return new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(
                            () => {
                                permissionState = 'granted';
                                resolve('granted');
                            },
                            (error) => {
                                if (error.code === error.PERMISSION_DENIED) {
                                    permissionState = 'denied';
                                    resolve('denied');
                                } else {
                                    permissionState = 'prompt';
                                    resolve('prompt');
                                }
                            },
                            { timeout: 1000 }
                        );
                    });
                }
            } catch (error) {
                permissionState = 'prompt';
                return 'prompt';
            }
        }

        // Update location permission status display
        async function updateLocationPermissionStatus() {
            const statusEl = document.getElementById('locationPermissionStatus');
            const lastUpdateEl = document.getElementById('locationLastUpdate');
            if (!statusEl) return;

            if (!navigator.geolocation) {
                statusEl.innerHTML = `<i data-lucide="x-circle" class="icon icon-sm"></i><span>${t('notSupported')}</span>`;
                statusEl.style.color = '#F44336';
                if (lastUpdateEl) lastUpdateEl.textContent = '-';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // Check permission state
            const state = await checkPermissionState();

            if (state === 'granted') {
                statusEl.innerHTML = `<i data-lucide="check-circle" class="icon icon-sm"></i><span>✅ ${t('permissionGranted')}</span>`;
                statusEl.style.color = '#4CAF50';
            } else if (state === 'denied') {
                statusEl.innerHTML = `<i data-lucide="x-circle" class="icon icon-sm"></i><span>❌ ${t('permissionDenied')}</span>`;
                statusEl.style.color = '#F44336';
            } else {
                statusEl.innerHTML = `<i data-lucide="clock" class="icon icon-sm"></i><span>${t('permissionPending')}</span>`;
                statusEl.style.color = '#667781';
            }

            // Update last update time
            if (lastUpdateEl) {
                if (lastLocationUpdateTime) {
                    const diff = Math.floor((Date.now() - lastLocationUpdateTime) / 1000 / 60); // minutes
                    if (diff < 1) {
                        lastUpdateEl.textContent = t('justNow');
                    } else if (diff < 60) {
                        lastUpdateEl.textContent = `${diff} ${t('minutesAgo')}`;
                    } else {
                        const hours = Math.floor(diff / 60);
                        lastUpdateEl.textContent = `${hours} ${t('hoursAgo')}`;
                    }
                } else {
                    lastUpdateEl.textContent = '-';
                }
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Open location settings guide
        function openLocationSettingsGuide() {
            const guide = currentLanguage === 'tr' ?
                'Tarayıcı ayarlarından konum iznini değiştirebilirsiniz:\n\n' +
                'Safari iOS:\n' +
                '1. Ayarlar > Safari > Konum Servisleri\n' +
                '2. Bu site için "İzin Ver" seçin\n\n' +
                'Chrome Android:\n' +
                '1. Site ayarları (🔒) > İzinler > Konum\n' +
                '2. "İzin Ver" seçin\n\n' +
                'Ayarları değiştirdikten sonra sayfayı yenileyin.' :
                currentLanguage === 'en' ?
                'You can change location permission from browser settings:\n\n' +
                'Safari iOS:\n' +
                '1. Settings > Safari > Location Services\n' +
                '2. Select "Allow" for this site\n\n' +
                'Chrome Android:\n' +
                '1. Site settings (🔒) > Permissions > Location\n' +
                '2. Select "Allow"\n\n' +
                'Please refresh the page after changing settings.' :
                'Sie können die Standortberechtigung in den Browsereinstellungen ändern.';
            alert(guide);
        }

        // Handle permission banner click
        async function handlePermissionBannerClick() {
            const state = await checkPermissionState();
            
            if (state === 'denied') {
                // Show settings guide
                openLocationSettingsGuide();
            } else {
                // Show permission modal
                showLocationPermissionModal();
            }
        }

        // Update permission banner visibility
        async function updatePermissionBanner() {
            const banner = document.getElementById('locationPermissionBanner');
            if (!banner) return;

            const state = await checkPermissionState();

            if (state === 'granted') {
                // Hide banner when permission is granted
                banner.style.display = 'none';
            } else if (state === 'denied') {
                // Show banner with different message for denied state
                banner.style.display = 'flex';
                const titleEl = document.getElementById('permissionBannerTitle');
                const messageEl = document.getElementById('permissionBannerMessage');
                const btnEl = document.getElementById('permissionBannerBtn');
                if (titleEl) {
                    titleEl.textContent = currentLanguage === 'tr' ? 
                        'Konum izni gerekli' : 
                        currentLanguage === 'en' ? 'Location permission required' :
                        'Standortberechtigung erforderlich';
                }
                if (messageEl) {
                    messageEl.textContent = currentLanguage === 'tr' ?
                        'Ayarlardan konum iznini etkinleştirebilirsiniz.' :
                        currentLanguage === 'en' ?
                        'You can enable location permission from settings.' :
                        'Sie können die Standortberechtigung in den Einstellungen aktivieren.';
                }
                if (btnEl) {
                    btnEl.textContent = currentLanguage === 'tr' ? 'Ayarları Aç' :
                                       currentLanguage === 'en' ? 'Open Settings' :
                                       'Einstellungen öffnen';
                }
            } else {
                // Show banner for prompt state (not yet asked)
                banner.style.display = 'flex';
                const titleEl = document.getElementById('permissionBannerTitle');
                const messageEl = document.getElementById('permissionBannerMessage');
                const btnEl = document.getElementById('permissionBannerBtn');
                if (titleEl) {
                    titleEl.textContent = currentLanguage === 'tr' ?
                        'Konumunuza ihtiyacımız var' :
                        currentLanguage === 'en' ? 'We need your location' :
                        'Wir benötigen Ihren Standort';
                }
                if (messageEl) {
                    messageEl.textContent = currentLanguage === 'tr' ?
                        'Haritada konumunuzu göstermek için konum iznine ihtiyacımız var.' :
                        currentLanguage === 'en' ?
                        'We need location permission to show your position on the map.' :
                        'Wir benötigen Standortberechtigung, um Ihre Position auf der Karte anzuzeigen.';
                }
                if (btnEl) {
                    btnEl.textContent = currentLanguage === 'tr' ? 'Konum Ver' :
                                       currentLanguage === 'en' ? 'Allow Location' :
                                       'Standort erlauben';
                }
            }
        }

        // Force update app - Clear cache and reload
        async function forceUpdateApp() {
            const confirmMessage = currentLanguage === 'tr' ? 
                'Uygulamayı güncellemek istediğinize emin misiniz? Tüm cache temizlenecek ve sayfa yenilenecek.' :
                currentLanguage === 'en' ?
                'Are you sure you want to update the app? All cache will be cleared and the page will reload.' :
                currentLanguage === 'de' ?
                'Sind Sie sicher, dass Sie die App aktualisieren möchten? Der gesamte Cache wird gelöscht und die Seite wird neu geladen.' :
                'Вы уверены, что хотите обновить приложение? Весь кеш будет очищен, и страница будет перезагружена.';
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Clear all caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(
                        cacheNames.map(cacheName => {
                            console.log('🗑️ Deleting cache:', cacheName);
                            return caches.delete(cacheName);
                        })
                    );
                    console.log('✅ All caches cleared');
                }

                // Unregister service worker
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        await registration.unregister();
                        console.log('✅ Service worker unregistered');
                    }

                    // Unregister all service workers
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(
                        registrations.map(reg => reg.unregister())
                    );
                }

                // Clear localStorage (optional - you might want to keep some data)
                // localStorage.clear();

                // Force reload with cache bypass
                const successMessage = currentLanguage === 'tr' ?
                    'Uygulama güncelleniyor...' :
                    currentLanguage === 'en' ?
                    'Updating app...' :
                    currentLanguage === 'de' ?
                    'App wird aktualisiert...' :
                    'Обновление приложения...';

                // Show loading indicator
                const loadingMessage = document.createElement('div');
                loadingMessage.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000;';
                loadingMessage.textContent = successMessage;
                document.body.appendChild(loadingMessage);

                // Reload after a short delay
                setTimeout(() => {
                    window.location.reload(true);
                }, 500);

            } catch (error) {
                console.error('❌ Error updating app:', error);
                const errorMessage = currentLanguage === 'tr' ?
                    'Güncelleme sırasında bir hata oluştu. Sayfayı manuel olarak yenileyin.' :
                    currentLanguage === 'en' ?
                    'An error occurred during update. Please reload the page manually.' :
                    currentLanguage === 'de' ?
                    'Bei der Aktualisierung ist ein Fehler aufgetreten. Bitte laden Sie die Seite manuell neu.' :
                    'Произошла ошибка при обновлении. Пожалуйста, перезагрузите страницу вручную.';
                alert(errorMessage);
                window.location.reload(true);
            }
        }

        // Open activity story
        function openActivityStory(activity) {
            const modal = document.getElementById('storyViewerModal');
            const content = document.getElementById('storyViewerContent');
            const title = document.getElementById('storyViewerTitle');
            const indicators = document.getElementById('storyViewerIndicators');
            
            if (!modal || !content) return;
            
            // Get all media items (images and videos combined)
            const imageUrls = Array.isArray(activity.image_url) ? activity.image_url : (activity.image_url ? [activity.image_url] : []);
            const videoUrls = Array.isArray(activity.video_url) ? activity.video_url : (activity.video_url ? [activity.video_url] : []);
            const allMedia = [
                ...imageUrls.map(url => ({ type: 'image', url: toAbsoluteUrl(url) })),
                ...videoUrls.map(url => ({ type: 'video', url: toAbsoluteUrl(url) }))
            ];
            
            if (allMedia.length === 0) {
                alert('Bu story için medya bulunamadı');
                return;
            }
            
            // Set title
            if (title) {
                title.textContent = activity.title || 'Story';
            }
            
            // Clear and populate content
            content.innerHTML = '';
            indicators.innerHTML = '';
            
            allMedia.forEach((media, index) => {
                // Create media item
                const item = document.createElement('div');
                item.className = 'story-viewer-item';
                
                if (media.type === 'video') {
                    item.innerHTML = `<video controls autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;"><source src="${media.url}" type="video/mp4"></video>`;
                } else {
                    item.innerHTML = `<img src="${media.url}" alt="Story ${index + 1}" style="width: 100%; height: 100%; object-fit: contain;">`;
                }
                
                content.appendChild(item);
                
                // Create indicator
                const indicator = document.createElement('div');
                indicator.className = 'story-indicator';
                if (index === 0) indicator.classList.add('active');
                indicators.appendChild(indicator);
            });
            
            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Handle scroll to update indicators
            let currentIndex = 0;
            const updateIndicators = () => {
                const newIndex = Math.round(content.scrollLeft / window.innerWidth);
                if (newIndex !== currentIndex && newIndex >= 0 && newIndex < allMedia.length) {
                    currentIndex = newIndex;
                    indicators.querySelectorAll('.story-indicator').forEach((ind, idx) => {
                        ind.classList.toggle('active', idx === currentIndex);
                    });
                }
            };
            content.addEventListener('scroll', updateIndicators);
            
            // Touch/swipe support
            let touchStartX = 0;
            let touchEndX = 0;
            
            content.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            content.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0 && currentIndex < allMedia.length - 1) {
                        // Swipe left - next
                        currentIndex++;
                        content.scrollTo({
                            left: currentIndex * window.innerWidth,
                            behavior: 'smooth'
                        });
                    } else if (diff < 0 && currentIndex > 0) {
                        // Swipe right - previous
                        currentIndex--;
                        content.scrollTo({
                            left: currentIndex * window.innerWidth,
                            behavior: 'smooth'
                        });
                    }
                    updateIndicators();
                }
            }
            
            // Close on click outside or close button
            const closeBtn = document.getElementById('storyViewerClose');
            if (closeBtn) {
                closeBtn.onclick = closeStoryViewer;
            }
            
            // Close on escape key
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    closeStoryViewer();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }
        
        function closeStoryViewer() {
            const modal = document.getElementById('storyViewerModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
                
                // Stop all videos
                modal.querySelectorAll('video').forEach(video => {
                    video.pause();
                    video.currentTime = 0;
                });
            }
        }

        // Load activity story videos
        async function loadActivityStories() {
            try {
                const response = await fetch('/api/story-tray-items');
                if (!response.ok) {
                    console.warn('Failed to load activity stories');
                    return;
                }
                const activities = await response.json();
                
                const tray = document.getElementById('activityStoriesTray');
                if (!tray) return;
                
                if (activities.length === 0) {
                    tray.innerHTML = '';
                    return;
                }
                
                tray.innerHTML = '';
                
                // Sort by display_order
                activities.sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
                
                activities.forEach((activity, index) => {
                    const storyEl = document.createElement('div');
                    storyEl.className = 'activity-story';
                    storyEl.onclick = () => openActivityStory(activity);
                    
                    // Handle arrays for image_url and video_url
                    const imageUrls = Array.isArray(activity.image_url) ? activity.image_url : (activity.image_url ? [activity.image_url] : []);
                    const videoUrls = Array.isArray(activity.video_url) ? activity.video_url : (activity.video_url ? [activity.video_url] : []);
                    const hasVideo = videoUrls.length > 0;
                    const hasImage = imageUrls.length > 0;
                    const firstImage = imageUrls[0];
                    const firstVideo = videoUrls[0];
                    
                    storyEl.innerHTML = `
                        <div class="story-avatar">
                            ${hasVideo ? 
                                `<video class="story-video active" muted loop autoplay playsinline><source src="${toAbsoluteUrl(firstVideo)}" type="video/mp4"></video>` : 
                                ''
                            }
                            ${hasImage && !hasVideo ? 
                                `<img src="${toAbsoluteUrl(firstImage)}" alt="${activity.title || ''}" onload="this.style.display='block'; this.parentElement.querySelector('.story-avatar-placeholder').style.display='none';" onerror="this.style.display='none';">` :
                                ''
                            }
                            <div class="story-avatar-placeholder" style="${hasVideo || hasImage ? 'display: none;' : ''}">
                                <i data-lucide="${activity.icon || 'circle'}" class="icon icon-xl"></i>
                            </div>
                        </div>
                        <div class="story-label">${activity.title || ''}</div>
                    `;
                    tray.appendChild(storyEl);
                    
                    // If video exists, ensure it plays
                    if (hasVideo) {
                        const video = storyEl.querySelector('.story-video');
                        if (video) {
                            video.addEventListener('loadeddata', () => {
                                video.play().catch(err => {
                                    console.warn('Video autoplay failed:', err);
                                });
                            });
                            // Also try to play immediately if already loaded
                            if (video.readyState >= 2) {
                                video.play().catch(err => {
                                    console.warn('Video autoplay failed:', err);
                                });
                            }
                        }
                    }
                });
                
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => {
                        lucide.createIcons();
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading activity stories:', error);
            }
        }

        // Helper function to convert relative URLs to absolute URLs
        function toAbsoluteUrl(url) {
            if (!url) return url;
            url = url.trim();
            // If already absolute URL (starts with http:// or https://), return as is
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            // If relative URL (starts with /), convert to absolute
            if (url.startsWith('/')) {
                return window.location.origin + url;
            }
            // Otherwise return as is
            return url;
        }

        async function loadInfoPosts() {
            try {
                const response = await fetch('/api/info-posts');
                if (!response.ok) {
                    console.warn('Failed to load info posts, using static data');
                    return;
                }
                const posts = await response.json();
                
                // Debug: Log posts data
                console.log('Loaded posts:', posts.map(p => ({
                    id: p.id,
                    post_id: p.post_id,
                    title: p.title,
                    image_url: p.image_url,
                    video_url: p.video_url,
                    image_url_type: typeof p.image_url,
                    video_url_type: typeof p.video_url
                })));
                
                const container = document.querySelector('.info-posts-container');
                if (!container || posts.length === 0) return;
                
                // Get current user's likes and bookmarks status for each post
                const guestUniqueId = getCookie('guest_unique_id');
                const userLikesMap = {};
                const userBookmarksMap = {};
                
                if (guestUniqueId) {
                    for (const post of posts) {
                        try {
                            // Check if user liked this post
                            const likesRes = await fetch(`/api/info-posts/${post.post_id}/likes`, {
                                credentials: 'include'
                            });
                            if (likesRes.ok) {
                                const likesData = await likesRes.json();
                                post.currentLikesCount = likesData.count;
                                userLikesMap[post.post_id] = likesData.userLiked || false;
                            }
                            
                            // Check if user bookmarked this post
                            const bookmarksRes = await fetch(`/api/info-posts/bookmarked`, {
                                credentials: 'include'
                            });
                            if (bookmarksRes.ok) {
                                const bookmarks = await bookmarksRes.json();
                                userBookmarksMap[post.post_id] = bookmarks.some(b => b.post_id === post.post_id);
                            }
                        } catch (err) {
                            console.warn('Error loading post status:', err);
                        }
                    }
                }
                
                container.innerHTML = '';
                
                posts.forEach(post => {
                    const postEl = document.createElement('div');
                    postEl.className = 'info-post';
                    postEl.dataset.postId = post.post_id;
                    postEl.dataset.postDbId = post.id;
                    postEl.innerHTML = `
                        <div class="post-header">
                            <div class="post-avatar">
                                <div class="post-avatar-inner"><i data-lucide="${post.icon || 'circle'}" class="icon icon-lg"></i></div>
                            </div>
                            <div class="post-header-info">
                                <div class="post-username">${post.title}</div>
                                <div class="post-location">${post.location || t('voyageSorgun')}</div>
                            </div>
                            <div class="post-more">⋯</div>
                        </div>
                        <div class="post-image">
                            ${(() => {
                                // Handle arrays for image_url and video_url
                                // Backend already parses JSON, but handle both cases
                                let imageUrls = [];
                                let videoUrls = [];
                                
                                if (post.image_url) {
                                    if (Array.isArray(post.image_url)) {
                                        imageUrls = post.image_url.filter(url => url && url.trim());
                                    } else if (typeof post.image_url === 'string') {
                                        // Try to parse as JSON, if fails use as single value
                                        try {
                                            const parsed = JSON.parse(post.image_url);
                                            imageUrls = Array.isArray(parsed) ? parsed.filter(url => url && url.trim()) : [post.image_url.trim()];
                                        } catch (e) {
                                            imageUrls = post.image_url.trim() ? [post.image_url.trim()] : [];
                                        }
                                    }
                                }
                                
                                if (post.video_url) {
                                    if (Array.isArray(post.video_url)) {
                                        videoUrls = post.video_url.filter(url => url && url.trim());
                                    } else if (typeof post.video_url === 'string') {
                                        try {
                                            const parsed = JSON.parse(post.video_url);
                                            videoUrls = Array.isArray(parsed) ? parsed.filter(url => url && url.trim()) : [post.video_url.trim()];
                                        } catch (e) {
                                            videoUrls = post.video_url.trim() ? [post.video_url.trim()] : [];
                                        }
                                    }
                                }
                                
                                const allMedia = [
                                    ...imageUrls.map(url => ({ type: 'image', url: toAbsoluteUrl(url) })),
                                    ...videoUrls.map(url => ({ type: 'video', url: toAbsoluteUrl(url) }))
                                ].filter(media => media.url);
                                
                                if (allMedia.length === 0) {
                                    return `<div class="post-image-placeholder">
                                        <i data-lucide="${post.icon || 'circle'}" class="icon icon-xl"></i>
                                    </div>`;
                                }
                                
                                if (allMedia.length === 1) {
                                    const media = allMedia[0];
                                    if (media.type === 'video') {
                                        return `<video src="${media.url}" style="width: 100%; height: 100%; object-fit: cover;" controls playsinline></video>`;
                                    } else {
                                        return `<img src="${media.url}" alt="${post.title}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.style.display='block';">
                                        <div class="post-image-placeholder" style="display: none;">
                                            <i data-lucide="${post.icon || 'circle'}" class="icon icon-xl"></i>
                                        </div>`;
                                    }
                                }
                                
                                // Multiple media - create scrollable carousel
                                return `
                                    <div class="post-media-carousel" style="display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; width: 100%; height: 100%;">
                                        ${allMedia.map((media, idx) => `
                                            <div class="post-media-item" style="min-width: 100%; width: 100%; height: 100%; scroll-snap-align: start; position: relative; flex-shrink: 0;">
                                                ${media.type === 'video' ? 
                                                    `<video src="${media.url}" style="width: 100%; height: 100%; object-fit: cover; display: block;" controls playsinline></video>` :
                                                    `<img src="${media.url}" alt="${post.title} ${idx + 1}" style="width: 100%; height: 100%; object-fit: cover; display: block;" loading="lazy" onerror="console.error('Image load error for post ${post.post_id}:', '${media.url}'); this.style.opacity='0.3'; this.style.filter='grayscale(100%)';" onload="this.style.opacity='1'; this.style.filter='none';">`
                                                }
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="post-media-indicators" style="position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px; z-index: 10;">
                                        ${allMedia.map((_, idx) => `
                                            <div class="post-media-indicator ${idx === 0 ? 'active' : ''}" style="width: 6px; height: 6px; border-radius: 50%; background: ${idx === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.4)'}; transition: background 0.3s;"></div>
                                        `).join('')}
                                    </div>
                                `;
                            })()}
                        </div>
                        <div class="post-actions">
                            <div class="post-action like-btn ${userLikesMap[post.post_id] ? 'liked' : ''}">
                                <i data-lucide="heart" class="icon icon-lg" style="${userLikesMap[post.post_id] ? 'color: #ed4956; fill: #ed4956;' : 'color: #111b21; fill: none;'}"></i>
                            </div>
                            <div class="post-action comment-btn"><i data-lucide="message-circle" class="icon icon-lg"></i></div>
                            <div class="post-action dm-btn"><i data-lucide="send" class="icon icon-lg"></i></div>
                            <div class="post-action save bookmark-btn ${userBookmarksMap[post.post_id] ? 'bookmarked' : ''}">
                                <i data-lucide="bookmark" class="icon icon-lg" style="${userBookmarksMap[post.post_id] ? 'fill: #111b21;' : 'fill: none;'}"></i>
                            </div>
                        </div>
                        <div class="post-likes">${post.likes_count || 0} <span data-i18n="likes">beğeni</span></div>
                        <div class="post-caption">
                            <span class="post-caption-username">${post.title}</span>
                            ${post.caption || ''}
                        </div>
                        <div class="post-comments" data-i18n="viewComments">Yorumları görüntüle</div>
                        <div class="post-time" data-i18n="now">Şimdi</div>
                    `;
                    container.appendChild(postEl);
                    
                    // Setup carousel scroll listeners for indicators
                    const carousel = postEl.querySelector('.post-media-carousel');
                    if (carousel) {
                        const indicators = postEl.querySelectorAll('.post-media-indicator');
                        if (indicators.length > 1) {
                            let currentIndex = 0;
                            const updateIndicators = () => {
                                const newIndex = Math.round(carousel.scrollLeft / carousel.offsetWidth);
                                if (newIndex !== currentIndex && newIndex >= 0 && newIndex < indicators.length) {
                                    currentIndex = newIndex;
                                    indicators.forEach((ind, idx) => {
                                        ind.classList.toggle('active', idx === currentIndex);
                                        ind.style.background = idx === currentIndex ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.4)';
                                    });
                                }
                            };
                            carousel.addEventListener('scroll', updateIndicators);
                            
                        }
                    }
                });
                
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => {
                        lucide.createIcons();
                    }, 100);
                }
                
                // Setup actions after posts are loaded
                setupPostActions();
                
                // Apply translations to dynamically loaded content
                applyTranslations();
            } catch (error) {
                console.error('Error loading info posts:', error);
            }
        }

        function setupPostActions() {
            // Like button
            document.querySelectorAll('.post-action.like-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const post = e.currentTarget.closest('.info-post');
                    const postId = post.dataset.postId;
                    await handlePostLike(postId, post);
                });
            });

            // Comment button
            document.querySelectorAll('.post-action.comment-btn, .post-comments').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const post = e.currentTarget.closest('.info-post');
                    const postId = post.dataset.postId;
                    await openCommentsModal(postId);
                });
            });

            // Send/DM button
            document.querySelectorAll('.post-action.dm-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const post = e.currentTarget.closest('.info-post');
                    const postId = post.dataset.postId;
                    await openDMModal(postId);
                });
            });

            // Bookmark button
            document.querySelectorAll('.post-action.bookmark-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const post = e.currentTarget.closest('.info-post');
                    const postId = post.dataset.postId;
                    await handlePostBookmark(postId, post);
                });
            });
        }

        async function handlePostLike(postId, postElement) {
            // Check authentication first
            if (!requireAuth()) return;
            
            try {
                const response = await fetch(`/api/info-posts/${postId}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Beğenmek için giriş yapmanız gerekiyor.');
                        return;
                    }
                    throw new Error('Failed to like post');
                }
                
                const data = await response.json();
                
                // Update UI
                const likeBtn = postElement.querySelector('.post-action.like-btn');
                const likesCount = postElement.querySelector('.post-likes');
                
                if (data.liked) {
                    likeBtn.classList.add('liked');
                    // Replace heart outline with filled heart
                    const icon = likeBtn.querySelector('i');
                    if (icon) {
                        icon.setAttribute('data-lucide', 'heart');
                        icon.style.color = '#ed4956';
                        icon.style.fill = '#ed4956';
                        // Force re-render Lucide icon
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    }
                    // Add animation
                    likeBtn.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        likeBtn.style.transform = 'scale(1)';
                        likeBtn.style.transition = 'transform 0.2s ease';
                    }, 200);
                } else {
                    likeBtn.classList.remove('liked');
                    const icon = likeBtn.querySelector('i');
                    if (icon) {
                        icon.setAttribute('data-lucide', 'heart');
                        icon.style.color = '#111b21';
                        icon.style.fill = 'none';
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    }
                }
                
                likesCount.innerHTML = `${data.likesCount} <span data-i18n="likes">beğeni</span>`;
                applyTranslations();
            } catch (error) {
                console.error('Error liking post:', error);
            }
        }

        async function handlePostBookmark(postId, postElement) {
            // Check authentication first
            if (!requireAuth()) return;
            
            try {
                const response = await fetch(`/api/info-posts/${postId}/bookmark`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Kaydetmek için giriş yapmanız gerekiyor.');
                        return;
                    }
                    throw new Error('Failed to bookmark post');
                }
                
                const data = await response.json();
                
                const bookmarkBtn = postElement.querySelector('.post-action.bookmark-btn');
                if (data.bookmarked) {
                    bookmarkBtn.classList.add('bookmarked');
                    const icon = bookmarkBtn.querySelector('i');
                    if (icon) {
                        icon.style.fill = '#111b21';
                    }
                } else {
                    bookmarkBtn.classList.remove('bookmarked');
                    const icon = bookmarkBtn.querySelector('i');
                    if (icon) {
                        icon.style.fill = 'none';
                    }
                }
            } catch (error) {
                console.error('Error bookmarking post:', error);
            }
        }

        async function openCommentsModal(postId) {
            try {
                // Get post details and comments
                const [commentsRes, postsRes] = await Promise.all([
                    fetch(`/api/info-posts/${postId}/comments`),
                    fetch(`/api/info-posts`).then(r => r.ok ? r.json() : [])
                ]);
                
                if (!commentsRes.ok) {
                    throw new Error('Failed to load comments');
                }
                const comments = await commentsRes.json();
                const posts = await postsRes;
                const post = posts.find(p => p.post_id === postId) || {};
                
                // Format time ago
                function timeAgo(date) {
                    const now = new Date();
                    const diff = Math.floor((now - new Date(date)) / 1000);
                    if (diff < 60) return currentLanguage === 'tr' ? 'şimdi' : currentLanguage === 'en' ? 'now' : currentLanguage === 'de' ? 'gerade eben' : 'сейчас';
                    if (diff < 3600) {
                        const mins = Math.floor(diff / 60);
                        return currentLanguage === 'tr' ? `${mins}d` : currentLanguage === 'en' ? `${mins}m` : currentLanguage === 'de' ? `${mins}m` : `${mins}м`;
                    }
                    if (diff < 86400) {
                        const hours = Math.floor(diff / 3600);
                        return currentLanguage === 'tr' ? `${hours}s` : currentLanguage === 'en' ? `${hours}h` : currentLanguage === 'de' ? `${hours}h` : `${hours}ч`;
                    }
                    const days = Math.floor(diff / 86400);
                    return currentLanguage === 'tr' ? `${days}g` : currentLanguage === 'en' ? `${days}d` : currentLanguage === 'de' ? `${days}T` : `${days}д`;
                }
                
                // Create modal (Instagram-style fullscreen)
                const modal = document.createElement('div');
                modal.id = 'commentsModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: white;
                    display: flex;
                    flex-direction: column;
                    z-index: 10000;
                `;
                
                const title = currentLanguage === 'tr' ? 'Yorumlar' :
                              currentLanguage === 'en' ? 'Comments' :
                              currentLanguage === 'de' ? 'Kommentare' :
                              'Комментарии';
                
                modal.innerHTML = `
                    <!-- Header -->
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #e4e6e9;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button id="closeCommentsBtn" style="background: none; border: none; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #111b21;">
                                <i data-lucide="arrow-left" style="width: 24px; height: 24px;"></i>
                            </button>
                            <div style="font-size: 16px; font-weight: 600; color: #111b21;">${title}</div>
                        </div>
                    </div>
                    
                    <!-- Post Preview (Instagram-style) -->
                    ${post.image_url || post.video_url ? `
                    <div style="border-bottom: 1px solid #e4e6e9; background: #000; display: flex; align-items: center; justify-content: center; max-height: 400px; overflow: hidden;">
                        ${post.video_url ? 
                            `<video src="${post.video_url}" style="width: 100%; max-height: 400px; object-fit: contain;" controls playsinline></video>` :
                            `<img src="${post.image_url}" alt="${post.title}" style="width: 100%; max-height: 400px; object-fit: contain; display: block;">`
                        }
                    </div>
                    ` : ''}
                    
                    <!-- Comments List (Scrollable) -->
                    <div id="commentsList" style="flex: 1; overflow-y: auto; padding: 8px 16px; background: white;">
                        ${comments.length === 0 ? 
                            '<div style="text-align: center; color: #667781; padding: 40px 20px;">Henüz yorum yok</div>' :
                            comments.map(c => `
                                <div style="display: flex; gap: 12px; padding: 12px 0;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #e4e6e9; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden;">
                                        ${c.profile_photo ? 
                                            `<img src="${c.profile_photo}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                            '<i data-lucide="user" style="width: 24px; height: 24px; color: #667781;"></i>'
                                        }
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                                            <span style="font-weight: 600; font-size: 14px; color: #111b21;">${(c.guest_name || 'Misafir') + ' ' + (c.guest_surname || '')}</span>
                                            <span style="font-size: 14px; color: #111b21; word-break: break-word; flex: 1; min-width: 0;">${c.comment}</span>
                                        </div>
                                        <div style="display: flex; gap: 16px; margin-top: 6px;">
                                            <span style="font-size: 12px; color: #8e8e8e;">${timeAgo(c.created_at)}</span>
                                            <button style="background: none; border: none; font-size: 12px; color: #8e8e8e; cursor: pointer; padding: 0;">${currentLanguage === 'tr' ? 'Yanıtla' : currentLanguage === 'en' ? 'Reply' : currentLanguage === 'de' ? 'Antworten' : 'Ответить'}</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                    
                    <!-- Input Area (Instagram-style bottom input) -->
                    <div style="border-top: 1px solid #e4e6e9; padding: 8px 16px; background: white;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="text" id="newCommentInput" placeholder="${currentLanguage === 'tr' ? 'Yorum ekle...' : currentLanguage === 'en' ? 'Add a comment...' : currentLanguage === 'de' ? 'Kommentar hinzufügen...' : 'Добавить комментарий...'}" style="flex: 1; padding: 8px 0; border: none; outline: none; font-size: 14px; color: #111b21;">
                            <button id="sendCommentBtn" style="background: none; border: none; color: #34B7F1; font-size: 14px; font-weight: 600; cursor: pointer; padding: 0; opacity: 0.5;" disabled>${currentLanguage === 'tr' ? 'Gönder' : currentLanguage === 'en' ? 'Post' : currentLanguage === 'de' ? 'Posten' : 'Отправить'}</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => {
                        lucide.createIcons();
                    }, 100);
                }
                
                // Close button
                document.getElementById('closeCommentsBtn').onclick = () => {
                    modal.remove();
                };
                
                // Input handler for enable/disable send button
                const input = document.getElementById('newCommentInput');
                const sendBtn = document.getElementById('sendCommentBtn');
                
                input.addEventListener('input', () => {
                    const text = input.value.trim();
                    if (text) {
                        sendBtn.style.opacity = '1';
                        sendBtn.disabled = false;
                    } else {
                        sendBtn.style.opacity = '0.5';
                        sendBtn.disabled = true;
                    }
                });
                
                // Send comment
                async function sendComment() {
                    const commentText = input.value.trim();
                    
                    if (!commentText) return;
                    
                    // Check auth
                    if (!requireAuth()) return;
                    
                    try {
                        sendBtn.style.opacity = '0.5';
                        sendBtn.disabled = true;
                        
                        const sendResponse = await fetch(`/api/info-posts/${postId}/comments`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ comment: commentText })
                        });
                        
                        if (!sendResponse.ok) {
                            if (sendResponse.status === 401) {
                                alert(currentLanguage === 'tr' ? 'Yorum yazmak için giriş yapmanız gerekiyor.' :
                                      currentLanguage === 'en' ? 'You need to login to comment.' :
                                      currentLanguage === 'de' ? 'Sie müssen sich anmelden, um zu kommentieren.' :
                                      'Вам нужно войти, чтобы комментировать.');
                                return;
                            }
                            throw new Error('Failed to send comment');
                        }
                        
                        const newComment = await sendResponse.json();
                        
                        // Add comment to list (Instagram-style)
                        const commentsList = document.getElementById('commentsList');
                        const commentDiv = document.createElement('div');
                        commentDiv.style.cssText = 'display: flex; gap: 12px; padding: 12px 0;';
                        
                        function timeAgo(date) {
                            const now = new Date();
                            const diff = Math.floor((now - new Date(date)) / 1000);
                            if (diff < 60) return currentLanguage === 'tr' ? 'şimdi' : currentLanguage === 'en' ? 'now' : currentLanguage === 'de' ? 'gerade eben' : 'сейчас';
                            if (diff < 3600) {
                                const mins = Math.floor(diff / 60);
                                return currentLanguage === 'tr' ? `${mins}d` : currentLanguage === 'en' ? `${mins}m` : currentLanguage === 'de' ? `${mins}m` : `${mins}м`;
                            }
                            if (diff < 86400) {
                                const hours = Math.floor(diff / 3600);
                                return currentLanguage === 'tr' ? `${hours}s` : currentLanguage === 'en' ? `${hours}h` : currentLanguage === 'de' ? `${hours}h` : `${hours}ч`;
                            }
                            const days = Math.floor(diff / 86400);
                            return currentLanguage === 'tr' ? `${days}g` : currentLanguage === 'en' ? `${days}d` : currentLanguage === 'de' ? `${days}T` : `${days}д`;
                        }
                        
                        commentDiv.innerHTML = `
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #e4e6e9; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden;">
                                ${newComment.profile_photo ? 
                                    `<img src="${newComment.profile_photo}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                    '<i data-lucide="user" style="width: 24px; height: 24px; color: #667781;"></i>'
                                }
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px;">
                                    <span style="font-weight: 600; font-size: 14px; color: #111b21;">${(newComment.guest_name || 'Misafir') + ' ' + (newComment.guest_surname || '')}</span>
                                    <span style="font-size: 14px; color: #111b21; word-break: break-word;">${newComment.comment}</span>
                                </div>
                                <div style="display: flex; gap: 16px; margin-top: 6px;">
                                    <span style="font-size: 12px; color: #8e8e8e;">${timeAgo(newComment.created_at)}</span>
                                    <button style="background: none; border: none; font-size: 12px; color: #8e8e8e; cursor: pointer; padding: 0;">${currentLanguage === 'tr' ? 'Yanıtla' : currentLanguage === 'en' ? 'Reply' : currentLanguage === 'de' ? 'Antworten' : 'Ответить'}</button>
                                </div>
                            </div>
                        `;
                        
                        // Remove "no comments" message if exists
                        const noCommentsMsg = commentsList.querySelector('div[style*="text-align: center"]');
                        if (noCommentsMsg) {
                            noCommentsMsg.remove();
                        }
                        
                        commentsList.appendChild(commentDiv);
                        commentsList.scrollTop = commentsList.scrollHeight;
                        
                        input.value = '';
                        sendBtn.style.opacity = '0.5';
                        sendBtn.disabled = true;
                        
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    } catch (error) {
                        console.error('Error sending comment:', error);
                        alert(currentLanguage === 'tr' ? 'Yorum gönderilirken bir hata oluştu.' :
                              currentLanguage === 'en' ? 'An error occurred while sending comment.' :
                              currentLanguage === 'de' ? 'Beim Senden des Kommentars ist ein Fehler aufgetreten.' :
                              'Произошла ошибка при отправке комментария.');
                        sendBtn.style.opacity = '1';
                        sendBtn.disabled = false;
                    }
                }
                
                sendBtn.onclick = sendComment;
                
                // Enter key to send
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendComment();
                    }
                });
                
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => {
                        lucide.createIcons();
                    }, 100);
                }
            } catch (error) {
                console.error('Error opening comments modal:', error);
                alert('Yorumlar yüklenirken bir hata oluştu.');
            }
        }

        async function openDMModal(postId) {
            // Check authentication first
            if (!requireAuth()) return;
            
            const modal = document.createElement('div');
            modal.id = 'dmModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 400px;
                width: 100%;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            `;
            
            const title = currentLanguage === 'tr' ? 'Mesaj Gönder' :
                          currentLanguage === 'en' ? 'Send Message' :
                          currentLanguage === 'de' ? 'Nachricht senden' :
                          'Отправить сообщение';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 18px; font-weight: 600; color: #111b21;">${title}</div>
                    <button id="closeDMBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #667781;">×</button>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: #111b21;">${currentLanguage === 'tr' ? 'Alıcı Oda Numarası' : currentLanguage === 'en' ? 'Recipient Room Number' : currentLanguage === 'de' ? 'Empfänger Zimmernummer' : 'Номер комнаты получателя'}</label>
                    <input type="text" id="dmRoomNumber" placeholder="101" style="width: 100%; padding: 12px; border: 1px solid #e4e6e9; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: #111b21;">${currentLanguage === 'tr' ? 'Mesaj' : currentLanguage === 'en' ? 'Message' : currentLanguage === 'de' ? 'Nachricht' : 'Сообщение'}</label>
                    <textarea id="dmMessage" placeholder="${currentLanguage === 'tr' ? 'Mesajınızı yazın...' : currentLanguage === 'en' ? 'Write your message...' : currentLanguage === 'de' ? 'Schreiben Sie Ihre Nachricht...' : 'Напишите ваше сообщение...'}" style="width: 100%; padding: 12px; border: 1px solid #e4e6e9; border-radius: 8px; font-size: 14px; min-height: 100px; resize: vertical; box-sizing: border-box; font-family: inherit;"></textarea>
                </div>
                <button id="sendDMBtn" style="width: 100%; padding: 12px; background: #34B7F1; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">${currentLanguage === 'tr' ? 'Gönder' : currentLanguage === 'en' ? 'Send' : currentLanguage === 'de' ? 'Senden' : 'Отправить'}</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Close button
            document.getElementById('closeDMBtn').onclick = () => {
                modal.remove();
            };
            
            // Click outside to close
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // Send DM
            document.getElementById('sendDMBtn').onclick = async () => {
                const roomNumber = document.getElementById('dmRoomNumber').value.trim();
                const message = document.getElementById('dmMessage').value.trim();
                
                if (!roomNumber || !message) {
                    alert(currentLanguage === 'tr' ? 'Oda numarası ve mesaj gereklidir.' : 
                          currentLanguage === 'en' ? 'Room number and message are required.' :
                          currentLanguage === 'de' ? 'Zimmernummer und Nachricht sind erforderlich.' :
                          'Требуются номер комнаты и сообщение.');
                    return;
                }
                
                try {
                    // Get guest_unique_id from room number
                    const roomResponse = await fetch(`/api/rooms/${roomNumber}`);
                    if (!roomResponse.ok) {
                        throw new Error('Room not found');
                    }
                    const roomData = await roomResponse.json();
                    const toGuestUniqueId = roomData.guest_unique_id;
                    
                    const sendResponse = await fetch(`/api/info-posts/${postId}/dm`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            to_guest_unique_id: toGuestUniqueId,
                            message: message
                        })
                    });
                    
                    if (!sendResponse.ok) {
                        if (sendResponse.status === 401) {
                            alert(currentLanguage === 'tr' ? 'Mesaj göndermek için giriş yapmanız gerekiyor.' :
                                  currentLanguage === 'en' ? 'You need to login to send messages.' :
                                  currentLanguage === 'de' ? 'Sie müssen sich anmelden, um Nachrichten zu senden.' :
                                  'Вам нужно войти, чтобы отправлять сообщения.');
                            return;
                        }
                        throw new Error('Failed to send DM');
                    }
                    
                    modal.remove();
                    alert(currentLanguage === 'tr' ? 'Mesaj gönderildi!' :
                          currentLanguage === 'en' ? 'Message sent!' :
                          currentLanguage === 'de' ? 'Nachricht gesendet!' :
                          'Сообщение отправлено!');
                } catch (error) {
                    console.error('Error sending DM:', error);
                    alert(currentLanguage === 'tr' ? 'Mesaj gönderilirken bir hata oluştu.' :
                          currentLanguage === 'en' ? 'An error occurred while sending the message.' :
                          currentLanguage === 'de' ? 'Beim Senden der Nachricht ist ein Fehler aufgetreten.' :
                          'Произошла ошибка при отправке сообщения.');
                }
            };
        }

        // Helper function to get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Map initialization
        let map = null;
        let userMarker = null;
        let hotelMarker = null;
        let userLocationWatchId = null;
        let otherUsersMarkers = {};
        let activityMarkers = [];
        let lastLocationUpdateTime = null;
        let locationUpdateInterval = null;
        let permissionState = null; // 'granted', 'denied', 'prompt'
        let isCreatingUserMarker = false; // Race condition prevention flag

        // Mapbox access token
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiYWxpbXVyc2l0IiwiYSI6ImNtazRnYTRjZjAwa2IzZXF2cWJnaW9ocDcifQ.EL6OVUXoR22l0vrNPzVyoQ';

        // Flag to prevent repeated cinematic animation
        let hasPlayedCinematicAnimation = false;

        // Snapchat-style 3D view setup
        function setup3DView() {
            if (!map || !map.isStyleLoaded()) return;

            // 1. Add 3D buildings (fill-extrusion)
            try {
                const style = map.getStyle();
                let buildingSource = null;
                let buildingSourceLayer = null;

                // Check for building data in composite source
                if (style.sources && style.sources.composite) {
                    buildingSource = 'composite';
                    buildingSourceLayer = 'building';
                } else {
                    // Try to find building source-layer in existing sources
                    for (const [sourceId, source] of Object.entries(style.sources || {})) {
                        if (source.type === 'vector' && source.url) {
                            // Check layers for building references
                            const buildingLayer = style.layers.find(layer => 
                                layer.source === sourceId && 
                                layer['source-layer'] && 
                                layer['source-layer'].toLowerCase().includes('building')
                            );
                            if (buildingLayer) {
                                buildingSource = sourceId;
                                buildingSourceLayer = buildingLayer['source-layer'];
                                break;
                            }
                        }
                    }
                }

                if (buildingSource && buildingSourceLayer) {
                    // Find insertion point (before first symbol layer or after waterway-label)
                    let insertBeforeLayer = null;
                    const layers = style.layers || [];
                    
                    for (let i = 0; i < layers.length; i++) {
                        const layer = layers[i];
                        if (layer.type === 'symbol') {
                            insertBeforeLayer = layer.id;
                            break;
                        }
                        if (layer.id && layer.id.includes('waterway-label')) {
                            insertBeforeLayer = layers[i + 1]?.id || null;
                            break;
                        }
                    }

                    // Check if building layer already exists
                    const existingBuildingLayer = map.getLayer('3d-buildings');
                    if (!existingBuildingLayer) {
                        map.addLayer({
                            'id': '3d-buildings',
                            'source': buildingSource,
                            'source-layer': buildingSourceLayer,
                            'type': 'fill-extrusion',
                            'minzoom': 15,
                            'paint': {
                                'fill-extrusion-color': '#d0d0d0',
                                'fill-extrusion-opacity': 0.9,
                                'fill-extrusion-height': [
                                    'interpolate',
                                    ['linear'],
                                    ['zoom'],
                                    15, 0,
                                    15.5, ['get', 'height'] || 0,
                                    16, ['*', ['get', 'height'] || 0, 1.1]
                                ],
                                'fill-extrusion-base': ['get', 'min_height'] || 0
                            }
                        }, insertBeforeLayer);

                        console.log('✅ 3D buildings layer added');
                    }
                } else {
                    console.warn('Selected style has no building layer/source-layer for 3D extrusions.');
                }
            } catch (error) {
                console.warn('Could not add 3D buildings:', error);
            }

            // 2. Atmosphere / Light / Fog / Sky (v3 compatible)
            try {
                // Fog (if available in v3)
                if (typeof map.setFog === 'function') {
                    map.setFog({
                        'range': [0.5, 8],
                        'color': '#ffffff',
                        'horizon-blend': 0.1,
                        'high-color': '#245bde',
                        'space-color': '#000000',
                        'star-intensity': 0.15
                    });
                }
            } catch (error) {
                // Fog API not available, silently skip
            }

            try {
                // Light (if available)
                if (typeof map.setLight === 'function') {
                    map.setLight({
                        'anchor': 'viewport',
                        'color': '#ffffff',
                        'intensity': 0.8,
                        'position': [1.15, 210, 30]
                    });
                }
            } catch (error) {
                // Light API not available, silently skip
            }

            try {
                // Sky layer (if available)
                if (typeof map.addLayer === 'function') {
                    const style = map.getStyle();
                    const hasSky = style.layers.some(layer => layer.id === 'sky');
                    
                    if (!hasSky && style.sources && style.sources.mapbox) {
                        map.addLayer({
                            'id': 'sky',
                            'type': 'sky',
                            'paint': {
                                'sky-type': 'atmosphere',
                                'sky-atmosphere-sun': [0.0, 0.0],
                                'sky-atmosphere-sun-intensity': 15,
                                'sky-atmosphere-color': '#ffd700',
                                'sky-atmosphere-halo-color': '#ffffff',
                                'sky-atmosphere-space-color': '#000000',
                                'sky-atmosphere-star-intensity': 0.2
                            }
                        });
                    }
                }
            } catch (error) {
                // Sky layer not available, silently skip
            }

            // 3. Cinematic camera animation (only once)
            if (!hasPlayedCinematicAnimation) {
                hasPlayedCinematicAnimation = true;
                
                // Wait a bit for map to stabilize
                setTimeout(() => {
                    map.easeTo({
                        zoom: 15.5,
                        pitch: 62,
                        bearing: -20,
                        duration: 1600,
                        easing: (t) => {
                            // Smooth easing function
                            return t < 0.5 
                                ? 2 * t * t 
                                : -1 + (4 - 2 * t) * t;
                        }
                    });
                }, 300);
            }
        }

        function initMap() {
            const mapContainer = document.getElementById('mapContainer');
            if (!mapContainer) return;

            // Voyage Sorgun coordinates (Sorgun, Manavgat, Antalya, Turkey)
            const hotelLat = 36.77709681280941;
            const hotelLng = 31.404080701222686;

            // If map already exists, just update it
            if (map) {
                // Start location tracking if not already running
                startLocationTracking();
                loadOtherUsers();
                loadActivityMarkers();
                return;
            }

            // Clear loading text but keep container structure
            const loadingDiv = mapContainer.querySelector('div');
            if (loadingDiv) {
                loadingDiv.remove();
            }

            // Ensure container has explicit height for Mapbox (required!)
            // Ensure container has explicit height for Mapbox (REQUIRED!)
            // Mapbox needs a fixed pixel height, not percentage
            const parent = mapContainer.parentElement;
            let containerHeight = 500; // Default height
            
            if (parent && parent.classList.contains('map-container')) {
                // Get computed or offset height
                const computedStyle = window.getComputedStyle(parent);
                const parentHeight = parseInt(computedStyle.height) || parent.offsetHeight || 500;
                containerHeight = Math.max(parentHeight, 400); // At least 400px
            }
            
            // Set explicit pixel height (Mapbox requirement)
            mapContainer.style.height = containerHeight + 'px';
            mapContainer.style.width = '100%';
            mapContainer.style.position = 'relative';
            
            console.log('🗺️ Map container setup:', {
                width: mapContainer.offsetWidth,
                height: mapContainer.offsetHeight,
                styleHeight: mapContainer.style.height,
                containerHeight,
                parentHeight: parent ? parent.offsetHeight : 'no parent'
            });

            // Check if mapboxgl is loaded
            if (typeof mapboxgl === 'undefined') {
                console.error('Mapbox GL JS not loaded');
                mapContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Mapbox GL JS yüklenemedi. Lütfen internet bağlantınızı kontrol edin.</div>';
                return;
            }

            // Initialize Mapbox map
            try {
                mapboxgl.accessToken = MAPBOX_TOKEN;
                map = new mapboxgl.Map({
                    container: 'mapContainer',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: [hotelLng, hotelLat],
                    zoom: 15,
                    pitch: 0,
                    bearing: 0,
                    // Snapchat-style 3D camera settings
                    antialias: true,
                    cooperativeGestures: true,
                    dragRotate: true,
                    touchPitch: true,
                    scrollZoom: {
                        around: 'center',
                        smooth: true
                    }
                });

                // Add error handler
                map.on('error', (e) => {
                    console.error('Mapbox error:', e);
                    if (e.error && e.error.message) {
                        console.error('Error message:', e.error.message);
                        if (e.error.message.includes('token') || e.error.message.includes('401') || e.error.message.includes('Unauthorized')) {
                            mapContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;"><strong>Mapbox Token Hatası</strong><br>Lütfen geçerli bir Mapbox access token ekleyin.<br><small>Şu anda demo token kullanılıyor ve sınırlı olabilir.</small></div>';
                        } else {
                            mapContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545;">Harita hatası: ${e.error.message}</div>`;
                        }
                    }
                });

                // Debug: Log when map loads
                map.on('load', () => {
                    console.log('✅ Mapbox map loaded successfully');
                });

                map.on('style.load', () => {
                    console.log('✅ Mapbox style loaded');
                    
                    // Snapchat-style 3D buildings and atmosphere
                    setup3DView();
                });
            } catch (error) {
                console.error('Error initializing map:', error);
                mapContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545;">Harita yüklenirken hata: ${error.message}</div>`;
                return;
            }

            // Wait for map to load
            map.on('load', () => {
                // Initial cinematic animation (if style already loaded)
                if (map.isStyleLoaded() && !hasPlayedCinematicAnimation) {
                    setup3DView();
                }
                
                // Add hotel marker
                const hotelEl = document.createElement('div');
                hotelEl.className = 'hotel-marker';
                hotelEl.style.cssText = `
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #34B7F1;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                hotelEl.innerHTML = '<i data-lucide="building" style="color: white; width: 16px; height: 16px;"></i>';

                hotelMarker = new mapboxgl.Marker(hotelEl)
                    .setLngLat([hotelLng, hotelLat])
                    .setPopup(new mapboxgl.Popup().setHTML('<b>Voyage Sorgun</b><br>Otel konumu'))
                    .addTo(map);

                // Re-initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => {
                        lucide.createIcons();
                    }, 100);
                }

                // Setup map chip click handlers
                setupMapChips();

                // Add location button to map
                addLocationButton();

                // Load other users and activities
                loadOtherUsers();
                loadActivityMarkers();

                // Poll for updates every 5 seconds
                setInterval(() => {
                    loadOtherUsers();
                }, 5000);
            });
        }

        function addLocationButton() {
            const mapContainer = document.getElementById('mapContainer');
            if (!mapContainer) {
                console.warn('Map container not found');
                return;
            }

            // Remove existing button if any
            const existingButton = document.getElementById('mapLocationButton');
            if (existingButton) {
                existingButton.remove();
            }

            // Wait a bit for map to fully render
            setTimeout(() => {
                // Create location button
                const locationButton = document.createElement('button');
                locationButton.id = 'mapLocationButton';
                locationButton.className = 'map-location-button';
                locationButton.innerHTML = '<i data-lucide="crosshair"></i>';
                locationButton.title = 'Konumunuza git';
                locationButton.type = 'button';
                
                // Use addEventListener instead of onclick for better reliability
                locationButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Location button clicked');
                    focusOnUserLocation();
                });

                mapContainer.appendChild(locationButton);
                console.log('Location button added to map');

                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => {
                        lucide.createIcons();
                    }, 100);
                }
            }, 300);
        }

        // Show location permission modal
        function showLocationPermissionModal() {
            const modal = document.createElement('div');
            modal.id = 'locationPermissionModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 320px;
                width: 100%;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            `;
            
            const title = currentLanguage === 'tr' ? 'Konumunuza İhtiyacımız Var' :
                          currentLanguage === 'en' ? 'We Need Your Location' :
                          currentLanguage === 'de' ? 'Wir benötigen Ihren Standort' :
                          'Нам нужно ваше местоположение';
            
            const message = currentLanguage === 'tr' ? 
                'Size haritada konumunuzu göstermek için konum iznine ihtiyacımız var.' :
                currentLanguage === 'en' ?
                'We need location permission to show your position on the map.' :
                currentLanguage === 'de' ?
                'Wir benötigen Standortberechtigung, um Ihre Position auf der Karte anzuzeigen.' :
                'Нам нужно разрешение на местоположение, чтобы показать вашу позицию на карте.';
            
            // Get translation
            const cancelText = (typeof t !== 'undefined' ? t('cancel') : null) || 'İptal';
            const allowText = currentLanguage === 'tr' ? 'Konum Ver' :
                              currentLanguage === 'en' ? 'Allow Location' :
                              currentLanguage === 'de' ? 'Standort erlauben' :
                              'Разрешить местоположение';
            
            content.innerHTML = `
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #111b21;">${title}</div>
                <div style="font-size: 14px; color: #667781; margin-bottom: 24px; line-height: 1.5;">${message}</div>
                <div style="display: flex; gap: 8px;">
                    <button id="cancelLocationBtn" style="flex: 1; padding: 12px; border: 1px solid #e4e6e9; background: white; color: #667781; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">${cancelText}</button>
                    <button id="allowLocationBtn" style="flex: 1; padding: 12px; border: none; background: #34B7F1; color: white; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">${allowText}</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Cancel button
            document.getElementById('cancelLocationBtn').onclick = () => {
                modal.remove();
            };
            
            // Allow button
            document.getElementById('allowLocationBtn').onclick = () => {
                modal.remove();
                requestLocationAndFocus();
            };
            
            // Click outside to close
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // Request location and focus on it
        async function requestLocationAndFocus() {
            if (!navigator.geolocation) {
                alert('Tarayıcınız konum servislerini desteklemiyor.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    permissionState = 'granted';
                    await updateUserLocation(latitude, longitude, accuracy);
                    updatePermissionBanner(); // Hide banner
                    updateLocationPermissionStatus(); // Update status
                    
                    // Start continuous tracking
                    startLocationTracking();
                    
                    // Focus on location
                    if (map && userMarker) {
                        const lngLat = userMarker.getLngLat();
                        map.easeTo({
                            center: [lngLat.lng, lngLat.lat],
                            zoom: 17,
                            duration: 1000
                        });
                    } else if (map) {
                        // If marker doesn't exist yet, focus on current position
                        map.easeTo({
                            center: [longitude, latitude],
                            zoom: 17,
                            duration: 1000
                        });
                    }
                },
                (error) => {
                    console.error('Location error:', error);
                    if (error.code === error.PERMISSION_DENIED) {
                        permissionState = 'denied';
                        updatePermissionBanner();
                        updateLocationPermissionStatus();
                        alert('Konum izni reddedildi. Lütfen tarayıcı ayarlarından izin verin.');
                    } else {
                        alert('Konum alınamadı. Lütfen tekrar deneyin.');
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Focus on user location - shows modal if no marker exists
        function focusOnUserLocation() {
            console.log('focusOnUserLocation called, map:', map, 'userMarker:', userMarker);
            
            if (!map) {
                console.warn('Map not initialized');
                initMap();
                setTimeout(() => {
                    if (!userMarker) {
                        showLocationPermissionModal();
                    }
                }, 500);
                return;
            }

            // If user marker exists, just focus on it
            if (userMarker) {
                console.log('User marker exists, focusing on it');
                const lngLat = userMarker.getLngLat();
                map.easeTo({
                    center: [lngLat.lng, lngLat.lat],
                    zoom: 17,
                    duration: 1000
                });
            } else {
                // Show permission modal
                console.log('No user marker, showing permission modal');
                showLocationPermissionModal();
            }
        }

        // Start location tracking (watchPosition)
        async function startLocationTracking() {
            // Stop existing tracking if any
            if (userLocationWatchId !== null) {
                navigator.geolocation.clearWatch(userLocationWatchId);
            }
            if (locationUpdateInterval) {
                clearInterval(locationUpdateInterval);
            }

            // Default location for testing (Voyage Sorgun - Sorgun, Manavgat, Antalya)
            const DEFAULT_LAT = 36.77709681280941;
            const DEFAULT_LNG = 31.404080701222686;
            const DEFAULT_ACCURACY = 19;

            if (!navigator.geolocation) {
                console.warn('Geolocation not supported, using default location');
                // Use default location if geolocation not available
                updateUserLocation(DEFAULT_LAT, DEFAULT_LNG, DEFAULT_ACCURACY);
                return;
            }

            // Check permission state first
            const state = await checkPermissionState();

            if (state === 'granted') {
                // Permission already granted, start tracking
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude, accuracy } = position.coords;
                        updateUserLocation(latitude, longitude, accuracy);
                        
                        // Start continuous tracking
                        userLocationWatchId = navigator.geolocation.watchPosition(
                            (position) => {
                                const { latitude, longitude, accuracy } = position.coords;
                                updateUserLocation(latitude, longitude, accuracy);
                            },
                            (error) => {
                                console.error('Location tracking error:', error);
                                if (error.code === error.PERMISSION_DENIED) {
                                    permissionState = 'denied';
                                    updatePermissionBanner();
                                    updateLocationPermissionStatus();
                                }
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 5000 // Accept positions up to 5 seconds old
                            }
                        );
                    },
                    (error) => {
                        console.error('Location error:', error);
                        if (error.code === error.PERMISSION_DENIED) {
                            permissionState = 'denied';
                            updatePermissionBanner();
                            updateLocationPermissionStatus();
                        }
                    }
                );
            } else if (state === 'denied') {
                // Permission denied, don't request again automatically
                console.log('Location permission denied, showing banner');
                updatePermissionBanner();
            } else {
                // Permission not yet asked (prompt)
                // Don't auto-request, wait for user to click banner
                console.log('Location permission not yet asked, showing banner');
                updatePermissionBanner();
            }
        }

        // Stop location tracking
        function stopLocationTracking() {
            if (userLocationWatchId !== null) {
                navigator.geolocation.clearWatch(userLocationWatchId);
                userLocationWatchId = null;
            }
            if (locationUpdateInterval) {
                clearInterval(locationUpdateInterval);
                locationUpdateInterval = null;
            }
        }

        // Update user location on map
        async function updateUserLocation(lat, lng, accuracy) {
            if (!map) return;

            // Check ghost mode - only send to backend if not in ghost mode
            try {
                const response = await fetch('/api/guest/me', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    const isGhostMode = data.success && data.guest && data.guest.ghost_mode === true;
                    
                    // Only send location to backend if not in ghost mode
                    if (!isGhostMode) {
                        try {
                            await fetch('/api/location/update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ latitude: lat, longitude: lng, accuracy })
                            });
                            lastLocationUpdateTime = Date.now();
                            updateLocationPermissionStatus(); // Update last update time
                        } catch (error) {
                            console.error('Error updating location:', error);
                        }
                    } else {
                        // Still update lastLocationUpdateTime for display, but don't send to backend
                        lastLocationUpdateTime = Date.now();
                        updateLocationPermissionStatus();
                    }
                }
            } catch (error) {
                console.error('Error checking ghost mode:', error);
            }

            // Always update marker on own map (even in ghost mode)

            // Update or create user marker
            // Prevent race condition: check if marker creation is already in progress
            if (!userMarker && !isCreatingUserMarker) {
                isCreatingUserMarker = true; // Set flag to prevent concurrent marker creation
                
                // Remove any existing user markers from map (cleanup duplicates)
                try {
                    // Get all markers on the map and remove any that look like user markers
                    const mapContainer = map.getContainer();
                    const allMarkers = mapContainer.querySelectorAll('.mapboxgl-marker');
                    allMarkers.forEach(markerElement => {
                        const userMarkerContainer = markerElement.querySelector('.user-marker-container');
                        if (userMarkerContainer) {
                            markerElement.remove();
                        }
                    });
                } catch (error) {
                    console.warn('Error cleaning up existing markers:', error);
                }

                // Create user marker with pulse animation
                const userMarkerContainer = document.createElement('div');
                userMarkerContainer.className = 'user-marker-container';
                userMarkerContainer.style.cssText = `
                    position: relative;
                    width: 40px;
                    height: 40px;
                `;

                // Pulse ring
                const pulse = document.createElement('div');
                pulse.className = 'user-marker-pulse';
                userMarkerContainer.appendChild(pulse);

                // Avatar or default icon
                const markerEl = document.createElement('div');
                markerEl.style.cssText = `
                    position: absolute;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background: #008069;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1;
                `;

                // Try to load avatar
                try {
                    const response = await fetch('/api/guest/me', { credentials: 'include' });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.guest && data.guest.avatar_seed && data.guest.avatar_style) {
                            const avatarUrl = `https://api.dicebear.com/7.x/${data.guest.avatar_style}/svg?seed=${data.guest.avatar_seed}`;
                            markerEl.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="Avatar">`;
                        } else {
                            markerEl.innerHTML = '<i data-lucide="user" style="color: white; width: 20px; height: 20px;"></i>';
                        }
                    } else {
                        markerEl.innerHTML = '<i data-lucide="user" style="color: white; width: 20px; height: 20px;"></i>';
                    }
                } catch (error) {
                    markerEl.innerHTML = '<i data-lucide="user" style="color: white; width: 20px; height: 20px;"></i>';
                }

                userMarkerContainer.appendChild(markerEl);
                lucide.createIcons();

                // Double-check userMarker is still null before creating (final race condition check)
                if (!userMarker) {
                    userMarker = new mapboxgl.Marker(userMarkerContainer)
                        .setLngLat([lng, lat])
                        .setPopup(new mapboxgl.Popup().setHTML('<b>Siz</b><br>Konumunuz'))
                        .addTo(map);
                } else {
                    // Another call already created the marker, just update position of existing marker
                    userMarker.setLngLat([lng, lat]);
                }
                
                isCreatingUserMarker = false; // Reset flag
            } else if (userMarker) {
                // Marker exists - update position AND check/update avatar
                // Check if avatar needs to be updated
                try {
                    const avatarResponse = await fetch('/api/guest/me', { credentials: 'include' });
                    if (avatarResponse.ok) {
                        const avatarData = await avatarResponse.json();
                        if (avatarData.success && avatarData.guest && avatarData.guest.avatar_seed && avatarData.guest.avatar_style) {
                            // Get current marker's container element
                            const markerElement = userMarker.getElement();
                            if (markerElement) {
                                // Find the marker container div
                                const markerContainer = markerElement.querySelector('.user-marker-container');
                                if (markerContainer) {
                                    // Find the avatar/image element (div with border-radius)
                                    const markerEl = markerContainer.querySelector('div[style*="border-radius: 50%"]');
                                    if (markerEl) {
                                        const newAvatarUrl = `https://api.dicebear.com/7.x/${avatarData.guest.avatar_style}/svg?seed=${avatarData.guest.avatar_seed}`;
                                        const existingImg = markerEl.querySelector('img');
                                        
                                        // Check if avatar changed
                                        if (existingImg) {
                                            if (existingImg.src !== newAvatarUrl) {
                                                // Update avatar URL
                                                existingImg.src = newAvatarUrl;
                                                console.log('✅ User marker avatar updated in existing marker');
                                            }
                                        } else {
                                            // No img element, replace icon with avatar
                                            markerEl.innerHTML = `<img src="${newAvatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="Avatar" onerror="this.parentElement.innerHTML='<i data-lucide=\\"user\\" style=\\"color: white; width: 20px; height: 20px;\\"></i>'; if(typeof lucide !== \\'undefined\\') lucide.createIcons();">`;
                                            if (typeof lucide !== 'undefined') {
                                                lucide.createIcons();
                                            }
                                            console.log('✅ User marker avatar updated (icon replaced with avatar)');
                                        }
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating avatar in existing marker:', error);
                }

                // Smoothly animate marker to new position
                const currentPos = userMarker.getLngLat();
                const targetPos = [lng, lat];
                
                // Simple interpolation (could use more sophisticated easing)
                const steps = 10;
                let step = 0;
                const interval = setInterval(() => {
                    step++;
                    const progress = step / steps;
                    const newLng = currentPos.lng + (targetPos[0] - currentPos.lng) * progress;
                    const newLat = currentPos.lat + (targetPos[1] - currentPos.lat) * progress;
                    userMarker.setLngLat([newLng, newLat]);
                    
                    if (step >= steps) {
                        clearInterval(interval);
                    }
                }, 100); // Update every 100ms for 1 second total
            }

            // Add/update accuracy circle if accuracy is low
            if (accuracy && accuracy > 50) {
                // Remove existing accuracy circle
                const existingCircle = document.querySelector('.accuracy-circle');
                if (existingCircle) existingCircle.remove();

                // Calculate radius in pixels (rough approximation)
                const metersPerPixel = 156543.03392 * Math.cos(lat * Math.PI / 180) / Math.pow(2, map.getZoom());
                const radiusPixels = accuracy / metersPerPixel;

                // Create accuracy circle
                const circle = document.createElement('div');
                circle.className = 'accuracy-circle';
                circle.style.width = `${radiusPixels * 2}px`;
                circle.style.height = `${radiusPixels * 2}px`;
                circle.style.left = '50%';
                circle.style.top = '50%';
                circle.style.transform = 'translate(-50%, -50%)';
                circle.style.marginLeft = `-${radiusPixels}px`;
                circle.style.marginTop = `-${radiusPixels}px`;

                if (userMarker) {
                    const markerElement = userMarker.getElement();
                    if (markerElement && markerElement.parentElement) {
                        markerElement.parentElement.style.position = 'relative';
                        markerElement.parentElement.appendChild(circle);
                    }
                }
            }
        }

        // Update user marker avatar on map
        function updateUserMarkerAvatar(seed, style) {
            if (!map) {
                console.log('Map not initialized yet');
                return;
            }

            if (!userMarker) {
                // Marker doesn't exist yet - it will be created with avatar when location is set
                // The updateUserLocation function will check for avatar on next update
                console.log('User marker not found, will be created with avatar on next location update');
                return;
            }

            // Get current marker element
            const markerElement = userMarker.getElement();
            if (!markerElement) return;

            // Find the marker container div
            const markerContainer = markerElement.querySelector('.user-marker-container');
            if (!markerContainer) return;

            // Find the avatar/image element (div with border-radius)
            const markerEl = markerContainer.querySelector('div[style*="border-radius: 50%"]');
            if (!markerEl) return;

            // Update avatar
            if (seed && style) {
                const avatarUrl = `https://api.dicebear.com/7.x/${style}/svg?seed=${seed}`;
                const existingImg = markerEl.querySelector('img');
                
                if (existingImg) {
                    // Update existing image src
                    existingImg.src = avatarUrl;
                    console.log('✅ User marker avatar updated (existing image)');
                } else {
                    // Replace icon with avatar
                    markerEl.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="Avatar" onerror="this.parentElement.innerHTML='<i data-lucide=\\"user\\" style=\\"color: white; width: 20px; height: 20px;\\"></i>'; if(typeof lucide !== \\'undefined\\') lucide.createIcons();">`;
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    console.log('✅ User marker avatar updated (icon replaced with avatar)');
                }
            } else {
                // No avatar, use default icon
                markerEl.innerHTML = '<i data-lucide="user" style="color: white; width: 20px; height: 20px;"></i>';
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                console.log('✅ User marker updated to default icon');
            }
        }

        // Load other users' locations
        async function loadOtherUsers() {
            if (!map) return;

            // Check ghost mode - if enabled, don't load other users
            try {
                const response = await fetch('/api/guest/me', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    const isGhostMode = data.success && data.guest && data.guest.ghost_mode === true;
                    
                    if (isGhostMode) {
                        // Remove all other users' markers
                        Object.values(otherUsersMarkers).forEach(marker => marker.remove());
                        otherUsersMarkers = {};
                        return; // Don't load other users in ghost mode
                    }
                }
            } catch (error) {
                console.error('Error checking ghost mode:', error);
            }

            try {
                const response = await fetch('/api/location/users', { credentials: 'include' });
                if (!response.ok) return;
                
                const users = await response.json();
                
                // Remove users that are no longer active
                Object.keys(otherUsersMarkers).forEach(userId => {
                    if (!users.find(u => u.guest_unique_id === userId)) {
                        otherUsersMarkers[userId].remove();
                        delete otherUsersMarkers[userId];
                    }
                });

                // Add or update markers for active users
                users.forEach(user => {
                    if (!user.latitude || !user.longitude) return;

                    if (otherUsersMarkers[user.guest_unique_id]) {
                        // Update existing marker position smoothly
                        const marker = otherUsersMarkers[user.guest_unique_id];
                        const currentPos = marker.getLngLat();
                        const targetPos = [user.longitude, user.latitude];
                        
                        const steps = 10;
                        let step = 0;
                        const interval = setInterval(() => {
                            step++;
                            const progress = step / steps;
                            const newLng = currentPos.lng + (targetPos[0] - currentPos.lng) * progress;
                            const newLat = currentPos.lat + (targetPos[1] - currentPos.lat) * progress;
                            marker.setLngLat([newLng, newLat]);
                            
                            if (step >= steps) {
                                clearInterval(interval);
                            }
                        }, 100);
                    } else {
                        // Create new marker with fade-in
                        const markerEl = document.createElement('div');
                        markerEl.style.cssText = `
                            width: 36px;
                            height: 36px;
                            border-radius: 50%;
                            background: #f0f0f0;
                            border: 2px solid white;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            opacity: 0;
                            transition: opacity 0.5s;
                        `;

                        // Load avatar
                        if (user.avatar_seed && user.avatar_style) {
                            const avatarUrl = `https://api.dicebear.com/7.x/${user.avatar_style}/svg?seed=${user.avatar_seed}`;
                            markerEl.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="Avatar">`;
                        } else {
                            markerEl.innerHTML = '<i data-lucide="user" style="color: #667781; width: 18px; height: 18px;"></i>';
                            lucide.createIcons();
                        }

                        const marker = new mapboxgl.Marker(markerEl)
                            .setLngLat([user.longitude, user.latitude])
                            .setPopup(new mapboxgl.Popup().setHTML(`<b>${user.guest_name || 'Misafir'}</b>`))
                            .addTo(map);

                        // Fade in animation
                        setTimeout(() => {
                            markerEl.style.opacity = '1';
                        }, 10);

                        otherUsersMarkers[user.guest_unique_id] = marker;
                    }
                });
            } catch (error) {
                console.error('Error loading other users:', error);
            }
        }

        // Load activity markers
        async function loadActivityMarkers() {
            if (!map) return;

            try {
                // Get today's activities with location
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/activities?date=${today}`);
                if (!response.ok) return;

                const activities = await response.json();
                
                // Clear existing activity markers
                activityMarkers.forEach(marker => marker.remove());
                activityMarkers = [];

                // Add markers for activities with coordinates
                activities.forEach(activity => {
                    if (!activity.map_latitude || !activity.map_longitude) return;

                    const markerEl = document.createElement('div');
                    markerEl.style.cssText = `
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        background: #FF9800;
                        border: 2px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;

                    if (activity.icon) {
                        markerEl.innerHTML = `<i data-lucide="${activity.icon}" style="color: white; width: 16px; height: 16px;"></i>`;
                        lucide.createIcons();
                    } else {
                        markerEl.innerHTML = '📍';
                    }

                    const popupContent = `
                        <div style="text-align: center;">
                            <b>${activity.title || 'Aktivite'}</b><br>
                            ${activity.start_time ? formatTime(activity.start_time) : ''}
                            ${activity.location ? `<br><small>${activity.location}</small>` : ''}
                            ${activity.map_latitude && activity.map_longitude ? 
                                `<br><button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${activity.map_latitude},${activity.map_longitude}', '_blank')" style="margin-top: 8px; padding: 4px 8px; background: #008069; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Yol Tarifi Al</button>` 
                                : ''}
                        </div>
                    `;

                    const marker = new mapboxgl.Marker(markerEl)
                        .setLngLat([activity.map_longitude, activity.map_latitude])
                        .setPopup(new mapboxgl.Popup().setHTML(popupContent))
                        .addTo(map);

                    activityMarkers.push(marker);
                });
            } catch (error) {
                console.error('Error loading activity markers:', error);
            }
        }

        // Store locations data from database
        let mapLocationsData = {};

        async function loadMapChips() {
            try {
                const response = await fetch('/api/map/locations');
                if (!response.ok) {
                    console.error('Failed to load map locations');
                    return;
                }
                
                const locations = await response.json();
                mapLocationsData = {};
                
                // Store locations by id for quick lookup
                locations.forEach(loc => {
                    mapLocationsData[loc.id] = {
                        name: loc.name,
                        latitude: parseFloat(loc.latitude),
                        longitude: parseFloat(loc.longitude),
                        category: loc.category
                    };
                });
                
                // Create map chip buttons
                const suggestionsContainer = document.getElementById('mapSuggestions');
                if (!suggestionsContainer) return;
                
                suggestionsContainer.innerHTML = '';
                
                // Define featured location keywords for map chips (only these will be shown as chips)
                const featuredKeywords = [
                    { keywords: ['resepsiyon', 'lobby'], displayName: 'Resepsiyon' },
                    { keywords: ['ana restoran', 'restoran teras'], displayName: 'Ana Restoran' },
                    { keywords: ['sahil'], displayName: 'Sahil' },
                    { keywords: ['aquapark'], displayName: 'Aquapark' },
                    { keywords: ['beach club'], displayName: 'Beach Club' },
                    { keywords: ['tenis court'], displayName: 'Tenis Court' }
                ];
                
                // Filter and create chips only for featured locations
                const featuredLocations = [];
                
                featuredKeywords.forEach((featured, index) => {
                    const matchingLoc = locations.find(loc => {
                        const name = loc.name.toLowerCase();
                        return featured.keywords.some(keyword => name.includes(keyword));
                    });
                    
                    if (matchingLoc) {
                        featuredLocations.push({
                            ...matchingLoc,
                            displayName: featured.displayName,
                            order: index
                        });
                    }
                });
                
                // Create chips in the specified order
                featuredLocations
                    .sort((a, b) => a.order - b.order)
                    .forEach(loc => {
                        const chip = document.createElement('button');
                        chip.type = 'button';
                        chip.className = 'map-chip';
                        chip.setAttribute('data-location-id', loc.id);
                        chip.textContent = loc.displayName; // Use display name
                        suggestionsContainer.appendChild(chip);
                    });
                
                // Setup click handlers
                setupMapChips();
            } catch (error) {
                console.error('Error loading map locations:', error);
            }
        }

        function setupMapChips() {
            const mapChips = document.querySelectorAll('.map-chip');
            mapChips.forEach(chip => {
                // Remove existing listeners to avoid duplicates
                const newChip = chip.cloneNode(true);
                chip.parentNode.replaceChild(newChip, chip);
                
                newChip.addEventListener('click', async (e) => {
                    const locationId = parseInt(e.target.getAttribute('data-location-id'));
                    
                    if (!map) {
                        initMap();
                        return;
                    }

                    // Get location data from stored data
                    const locationData = mapLocationsData[locationId];
                    if (!locationData || !locationData.latitude || !locationData.longitude) {
                        console.error('Location not found or missing coordinates:', locationId);
                        return;
                    }

                    const lat = locationData.latitude;
                    const lng = locationData.longitude;

                    map.easeTo({
                        center: [lng, lat], // [lng, lat]
                        zoom: 18,
                        duration: 500
                    });

                    // Add temporary marker
                    const tempEl = document.createElement('div');
                    tempEl.style.cssText = `
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        background: #FF9800;
                        border: 3px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    tempEl.innerHTML = '<i data-lucide="navigation" style="color: white; width: 16px; height: 16px;"></i>';

                    // Remove previous temp marker if exists
                    if (window.tempMarker) {
                        window.tempMarker.remove();
                    }

                    window.tempMarker = new mapboxgl.Marker(tempEl)
                        .setLngLat([lng, lat])
                        .setPopup(new mapboxgl.Popup().setHTML(`<b>${locationData.name}</b>`))
                        .addTo(map)
                        .togglePopup();

                    // Re-initialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        setTimeout(() => {
                            lucide.createIcons();
                        }, 100);
                    }
                });
            });
        }

        // Map search functionality
        let searchMarkers = [];
        let searchTimeout = null;
        
        function setupMapSearch() {
            const searchInput = document.getElementById('mapSearchInput');
            if (!searchInput || !map) return;
            
            // Clear previous markers
            function clearSearchMarkers() {
                searchMarkers.forEach(marker => marker.remove());
                searchMarkers = [];
            }
            
            // Search and mark locations on map
            async function searchAndMarkLocations(query) {
                if (!query || query.trim().length === 0) {
                    clearSearchMarkers();
                    return;
                }
                
                try {
                    const response = await fetch(`/api/map/search?q=${encodeURIComponent(query)}`);
                    if (!response.ok) {
                        console.error('Map search failed');
                        return;
                    }
                    
                    const locations = await response.json();
                    clearSearchMarkers();
                    
                    if (locations.length === 0) {
                        return;
                    }
                    
                    // Mark all matching locations on map
                    locations.forEach(location => {
                        const markerEl = document.createElement('div');
                        markerEl.style.cssText = `
                            width: 30px;
                            height: 30px;
                            background: #1A4D6D;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            cursor: pointer;
                        `;
                        markerEl.innerHTML = '<i data-lucide="map-pin" style="color: white; width: 16px; height: 16px;"></i>';
                        
                        const marker = new mapboxgl.Marker(markerEl)
                            .setLngLat([location.longitude, location.latitude])
                            .setPopup(new mapboxgl.Popup().setHTML(`
                                <b>${location.name}</b><br>
                                <small>${location.category}</small>${location.distance_km ? `<br><small>${location.distance_km} km</small>` : ''}
                            `))
                            .addTo(map);
                        
                        searchMarkers.push(marker);
                        
                        // Re-initialize Lucide icons
                        if (typeof lucide !== 'undefined') {
                            setTimeout(() => {
                                lucide.createIcons();
                            }, 100);
                        }
                    });
                    
                    // Fit map to show all markers
                    if (searchMarkers.length > 0 && map) {
                        const bounds = new mapboxgl.LngLatBounds();
                        searchMarkers.forEach(marker => {
                            bounds.extend(marker.getLngLat());
                        });
                        map.fitBounds(bounds, { padding: 50, maxZoom: 16 });
                    }
                } catch (error) {
                    console.error('Error searching map locations:', error);
                }
            }
            
            // Debounced search
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                searchTimeout = setTimeout(() => {
                    searchAndMarkLocations(query);
                }, 300);
            });
            
            // Clear markers when input is cleared
            searchInput.addEventListener('input', (e) => {
                if (e.target.value.trim().length === 0) {
                    clearSearchMarkers();
                }
            });
        }

        // Old getUserLocation function - replaced by startLocationTracking
        // Keeping for backwards compatibility if needed elsewhere
        function getUserLocation(showError = false) {
            // This function is now replaced by startLocationTracking
            // But keeping for compatibility
            if (!navigator.geolocation) {
                console.warn('Geolocation is not supported by this browser.');
                if (showError) {
                    const errorMsg = currentLanguage === 'tr' ? 
                        'Tarayıcınız konum servislerini desteklemiyor.' :
                        currentLanguage === 'en' ?
                        'Your browser does not support location services.' :
                        currentLanguage === 'de' ?
                        'Ihr Browser unterstützt keine Standortdienste.' :
                        'Ваш браузер не поддерживает службы определения местоположения.';
                    alert(errorMsg);
                }
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;

                    // Use updateUserLocation function
                    updateUserLocation(userLat, userLng, position.coords.accuracy);

                    // Fit map to show both markers
                    if (hotelMarker && userMarker && map) {
                        const bounds = new mapboxgl.LngLatBounds();
                        bounds.extend([hotelMarker.getLngLat().lng, hotelMarker.getLngLat().lat]);
                        bounds.extend([userLng, userLat]);
                        map.fitBounds(bounds, { padding: 50 });
                    } else if (map) {
                        map.easeTo({
                            center: [userLng, userLat],
                            zoom: 15,
                            duration: 1000
                        });
                    }
                },
                (error) => {
                    console.warn('Error getting user location:', error);
                    
                    // If geolocation fails, just show hotel location (silent mode)
                    if (map && hotelMarker) {
                        const lngLat = hotelMarker.getLngLat();
                        map.easeTo({
                            center: [lngLat.lng, lngLat.lat],
                            zoom: 15,
                            duration: 1000
                        });
                    }
                    
                    // Show error message only if explicitly requested
                    if (showError) {
                        let errorMsg;
                        
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMsg = currentLanguage === 'tr' ?
                                'Konum izni reddedildi.\n\nTarayıcı ayarlarından izin verebilirsiniz:\n\n📱 Safari: Ayarlar > Safari > Konum Servisleri\n📱 Chrome: Ayarlar > Site Ayarları > Konum\n\nYa da Settings > Konum İzni bölümünden tekrar deneyebilirsiniz.' :
                                currentLanguage === 'en' ?
                                'Location permission denied.\n\nYou can grant permission in browser settings:\n\n📱 Safari: Settings > Safari > Location Services\n📱 Chrome: Settings > Site Settings > Location\n\nOr try again from Settings > Location Permission.' :
                                currentLanguage === 'de' ?
                                'Standortberechtigung abgelehnt.\n\nSie können die Berechtigung in den Browsereinstellungen erteilen:\n\n📱 Safari: Einstellungen > Safari > Standortdienste\n📱 Chrome: Einstellungen > Website-Einstellungen > Standort\n\nOder versuchen Sie es erneut unter Einstellungen > Standortberechtigung.' :
                                'Разрешение на местоположение отклонено.\n\nВы можете предоставить разрешение в настройках браузера:\n\n📱 Safari: Настройки > Safari > Службы геолокации\n📱 Chrome: Настройки > Настройки сайта > Местоположение\n\nИли попробуйте снова в Настройки > Разрешение на местоположение.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMsg = currentLanguage === 'tr' ?
                                'Konum bilgisi alınamadı. Lütfen internet bağlantınızı kontrol edin.' :
                                currentLanguage === 'en' ?
                                'Location information unavailable. Please check your internet connection.' :
                                currentLanguage === 'de' ?
                                'Standortinformationen nicht verfügbar. Bitte überprüfen Sie Ihre Internetverbindung.' :
                                'Информация о местоположении недоступна. Пожалуйста, проверьте подключение к интернету.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMsg = currentLanguage === 'tr' ?
                                'Konum bilgisi alınırken zaman aşımı oluştu. Lütfen tekrar deneyin.' :
                                currentLanguage === 'en' ?
                                'Timeout while getting location. Please try again.' :
                                currentLanguage === 'de' ?
                                'Zeitüberschreitung beim Abrufen des Standorts. Bitte versuchen Sie es erneut.' :
                                'Истекло время ожидания получения местоположения. Пожалуйста, попробуйте еще раз.';
                        } else {
                            errorMsg = currentLanguage === 'tr' ?
                                'Konum alınamadı. Lütfen tekrar deneyin.' :
                                currentLanguage === 'en' ?
                                'Could not get location. Please try again.' :
                                currentLanguage === 'de' ?
                                'Standort konnte nicht ermittelt werden. Bitte versuchen Sie es erneut.' :
                                'Не удалось получить местоположение. Пожалуйста, попробуйте еще раз.';
                        }
                        alert(errorMsg);
                    }
                },
                options
            );
        }

        // Update reservations information
        function updateReservationsInfo() {
            const reservationRoomNumberEl = document.getElementById('reservationRoomNumber');
            const reservationCheckinDateEl = document.getElementById('reservationCheckinDate');
            const reservationCheckoutDateEl = document.getElementById('reservationCheckoutDate');
            const reservationAdultCountEl = document.getElementById('reservationAdultCount');
            const reservationChildCountEl = document.getElementById('reservationChildCount');

            if (reservationRoomNumberEl) {
                reservationRoomNumberEl.textContent = ROOM_NUMBER || '-';
            }

            if (reservationCheckinDateEl && CHECKIN_DATE) {
                const date = new Date(CHECKIN_DATE);
                reservationCheckinDateEl.textContent = date.toLocaleDateString('tr-TR', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }

            if (reservationCheckoutDateEl && CHECKOUT_DATE) {
                const date = new Date(CHECKOUT_DATE);
                reservationCheckoutDateEl.textContent = date.toLocaleDateString('tr-TR', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }

            // TODO: Get adult_count, child_count from backend
            if (reservationAdultCountEl) {
                reservationAdultCountEl.textContent = '1'; // Default, will be updated from backend
            }

            if (reservationChildCountEl) {
                reservationChildCountEl.textContent = '0'; // Default, will be updated from backend
            }

            // Load SPA reservations and restaurant reservations
            loadSpaReservations();
            loadRestaurantReservations();
        }

        // ============================================
        // SPA Booking API Client
        // ============================================
        const spaApi = {
            baseUrl: SERVER_URL || window.location.origin,

            async getServices() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/spa/services`, {
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Failed to fetch services');
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching SPA services:', error);
                    throw error;
                }
            },

            async getAvailability(serviceId, from, to) {
                try {
                    const params = new URLSearchParams({ serviceId, from, to });
                    const response = await fetch(`${this.baseUrl}/api/spa/availability?${params}`, {
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Failed to fetch availability');
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching SPA availability:', error);
                    throw error;
                }
            },

            async createRequest(payload) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/spa/requests`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to create request');
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error creating SPA request:', error);
                    throw error;
                }
            },

            async listMyRequests() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/spa/requests?mine=true`, {
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Failed to fetch requests');
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching SPA requests:', error);
                    throw error;
                }
            },

            async cancelRequest(requestId) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/spa/requests/${requestId}/cancel`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to cancel request');
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error canceling SPA request:', error);
                    throw error;
                }
            }
        };

        // ============================================
        // SPA Booking Wizard State
        // ============================================
        let spaBookingState = {
            selectedService: null,
            selectedDate: null,
            selectedSlot: null,
            selectedTherapist: null,
            note: ''
        };

        // ============================================
        // SPA Booking Wizard Functions
        // ============================================
        async function openSpaBookingWizard() {
            // Reset state
            spaBookingState = {
                selectedService: null,
                selectedDate: null,
                selectedSlot: null,
                selectedTherapist: null,
                note: ''
            };
            
            // Show modal and start with service selection
            document.getElementById('spaBookingModal').style.display = 'flex';
            showSpaBookingStep('service');
            await loadSpaServices();
        }

        function closeSpaBookingWizard() {
            document.getElementById('spaBookingModal').style.display = 'none';
            spaBookingState = {
                selectedService: null,
                selectedDate: null,
                selectedSlot: null,
                selectedTherapist: null,
                note: ''
            };
        }

        function showSpaBookingStep(step) {
            // Hide all steps
            document.querySelectorAll('.spa-booking-step').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected step
            const stepEl = document.getElementById(`spa-booking-step-${step}`);
            if (stepEl) {
                stepEl.style.display = 'block';
            }
            
            // Update progress indicator
            const steps = ['service', 'date', 'time', 'therapist', 'confirm'];
            const currentIndex = steps.indexOf(step);
            document.querySelectorAll('.spa-booking-progress-dot').forEach((dot, idx) => {
                if (idx <= currentIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        async function loadSpaServices() {
            const container = document.getElementById('spa-services-list');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Yükleniyor...</div>';
            
            try {
                const services = await spaApi.getServices();
                if (!services || services.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Henüz hizmet bulunmamaktadır.</div>';
                    return;
                }
                
                container.innerHTML = '';
                services.forEach(service => {
                    const item = document.createElement('div');
                    item.className = 'spa-service-item';
                    item.onclick = () => selectSpaService(service);
                    item.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #111b21; margin-bottom: 4px;">${service.name}</div>
                            <div style="font-size: 13px; color: #667781; margin-bottom: 4px;">${service.shortDescription || service.category || ''}</div>
                            <div style="font-size: 12px; color: #667781;">${service.durationMin} dk • ${service.price} ${service.currency}</div>
                        </div>
                        <i data-lucide="chevron-right" class="icon icon-md" style="color: #667781;"></i>
                    `;
                    container.appendChild(item);
                });
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (error) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Hata: ${error.message}</div>`;
            }
        }

        function selectSpaService(service) {
            spaBookingState.selectedService = service;
            showSpaBookingStep('date');
            loadSpaAvailability();
        }

        async function loadSpaAvailability() {
            if (!spaBookingState.selectedService) return;
            
            // Calculate stay range
            if (!CHECKIN_DATE || !CHECKOUT_DATE) {
                alert('Giriş ve çıkış tarihleri bulunamadı. Lütfen profil bilgilerinizi kontrol edin.');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const checkin = new Date(CHECKIN_DATE);
            checkin.setHours(0, 0, 0, 0);
            const checkout = new Date(CHECKOUT_DATE);
            checkout.setHours(0, 0, 0, 0);
            
            const from = checkin > today ? checkin : today;
            const to = new Date(checkout);
            to.setDate(to.getDate() - 1); // departure-1
            
            const fromStr = from.toISOString().split('T')[0];
            const toStr = to.toISOString().split('T')[0];
            
            const container = document.getElementById('spa-availability-calendar');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Yükleniyor...</div>';
            
            try {
                const availability = await spaApi.getAvailability(
                    spaBookingState.selectedService.id,
                    fromStr,
                    toStr
                );
                
                renderSpaCalendar(availability);
                
                // Show last updated warning if older than 10 minutes
                if (availability.lastUpdatedAt) {
                    const lastUpdated = new Date(availability.lastUpdatedAt);
                    const now = new Date();
                    const minutesAgo = Math.floor((now - lastUpdated) / 60000);
                    
                    const warningEl = document.getElementById('spa-availability-warning');
                    if (warningEl) {
                        if (minutesAgo > 10) {
                            warningEl.style.display = 'block';
                            warningEl.textContent = `⚠️ Müsaitlik verisi güncel olmayabilir. (Son güncelleme: ${minutesAgo} dakika önce)`;
                        } else {
                            warningEl.style.display = 'none';
                        }
                    }
                    
                    const lastUpdateEl = document.getElementById('spa-availability-last-update');
                    if (lastUpdateEl) {
                        lastUpdateEl.textContent = `Son güncelleme: ${minutesAgo === 0 ? 'Az önce' : `${minutesAgo} dakika önce`}`;
                    }
                }
            } catch (error) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Hata: ${error.message}</div>`;
            }
        }

        function renderSpaCalendar(availability) {
            const container = document.getElementById('spa-availability-calendar');
            if (!container) return;
            
            if (!availability.days || availability.days.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Bu tarih aralığında müsaitlik bulunmamaktadır.</div>';
                return;
            }
            
            container.innerHTML = '';
            
            // Add "En erken uygun" button
            const earliestBtn = document.createElement('button');
            earliestBtn.className = 'spa-earliest-btn';
            earliestBtn.onclick = () => selectEarliestAvailableSlot(availability);
            earliestBtn.innerHTML = '<i data-lucide="clock" class="icon icon-sm"></i> En erken uygun';
            container.appendChild(earliestBtn);
            
            // Render calendar days
            availability.days.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'spa-calendar-day';
                
                const date = new Date(day.date);
                const isToday = date.toDateString() === new Date().toDateString();
                const isSelected = spaBookingState.selectedDate === day.date;
                
                let heatClass = '';
                if (day.heat === 'GREEN') heatClass = 'heat-green';
                else if (day.heat === 'YELLOW') heatClass = 'heat-yellow';
                else if (day.heat === 'RED') heatClass = 'heat-red';
                
                dayEl.className = `spa-calendar-day ${heatClass} ${isSelected ? 'selected' : ''}`;
                dayEl.onclick = () => selectSpaDate(day.date, availability);
                
                const dayName = date.toLocaleDateString('tr-TR', { weekday: 'short' });
                const dayNumber = date.getDate();
                const month = date.toLocaleDateString('tr-TR', { month: 'short' });
                
                dayEl.innerHTML = `
                    <div style="font-size: 11px; color: #667781; margin-bottom: 4px;">${dayName}</div>
                    <div style="font-size: 18px; font-weight: 600; color: #111b21;">${dayNumber}</div>
                    <div style="font-size: 10px; color: #667781;">${month}</div>
                    ${isToday ? '<div style="position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; background: #008069; border-radius: 50%;"></div>' : ''}
                `;
                
                container.appendChild(dayEl);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function selectEarliestAvailableSlot(availability) {
            for (const day of availability.days) {
                for (const slot of day.slots || []) {
                    if (slot.availability === 'AVAILABLE' && slot.therapists && slot.therapists.length > 0) {
                        spaBookingState.selectedDate = day.date;
                        spaBookingState.selectedSlot = slot;
                        spaBookingState.selectedTherapist = slot.therapists[0];
                        showSpaBookingStep('confirm');
                        renderSpaConfirmStep();
                        return;
                    }
                }
            }
            alert('Uygun slot bulunamadı.');
        }

        function selectSpaDate(date, availability) {
            spaBookingState.selectedDate = date;
            const selectedDay = availability.days.find(d => d.date === date);
            if (!selectedDay) return;
            
            // Render time slots for selected day
            const container = document.getElementById('spa-time-slots-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!selectedDay.slots || selectedDay.slots.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Bu tarihte müsaitlik bulunmamaktadır.</div>';
                return;
            }
            
            selectedDay.slots.forEach(slot => {
                const slotEl = document.createElement('div');
                const isAvailable = slot.availability === 'AVAILABLE';
                const isLimited = slot.availability === 'LIMITED';
                const isFull = slot.availability === 'FULL';
                
                slotEl.className = `spa-time-slot ${isFull ? 'disabled' : ''}`;
                if (!isFull) {
                    slotEl.onclick = () => selectSpaTimeSlot(slot);
                }
                
                const start = new Date(slot.start);
                const end = new Date(slot.end);
                const timeStr = `${start.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                
                let availabilityBadge = '';
                if (isLimited) {
                    availabilityBadge = '<span style="font-size: 10px; background: #ffc107; color: #000; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Sınırlı</span>';
                } else if (isFull) {
                    availabilityBadge = '<span style="font-size: 10px; background: #dc3545; color: #fff; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Dolu</span>';
                }
                
                slotEl.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: ${isFull ? '#999' : '#111b21'};">
                            ${timeStr}
                            ${availabilityBadge}
                        </div>
                        <div style="font-size: 12px; color: #667781; margin-top: 4px;">
                            ${slot.therapists ? slot.therapists.length + ' terapist' : 'Terapist yok'}
                        </div>
                    </div>
                    ${!isFull ? '<i data-lucide="chevron-right" class="icon icon-md" style="color: #667781;"></i>' : ''}
                `;
                
                container.appendChild(slotEl);
            });
            
            showSpaBookingStep('time');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function selectSpaTimeSlot(slot) {
            spaBookingState.selectedSlot = slot;
            showSpaBookingStep('therapist');
            renderSpaTherapists();
        }

        function renderSpaTherapists() {
            const container = document.getElementById('spa-therapists-list');
            if (!container) return;
            
            if (!spaBookingState.selectedSlot || !spaBookingState.selectedSlot.therapists) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Terapist bulunamadı.</div>';
                return;
            }
            
            container.innerHTML = '';
            
            spaBookingState.selectedSlot.therapists.forEach(therapist => {
                const item = document.createElement('div');
                item.className = 'spa-therapist-item';
                item.onclick = () => selectSpaTherapist(therapist);
                
                const tags = therapist.tags && therapist.tags.length > 0 
                    ? therapist.tags.map(t => `<span class="spa-therapist-tag">${t}</span>`).join('')
                    : '';
                
                item.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #111b21; margin-bottom: 4px;">${therapist.displayName}</div>
                        <div style="font-size: 13px; color: #667781; margin-bottom: 4px;">${therapist.level || ''}</div>
                        ${tags ? `<div style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px;">${tags}</div>` : ''}
                    </div>
                    <i data-lucide="chevron-right" class="icon icon-md" style="color: #667781;"></i>
                `;
                
                container.appendChild(item);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function selectSpaTherapist(therapist) {
            spaBookingState.selectedTherapist = therapist;
            showSpaBookingStep('confirm');
            renderSpaConfirmStep();
        }

        function renderSpaConfirmStep() {
            const serviceEl = document.getElementById('spa-confirm-service');
            const dateEl = document.getElementById('spa-confirm-date');
            const timeEl = document.getElementById('spa-confirm-time');
            const therapistEl = document.getElementById('spa-confirm-therapist');
            const noteInput = document.getElementById('spa-confirm-note');
            
            if (serviceEl && spaBookingState.selectedService) {
                serviceEl.textContent = spaBookingState.selectedService.name;
            }
            
            if (dateEl && spaBookingState.selectedDate) {
                const date = new Date(spaBookingState.selectedDate);
                dateEl.textContent = date.toLocaleDateString('tr-TR', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric',
                    weekday: 'long'
                });
            }
            
            if (timeEl && spaBookingState.selectedSlot) {
                const start = new Date(spaBookingState.selectedSlot.start);
                const end = new Date(spaBookingState.selectedSlot.end);
                timeEl.textContent = `${start.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
            }
            
            if (therapistEl && spaBookingState.selectedTherapist) {
                therapistEl.textContent = spaBookingState.selectedTherapist.displayName;
            }
            
            if (noteInput) {
                noteInput.value = spaBookingState.note;
            }
        }

        async function submitSpaRequest() {
            if (!spaBookingState.selectedService || !spaBookingState.selectedSlot || !spaBookingState.selectedTherapist) {
                alert('Lütfen tüm seçimleri yapın.');
                return;
            }
            
            const noteInput = document.getElementById('spa-confirm-note');
            if (noteInput) {
                spaBookingState.note = noteInput.value.trim();
            }
            
            const submitBtn = document.getElementById('spa-submit-request-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Gönderiliyor...';
            }
            
            try {
                const payload = {
                    serviceId: spaBookingState.selectedService.id,
                    start: spaBookingState.selectedSlot.start,
                    end: spaBookingState.selectedSlot.end,
                    therapistId: spaBookingState.selectedTherapist.id,
                    note: spaBookingState.note || null
                };
                
                const result = await spaApi.createRequest(payload);
                
                alert('SPA talebiniz başarıyla oluşturuldu! SPA ekibi onayladıktan sonra kesinleşecektir.');
                closeSpaBookingWizard();
                loadSpaReservations();
                
                // Reload my SPA reservations if on reservations section
                const reservationsSection = document.getElementById('reservationsSection');
                if (reservationsSection && reservationsSection.classList.contains('active')) {
                    loadMySpaReservations();
                }
            } catch (error) {
                alert(`Hata: ${error.message}`);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Talebi Gönder';
                }
            }
        }

        // ============================================
        // SPA Reservations Management
        // ============================================
        async function loadSpaReservations() {
            const container = document.getElementById('spaReservations');
            if (!container) return;
            
            try {
                // Calculate date range
                if (!CHECKIN_DATE || !CHECKOUT_DATE) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Giriş ve çıkış tarihleri bulunamadı.</div>';
                    return;
                }
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const checkin = new Date(CHECKIN_DATE);
                checkin.setHours(0, 0, 0, 0);
                const checkout = new Date(CHECKOUT_DATE);
                checkout.setHours(0, 0, 0, 0);
                
                // Start from today, include checkout date
                const from = today;
                const to = new Date(checkout);
                
                container.innerHTML = '';
                
                // Date selection grid (first step) - scrollable calendar
                const dateSelectSection = document.createElement('div');
                dateSelectSection.style.cssText = 'margin-bottom: 24px;';

                const dateSelectTitle = document.createElement('div');
                dateSelectTitle.style.cssText = 'font-size: 14px; font-weight: 600; color: #111b21; margin-bottom: 12px;';
                dateSelectTitle.textContent = 'Tarih Seçin';
                dateSelectSection.appendChild(dateSelectTitle);

                // Generate all dates from today to checkout (including checkout date)
                const allDates = [];
                let currentDate = new Date(from);
                while (currentDate <= to) {
                    allDates.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                // Store dates for navigation
                window.spaAllDates = allDates.map(d => ({
                    date: d.toISOString().split('T')[0],
                    dateObj: new Date(d)
                }));
                window.spaCurrentDateIndex = 0;
                window.spaSelectedDateElement = null; // Track selected date element

                // Date navigation controls
                const navContainer = document.createElement('div');
                navContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';

                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '<i data-lucide="chevron-left" class="icon icon-md"></i>';
                prevBtn.style.cssText = 'background: #f8f9fa; border: 1px solid #e4e6e9; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
                prevBtn.onclick = () => navigateSpaDateGrid('prev');

                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = '<i data-lucide="chevron-right" class="icon icon-md"></i>';
                nextBtn.style.cssText = 'background: #f8f9fa; border: 1px solid #e4e6e9; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
                nextBtn.onclick = () => navigateSpaDateGrid('next');

                navContainer.appendChild(prevBtn);

                const calendarGrid = document.createElement('div');
                calendarGrid.id = 'spa-date-calendar-grid';
                calendarGrid.style.cssText = 'display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; flex: 1; margin: 0 8px;';

                navContainer.appendChild(calendarGrid);
                navContainer.appendChild(nextBtn);
                dateSelectSection.appendChild(navContainer);
                container.appendChild(dateSelectSection);

                // Render initial date grid
                renderSpaDateGrid(calendarGrid, window.spaAllDates, 0);
                
                // Service selection grid (populated after date selection)
                const serviceSelect = document.createElement('div');
                serviceSelect.id = 'spa-service-selector-wrapper';
                serviceSelect.style.cssText = 'margin-bottom: 24px; display: none;';
                
                const serviceSelectTitle = document.createElement('div');
                serviceSelectTitle.style.cssText = 'font-size: 14px; font-weight: 600; color: #111b21; margin-bottom: 12px;';
                serviceSelectTitle.textContent = 'Terapi Seçin';
                serviceSelect.appendChild(serviceSelectTitle);
                
                // Service navigation controls
                const serviceNavContainer = document.createElement('div');
                serviceNavContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
                
                const servicePrevBtn = document.createElement('button');
                servicePrevBtn.innerHTML = '<i data-lucide="chevron-left" class="icon icon-md"></i>';
                servicePrevBtn.style.cssText = 'background: #f8f9fa; border: 1px solid #e4e6e9; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
                servicePrevBtn.onclick = () => navigateSpaServiceGrid('prev');
                
                const serviceNextBtn = document.createElement('button');
                serviceNextBtn.innerHTML = '<i data-lucide="chevron-right" class="icon icon-md"></i>';
                serviceNextBtn.style.cssText = 'background: #f8f9fa; border: 1px solid #e4e6e9; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
                serviceNextBtn.onclick = () => navigateSpaServiceGrid('next');
                
                serviceNavContainer.appendChild(servicePrevBtn);
                
                const serviceGrid = document.createElement('div');
                serviceGrid.id = 'spa-service-grid';
                serviceGrid.style.cssText = 'display: flex; gap: 12px; flex-wrap: nowrap; justify-content: center; flex: 1; margin: 0 8px; overflow: hidden;';
                
                serviceNavContainer.appendChild(serviceGrid);
                serviceNavContainer.appendChild(serviceNextBtn);
                serviceSelect.appendChild(serviceNavContainer);
                container.appendChild(serviceSelect);
                
                // Therapist selection grid (populated after service selection)
                const therapistSelect = document.createElement('div');
                therapistSelect.id = 'spa-therapist-selector-wrapper';
                therapistSelect.style.cssText = 'margin-bottom: 24px; display: none;';
                
                const therapistSelectTitle = document.createElement('div');
                therapistSelectTitle.style.cssText = 'font-size: 14px; font-weight: 600; color: #111b21; margin-bottom: 12px;';
                therapistSelectTitle.textContent = 'Terapist Seçin (Opsiyonel)';
                therapistSelect.appendChild(therapistSelectTitle);
                
                // Therapist navigation controls
                const therapistNavContainer = document.createElement('div');
                therapistNavContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
                
                const therapistPrevBtn = document.createElement('button');
                therapistPrevBtn.innerHTML = '<i data-lucide="chevron-left" class="icon icon-md"></i>';
                therapistPrevBtn.style.cssText = 'background: #f8f9fa; border: 1px solid #e4e6e9; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
                therapistPrevBtn.onclick = () => navigateSpaTherapistGrid('prev');
                
                const therapistNextBtn = document.createElement('button');
                therapistNextBtn.innerHTML = '<i data-lucide="chevron-right" class="icon icon-md"></i>';
                therapistNextBtn.style.cssText = 'background: #f8f9fa; border: 1px solid #e4e6e9; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
                therapistNextBtn.onclick = () => navigateSpaTherapistGrid('next');
                
                therapistNavContainer.appendChild(therapistPrevBtn);
                
                const therapistGrid = document.createElement('div');
                therapistGrid.id = 'spa-therapist-grid';
                therapistGrid.style.cssText = 'display: flex; gap: 12px; flex-wrap: nowrap; justify-content: center; flex: 1; margin: 0 8px; overflow: hidden;';
                
                therapistNavContainer.appendChild(therapistGrid);
                therapistNavContainer.appendChild(therapistNextBtn);
                therapistSelect.appendChild(therapistNavContainer);
                container.appendChild(therapistSelect);
                
                // Time slots container (shown after date selection)
                const slotsContainer = document.createElement('div');
                slotsContainer.id = 'spa-time-slots-container';
                slotsContainer.style.cssText = 'margin-top: 16px; display: none;';
                container.appendChild(slotsContainer);
                
                // Store date range for later use
                window.spaDateRange = { from, to };
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (error) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Hata: ${error.message}</div>`;
            }
        }
        
        // Called when a date is selected (from grid)
        async function onSpaDateSelected(selectedDate) {
            if (!selectedDate) return;
            const serviceSelectorWrapper = document.getElementById('spa-service-selector-wrapper');
            const therapistSelectorWrapper = document.getElementById('spa-therapist-selector-wrapper');
            const slotsContainer = document.getElementById('spa-time-slots-container');
            
            try {
                // Get all services
                const allServices = await spaApi.getServices();
                if (!allServices || allServices.length === 0) {
                    if (slotsContainer) {
                        slotsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Henüz SPA hizmeti bulunmamaktadır.</div>';
                    }
                    return;
                }
                
                // Get availability for all services on selected date
                const availableServices = [];
                const allSlotsByService = new Map(); // serviceId -> slots
                
                for (const service of allServices) {
                    try {
                        const availability = await spaApi.getAvailability(service.id, selectedDate, selectedDate);
                        if (availability.days && availability.days.length > 0) {
                            const day = availability.days[0];
                            if (day.slots && day.slots.some(s => s.availability === 'AVAILABLE' && s.therapists && s.therapists.length > 0)) {
                                availableServices.push(service);
                                allSlotsByService.set(service.id, day.slots || []);
                            }
                        }
                    } catch (error) {
                        console.error(`Error checking availability for service ${service.id}:`, error);
                    }
                }
                
                // Populate service grid
                if (availableServices.length > 0 && serviceSelectorWrapper) {
                    serviceSelectorWrapper.style.display = 'block';
                    
                    // Store services for navigation
                    window.spaAvailableServices = availableServices;
                    window.spaCurrentServiceIndex = 0;
                    window.spaSelectedServiceElement = null;
                    window.spaSelectedServiceId = null;
                    
                    // Render service grid
                    const serviceGrid = document.getElementById('spa-service-grid');
                    if (serviceGrid) {
                        renderSpaServiceGrid(serviceGrid, availableServices, 0);
                    }
                }
                
                // Store all slots for later filtering
                window.spaDateSlotsByService = allSlotsByService;
                window.spaSelectedDate = selectedDate;
                
                // Reset service and therapist selectors
                window.spaSelectedServiceId = null;
                window.spaSelectedTherapistId = null;
                if (therapistSelectorWrapper) therapistSelectorWrapper.style.display = 'none';
                
                // Show all available slots for all services on this date
                await filterAndShowSlots(selectedDate, null);
                
            } catch (error) {
                console.error('Error loading date availability:', error);
                if (slotsContainer) {
                    slotsContainer.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Hata: ${error.message}</div>`;
                }
            }
        }
        
        // Called when a service is selected (from grid)
        async function onSpaServiceSelected(selectedServiceId) {
            if (!selectedServiceId || !window.spaSelectedDate) return;
            
            const therapistSelectorWrapper = document.getElementById('spa-therapist-selector-wrapper');
            
            // Get slots for this service
            const serviceSlots = window.spaDateSlotsByService?.get(selectedServiceId) || [];
            
            // Collect all therapists who can do this service on this date
            const therapists = new Map();
            serviceSlots.forEach(slot => {
                if (slot.availability === 'AVAILABLE' && slot.therapists) {
                    slot.therapists.forEach(therapist => {
                        if (!therapists.has(therapist.id)) {
                            therapists.set(therapist.id, therapist);
                        }
                    });
                }
            });
            
            // Populate therapist grid
            if (therapists.size > 0 && therapistSelectorWrapper) {
                therapistSelectorWrapper.style.display = 'block';
                
                // Store therapists for navigation
                window.spaAvailableTherapists = Array.from(therapists.values());
                window.spaCurrentTherapistIndex = 0;
                window.spaSelectedTherapistElement = null;
                window.spaSelectedTherapistId = null;
                
                // Render therapist grid
                const therapistGrid = document.getElementById('spa-therapist-grid');
                if (therapistGrid) {
                    renderSpaTherapistGrid(therapistGrid, window.spaAvailableTherapists, 0);
                }
            } else if (therapistSelectorWrapper) {
                therapistSelectorWrapper.style.display = 'none';
                window.spaSelectedTherapistId = null;
            }
            
            // Show slots for this service (without therapist filter)
            await filterAndShowSlots(window.spaSelectedDate, selectedServiceId);
        }
        
        // Called when a therapist is selected (from grid)
        async function onSpaTherapistSelected(selectedTherapistId) {
            if (!window.spaSelectedDate || !window.spaSelectedServiceId) return;
            
            // Show slots with therapist filter if selected, otherwise show service slots
            await filterAndShowSlots(window.spaSelectedDate, window.spaSelectedServiceId);
        }
        
        // Filter and show slots based on selected service and therapist
        async function filterAndShowSlots(date, selectedServiceId) {
            const slotsContainer = document.getElementById('spa-time-slots-container');
            const selectedTherapistId = window.spaSelectedTherapistId || null;
            
            if (!slotsContainer || !date) return;
            
            let slotsToShow = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dateObj = new Date(date);
            dateObj.setHours(0, 0, 0, 0);
            const isToday = dateObj.getTime() === today.getTime();
            
            if (selectedServiceId) {
                // Filter by service
                const serviceSlots = window.spaDateSlotsByService?.get(selectedServiceId) || [];
                serviceSlots.forEach(slot => {
                    if (slot.availability === 'AVAILABLE' && slot.therapists && slot.therapists.length > 0) {
                        // Filter by therapist if selected
                        if (selectedTherapistId) {
                            const hasTherapist = slot.therapists.some(t => t.id === selectedTherapistId);
                            if (!hasTherapist) return;
                        }
                        
                        // Filter out past slots for today
                        if (isToday) {
                            const slotStart = new Date(slot.start);
                            if (slotStart <= new Date()) return;
                        }
                        
                        slotsToShow.push({
                            slot: slot,
                            serviceId: selectedServiceId
                        });
                    }
                });
            } else {
                // Show all slots from all available services (no service selected)
                if (window.spaDateSlotsByService) {
                    window.spaDateSlotsByService.forEach((slots, serviceId) => {
                        slots.forEach(slot => {
                            if (slot.availability === 'AVAILABLE' && slot.therapists && slot.therapists.length > 0) {
                                // Filter out past slots for today
                                if (isToday) {
                                    const slotStart = new Date(slot.start);
                                    if (slotStart <= new Date()) return;
                                }
                                
                                slotsToShow.push({
                                    slot: slot,
                                    serviceId: serviceId
                                });
                            }
                        });
                    });
                }
            }
            
            // Sort by time
            slotsToShow.sort((a, b) => {
                const timeA = new Date(a.slot.start);
                const timeB = new Date(b.slot.start);
                return timeA.getTime() - timeB.getTime();
            });
            
            // Show container and render slots
            slotsContainer.style.display = 'block';
            renderTimeSlots(slotsToShow, slotsContainer, date);
        }
        
        // Render time slots list
        function renderTimeSlots(slots, container, date) {
            if (!container) return;
            
            if (slots.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Bu tarihte uygun seans bulunmamaktadır.</div>';
                return;
            }
            
            const dateStr = new Date(date).toLocaleDateString('tr-TR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                weekday: 'long'
            });
            
            container.innerHTML = '';
            
            const title = document.createElement('div');
            title.style.cssText = 'font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 12px;';
            title.textContent = `${dateStr} - Uygun Seanslar`;
            container.appendChild(title);
            
            const slotsList = document.createElement('div');
            slotsList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
            
            slots.forEach(({ slot, serviceId }) => {
                const slotEl = document.createElement('div');
                slotEl.className = 'spa-time-slot';
                slotEl.style.cssText = 'padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e4e6e9; cursor: pointer; display: flex; justify-content: space-between; align-items: center;';
                slotEl.onclick = () => startBookingFromSlot(date, slot, serviceId);
                
                const start = new Date(slot.start);
                const end = new Date(slot.end);
                const timeStr = `${start.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                
                const selectedTherapistId = window.spaSelectedTherapistId || null;
                
                // Get therapist info text
                let therapistText = 'Terapist yok';
                if (slot.therapists && slot.therapists.length > 0) {
                    if (selectedTherapistId) {
                        const selectedTherapist = slot.therapists.find(t => t.id === selectedTherapistId);
                        therapistText = selectedTherapist ? selectedTherapist.displayName || 'Terapist' : 'Terapist müsait';
                    } else {
                        therapistText = slot.therapists.length + ' terapist müsait';
                    }
                }
                
                // Get service name if we know which service this slot belongs to
                let serviceInfo = '';
                if (serviceId && window.spaAvailableServices) {
                    const service = window.spaAvailableServices.find(s => s.id === serviceId);
                    if (service) {
                        serviceInfo = `<div style="font-size: 11px; color: #008069; margin-top: 4px;">${service.name}</div>`;
                    }
                }
                
                slotEl.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #111b21; margin-bottom: 4px;">${timeStr}</div>
                        <div style="font-size: 12px; color: #667781;">
                            ${therapistText}
                        </div>
                        ${serviceInfo}
                    </div>
                    <i data-lucide="chevron-right" class="icon icon-md" style="color: #667781;"></i>
                `;
                
                slotsList.appendChild(slotEl);
            });
            
            container.appendChild(slotsList);
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        // Load SPA calendar for selected service
        async function loadSpaCalendar() {
            const serviceSelector = document.getElementById('spa-service-selector');
            const calendarContainer = document.getElementById('spa-calendar-container');
            const lastUpdateInfo = document.getElementById('spa-calendar-last-update');
            const warningBanner = document.getElementById('spa-calendar-warning');
            
            if (!serviceSelector || !calendarContainer) return;
            
            const serviceId = serviceSelector.value;
            if (!serviceId) {
                calendarContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Lütfen bir hizmet seçin.</div>';
                return;
            }
            
            // Calculate stay range
            if (!CHECKIN_DATE || !CHECKOUT_DATE) {
                calendarContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Giriş ve çıkış tarihleri bulunamadı.</div>';
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const checkin = new Date(CHECKIN_DATE);
            checkin.setHours(0, 0, 0, 0);
            const checkout = new Date(CHECKOUT_DATE);
            checkout.setHours(0, 0, 0, 0);
            
            const from = checkin > today ? checkin : today;
            const to = new Date(checkout);
            to.setDate(to.getDate() - 1); // departure-1
            
            const fromStr = from.toISOString().split('T')[0];
            const toStr = to.toISOString().split('T')[0];
            
            calendarContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Yükleniyor...</div>';
            
            try {
                const availability = await spaApi.getAvailability(serviceId, fromStr, toStr);
                
                // Show last updated info
                if (availability.lastUpdatedAt && lastUpdateInfo) {
                    const lastUpdated = new Date(availability.lastUpdatedAt);
                    const now = new Date();
                    const minutesAgo = Math.floor((now - lastUpdated) / 60000);
                    
                    lastUpdateInfo.textContent = `Son güncelleme: ${minutesAgo === 0 ? 'Az önce' : `${minutesAgo} dakika önce`}`;
                    
                    // Show warning if older than 10 minutes
                    if (warningBanner) {
                        if (minutesAgo > 10) {
                            warningBanner.style.display = 'block';
                            warningBanner.textContent = `⚠️ Müsaitlik verisi güncel olmayabilir. (Son güncelleme: ${minutesAgo} dakika önce)`;
                        } else {
                            warningBanner.style.display = 'none';
                        }
                    }
                }
                
                // Collect all therapists for the selected service
                const allTherapists = new Map();
                if (availability.days) {
                    availability.days.forEach(day => {
                        if (day.slots) {
                            day.slots.forEach(slot => {
                                if (slot.therapists) {
                                    slot.therapists.forEach(therapist => {
                                        if (!allTherapists.has(therapist.id)) {
                                            allTherapists.set(therapist.id, therapist);
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                
                // Update therapist selector
                const therapistSelectorWrapper = document.getElementById('spa-therapist-selector-wrapper');
                const therapistSelector = document.getElementById('spa-therapist-selector');
                if (therapistSelector && therapistSelectorWrapper) {
                    if (allTherapists.size > 0) {
                        therapistSelectorWrapper.style.display = 'block';
                        therapistSelector.innerHTML = '<option value="">Tüm terapistler</option>';
                        Array.from(allTherapists.values()).forEach(therapist => {
                            const option = document.createElement('option');
                            option.value = therapist.id;
                            option.textContent = therapist.displayName || `Terapist ${therapist.id}`;
                            therapistSelector.appendChild(option);
                        });
                    } else {
                        therapistSelectorWrapper.style.display = 'none';
                    }
                }
                
                // Render calendar
                renderSpaCalendarInline(availability, calendarContainer);
                
            } catch (error) {
                calendarContainer.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Hata: ${error.message}</div>`;
            }
        }
        
        // Render calendar inline (not in modal)
        function renderSpaCalendarInline(availability, container) {
            if (!availability.days || availability.days.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Bu tarih aralığında müsaitlik bulunmamaktadır.</div>';
                return;
            }
            
            container.innerHTML = '';
            
            // Filter out past dates
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const filteredDays = availability.days.filter(day => {
                const dayDate = new Date(day.date);
                dayDate.setHours(0, 0, 0, 0);
                return dayDate >= today;
            });
            
            if (filteredDays.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Gelecek tarihlerde müsaitlik bulunmamaktadır.</div>';
                return;
            }
            
            // Show available slots sorted by time (earliest first) for all days
            showAvailableSlotsSorted(filteredDays, container);
            
            // Render calendar days with navigation
            const calendarSection = document.createElement('div');
            calendarSection.style.cssText = 'margin-top: 24px;';
            
            const calendarTitle = document.createElement('div');
            calendarTitle.style.cssText = 'font-size: 14px; font-weight: 600; color: #111b21; margin-bottom: 12px;';
            calendarTitle.textContent = 'Tarih Seçin';
            calendarSection.appendChild(calendarTitle);
            
            // Date navigation controls
            const navContainer = document.createElement('div');
            navContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
            
            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '<i data-lucide="chevron-left" class="icon icon-md"></i>';
            prevBtn.style.cssText = 'background: #f8f9fa; border: 1px solid #e4e6e9; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
            prevBtn.onclick = () => navigateSpaCalendar('prev', availability);
            
            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = '<i data-lucide="chevron-right" class="icon icon-md"></i>';
            nextBtn.style.cssText = 'background: #f8f9fa; border: 1px solid #e4e6e9; border-radius: 8px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
            nextBtn.onclick = () => navigateSpaCalendar('next', availability);
            
            navContainer.appendChild(prevBtn);
            
            const calendarGrid = document.createElement('div');
            calendarGrid.id = 'spa-calendar-grid';
            calendarGrid.style.cssText = 'display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; flex: 1; margin: 0 8px;';
            
            // Store original days for navigation
            window.spaAvailabilityDays = filteredDays;
            window.spaCurrentDateIndex = 0;
            
            renderSpaCalendarGrid(calendarGrid, filteredDays, availability, 0);
            
            navContainer.appendChild(calendarGrid);
            navContainer.appendChild(nextBtn);
            calendarSection.appendChild(navContainer);
            container.appendChild(calendarSection);
            
            // Store availability for navigation
            window.spaCurrentAvailability = availability;
            
            // Time slots container (initially hidden)
            const slotsContainer = document.createElement('div');
            slotsContainer.id = 'spa-day-slots-container';
            slotsContainer.style.cssText = 'display: none; margin-top: 16px;';
            container.appendChild(slotsContainer);
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        // Render calendar grid with pagination (show 7 days at a time)
        function renderSpaCalendarGrid(container, days, availability, startIndex) {
            container.innerHTML = '';
            const daysPerPage = 7;
            const endIndex = Math.min(startIndex + daysPerPage, days.length);
            const visibleDays = days.slice(startIndex, endIndex);
            
            visibleDays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'spa-calendar-day';
                
                const date = new Date(day.date);
                const isToday = date.toDateString() === new Date().toDateString();
                
                let heatClass = '';
                if (day.heat === 'GREEN') heatClass = 'heat-green';
                else if (day.heat === 'YELLOW') heatClass = 'heat-yellow';
                else if (day.heat === 'RED') heatClass = 'heat-red';
                
                dayEl.className = `spa-calendar-day ${heatClass}`;
                dayEl.onclick = () => showDaySlotsWithTherapistFilter(day.date, availability);
                
                const dayName = date.toLocaleDateString('tr-TR', { weekday: 'short' });
                const dayNumber = date.getDate();
                const month = date.toLocaleDateString('tr-TR', { month: 'short' });
                
                dayEl.innerHTML = `
                    <div style="font-size: 11px; color: #667781; margin-bottom: 4px;">${dayName}</div>
                    <div style="font-size: 18px; font-weight: 600; color: #111b21;">${dayNumber}</div>
                    <div style="font-size: 10px; color: #667781;">${month}</div>
                    ${isToday ? '<div style="position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; background: #008069; border-radius: 50%;"></div>' : ''}
                `;
                
                container.appendChild(dayEl);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        // Render date grid for SPA reservations (new flow)
        function renderSpaDateGrid(container, dates, startIndex) {
            container.innerHTML = '';
            const daysPerPage = 3;
            const endIndex = Math.min(startIndex + daysPerPage, dates.length);
            const visibleDates = dates.slice(startIndex, endIndex);
            
            visibleDates.forEach((dateItem, idx) => {
                const dayEl = document.createElement('div');
                dayEl.className = 'spa-calendar-day';
                dayEl.style.cssText = 'position: relative; min-width: 70px; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; border: 1px solid #e4e6e9; border-radius: 12px; cursor: pointer; background: white; transition: all 0.2s;';
                
                const date = dateItem.dateObj;
                const dateStr = dateItem.date;
                const isToday = date.toDateString() === new Date().toDateString();
                
                // Highlight today
                if (isToday) {
                    dayEl.style.borderColor = '#008069';
                    dayEl.style.borderWidth = '2px';
                }
                
                // Highlight selected date
                if (dateStr === window.spaSelectedDate) {
                    dayEl.style.background = '#008069';
                    dayEl.style.color = 'white';
                    window.spaSelectedDateElement = dayEl;
                }
                
                const dayName = date.toLocaleDateString('tr-TR', { weekday: 'short' });
                const dayNumber = date.getDate();
                const month = date.toLocaleDateString('tr-TR', { month: 'short' });
                
                dayEl.innerHTML = `
                    <div style="font-size: 11px; color: ${dateStr === window.spaSelectedDate ? 'white' : '#667781'}; margin-bottom: 4px;">${dayName}</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${dateStr === window.spaSelectedDate ? 'white' : '#111b21'};">${dayNumber}</div>
                    <div style="font-size: 10px; color: ${dateStr === window.spaSelectedDate ? 'white' : '#667781'};">${month}</div>
                    ${isToday && dateStr !== window.spaSelectedDate ? '<div style="position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; background: #008069; border-radius: 50%;"></div>' : ''}
                `;
                
                dayEl.onclick = () => {
                    // Remove previous selection highlight
                    if (window.spaSelectedDateElement) {
                        const prevDate = new Date(window.spaSelectedDate);
                        const prevIsToday = prevDate.toDateString() === new Date().toDateString();
                        window.spaSelectedDateElement.style.background = 'white';
                        window.spaSelectedDateElement.style.color = '';
                        window.spaSelectedDateElement.style.borderColor = prevIsToday ? '#008069' : '#e4e6e9';
                        window.spaSelectedDateElement.style.borderWidth = prevIsToday ? '2px' : '1px';
                    }
                    
                    // Highlight new selection
                    dayEl.style.background = '#008069';
                    dayEl.style.color = 'white';
                    dayEl.style.borderColor = '#008069';
                    dayEl.style.borderWidth = '2px';
                    window.spaSelectedDateElement = dayEl;
                    
                    // Update selected date
                    window.spaSelectedDate = dateStr;
                    
                    // Trigger date selection
                    onSpaDateSelected(dateStr);
                };
                
                dayEl.onmouseenter = () => {
                    if (dateStr !== window.spaSelectedDate) {
                        dayEl.style.background = '#f0f2f5';
                        dayEl.style.borderColor = '#c1c7cd';
                    }
                };
                
                dayEl.onmouseleave = () => {
                    if (dateStr !== window.spaSelectedDate) {
                        dayEl.style.background = isToday ? 'white' : 'white';
                        dayEl.style.borderColor = isToday ? '#008069' : '#e4e6e9';
                    }
                };
                
                container.appendChild(dayEl);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        // Render service grid for SPA reservations
        function renderSpaServiceGrid(container, services, startIndex) {
            container.innerHTML = '';
            const itemsPerPage = 2;
            const endIndex = Math.min(startIndex + itemsPerPage, services.length);
            const visibleServices = services.slice(startIndex, endIndex);
            
            visibleServices.forEach((service, idx) => {
                const serviceEl = document.createElement('div');
                serviceEl.className = 'spa-service-item';
                serviceEl.style.cssText = 'position: relative; min-width: 120px; flex: 1; display: flex; flex-direction: column; padding: 12px; border: 2px solid #e4e6e9; border-radius: 12px; cursor: pointer; background: white; transition: all 0.2s;';
                
                // Highlight selected service
                if (service.id === window.spaSelectedServiceId) {
                    serviceEl.style.background = '#008069';
                    serviceEl.style.borderColor = '#008069';
                    serviceEl.style.color = 'white';
                    window.spaSelectedServiceElement = serviceEl;
                }
                
                serviceEl.innerHTML = `
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px; color: ${service.id === window.spaSelectedServiceId ? 'white' : '#111b21'};">
                        ${service.name || 'Hizmet'}
                    </div>
                    <div style="font-size: 12px; color: ${service.id === window.spaSelectedServiceId ? 'white' : '#667781'}; margin-bottom: 4px;">
                        ${service.durationMin || 0} dakika
                    </div>
                    <div style="font-size: 13px; font-weight: 600; color: ${service.id === window.spaSelectedServiceId ? 'white' : '#008069'}; margin-top: auto;">
                        ${service.price || 0} ${service.currency || 'TL'}
                    </div>
                `;
                
                serviceEl.onclick = () => {
                    // Remove previous selection highlight
                    if (window.spaSelectedServiceElement) {
                        window.spaSelectedServiceElement.style.background = 'white';
                        window.spaSelectedServiceElement.style.borderColor = '#e4e6e9';
                        window.spaSelectedServiceElement.style.color = '';
                        // Update previous element's innerHTML with unselected colors
                        const prevService = window.spaAvailableServices?.find(s => s.id === window.spaSelectedServiceId);
                        if (prevService && window.spaSelectedServiceElement) {
                            window.spaSelectedServiceElement.innerHTML = `
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #111b21;">
                                    ${prevService.name || 'Hizmet'}
                                </div>
                                <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">
                                    ${prevService.durationMin || 0} dakika
                                </div>
                                <div style="font-size: 13px; font-weight: 600; color: #008069; margin-top: auto;">
                                    ${prevService.price || 0} ${prevService.currency || 'TL'}
                                </div>
                            `;
                        }
                    }
                    
                    // Highlight new selection
                    serviceEl.style.background = '#008069';
                    serviceEl.style.borderColor = '#008069';
                    serviceEl.style.color = 'white';
                    window.spaSelectedServiceElement = serviceEl;
                    
                    // Update innerHTML with white colors
                    serviceEl.innerHTML = `
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px; color: white;">
                            ${service.name || 'Hizmet'}
                        </div>
                        <div style="font-size: 12px; color: white; margin-bottom: 4px;">
                            ${service.durationMin || 0} dakika
                        </div>
                        <div style="font-size: 13px; font-weight: 600; color: white; margin-top: auto;">
                            ${service.price || 0} ${service.currency || 'TL'}
                        </div>
                    `;
                    
                    // Update selected service
                    window.spaSelectedServiceId = service.id;
                    
                    // Trigger service selection
                    onSpaServiceSelected(service.id);
                };
                
                serviceEl.onmouseenter = () => {
                    if (service.id !== window.spaSelectedServiceId) {
                        serviceEl.style.background = '#f0f2f5';
                        serviceEl.style.borderColor = '#c1c7cd';
                    }
                };
                
                serviceEl.onmouseleave = () => {
                    if (service.id !== window.spaSelectedServiceId) {
                        serviceEl.style.background = 'white';
                        serviceEl.style.borderColor = '#e4e6e9';
                    }
                };
                
                container.appendChild(serviceEl);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        // Navigate service grid
        function navigateSpaServiceGrid(direction) {
            if (!window.spaAvailableServices || window.spaAvailableServices.length === 0) return;
            
            const itemsPerPage = 2;
            let currentIndex = window.spaCurrentServiceIndex || 0;
            
            if (direction === 'prev') {
                currentIndex = Math.max(0, currentIndex - itemsPerPage);
            } else if (direction === 'next') {
                currentIndex = Math.min(
                    window.spaAvailableServices.length - itemsPerPage,
                    currentIndex + itemsPerPage
                );
            }
            
            window.spaCurrentServiceIndex = currentIndex;
            
            const serviceGrid = document.getElementById('spa-service-grid');
            if (serviceGrid) {
                renderSpaServiceGrid(serviceGrid, window.spaAvailableServices, currentIndex);
            }
        }
        
        // Render therapist grid for SPA reservations
        function renderSpaTherapistGrid(container, therapists, startIndex) {
            container.innerHTML = '';
            const itemsPerPage = 2;
            const endIndex = Math.min(startIndex + itemsPerPage, therapists.length);
            const visibleTherapists = therapists.slice(startIndex, endIndex);
            
            visibleTherapists.forEach((therapist, idx) => {
                const therapistEl = document.createElement('div');
                therapistEl.className = 'spa-therapist-item';
                therapistEl.style.cssText = 'position: relative; min-width: 120px; flex: 1; display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #e4e6e9; border-radius: 12px; cursor: pointer; background: white; transition: all 0.2s;';
                
                // Highlight selected therapist
                if (therapist.id === window.spaSelectedTherapistId) {
                    therapistEl.style.background = '#008069';
                    therapistEl.style.borderColor = '#008069';
                    therapistEl.style.color = 'white';
                    window.spaSelectedTherapistElement = therapistEl;
                }
                
                // Therapist photo or placeholder
                const photoUrl = therapist.photoUrl || therapist.avatar || therapist.photo || null;
                const photoHTML = photoUrl 
                    ? `<img src="${photoUrl}" alt="${therapist.displayName || 'Terapist'}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid ${therapist.id === window.spaSelectedTherapistId ? 'white' : '#e4e6e9'}; margin-bottom: 8px;">`
                    : `<div style="width: 60px; height: 60px; border-radius: 50%; background: #f0f2f5; border: 2px solid ${therapist.id === window.spaSelectedTherapistId ? 'white' : '#e4e6e9'}; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; font-size: 24px;">👤</div>`;
                
                therapistEl.innerHTML = `
                    ${photoHTML}
                    <div style="font-size: 13px; font-weight: 600; text-align: center; color: ${therapist.id === window.spaSelectedTherapistId ? 'white' : '#111b21'};">
                        ${therapist.displayName || `Terapist ${therapist.id}`}
                    </div>
                `;
                
                therapistEl.onclick = () => {
                    // Remove previous selection highlight
                    if (window.spaSelectedTherapistElement) {
                        window.spaSelectedTherapistElement.style.background = 'white';
                        window.spaSelectedTherapistElement.style.borderColor = '#e4e6e9';
                        window.spaSelectedTherapistElement.style.color = '';
                        // Reset photo border
                        const prevPhoto = window.spaSelectedTherapistElement.querySelector('img, div');
                        if (prevPhoto) {
                            prevPhoto.style.borderColor = '#e4e6e9';
                        }
                    }
                    
                    // Highlight new selection
                    therapistEl.style.background = '#008069';
                    therapistEl.style.borderColor = '#008069';
                    therapistEl.style.color = 'white';
                    window.spaSelectedTherapistElement = therapistEl;
                    
                    // Update photo border
                    const photo = therapistEl.querySelector('img, div');
                    if (photo) {
                        photo.style.borderColor = 'white';
                    }
                    
                    // Update selected therapist (allow deselect if clicking same)
                    if (window.spaSelectedTherapistId === therapist.id) {
                        window.spaSelectedTherapistId = null;
                        therapistEl.style.background = 'white';
                        therapistEl.style.borderColor = '#e4e6e9';
                        therapistEl.style.color = '';
                        if (photo) photo.style.borderColor = '#e4e6e9';
                        window.spaSelectedTherapistElement = null;
                    } else {
                        window.spaSelectedTherapistId = therapist.id;
                    }
                    
                    // Trigger therapist selection (or deselection)
                    onSpaTherapistSelected(window.spaSelectedTherapistId);
                };
                
                therapistEl.onmouseenter = () => {
                    if (therapist.id !== window.spaSelectedTherapistId) {
                        therapistEl.style.background = '#f0f2f5';
                        therapistEl.style.borderColor = '#c1c7cd';
                        const photo = therapistEl.querySelector('img, div');
                        if (photo) photo.style.borderColor = '#c1c7cd';
                    }
                };
                
                therapistEl.onmouseleave = () => {
                    if (therapist.id !== window.spaSelectedTherapistId) {
                        therapistEl.style.background = 'white';
                        therapistEl.style.borderColor = '#e4e6e9';
                        const photo = therapistEl.querySelector('img, div');
                        if (photo) photo.style.borderColor = '#e4e6e9';
                    }
                };
                
                container.appendChild(therapistEl);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        // Navigate therapist grid
        function navigateSpaTherapistGrid(direction) {
            if (!window.spaAvailableTherapists || window.spaAvailableTherapists.length === 0) return;
            
            const itemsPerPage = 2;
            let currentIndex = window.spaCurrentTherapistIndex || 0;
            
            if (direction === 'prev') {
                currentIndex = Math.max(0, currentIndex - itemsPerPage);
            } else if (direction === 'next') {
                currentIndex = Math.min(
                    window.spaAvailableTherapists.length - itemsPerPage,
                    currentIndex + itemsPerPage
                );
            }
            
            window.spaCurrentTherapistIndex = currentIndex;
            
            const therapistGrid = document.getElementById('spa-therapist-grid');
            if (therapistGrid) {
                renderSpaTherapistGrid(therapistGrid, window.spaAvailableTherapists, currentIndex);
            }
        }
        
        // Navigate date grid
        function navigateSpaDateGrid(direction) {
            if (!window.spaAllDates || window.spaAllDates.length === 0) return;
            
            const daysPerPage = 3;
            let currentIndex = window.spaCurrentDateIndex || 0;
            
            if (direction === 'prev') {
                currentIndex = Math.max(0, currentIndex - daysPerPage);
            } else if (direction === 'next') {
                currentIndex = Math.min(
                    window.spaAllDates.length - daysPerPage,
                    currentIndex + daysPerPage
                );
            }
            
            window.spaCurrentDateIndex = currentIndex;
            
            const calendarGrid = document.getElementById('spa-date-calendar-grid');
            if (calendarGrid) {
                renderSpaDateGrid(calendarGrid, window.spaAllDates, currentIndex);
            }
        }
        
        // Navigate calendar dates
        function navigateSpaCalendar(direction, availability) {
            if (!window.spaAvailabilityDays) return;
            
            const daysPerPage = 7;
            let currentIndex = window.spaCurrentDateIndex || 0;
            
            if (direction === 'prev') {
                currentIndex = Math.max(0, currentIndex - daysPerPage);
            } else if (direction === 'next') {
                currentIndex = Math.min(
                    window.spaAvailabilityDays.length - daysPerPage,
                    currentIndex + daysPerPage
                );
            }
            
            window.spaCurrentDateIndex = currentIndex;
            
            const calendarGrid = document.getElementById('spa-calendar-grid');
            if (calendarGrid) {
                renderSpaCalendarGrid(calendarGrid, window.spaAvailabilityDays, availability, currentIndex);
            }
        }
        
        // Show available slots sorted by time (for all days)
        function showAvailableSlotsSorted(days, container) {
            // Get selected therapist filter
            const selectedTherapistId = window.spaSelectedTherapistId || null;
            
            // Collect all available slots from all days, sorted by time
            const allSlots = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            days.forEach(day => {
                if (day.slots && day.slots.length > 0) {
                    const dayDate = new Date(day.date);
                    dayDate.setHours(0, 0, 0, 0);
                    const isToday = dayDate.getTime() === today.getTime();
                    
                    day.slots.forEach(slot => {
                        if (slot.availability === 'AVAILABLE' && slot.therapists && slot.therapists.length > 0) {
                            // Filter by selected therapist if any
                            if (selectedTherapistId) {
                                const hasSelectedTherapist = slot.therapists.some(t => t.id === selectedTherapistId);
                                if (!hasSelectedTherapist) {
                                    return; // Skip if selected therapist is not available
                                }
                            }
                            
                            // Filter out past slots for today
                            if (isToday) {
                                const slotStart = new Date(slot.start);
                                if (slotStart <= new Date()) {
                                    return; // Skip past slots
                                }
                            }
                            
                            allSlots.push({
                                date: day.date,
                                slot: slot,
                                day: day,
                                // Include only selected therapist or all therapists
                                therapists: selectedTherapistId 
                                    ? slot.therapists.filter(t => t.id === selectedTherapistId)
                                    : slot.therapists
                            });
                        }
                    });
                }
            });
            
            // Sort by date and time (earliest first)
            allSlots.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime();
                }
                const timeA = new Date(a.slot.start);
                const timeB = new Date(b.slot.start);
                return timeA.getTime() - timeB.getTime();
            });
            
            if (allSlots.length === 0) {
                const noSlotsMsg = document.createElement('div');
                noSlotsMsg.style.cssText = 'text-align: center; padding: 20px; color: #667781; margin-bottom: 16px;';
                noSlotsMsg.textContent = 'Uygun seans bulunmamaktadır.';
                container.appendChild(noSlotsMsg);
                return;
            }
            
            const slotsSection = document.createElement('div');
            slotsSection.style.cssText = 'margin-bottom: 24px;';
            
            const slotsTitle = document.createElement('div');
            slotsTitle.style.cssText = 'font-size: 14px; font-weight: 600; color: #111b21; margin-bottom: 12px;';
            slotsTitle.textContent = 'Uygun Seanslar';
            slotsSection.appendChild(slotsTitle);
            
            const slotsList = document.createElement('div');
            slotsList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
            
            allSlots.forEach(({ date, slot, day }) => {
                const slotEl = document.createElement('div');
                slotEl.className = 'spa-time-slot';
                slotEl.style.cssText = 'padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e4e6e9; cursor: pointer; display: flex; justify-content: space-between; align-items: center;';
                // Try to get serviceId from selector if available
                const serviceSelector = document.getElementById('spa-service-selector');
                const serviceId = serviceSelector?.value || null;
                slotEl.onclick = () => startBookingFromSlot(date, slot, serviceId);
                
                const dateObj = new Date(date);
                const start = new Date(slot.start);
                const end = new Date(slot.end);
                
                const dateStr = dateObj.toLocaleDateString('tr-TR', { 
                    day: 'numeric', 
                    month: 'short',
                    weekday: 'short'
                });
                const timeStr = `${start.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                
                // Get therapist info text
                let therapistText = 'Terapist yok';
                if (slot.therapists && slot.therapists.length > 0) {
                    if (selectedTherapistId) {
                        // If therapist is selected, show therapist name
                        const selectedTherapist = slot.therapists.find(t => t.id === selectedTherapistId);
                        therapistText = selectedTherapist ? selectedTherapist.displayName || 'Terapist' : 'Terapist müsait';
                    } else {
                        // If no therapist selected, show count
                        therapistText = slot.therapists.length + ' terapist müsait';
                    }
                }
                
                slotEl.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #111b21; margin-bottom: 4px;">${dateStr} • ${timeStr}</div>
                        <div style="font-size: 12px; color: #667781;">
                            ${therapistText}
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="icon icon-md" style="color: #667781;"></i>
                `;
                
                slotsList.appendChild(slotEl);
            });
            
            slotsSection.appendChild(slotsList);
            container.appendChild(slotsSection);
        }
        
        // Show day slots with therapist filter option
        function showDaySlotsWithTherapistFilter(date, availability) {
            const slotsContainer = document.getElementById('spa-day-slots-container');
            if (!slotsContainer) return;
            
            const selectedDay = availability.days.find(d => d.date === date);
            if (!selectedDay || !selectedDay.slots || selectedDay.slots.length === 0) {
                slotsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Bu tarihte müsaitlik bulunmamaktadır.</div>';
                slotsContainer.style.display = 'block';
                return;
            }
            
            // Get selected therapist filter
            const selectedTherapistId = window.spaSelectedTherapistId || null;
            
            // Filter out past slots for today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dayDate = new Date(date);
            dayDate.setHours(0, 0, 0, 0);
            const isToday = dayDate.getTime() === today.getTime();
            
            let availableSlots = selectedDay.slots.filter(slot => {
                if (slot.availability !== 'AVAILABLE' || !slot.therapists || slot.therapists.length === 0) {
                    return false;
                }
                
                // Filter by selected therapist if any
                if (selectedTherapistId) {
                    const hasSelectedTherapist = slot.therapists.some(t => t.id === selectedTherapistId);
                    if (!hasSelectedTherapist) {
                        return false; // Skip if selected therapist is not available
                    }
                }
                
                if (isToday) {
                    const slotStart = new Date(slot.start);
                    return slotStart > new Date(); // Only future slots for today
                }
                return true;
            });
            
            // Sort slots by time
            availableSlots.sort((a, b) => {
                const timeA = new Date(a.start);
                const timeB = new Date(b.start);
                return timeA.getTime() - timeB.getTime();
            });
            
            if (availableSlots.length === 0) {
                slotsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Bu tarihte uygun seans bulunmamaktadır.</div>';
                slotsContainer.style.display = 'block';
                return;
            }
            
            slotsContainer.innerHTML = '';
            
            const dateStr = new Date(date).toLocaleDateString('tr-TR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                weekday: 'long'
            });
            
            const title = document.createElement('div');
            title.style.cssText = 'font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 12px;';
            title.textContent = dateStr;
            slotsContainer.appendChild(title);
            
            availableSlots.forEach(slot => {
                const slotEl = document.createElement('div');
                slotEl.className = 'spa-time-slot';
                slotEl.style.cssText = 'padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e4e6e9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';
                // Try to get serviceId from selector if available
                const serviceSelector = document.getElementById('spa-service-selector');
                const serviceId = serviceSelector?.value || null;
                slotEl.onclick = () => startBookingFromSlot(date, slot, serviceId);
                
                const start = new Date(slot.start);
                const end = new Date(slot.end);
                const timeStr = `${start.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                
                // Get therapist info text
                let therapistText = 'Terapist yok';
                if (slot.therapists && slot.therapists.length > 0) {
                    if (selectedTherapistId) {
                        // If therapist is selected, show therapist name
                        const selectedTherapist = slot.therapists.find(t => t.id === selectedTherapistId);
                        therapistText = selectedTherapist ? selectedTherapist.displayName || 'Terapist' : 'Terapist müsait';
                    } else {
                        // If no therapist selected, show count
                        therapistText = slot.therapists.length + ' terapist müsait';
                    }
                }
                
                slotEl.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #111b21; margin-bottom: 4px;">${timeStr}</div>
                        <div style="font-size: 12px; color: #667781;">
                            ${therapistText}
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="icon icon-md" style="color: #667781;"></i>
                `;
                
                slotsContainer.appendChild(slotEl);
            });
            
            slotsContainer.style.display = 'block';
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Scroll to slots
            slotsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Show time slots for selected day
        function showDaySlots(date, availability) {
            const slotsContainer = document.getElementById('spa-day-slots-container');
            if (!slotsContainer) return;
            
            const selectedDay = availability.days.find(d => d.date === date);
            if (!selectedDay || !selectedDay.slots || selectedDay.slots.length === 0) {
                slotsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #667781;">Bu tarihte müsaitlik bulunmamaktadır.</div>';
                slotsContainer.style.display = 'block';
                return;
            }
            
            slotsContainer.innerHTML = '';
            
            const dateStr = new Date(date).toLocaleDateString('tr-TR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                weekday: 'long'
            });
            
            const title = document.createElement('div');
            title.style.cssText = 'font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 12px;';
            title.textContent = dateStr;
            slotsContainer.appendChild(title);
            
            selectedDay.slots.forEach(slot => {
                const slotEl = document.createElement('div');
                const isAvailable = slot.availability === 'AVAILABLE';
                const isLimited = slot.availability === 'LIMITED';
                const isFull = slot.availability === 'FULL';
                
                slotEl.className = `spa-time-slot ${isFull ? 'disabled' : ''}`;
                if (!isFull && slot.therapists && slot.therapists.length > 0) {
                    // Try to get serviceId from selector if available
                const serviceSelector = document.getElementById('spa-service-selector');
                const serviceId = serviceSelector?.value || null;
                slotEl.onclick = () => startBookingFromSlot(date, slot, serviceId);
                }
                
                const start = new Date(slot.start);
                const end = new Date(slot.end);
                const timeStr = `${start.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                
                let availabilityBadge = '';
                if (isLimited) {
                    availabilityBadge = '<span style="font-size: 10px; background: #ffc107; color: #000; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Sınırlı</span>';
                } else if (isFull) {
                    availabilityBadge = '<span style="font-size: 10px; background: #dc3545; color: #fff; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Dolu</span>';
                }
                
                slotEl.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: ${isFull ? '#999' : '#111b21'};">
                            ${timeStr}
                            ${availabilityBadge}
                        </div>
                        <div style="font-size: 12px; color: #667781; margin-top: 4px;">
                            ${slot.therapists ? slot.therapists.length + ' terapist' : 'Terapist yok'}
                        </div>
                    </div>
                    ${!isFull ? '<i data-lucide="chevron-right" class="icon icon-md" style="color: #667781;"></i>' : ''}
                `;
                
                slotsContainer.appendChild(slotEl);
            });
            
            slotsContainer.style.display = 'block';
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Scroll to slots
            slotsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Start booking from selected slot
        async function startBookingFromSlot(date, slot, serviceId) {
            let selectedService = null;
            
            // If serviceId provided, use it; otherwise try to get from selector
            if (serviceId) {
                if (window.spaAvailableServices) {
                    selectedService = window.spaAvailableServices.find(s => s.id === serviceId);
                }
                if (!selectedService) {
                    const serviceList = await spaApi.getServices();
                    selectedService = serviceList.find(s => s.id === serviceId);
                }
            } else {
                const serviceSelector = document.getElementById('spa-service-selector');
                if (serviceSelector && serviceSelector.value) {
                    const serviceList = await spaApi.getServices();
                    selectedService = serviceList.find(s => s.id === serviceSelector.value);
                }
            }
            
            if (!selectedService) {
                alert('Lütfen bir hizmet seçin.');
                return;
            }
            
            try {
                // Set booking state
                spaBookingState = {
                    selectedService: selectedService,
                    selectedDate: date,
                    selectedSlot: slot,
                    selectedTherapist: null,
                    note: ''
                };
                
                // If only one therapist, auto-select; otherwise go to therapist selection
                if (slot.therapists && slot.therapists.length === 1) {
                    spaBookingState.selectedTherapist = slot.therapists[0];
                    showSpaBookingStep('confirm');
                    renderSpaConfirmStep();
                } else if (slot.therapists && slot.therapists.length > 1) {
                    showSpaBookingStep('therapist');
                    renderSpaTherapists();
                } else {
                    alert('Bu slot için terapist bulunamadı.');
                    return;
                }
                
                // Open booking wizard modal
                document.getElementById('spaBookingModal').style.display = 'flex';
            } catch (error) {
                alert(`Hata: ${error.message}`);
            }
        }
        
        // Select earliest available slot (inline version)
        async function selectEarliestAvailableSlotInline(availability) {
            const serviceSelector = document.getElementById('spa-service-selector');
            if (!serviceSelector || !serviceSelector.value) {
                alert('Lütfen bir hizmet seçin.');
                return;
            }
            
            for (const day of availability.days) {
                for (const slot of day.slots || []) {
                    if (slot.availability === 'AVAILABLE' && slot.therapists && slot.therapists.length > 0) {
                        // Scroll to that day
                        const dayEl = document.querySelector(`[onclick*="${day.date}"]`);
                        if (dayEl) {
                            dayEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            dayEl.click(); // Trigger click to show slots
                            // Then select the slot
                            setTimeout(() => {
                                startBookingFromSlot(day.date, slot);
                            }, 300);
                        }
                        return;
                    }
                }
            }
            alert('Uygun slot bulunamadı.');
        }

        // ============================================
        // RESTAURANT RESERVATIONS FUNCTIONS
        // ============================================
        
        // Load available restaurants for today
        async function loadAvailableRestaurants() {
            const container = document.getElementById('availableRestaurants');
            if (!container) return;
            
            try {
                container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading">Yükleniyor...</div></div>';
                
                const response = await fetch('/restaurants');
                if (!response.ok) {
                    throw new Error('Restoranlar yüklenemedi');
                }
                
                const result = await response.json();
                const restaurants = result.success && result.data ? result.data : [];
                
                if (restaurants.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #667781;">
                            Bugün açık restoran bulunmamaktadır.
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = restaurants.map(restaurant => {
                    const photos = restaurant.photos && restaurant.photos.length > 0 ? restaurant.photos[0] : null;
                    const photoUrl = photos ? (photos.startsWith('/') ? photos : `/${photos}`) : null;
                    
                    return `
                        <div style="margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e4e6e9;">
                            ${photoUrl ? `<img src="${photoUrl}" alt="${restaurant.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;">` : ''}
                            <h3 style="font-size: 18px; font-weight: 600; color: #111b21; margin-bottom: 8px;">${restaurant.name || 'Restoran'}</h3>
                            ${restaurant.description ? `<p style="font-size: 14px; color: #667781; margin-bottom: 12px; line-height: 1.4;">${restaurant.description}</p>` : ''}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 16px; font-weight: 600; color: #1a4d6d;">
                                    ${restaurant.price_per_person || 0} ${restaurant.currency || 'TRY'} / kişi
                                </span>
                            </div>
                            <button onclick="openRestaurantReservationModal(${restaurant.id}, '${(restaurant.name || '').replace(/'/g, "\\'")}')" 
                                    style="width: 100%; padding: 12px; background: #1a4d6d; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;">
                                Rezervasyon Yap
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading restaurants:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <p>Restoranlar yüklenirken hata oluştu: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Load restaurant reservations for guest
        async function loadRestaurantReservations() {
            const container = document.getElementById('restaurantReservations');
            if (!container) {
                console.warn('restaurantReservations container not found');
                return;
            }
            
            if (!GUEST_UNIQUE_ID) {
                console.warn('GUEST_UNIQUE_ID not available, cannot load reservations');
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #667781;">
                        Oturum bilgisi bulunamadı. Lütfen sayfayı yenileyin.
                    </div>
                `;
                return;
            }
            
            try {
                console.log('Loading restaurant reservations for guest:', GUEST_UNIQUE_ID);
                // Add cache-busting parameter
                const cacheBuster = new Date().getTime();
                const response = await fetch(`/reservations?guest_unique_id=${encodeURIComponent(GUEST_UNIQUE_ID)}&_t=${cacheBuster}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    let errorMessage = 'Rezervasyonlar yüklenemedi';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                console.log('Reservations response:', result);
                const reservations = result.success && result.data ? result.data : [];
                
                console.log('Parsed reservations array:', reservations);
                console.log('Reservations count:', reservations.length);
                
                if (!reservations || reservations.length === 0) {
                    console.log('No reservations found, showing empty state');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #667781;" data-i18n="noRestaurantReservations">
                            Henüz restoran rezervasyonunuz bulunmamaktadır.
                        </div>
                    `;
                    return;
                }
                
                console.log('Rendering', reservations.length, 'reservations');
                
                try {
                    const reservationsHTML = reservations.map(reservation => {
                        try {
                            console.log('Rendering reservation:', reservation);
                            
                            if (!reservation || !reservation.id) {
                                console.warn('Invalid reservation data:', reservation);
                                return '';
                            }
                            
                            const resDate = reservation.reservation_date ? new Date(reservation.reservation_date) : new Date();
                            const formattedDate = resDate.toLocaleDateString('tr-TR', {
                                day: 'numeric',
                                month: 'long',
                                year: 'numeric'
                            });
                            
                            const photos = reservation.restaurant?.photos && Array.isArray(reservation.restaurant.photos) && reservation.restaurant.photos.length > 0 
                                ? reservation.restaurant.photos[0] 
                                : null;
                            const photoUrl = photos ? (photos.startsWith('/') ? photos : `/${photos}`) : null;
                            
                            const restaurantName = reservation.restaurant?.name || 'Restoran';
                            const paxAdult = reservation.pax_adult || 0;
                            const paxChild = reservation.pax_child || 0;
                            const totalPrice = reservation.total_price || 0;
                            const currency = reservation.currency || 'TRY';
                            const status = reservation.status || 'confirmed';
                            
                            return `
                        <div style="margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e4e6e9;">
                            <div style="display: flex; gap: 12px;">
                                ${photoUrl ? `<img src="${photoUrl}" alt="${restaurantName.replace(/"/g, '&quot;')}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0;">` : ''}
                                <div style="flex: 1; min-width: 0;">
                                    <h3 style="font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 4px;">
                                        ${restaurantName.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                    </h3>
                                    <p style="font-size: 14px; color: #667781; margin-bottom: 8px;">
                                        📅 ${formattedDate}
                                    </p>
                                    <p style="font-size: 14px; color: #667781; margin-bottom: 8px;">
                                        👥 ${paxAdult} Yetişkin, ${paxChild} Çocuk
                                    </p>
                                    <p style="font-size: 16px; font-weight: 600; color: #1a4d6d;">
                                        💰 ${totalPrice} ${currency}
                                    </p>
                                    ${reservation.special_requests ? `<p style="font-size: 12px; color: #667781; margin-top: 8px; font-style: italic;">"${String(reservation.special_requests).replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')}"</p>` : ''}
                                    ${status === 'confirmed' ? `
                                        <button onclick="cancelRestaurantReservation(${reservation.id})" 
                                                style="margin-top: 12px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">
                                            İptal Et
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                        } catch (mapError) {
                            console.error('Error rendering reservation row:', mapError, reservation);
                            return ''; // Skip this reservation
                        }
                    }).filter(html => html.trim().length > 0).join('');
                    
                    if (!reservationsHTML || reservationsHTML.trim().length === 0) {
                        console.warn('No valid reservations to render after filtering');
                        container.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #667781;" data-i18n="noRestaurantReservations">
                                Henüz restoran rezervasyonunuz bulunmamaktadır.
                            </div>
                        `;
                        return;
                    }
                    
                    // Ensure container is visible
                    container.style.display = 'block';
                    container.innerHTML = reservationsHTML;
                    console.log('Successfully rendered', reservations.length, 'reservations to container');
                    
                    // Scroll to top of container to show new reservation
                    container.scrollTop = 0;
                } catch (renderError) {
                    console.error('Error rendering reservations HTML:', renderError);
                    console.error('Render error stack:', renderError.stack);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #dc3545;">
                            <p>Rezervasyonlar gösterilirken hata oluştu: ${renderError.message}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading restaurant reservations:', error);
                console.error('Error stack:', error.stack);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <p>Rezervasyonlar yüklenirken hata oluştu: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Open restaurant reservation modal
        let currentRestaurantForReservation = null;
        function openRestaurantReservationModal(restaurantId, restaurantName) {
            currentRestaurantForReservation = { id: restaurantId, name: restaurantName };
            const modal = document.getElementById('restaurantReservationModal');
            const form = document.getElementById('restaurantReservationForm');
            
            if (modal) {
                document.getElementById('restaurantReservationModalTitle').textContent = 
                    `${restaurantName} - Rezervasyon`;
                document.getElementById('reservation-restaurant-id').value = restaurantId;
                
                // Set default values from guest info
                const adultInput = document.getElementById('reservation-pax-adult');
                const childInput = document.getElementById('reservation-pax-child');
                if (adultInput) {
                    // Try to get from guest info or default to 1
                    adultInput.value = 1;
                }
                if (childInput) {
                    childInput.value = 0;
                }
                
                modal.style.display = 'flex';
            }
        }
        
        // Close restaurant reservation modal
        function closeRestaurantReservationModal() {
            const modal = document.getElementById('restaurantReservationModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentRestaurantForReservation = null;
        }
        
        // Submit restaurant reservation
        async function submitRestaurantReservation(event) {
            event.preventDefault();
            
            if (!GUEST_UNIQUE_ID) {
                alert('Oturum bilgisi bulunamadı. Lütfen sayfayı yenileyin.');
                return;
            }
            
            const restaurantId = document.getElementById('reservation-restaurant-id').value;
            const paxAdult = parseInt(document.getElementById('reservation-pax-adult').value) || 1;
            const paxChild = parseInt(document.getElementById('reservation-pax-child').value) || 0;
            const specialRequests = document.getElementById('reservation-special-requests').value.trim();
            
            if (!restaurantId) {
                alert('Restoran seçilmedi.');
                return;
            }
            
            try {
                const response = await fetch('/reservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        restaurant_id: parseInt(restaurantId),
                        guest_unique_id: GUEST_UNIQUE_ID,
                        reservation_date: new Date().toISOString().split('T')[0], // Today
                        pax_adult: paxAdult,
                        pax_child: paxChild,
                        special_requests: specialRequests || null
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Rezervasyon yapılamadı');
                }
                
                if (result.success) {
                    console.log('Reservation created successfully:', result.data);
                    alert('Rezervasyonunuz başarıyla oluşturuldu!');
                    closeRestaurantReservationModal();
                    
                    // Ensure we're on reservations section to see the new reservation
                    const reservationsSection = document.getElementById('reservationsSection');
                    if (reservationsSection && !reservationsSection.classList.contains('active')) {
                        console.log('Switching to reservations section');
                        switchSection('reservations');
                    }
                    
                    // Small delay to ensure DOM is ready, then load reservations
                    setTimeout(async () => {
                        console.log('Reloading restaurant reservations...');
                        await loadRestaurantReservations();
                        loadAvailableRestaurants(); // Refresh available restaurants list
                        console.log('Restaurant reservations reloaded');
                    }, 500);
                } else {
                    throw new Error(result.error || 'Rezervasyon yapılamadı');
                }
            } catch (error) {
                console.error('Error creating reservation:', error);
                alert(`Rezervasyon yapılırken hata oluştu: ${error.message}`);
            }
        }
        
        // Cancel restaurant reservation
        async function cancelRestaurantReservation(reservationId) {
            if (!confirm('Bu rezervasyonu iptal etmek istediğinize emin misiniz?')) {
                return;
            }
            
            if (!GUEST_UNIQUE_ID) {
                alert('Oturum bilgisi bulunamadı.');
                return;
            }
            
            try {
                const response = await fetch(`/reservations/${reservationId}?guest_unique_id=${encodeURIComponent(GUEST_UNIQUE_ID)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Rezervasyon iptal edilemedi');
                }
                
                if (result.success) {
                    alert('Rezervasyonunuz iptal edildi.');
                    loadRestaurantReservations();
                    loadAvailableRestaurants(); // Refresh list
                } else {
                    throw new Error(result.error || 'Rezervasyon iptal edilemedi');
                }
            } catch (error) {
                console.error('Error cancelling reservation:', error);
                alert(`Rezervasyon iptal edilirken hata oluştu: ${error.message}`);
            }
        }
        
        // Load my SPA reservations (pending and confirmed) for reservations section
        async function loadMySpaReservations() {
            const container = document.getElementById('mySpaReservations');
            if (!container) return;

            if (!GUEST_UNIQUE_ID) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #667781;">
                        Oturum bilgisi bulunamadı. Lütfen giriş yapın.
                    </div>
                `;
                return;
            }

            try {
                const requests = await spaApi.listMyRequests();
                
                // Filter only PENDING and CONFIRMED requests
                const myRequests = requests.filter(req => 
                    req.status === 'PENDING' || req.status === 'CONFIRMED'
                );

                if (myRequests.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #667781;">
                            Bekleyen veya onaylanmış spa rezervasyonunuz bulunmamaktadır.
                        </div>
                    `;
                    return;
                }

                container.innerHTML = myRequests.map(request => {
                    const startDate = new Date(request.start);
                    const endDate = new Date(request.end);

                    const status = request.status || 'PENDING';
                    let statusClass = 'status-pending';
                    let statusText = 'Beklemede';
                    let statusColor = '#ffc107';

                    if (status === 'CONFIRMED') {
                        statusClass = 'status-confirmed';
                        statusText = 'Onaylandı';
                        statusColor = '#28a745';
                    }

                    const dateStr = startDate.toLocaleDateString('tr-TR', { 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric',
                        weekday: 'long'
                    });
                    const timeStr = `${startDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} - ${endDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;

                    return `
                        <div style="margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e4e6e9;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 8px;">
                                        ${request.serviceName || 'SPA Hizmeti'}
                                    </div>
                                    <div style="font-size: 14px; color: #667781; margin-bottom: 4px;">
                                        📅 ${dateStr}
                                    </div>
                                    <div style="font-size: 14px; color: #667781; margin-bottom: 4px;">
                                        🕐 ${timeStr}
                                    </div>
                                    ${request.therapistDisplayName ? `
                                        <div style="font-size: 14px; color: #667781; margin-bottom: 4px;">
                                            👤 Terapist: ${request.therapistDisplayName}
                                        </div>
                                    ` : ''}
                                </div>
                                <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${statusColor}; color: white;">
                                    ${statusText}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');

                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (error) {
                console.error('Error loading my SPA reservations:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        SPA rezervasyonları yüklenirken hata oluştu: ${error.message}
                    </div>
                `;
            }
        }

        async function loadSpaReservationsForMyReservations() {
            const container = document.getElementById('spaRequestsList');
            const section = document.getElementById('spaRequestsInMyReservations');
            if (!container || !section) return;
            
            try {
                const requests = await spaApi.listMyRequests();
                
                if (!requests || requests.length === 0) {
                    section.style.display = 'none';
                    return;
                }
                
                section.style.display = 'block';
                container.innerHTML = '';
                
                requests.forEach(request => {
                    const item = document.createElement('div');
                    item.className = 'spa-request-item';
                    item.onclick = () => showSpaRequestDetails(request);
                    
                    const status = request.status || 'PENDING';
                    let statusClass = 'status-pending';
                    let statusText = 'Beklemede';
                    let statusColor = '#ffc107';
                    
                    if (status === 'CONFIRMED') {
                        statusClass = 'status-confirmed';
                        statusText = 'Onaylandı';
                        statusColor = '#28a745';
                    } else if (status === 'REJECTED') {
                        statusClass = 'status-rejected';
                        statusText = 'Reddedildi';
                        statusColor = '#dc3545';
                    } else if (status === 'CANCELLED') {
                        statusClass = 'status-cancelled';
                        statusText = 'İptal Edildi';
                        statusColor = '#6c757d';
                    } else if (status === 'EXPIRED') {
                        statusClass = 'status-expired';
                        statusText = 'Süresi Doldu';
                        statusColor = '#6c757d';
                    }
                    
                    const start = new Date(request.start);
                    const end = new Date(request.end);
                    const dateStr = start.toLocaleDateString('tr-TR', { 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric'
                    });
                    const timeStr = `${start.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                    
                    item.innerHTML = `
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="font-weight: 600; color: #111b21;">${request.serviceName || 'SPA Hizmeti'}</div>
                                <span class="spa-status-badge ${statusClass}" style="background: ${statusColor}; color: white; font-size: 10px; padding: 2px 8px; border-radius: 12px; font-weight: 500;">${statusText}</span>
                            </div>
                            <div style="font-size: 13px; color: #667781; margin-bottom: 2px;">${dateStr}</div>
                            <div style="font-size: 13px; color: #667781; margin-bottom: 2px;">${timeStr}</div>
                            ${request.therapistDisplayName ? `<div style="font-size: 12px; color: #667781;">Terapist: ${request.therapistDisplayName}</div>` : ''}
                        </div>
                        <i data-lucide="chevron-right" class="icon icon-md" style="color: #667781;"></i>
                    `;
                    
                    container.appendChild(item);
                });
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (error) {
                console.error('Error loading SPA requests:', error);
                section.style.display = 'none';
            }
        }

        function showSpaRequestDetails(request) {
            const modal = document.createElement('div');
            modal.className = 'spa-request-details-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            const status = request.status || 'PENDING';
            let statusText = 'Beklemede';
            let statusColor = '#ffc107';
            
            if (status === 'CONFIRMED') {
                statusText = 'Onaylandı';
                statusColor = '#28a745';
            } else if (status === 'REJECTED') {
                statusText = 'Reddedildi';
                statusColor = '#dc3545';
            } else if (status === 'CANCELLED') {
                statusText = 'İptal Edildi';
                statusColor = '#6c757d';
            } else if (status === 'EXPIRED') {
                statusText = 'Süresi Doldu';
                statusColor = '#6c757d';
            }
            
            const start = new Date(request.start);
            const end = new Date(request.end);
            const dateStr = start.toLocaleDateString('tr-TR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                weekday: 'long'
            });
            const timeStr = `${start.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
            
            const canCancel = status === 'PENDING' || (status === 'CONFIRMED');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 20px; font-weight: 600; color: #111b21; margin: 0;">SPA Talebi Detayları</h3>
                        <button onclick="this.closest('.spa-request-details-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6C757D; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">Hizmet</div>
                        <div style="font-weight: 600; color: #111b21;">${request.serviceName || '-'}</div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">Tarih</div>
                        <div style="font-weight: 600; color: #111b21;">${dateStr}</div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">Saat</div>
                        <div style="font-weight: 600; color: #111b21;">${timeStr}</div>
                    </div>
                    
                    ${request.therapistDisplayName ? `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">Terapist</div>
                        <div style="font-weight: 600; color: #111b21;">${request.therapistDisplayName}</div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">Durum</div>
                        <div>
                            <span style="background: ${statusColor}; color: white; font-size: 12px; padding: 4px 12px; border-radius: 12px; font-weight: 500;">${statusText}</span>
                        </div>
                    </div>
                    
                    ${canCancel ? `
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e4e6e9;">
                        <button onclick="cancelSpaRequest('${request.requestId}')" style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">
                            Talebi İptal Et
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        async function cancelSpaRequest(requestId) {
            if (!confirm('Bu talebi iptal etmek istediğinize emin misiniz?')) {
                return;
            }
            
            try {
                await spaApi.cancelRequest(requestId);
                alert('Talebiniz iptal edildi.');
                document.querySelectorAll('.spa-request-details-modal').forEach(m => m.remove());
                loadSpaReservations();
            } catch (error) {
                alert(`Hata: ${error.message}`);
            }
        }

        // Update profile information
        function updateProfileInfo() {
            const profileNameEl = document.getElementById('profileName');
            const profileInfoEl = document.getElementById('profileInfo');
            const profileGuestNameEl = document.getElementById('profileGuestName');
            const profileGuestSurnameEl = document.getElementById('profileGuestSurname');
            const profileRoomNumberEl = document.getElementById('profileRoomNumber');
            const profileCheckinDateEl = document.getElementById('profileCheckinDate');
            const profileAvatarLargeEl = document.getElementById('profileAvatarLarge');
            
            if (profileNameEl && GUEST_NAME) {
                profileNameEl.textContent = `${GUEST_NAME} ${GUEST_SURNAME || ''}`.trim();
            }
            
            if (profileInfoEl && ROOM_NUMBER) {
                profileInfoEl.textContent = `Oda ${ROOM_NUMBER}`;
            }
            
            if (profileGuestNameEl) {
                profileGuestNameEl.textContent = GUEST_NAME || '-';
            }
            
            if (profileGuestSurnameEl) {
                profileGuestSurnameEl.textContent = GUEST_SURNAME || '-';
            }
            
            if (profileRoomNumberEl) {
                profileRoomNumberEl.textContent = ROOM_NUMBER || '-';
            }
            
            if (profileCheckinDateEl && CHECKIN_DATE) {
                const date = new Date(CHECKIN_DATE);
                profileCheckinDateEl.textContent = date.toLocaleDateString('tr-TR', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
            
            // Update profile avatar
            if (profileAvatarLargeEl && guestProfilePhoto) {
                profileAvatarLargeEl.innerHTML = `<img src="${guestProfilePhoto}" alt="Profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else if (profileAvatarLargeEl) {
                profileAvatarLargeEl.innerHTML = '<i data-lucide="user" class="icon icon-xl"></i>';
            }
        }

        // ============================================
        // Avatar Selection Functions
        // ============================================

        let currentAvatarStyle = 'avataaars'; // Always use avataaars style
        let currentAvatarSeed = null;

        // Load avatar selection
        async function loadAvatarSelection() {
            try {
                // Get current avatar from user data
                const response = await fetch('/api/guest/me', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.guest) {
                        // Always use avataaars style
                        currentAvatarSeed = data.guest.avatar_seed || 'avatar-1';
                        currentAvatarStyle = 'avataaars';
                    }
                }
            } catch (error) {
                console.error('Error loading avatar data:', error);
            }
            
            // Always generate avataaars avatars
            generateAvatars('avataaars');
            updateAvatarPreview();
        }

        // Generate avatars for a style (only avataaars, 36 unique avatars)
        function generateAvatars(style) {
            const grid = document.getElementById('avatarGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Always use avataaars style
            const avatarStyle = 'avataaars';
            
            // Generate 36 unique avatars with different seeds (6x6 grid)
            // Use unique seeds for variety: user name + index + common words
            const seeds = [
                'avatar-1', 'avatar-2', 'avatar-3', 'avatar-4', 'avatar-5', 'avatar-6',
                'person-1', 'person-2', 'person-3', 'person-4', 'person-5', 'person-6',
                'user-1', 'user-2', 'user-3', 'user-4', 'user-5', 'user-6',
                'human-1', 'human-2', 'human-3', 'human-4', 'human-5', 'human-6',
                'character-1', 'character-2', 'character-3', 'character-4', 'character-5', 'character-6',
                'profile-1', 'profile-2', 'profile-3', 'profile-4', 'profile-5', 'profile-6'
            ];
            
            for (let i = 0; i < 36; i++) {
                const seed = seeds[i] || `avatar-${i + 1}`;
                const avatarUrl = `https://api.dicebear.com/7.x/${avatarStyle}/svg?seed=${seed}`;
                
                const avatarItem = document.createElement('div');
                avatarItem.className = 'avatar-item';
                if (currentAvatarSeed && seed === currentAvatarSeed) {
                    avatarItem.classList.add('selected');
                }
                avatarItem.onclick = () => selectAvatar(seed, avatarStyle);
                
                const img = document.createElement('img');
                img.src = avatarUrl;
                img.alt = `Avatar ${i + 1}`;
                avatarItem.appendChild(img);
                
                grid.appendChild(avatarItem);
            }
        }

        // Switch avatar style (deprecated - always use avataaars)
        function switchAvatarStyle(style) {
            // Always use avataaars style
            currentAvatarStyle = 'avataaars';
            generateAvatars('avataaars');
        }

        // Select avatar
        async function selectAvatar(seed, style) {
            currentAvatarSeed = seed;
            currentAvatarStyle = style;
            
            // Update selected state
            document.querySelectorAll('.avatar-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Update preview
            updateAvatarPreview();
            
            // Save to backend
            try {
                const response = await fetch('/api/guest/avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        avatar_seed: seed,
                        avatar_style: style
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save avatar');
                
                // Update map marker with new avatar
                updateUserMarkerAvatar(seed, style);
            } catch (error) {
                console.error('Error saving avatar:', error);
            }
        }

        // Update avatar preview
        function updateAvatarPreview() {
            const preview = document.getElementById('currentAvatarPreview');
            const placeholder = document.getElementById('avatarPreviewPlaceholder');
            
            if (currentAvatarSeed && preview) {
                const avatarUrl = `https://api.dicebear.com/7.x/${currentAvatarStyle}/svg?seed=${currentAvatarSeed}`;
                preview.src = avatarUrl;
                preview.style.display = 'block';
                if (placeholder) placeholder.style.display = 'none';
            } else {
                if (preview) preview.style.display = 'none';
                if (placeholder) placeholder.style.display = 'flex';
            }
        }

        // ============================================
        // Ghost Mode Functions
        // ============================================

        // Toggle ghost mode
        function toggleGhostMode() {
            const toggle = document.getElementById('ghostModeToggle');
            if (toggle) {
                toggle.checked = !toggle.checked;
                handleGhostModeToggle();
            }
        }

        // Handle ghost mode toggle
        async function handleGhostModeToggle() {
            const toggle = document.getElementById('ghostModeToggle');
            if (!toggle) return;
            
            const enabled = toggle.checked;
            
            try {
                const response = await fetch('/api/guest/ghost-mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ enabled })
                });
                
                if (!response.ok) throw new Error('Failed to update ghost mode');
                
                // Show feedback
                if (enabled) {
                    console.log('Ghost mode enabled - location sharing disabled');
                } else {
                    console.log('Ghost mode disabled - location sharing enabled');
                }
            } catch (error) {
                console.error('Error updating ghost mode:', error);
                toggle.checked = !enabled; // Revert on error
            }
        }

        // Update ghost mode toggle state
        async function updateGhostModeToggle() {
            const toggle = document.getElementById('ghostModeToggle');
            if (!toggle) return;
            
            try {
                const response = await fetch('/api/guest/me', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.guest) {
                        // TODO: Get ghost_mode from guest data
                        // toggle.checked = data.guest.ghost_mode || false;
                    }
                }
            } catch (error) {
                console.error('Error loading ghost mode state:', error);
            }
        }

        // Safe area hesaplamalarını güncelle (PWA ana ekrana eklendiğinde)
        function refreshSafeAreaCalculations() {
            // CSS custom properties'leri güncelle
            const root = document.documentElement;
            const computedStyle = getComputedStyle(root);
            
            // Safe area değerlerini al ve custom property olarak set et
            const top = computedStyle.getPropertyValue('env(safe-area-inset-top)') || '0px';
            const bottom = computedStyle.getPropertyValue('env(safe-area-inset-bottom)') || '0px';
            const left = computedStyle.getPropertyValue('env(safe-area-inset-left)') || '0px';
            const right = computedStyle.getPropertyValue('env(safe-area-inset-right)') || '0px';
            
            root.style.setProperty('--safe-area-inset-top', top);
            root.style.setProperty('--safe-area-inset-bottom', bottom);
            root.style.setProperty('--safe-area-inset-left', left);
            root.style.setProperty('--safe-area-inset-right', right);
            
            // Force reflow - CSS'in yeniden hesaplanmasını sağla
            const appContainer = document.querySelector('.app-container');
            if (appContainer) {
                void appContainer.offsetHeight;
            }
        }

        // Klavye açıldığında input container pozisyonunu koru
        function setupKeyboardHandling() {
            const inputContainer = document.querySelector('.input-container');
            const messageInput = document.getElementById('messageInput');
            const chatContainer = document.querySelector('.chat-container');
            
            if (!inputContainer || !messageInput || !chatContainer) return;
            
            // Visual Viewport API ile klavye yüksekliğini takip et
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    // Input focus olduğunda scroll'u en alta al
                    setTimeout(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 100);
                });
            }
            
            // Input focus/blur event'leri
            messageInput.addEventListener('focus', () => {
                // Input focus olduğunda scroll'u en alta al
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 300);
            });
        }

        // PWA standalone mode değişikliğini dinle ve safe area'yı güncelle
        function setupPWASafeAreaRefresh() {
            // İlk yükleme
            setTimeout(refreshSafeAreaCalculations, 100);
            
            // Resize (debounced)
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(refreshSafeAreaCalculations, 150);
            });
            
            // Orientation change
            window.addEventListener('orientationchange', () => {
                setTimeout(refreshSafeAreaCalculations, 300);
            });
            
            // Visual Viewport API (daha hassas, Safari ve Chrome için)
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', refreshSafeAreaCalculations);
                window.visualViewport.addEventListener('scroll', refreshSafeAreaCalculations);
            }
            
            // Display mode değişikliği (PWA standalone)
            if (window.matchMedia) {
                const mediaQuery = window.matchMedia('(display-mode: standalone)');
                if (mediaQuery.addEventListener) {
                    mediaQuery.addEventListener('change', () => {
                        setTimeout(refreshSafeAreaCalculations, 200);
                    });
                }
                
                // Fullscreen mode kontrolü
                const fullscreenQuery = window.matchMedia('(display-mode: fullscreen)');
                if (fullscreenQuery.addEventListener) {
                    fullscreenQuery.addEventListener('change', () => {
                        setTimeout(refreshSafeAreaCalculations, 200);
                    });
                }
            }
            
            // Page visibility (PWA'ya geri dönüldüğünde)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    setTimeout(refreshSafeAreaCalculations, 100);
                }
            });
            
            // Focus (PWA'ya focus olduğunda)
            window.addEventListener('focus', () => {
                setTimeout(refreshSafeAreaCalculations, 100);
            });
            
            // Pageshow event (back/forward cache'den dönüldüğünde)
            window.addEventListener('pageshow', (e) => {
                if (e.persisted) {
                    setTimeout(refreshSafeAreaCalculations, 100);
                }
            });
            
            // iOS specific: Safari'dan PWA'ya geçiş kontrolü
            if (window.navigator.standalone !== undefined) {
                // iOS standalone mode
                window.addEventListener('resize', refreshSafeAreaCalculations);
            }
        }

        // ========== ÇEVİRİ SİSTEMİ ==========
        let currentLanguage = localStorage.getItem('appLanguage') || 'tr';
        
        const translations = {
            tr: {
                // Navigation
                'info': 'Hotel Info',
                'reservations': 'Rezervasyonlar',
                'chat': 'Sohbetler',
                'map': 'Harita',
                'settings': 'Ayarlar',
                
                // Settings
                'changeProfilePhoto': 'Profil Fotoğrafı Değiştir',
                'notifications': 'Bildirimler',
                'locationPermission': 'Konum İzni',
                'locationPermissionStatus': 'İzin ver',
                'location': 'Konum',
                'status': 'Durum:',
                'checking': 'Kontrol ediliyor...',
                'lastUpdate': 'Son güncelleme:',
                'changeSettings': 'Ayarları Değiştir',
                'notSupported': 'Desteklenmiyor',
                'permissionGranted': 'İzin Verildi',
                'permissionDenied': 'İzin Verilmedi',
                'permissionPending': 'İzin Bekleniyor',
                'justNow': 'Az önce',
                'minutesAgo': 'dk önce',
                'hoursAgo': 'saat önce',
                'updateApp': 'Uygulamayı Güncelle',
                'language': 'Dil',
                'selectLanguage': 'Dil Seçin',
                'cancel': 'İptal',
                'logout': 'Çıkış Yap',
                
                // Profile
                'personalInfo': 'Kişisel Bilgiler',
                'name': 'Ad',
                'surname': 'Soyad',
                'room': 'Oda',
                'checkinDate': 'Giriş Tarihi',
                'checkoutDate': 'Çıkış Tarihi',
                
                // Reservations
                'myReservations': 'Rezervasyonlarım',
                'mySpaReservations': 'Spa Rezervasyonlarım',
                'restaurantReservations': 'A\'la Carte Restoran Rezervasyonları',
                'availableRestaurants': 'Bugün Açık Restoranlar',
                'spaReservations': 'Spa Rezervasyonları',
                'noRestaurantReservations': 'Henüz restoran rezervasyonunuz bulunmamaktadır.',
                'noSpaReservations': 'Henüz spa rezervasyonunuz bulunmamaktadır.',
                'spaRequests': 'SPA Taleplerim',
                'newSpaRequest': 'Yeni SPA Talebi Oluştur',
                'spaBookingTitle': 'SPA Rezervasyon Talebi',
                'selectService': 'Terapi Seçin',
                'selectDate': 'Tarih Seçin',
                'selectTime': 'Saat Seçin',
                'selectTherapist': 'Terapist Seçin',
                'confirmRequest': 'Talebi Onaylayın',
                'requestNote': 'Bu bir taleptir. SPA ekibi onayladıktan sonra kesinleşir.',
                'submitRequest': 'Talebi Gönder',
                'earliestAvailable': 'En erken uygun',
                'lastUpdate': 'Son güncelleme',
                'availabilityWarning': 'Müsaitlik verisi güncel olmayabilir.',
                'requestPending': 'Beklemede',
                'requestConfirmed': 'Onaylandı',
                'requestRejected': 'Reddedildi',
                'requestCancelled': 'İptal Edildi',
                'requestExpired': 'Süresi Doldu',
                'cancelRequest': 'Talebi İptal Et',
                'requestDetails': 'SPA Talebi Detayları',
                'service': 'Hizmet',
                'date': 'Tarih',
                'time': 'Saat',
                'therapist': 'Terapist',
                'status': 'Durum',
                'note': 'Not',
                'optional': 'Opsiyonel',
                'back': 'Geri',
                
                // Chat
                'typeMessage': 'Mesajınızı yazın...',
                'connecting': 'Bağlanıyor...',
                'online': 'Çevrimiçi',
                'offline': 'Çevrimdışı',
                'reconnecting': 'Yeniden bağlanıyor...',
                'serverDisconnected': 'Sunucu bağlantıyı kapattı',
                'connectionLost': 'Bağlantı kesildi',
                'connectionError': 'Bağlantı hatası',
                'connectionFailed': 'Bağlantı başarısız',
                'connectionTimeout': 'Bağlantı zaman aşımı',
                'unknownError': 'Bilinmeyen hata',
                
                // Info
                'swimmingPool': 'Yüzme Havuzu',
                'beach': 'Plaj',
                'restaurant': 'Restoran',
                'spa': 'Spa',
                'activities': 'Aktiviteler',
                
                // Map
                'mapLoading': 'Harita yükleniyor...',
                'mapSearchLabel': 'Gitmek istediğiniz yer',
                'mapSearchPlaceholder': 'Oda numarası veya alan adı yazın',
                'room': 'Oda',
                'reception': 'Resepsiyon',
                'lobby': 'Lobby',
                'mainRestaurant': 'Ana Restoran',
                'beachClub': 'Beach Club',
                'spa': 'SPA',
                'voyageSorgun': 'Voyage Sorgun',
                
                // Activities
                'activities': 'Aktiviteler',
                'nowPlaying': 'ŞİMDİ OYNANIYOR',
                'today': 'Bugün',
                'tomorrow': 'Yarın',
                'all': 'Tümü',
                'kids': 'Çocuk',
                'adult': 'Yetişkin',
                'allAges': 'Tüm Yaşlar',
                'evening': 'Akşam',
                'morning': 'Sabah',
                'noon': 'Öğle',
                'other': 'Diğer',
                'noActivitiesForDate': 'Bu tarihte aktivite bulunmuyor',
                'activitiesLoadingError': 'Aktiviteler yüklenirken hata oluştu',
                'activitiesLoading': 'Aktiviteler yükleniyor...',
                
                // Settings
                'ghostMode': 'Hayalet Modu',
                
                // Common
                'loading': 'Yükleniyor...',
                'now': 'Şimdi',
                'viewComments': 'Yorumları görüntüle',
                'likes': 'beğeni',
                'likesLoading': 'Beğenmeler yükleniyor...'
            },
            en: {
                // Navigation
                'info': 'Hotel Info',
                'reservations': 'Reservations',
                'chat': 'Chats',
                'map': 'Map',
                'settings': 'Settings',
                
                // Settings
                'changeProfilePhoto': 'Change Profile Photo',
                'notifications': 'Notifications',
                'locationPermission': 'Location Permission',
                'locationPermissionStatus': 'Grant permission',
                'location': 'Location',
                'status': 'Status:',
                'checking': 'Checking...',
                'lastUpdate': 'Last update:',
                'changeSettings': 'Change Settings',
                'notSupported': 'Not Supported',
                'permissionGranted': 'Permission Granted',
                'permissionDenied': 'Permission Denied',
                'permissionPending': 'Permission Pending',
                'justNow': 'Just now',
                'minutesAgo': 'min ago',
                'hoursAgo': 'hours ago',
                'updateApp': 'Update App',
                'language': 'Language',
                'selectLanguage': 'Select Language',
                'cancel': 'Cancel',
                'logout': 'Logout',
                
                // Profile
                'personalInfo': 'Personal Information',
                'name': 'Name',
                'surname': 'Surname',
                'room': 'Room',
                'checkinDate': 'Check-in Date',
                'checkoutDate': 'Check-out Date',
                
                // Reservations
                'myReservations': 'My Reservations',
                'mySpaReservations': 'My SPA Reservations',
                'restaurantReservations': 'A la Carte Restaurant Reservations',
                'availableRestaurants': 'Restaurants Open Today',
                'spaReservations': 'Spa Reservations',
                'noRestaurantReservations': 'You do not have any restaurant reservations yet.',
                'noSpaReservations': 'You do not have any spa reservations yet.',
                'spaRequests': 'My SPA Requests',
                'newSpaRequest': 'Create New SPA Request',
                'spaBookingTitle': 'SPA Reservation Request',
                'selectService': 'Select Service',
                'selectDate': 'Select Date',
                'selectTime': 'Select Time',
                'selectTherapist': 'Select Therapist',
                'confirmRequest': 'Confirm Request',
                'requestNote': 'This is a request. It will be confirmed after SPA team approval.',
                'submitRequest': 'Submit Request',
                'earliestAvailable': 'Earliest Available',
                'lastUpdate': 'Last update',
                'availabilityWarning': 'Availability data may not be up to date.',
                'requestPending': 'Pending',
                'requestConfirmed': 'Confirmed',
                'requestRejected': 'Rejected',
                'requestCancelled': 'Cancelled',
                'requestExpired': 'Expired',
                'cancelRequest': 'Cancel Request',
                'requestDetails': 'SPA Request Details',
                'service': 'Service',
                'date': 'Date',
                'time': 'Time',
                'therapist': 'Therapist',
                'status': 'Status',
                'note': 'Note',
                'optional': 'Optional',
                'back': 'Back',
                
                // Chat
                'typeMessage': 'Type your message...',
                'connecting': 'Connecting...',
                'online': 'Online',
                'offline': 'Offline',
                'reconnecting': 'Reconnecting...',
                'serverDisconnected': 'Server disconnected',
                'connectionLost': 'Connection lost',
                'connectionError': 'Connection error',
                'connectionFailed': 'Connection failed',
                'connectionTimeout': 'Connection timeout',
                'unknownError': 'Unknown error',
                
                // Info
                'swimmingPool': 'Swimming Pool',
                'beach': 'Beach',
                'restaurant': 'Restaurant',
                'spa': 'Spa',
                'activities': 'Activities',
                
                // Map
                'mapLoading': 'Loading map...',
                'mapSearchLabel': 'Where do you want to go?',
                'mapSearchPlaceholder': 'Type room number or area name',
                'room': 'Room',
                'reception': 'Reception',
                'lobby': 'Lobby',
                'mainRestaurant': 'Main Restaurant',
                'beachClub': 'Beach Club',
                'spa': 'SPA',
                'voyageSorgun': 'Voyage Sorgun',
                
                // Activities
                'activities': 'Activities',
                'nowPlaying': 'NOW PLAYING',
                'today': 'Today',
                'tomorrow': 'Tomorrow',
                'all': 'All',
                'kids': 'Kids',
                'adult': 'Adult',
                'allAges': 'All Ages',
                'evening': 'Evening',
                'morning': 'Morning',
                'noon': 'Noon',
                'other': 'Other',
                'noActivitiesForDate': 'No activities for this date',
                'activitiesLoadingError': 'Error loading activities',
                'activitiesLoading': 'Loading activities...',
                
                // Settings
                'ghostMode': 'Ghost Mode',
                
                // Common
                'loading': 'Loading...',
                'now': 'Now',
                'viewComments': 'View comments',
                'likes': 'likes',
                'likesLoading': 'Likes loading...'
            },
            de: {
                // Navigation
                'info': 'Hotel Info',
                'reservations': 'Reservierungen',
                'chat': 'Chats',
                'map': 'Karte',
                'settings': 'Einstellungen',
                
                // Settings
                'changeProfilePhoto': 'Profilfoto ändern',
                'notifications': 'Benachrichtigungen',
                'locationPermission': 'Standortberechtigung',
                'locationPermissionStatus': 'Berechtigung erteilen',
                'location': 'Standort',
                'status': 'Status:',
                'checking': 'Wird geprüft...',
                'lastUpdate': 'Letzte Aktualisierung:',
                'changeSettings': 'Einstellungen ändern',
                'notSupported': 'Nicht unterstützt',
                'permissionGranted': 'Berechtigung erteilt',
                'permissionDenied': 'Berechtigung verweigert',
                'permissionPending': 'Berechtigung ausstehend',
                'justNow': 'Gerade eben',
                'minutesAgo': 'Min. zuvor',
                'hoursAgo': 'Std. zuvor',
                'updateApp': 'App aktualisieren',
                'language': 'Sprache',
                'selectLanguage': 'Sprache auswählen',
                'cancel': 'Abbrechen',
                'logout': 'Abmelden',
                
                // Profile
                'personalInfo': 'Persönliche Informationen',
                'name': 'Vorname',
                'surname': 'Nachname',
                'room': 'Zimmer',
                'checkinDate': 'Check-in Datum',
                'checkoutDate': 'Check-out Datum',
                
                // Reservations
                'myReservations': 'Meine Reservierungen',
                'mySpaReservations': 'Meine SPA-Reservierungen',
                'restaurantReservations': 'A la Carte Restaurant Reservierungen',
                'availableRestaurants': 'Heute geöffnete Restaurants',
                'spaReservations': 'Spa Reservierungen',
                'noRestaurantReservations': 'Sie haben noch keine Restaurantreservierungen.',
                'noSpaReservations': 'Sie haben noch keine Spa-Reservierungen.',
                'spaRequests': 'Meine SPA-Anfragen',
                'newSpaRequest': 'Neue SPA-Anfrage erstellen',
                'spaBookingTitle': 'SPA-Reservierungsanfrage',
                'selectService': 'Service auswählen',
                'selectDate': 'Datum auswählen',
                'selectTime': 'Uhrzeit auswählen',
                'selectTherapist': 'Therapeut auswählen',
                'confirmRequest': 'Anfrage bestätigen',
                'requestNote': 'Dies ist eine Anfrage. Sie wird nach Genehmigung durch das SPA-Team bestätigt.',
                'submitRequest': 'Anfrage senden',
                'earliestAvailable': 'Frühestes verfügbares',
                'lastUpdate': 'Letzte Aktualisierung',
                'availabilityWarning': 'Verfügbarkeitsdaten sind möglicherweise nicht aktuell.',
                'requestPending': 'Ausstehend',
                'requestConfirmed': 'Bestätigt',
                'requestRejected': 'Abgelehnt',
                'requestCancelled': 'Storniert',
                'requestExpired': 'Abgelaufen',
                'cancelRequest': 'Anfrage stornieren',
                'requestDetails': 'SPA-Anfragedetails',
                'service': 'Service',
                'date': 'Datum',
                'time': 'Uhrzeit',
                'therapist': 'Therapeut',
                'status': 'Status',
                'note': 'Notiz',
                'optional': 'Optional',
                'back': 'Zurück',
                
                // Chat
                'typeMessage': 'Geben Sie Ihre Nachricht ein...',
                'connecting': 'Verbinden...',
                'online': 'Online',
                'offline': 'Offline',
                'reconnecting': 'Wiederverbinden...',
                'serverDisconnected': 'Server getrennt',
                'connectionLost': 'Verbindung verloren',
                'connectionError': 'Verbindungsfehler',
                'connectionFailed': 'Verbindung fehlgeschlagen',
                'connectionTimeout': 'Verbindungszeitüberschreitung',
                'unknownError': 'Unbekannter Fehler',
                
                // Info
                'swimmingPool': 'Schwimmbad',
                'beach': 'Strand',
                'restaurant': 'Restaurant',
                'spa': 'Spa',
                'activities': 'Aktivitäten',
                
                // Map
                'mapLoading': 'Karte wird geladen...',
                'mapSearchLabel': 'Wohin möchten Sie gehen?',
                'mapSearchPlaceholder': 'Zimmernummer oder Bereich eingeben',
                'room': 'Zimmer',
                'reception': 'Rezeption',
                'lobby': 'Lobby',
                'mainRestaurant': 'Hauptrestaurant',
                'beachClub': 'Strandclub',
                'spa': 'SPA',
                'voyageSorgun': 'Voyage Sorgun',
                
                // Activities
                'activities': 'Aktivitäten',
                'nowPlaying': 'LÄUFT GERADE',
                'today': 'Heute',
                'tomorrow': 'Morgen',
                'all': 'Alle',
                'kids': 'Kinder',
                'adult': 'Erwachsene',
                'allAges': 'Alle Altersgruppen',
                'evening': 'Abend',
                'morning': 'Morgen',
                'noon': 'Mittag',
                'other': 'Andere',
                'noActivitiesForDate': 'Keine Aktivitäten für dieses Datum',
                'activitiesLoadingError': 'Fehler beim Laden der Aktivitäten',
                'activitiesLoading': 'Aktivitäten werden geladen...',
                
                // Settings
                'ghostMode': 'Geistermodus',
                
                // Common
                'loading': 'Lädt...',
                'now': 'Jetzt',
                'viewComments': 'Kommentare anzeigen',
                'likes': 'Likes',
                'likesLoading': 'Likes werden geladen...'
            },
            ru: {
                // Navigation
                'info': 'Информация об отеле',
                'reservations': 'Бронирования',
                'chat': 'Чаты',
                'map': 'Карта',
                'settings': 'Настройки',
                
                // Settings
                'changeProfilePhoto': 'Изменить фото профиля',
                'notifications': 'Уведомления',
                'locationPermission': 'Разрешение на местоположение',
                'locationPermissionStatus': 'Предоставить разрешение',
                'location': 'Местоположение',
                'status': 'Статус:',
                'checking': 'Проверка...',
                'lastUpdate': 'Последнее обновление:',
                'changeSettings': 'Изменить настройки',
                'notSupported': 'Не поддерживается',
                'permissionGranted': 'Разрешение предоставлено',
                'permissionDenied': 'Разрешение отклонено',
                'permissionPending': 'Ожидание разрешения',
                'justNow': 'Только что',
                'minutesAgo': 'мин. назад',
                'hoursAgo': 'ч. назад',
                'updateApp': 'Обновить приложение',
                'language': 'Язык',
                'selectLanguage': 'Выберите язык',
                'cancel': 'Отмена',
                'logout': 'Выйти',
                
                // Profile
                'personalInfo': 'Личная информация',
                'name': 'Имя',
                'surname': 'Фамилия',
                'room': 'Номер',
                'checkinDate': 'Дата заезда',
                'checkoutDate': 'Дата выезда',
                
                // Reservations
                'myReservations': 'Мои бронирования',
                'mySpaReservations': 'Мои бронирования SPA',
                'restaurantReservations': 'Бронирования ресторана A la Carte',
                'availableRestaurants': 'Рестораны, открытые сегодня',
                'spaReservations': 'Бронирования SPA',
                'noRestaurantReservations': 'У вас пока нет бронирований ресторана.',
                'noSpaReservations': 'У вас пока нет бронирований SPA.',
                'spaRequests': 'Мои запросы SPA',
                'newSpaRequest': 'Создать новый запрос SPA',
                'spaBookingTitle': 'Запрос на бронирование SPA',
                'selectService': 'Выберите услугу',
                'selectDate': 'Выберите дату',
                'selectTime': 'Выберите время',
                'selectTherapist': 'Выберите терапевта',
                'confirmRequest': 'Подтвердить запрос',
                'requestNote': 'Это запрос. Он будет подтвержден после одобрения командой SPA.',
                'submitRequest': 'Отправить запрос',
                'earliestAvailable': 'Самое раннее доступное',
                'lastUpdate': 'Последнее обновление',
                'availabilityWarning': 'Данные о доступности могут быть неактуальными.',
                'requestPending': 'В ожидании',
                'requestConfirmed': 'Подтверждено',
                'requestRejected': 'Отклонено',
                'requestCancelled': 'Отменено',
                'requestExpired': 'Истекло',
                'cancelRequest': 'Отменить запрос',
                'requestDetails': 'Детали запроса SPA',
                'service': 'Услуга',
                'date': 'Дата',
                'time': 'Время',
                'therapist': 'Терапевт',
                'status': 'Статус',
                'note': 'Примечание',
                'optional': 'Необязательно',
                'back': 'Назад',
                
                // Chat
                'typeMessage': 'Введите ваше сообщение...',
                'connecting': 'Подключение...',
                'online': 'Онлайн',
                'offline': 'Офлайн',
                'reconnecting': 'Переподключение...',
                'serverDisconnected': 'Сервер отключил соединение',
                'connectionLost': 'Соединение потеряно',
                'connectionError': 'Ошибка соединения',
                'connectionFailed': 'Соединение не удалось',
                'connectionTimeout': 'Тайм-аут соединения',
                'unknownError': 'Неизвестная ошибка',
                
                // Info
                'swimmingPool': 'Бассейн',
                'beach': 'Пляж',
                'restaurant': 'Ресторан',
                'spa': 'СПА',
                'activities': 'Активности',
                
                // Map
                'mapLoading': 'Загрузка карты...',
                'mapSearchLabel': 'Куда вы хотите пойти?',
                'mapSearchPlaceholder': 'Введите номер комнаты или название зоны',
                'room': 'Комната',
                'reception': 'Ресепшн',
                'lobby': 'Лобби',
                'mainRestaurant': 'Главный ресторан',
                'beachClub': 'Пляжный клуб',
                'spa': 'СПА',
                'voyageSorgun': 'Voyage Sorgun',
                
                // Activities
                'activities': 'Активности',
                'nowPlaying': 'СЕЙЧАС ИГРАЕТ',
                'today': 'Сегодня',
                'tomorrow': 'Завтра',
                'all': 'Все',
                'kids': 'Дети',
                'adult': 'Взрослые',
                'allAges': 'Все возрасты',
                'evening': 'Вечер',
                'morning': 'Утро',
                'noon': 'Полдень',
                'other': 'Другое',
                'noActivitiesForDate': 'На эту дату нет активностей',
                'activitiesLoadingError': 'Ошибка при загрузке активностей',
                'activitiesLoading': 'Загрузка активностей...',
                
                // Settings
                'ghostMode': 'Режим призрака',
                
                // Common
                'loading': 'Загрузка...',
                'now': 'Сейчас',
                'viewComments': 'Просмотреть комментарии',
                'likes': 'лайков',
                'likesLoading': 'Загрузка лайков...'
            }
        };
        
        function t(key) {
            return translations[currentLanguage][key] || translations['tr'][key] || key;
        }
        
        function applyTranslations() {
            // Tüm data-i18n attribute'larına sahip elementleri bul ve çevir
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (key) {
                    element.textContent = t(key);
                }
            });
            
            // Map chips için özel işlem (Oda 101, Oda 102, vs.)
            document.querySelectorAll('[data-i18n-room]').forEach(element => {
                const roomNumber = element.getAttribute('data-i18n-room');
                const roomText = t('room');
                element.textContent = `${roomText} ${roomNumber}`;
            });
            
            // Placeholder'ları çevir
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (key) {
                    element.placeholder = t(key);
                }
            });
            
            // Mevcut dili göster
            const langNames = {
                'tr': 'Türkçe',
                'en': 'English',
                'de': 'Deutsch',
                'ru': 'Русский'
            };
            const currentLangDisplay = document.getElementById('currentLanguageDisplay');
            if (currentLangDisplay) {
                currentLangDisplay.textContent = langNames[currentLanguage] || 'Türkçe';
            }
            
            // Dil seçim modal'ındaki check işaretlerini güncelle
            ['tr', 'en', 'de', 'ru'].forEach(lang => {
                const checkEl = document.getElementById(`langCheck${lang.charAt(0).toUpperCase() + lang.slice(1)}`);
                if (checkEl) {
                    checkEl.style.display = (lang === currentLanguage) ? 'inline' : 'none';
                }
            });
        }
        
        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            applyTranslations();
            // Update location permission status when language changes
            if (typeof updateLocationPermissionStatus === 'function') {
                updateLocationPermissionStatus();
            }
            closeLanguageSelector();
        }
        
        function openLanguageSelector() {
            const modal = document.getElementById('languageModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeLanguageSelector() {
            const modal = document.getElementById('languageModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // ============================================
        // Activities Timeline Functions
        // ============================================

        let currentActivityDate = new Date().toISOString().split('T')[0]; // Default: today's date
        let currentActivityCategory = 'All'; // Backend category value
        let activitiesData = [];

        // Format time
        function formatTime(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            return `${hours}:${minutes}`;
        }

        // Format date
        function formatActivityDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const days = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            return `${date.getDate()} ${months[date.getMonth()]} ${days[date.getDay()]}`;
        }

        // Get date string for API (currentActivityDate is already a date string)
        function getActivityDateString() {
            return currentActivityDate || new Date().toISOString().split('T')[0];
        }

        // Load activities timeline
        async function loadActivitiesTimeline() {
            try {
                const dateStr = getActivityDateString();
                console.log('📅 Loading activities for date:', dateStr);
                let url = `/api/activities?date=${dateStr}`;
                
                if (currentActivityCategory && currentActivityCategory !== 'All') {
                    url += `&type=${encodeURIComponent(currentActivityCategory)}`;
                }
                
                console.log('🔗 Fetching URL:', url);
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load activities');
                
                activitiesData = await response.json();
                console.log('✅ Loaded activities:', activitiesData.length, 'items');
                if (activitiesData.length > 0) {
                    console.log('🔍 Sample activity data:', {
                        id: activitiesData[0].id,
                        title: activitiesData[0].title,
                        category: activitiesData[0].category,
                        type: activitiesData[0].type
                    });
                }
                renderActivitiesTimeline();
                updateNowPlayingBanner();
                // Apply translations after loading
                applyTranslations();
            } catch (error) {
                console.error('Error loading activities:', error);
                document.getElementById('timelineContainer').innerHTML = `
                    <div class="empty-timeline">
                        <div class="empty-timeline-icon">⚠️</div>
                        <div class="empty-timeline-text" data-i18n="activitiesLoadingError">Aktiviteler yüklenirken hata oluştu</div>
                    </div>
                `;
                applyTranslations();
            }
        }

        // Render activities timeline
        function renderActivitiesTimeline() {
            const container = document.getElementById('timelineContainer');
            
            if (activitiesData.length === 0) {
                container.innerHTML = `
                    <div class="empty-timeline">
                        <div class="empty-timeline-icon">📅</div>
                        <div class="empty-timeline-text" data-i18n="noActivitiesForDate">Bu tarihte aktivite bulunmuyor</div>
                    </div>
                `;
                applyTranslations();
                return;
            }
            
            // Group by category (Sabah, Öğle, Akşam) or use actual category from DB
            const grouped = {};
            const now = new Date();
            
            activitiesData.forEach(activity => {
                // Use actual category from DB, or group by time of day
                let category = activity.category || 'Diğer';
                
                // If category is in English (Sports, Kids Club, etc.), map to time-based category
                // Otherwise use as-is
                if (!['Sabah', 'Öğle', 'Akşam'].includes(category)) {
                    // Try to infer category from start_time if available
                    if (activity.start_time) {
                        const hour = parseInt(activity.start_time.split(':')[0]);
                        if (hour >= 6 && hour < 12) {
                            category = 'Sabah';
                        } else if (hour >= 12 && hour < 18) {
                            category = 'Öğle';
                        } else if (hour >= 18 && hour < 24) {
                            category = 'Akşam';
                        } else {
                            category = 'Diğer';
                        }
                    } else {
                        category = 'Diğer';
                    }
                }
                
                if (!grouped[category]) {
                    grouped[category] = [];
                }
                grouped[category].push(activity);
            });
            
            console.log('📊 Grouped activities:', Object.keys(grouped).map(k => `${k}: ${grouped[k].length}`).join(', '));
            
            let html = '';
            const categoryMap = {
                'Sabah': 'morning',
                'Öğle': 'noon',
                'Akşam': 'evening',
                'Diğer': 'other'
            };
            const categories = ['Sabah', 'Öğle', 'Akşam', 'Diğer'];
            
            categories.forEach(cat => {
                if (!grouped[cat] || grouped[cat].length === 0) return;
                
                html += `
                    <div class="time-period">
                        <div class="time-period-header" data-i18n="${categoryMap[cat]}">${cat.toUpperCase()}</div>
                        ${grouped[cat].map(activity => {
                            const startTime = formatTime(activity.start_time);
                            const endTime = formatTime(activity.end_time);
                            const timeRange = endTime ? `${startTime} - ${endTime}` : startTime;
                            
                            // Check if activity is past, current, or upcoming
                            const activityDate = activity.activity_date ? new Date(activity.activity_date + 'T' + (activity.start_time || '00:00:00')) : null;
                            let cardClass = '';
                            let isPast = false;
                            let isCurrent = false;
                            
                            if (activityDate) {
                                const now = new Date();
                                const endDate = activity.end_time ? new Date(activity.activity_date + 'T' + activity.end_time) : activityDate;
                                isPast = endDate < now;
                                isCurrent = activityDate <= now && endDate >= now;
                                
                                if (isPast) cardClass = 'past';
                                if (isCurrent) cardClass = 'current';
                            }
                            
                            return `
                                <div class="activity-card ${cardClass}" data-activity-id="${activity.id}">
                                    <div class="activity-card-image">
                                        ${activity.image_url ? 
                                            `<img src="${activity.image_url}" alt="${activity.title}">` :
                                            `<i data-lucide="${activity.icon || 'calendar'}" class="icon icon-xl"></i>`
                                        }
                                    </div>
                                    <div class="activity-card-content">
                                        <div class="activity-card-time">${timeRange}</div>
                                        <div class="activity-card-title">${activity.title || ''}</div>
                                        ${activity.location ? `
                                            <div class="activity-card-location">
                                                <i data-lucide="map-pin" class="icon icon-sm"></i>
                                                <span>${activity.location}</span>
                                            </div>
                                        ` : ''}
                                        ${activity.type ? `
                                            <span class="activity-card-type">${activity.type}</span>
                                        ` : ''}
                                        ${!isPast && !isCurrent && activityDate ? `
                                            <div class="activity-card-countdown" id="countdown-${activity.id}"></div>
                                        ` : ''}
                                    </div>
                                    <div class="activity-card-actions">
                                        ${activity.map_latitude && activity.map_longitude ? `
                                            <button class="activity-action-btn" onclick="showActivityOnMap(${activity.map_latitude}, ${activity.map_longitude}, '${activity.title}')" title="Haritada göster">
                                                <i data-lucide="map" class="icon icon-sm"></i>
                                            </button>
                                        ` : ''}
                                        <button class="activity-action-btn" onclick="toggleFavorite(${activity.id})" title="Favorilere ekle">
                                            <i data-lucide="star" class="icon icon-sm"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });
            
            container.innerHTML = html || `
                <div class="empty-timeline">
                    <div class="empty-timeline-icon">📅</div>
                    <div class="empty-timeline-text" data-i18n="noActivitiesForDate">Bu tarihte aktivite bulunmuyor</div>
                </div>
            `;
            
            // Apply translations to dynamically loaded content
            applyTranslations();
            
            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Start countdown timers
            startCountdownTimers();
        }

        // Update Now Playing banner
        function updateNowPlayingBanner() {
            const banner = document.getElementById('nowPlayingBanner');
            const titleEl = document.getElementById('nowPlayingTitle');
            const timeEl = document.getElementById('nowPlayingTime');
            
            const now = new Date();
            const currentActivity = activitiesData.find(activity => {
                if (!activity.start_time || !activity.activity_date) return false;
                const startDate = new Date(activity.activity_date + 'T' + activity.start_time);
                const endDate = activity.end_time ? new Date(activity.activity_date + 'T' + activity.end_time) : startDate;
                return startDate <= now && endDate >= now;
            });
            
            if (currentActivity) {
                banner.classList.add('active');
                titleEl.textContent = currentActivity.title || '';
                const timeRange = currentActivity.end_time 
                    ? `${formatTime(currentActivity.start_time)} - ${formatTime(currentActivity.end_time)}`
                    : formatTime(currentActivity.start_time);
                timeEl.textContent = timeRange;
            } else {
                banner.classList.remove('active');
            }
        }

        // Switch activity date
        function switchActivityDate(selectedDate) {
            // If called with 'today' or 'tomorrow' for backwards compatibility
            if (selectedDate === 'today') {
                selectedDate = new Date().toISOString().split('T')[0];
            } else if (selectedDate === 'tomorrow') {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                selectedDate = tomorrow.toISOString().split('T')[0];
            }
            
            if (!selectedDate) {
                selectedDate = new Date().toISOString().split('T')[0];
            }
            
            currentActivityDate = selectedDate;
            
            // Update date picker if it exists
            const datePicker = document.getElementById('activity-date-selector');
            if (datePicker) {
                datePicker.value = selectedDate;
            }
            
            loadActivitiesTimeline();
        }

        // Filter by category
        function filterByCategory(buttonElement) {
            const backendCategory = buttonElement.getAttribute('data-category');
            currentActivityCategory = backendCategory;
            
            document.querySelectorAll('.category-filter-chip').forEach(chip => chip.classList.remove('active'));
            buttonElement.classList.add('active');
            
            loadActivitiesTimeline();
        }

        // Start countdown timers
        function startCountdownTimers() {
            const now = new Date();
            
            activitiesData.forEach(activity => {
                if (!activity.start_time || !activity.activity_date) return;
                
                const startDate = new Date(activity.activity_date + 'T' + activity.start_time);
                if (startDate <= now) return; // Skip past activities
                
                const countdownEl = document.getElementById(`countdown-${activity.id}`);
                if (!countdownEl) return;
                
                const updateCountdown = () => {
                    const diff = startDate - new Date();
                    if (diff <= 0) {
                        countdownEl.textContent = '';
                        loadActivitiesTimeline(); // Reload to update status
                        return;
                    }
                    
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (hours > 0) {
                        countdownEl.textContent = `${hours}s ${minutes}dk sonra başlıyor`;
                    } else {
                        countdownEl.textContent = `${minutes}dk sonra başlıyor`;
                    }
                };
                
                updateCountdown();
                setInterval(updateCountdown, 60000); // Update every minute
            });
        }

        // Toggle favorite
        function toggleFavorite(activityId) {
            // Check authentication first
            if (!requireAuth()) return;
            
            // TODO: Implement favorite functionality with database
            const btn = event.target.closest('.activity-action-btn');
            btn.classList.toggle('active');
            
            // Save to localStorage for now
            const favorites = JSON.parse(localStorage.getItem('activityFavorites') || '[]');
            const index = favorites.indexOf(activityId);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(activityId);
            }
            localStorage.setItem('activityFavorites', JSON.stringify(favorites));
        }

        // Show activity on map
        function showActivityOnMap(lat, lng, title) {
            // Switch to map section and show activity location
            switchSection('map');
            setTimeout(() => {
                if (typeof map !== 'undefined' && map) {
                    map.setView([lat, lng], 17, { animate: true, duration: 1.0 });
                    
                    // Add marker if it doesn't exist
                    if (typeof L !== 'undefined') {
                        const marker = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup(`<b>${title}</b>`)
                            .openPopup();
                    }
                }
            }, 300);
        }

        // Add pulse animation for now playing banner
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }
        `;
        document.head.appendChild(style);

        window.addEventListener('DOMContentLoaded', async () => {
            // await checkGuestAuth(); // Geçici olarak devre dışı - tasarım görmek için
            applyTranslations(); // Sayfa yüklendiğinde çevirileri uygula
            
            // Initialize navigation visibility based on auth status
            await checkAuthStatus();
            updateNavigationVisibility();
            
            // Initialize date picker with today's date
            const datePicker = document.getElementById('activity-date-selector');
            if (datePicker) {
                datePicker.value = currentActivityDate;
            }
        });

        window.addEventListener('load', async () => {
            // Initialize Lucide Icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            console.log('🚀 Voyage Sorgun Chat initialized');

            // Settings login/session state (uses guest_unique_id cookie)
            await checkAuthStatus();
            
            // Setup PWA fullscreen support
            setupPWAFullscreen();
            
            // Setup PWA safe area refresh (ana ekrana eklendiğinde safe area'yı güncelle)
            setupPWASafeAreaRefresh();
            
            // Klavye açıldığında input container pozisyonunu koru
            setupKeyboardHandling();
            
            // Initialize socket connection if guest is authenticated
            if (GUEST_UNIQUE_ID) {
            await initializeSocket();
            }
            
            console.log('Room:', ROOM_NUMBER);
            console.log('Guest:', GUEST_NAME);
            loadProfilePhoto();
            
            // Initialize notification toggle
            updateNotificationToggle();
            
            // Initialize location permission status
            updateLocationPermissionStatus();
            
            // Setup file input event listeners
            const cameraInput = document.getElementById('cameraInput');
            const galleryInput = document.getElementById('galleryInput');
            
            if (cameraInput) {
                cameraInput.addEventListener('change', handlePhotoSelect);
                console.log('✅ Camera input listener attached');
            }
            
            if (galleryInput) {
                galleryInput.addEventListener('change', handlePhotoSelect);
                console.log('✅ Gallery input listener attached');
            }
        });
        // ============================================
        // RESTAURANT RESERVATION FUNCTIONS
        // ============================================

        // Legacy openRestaurantReservationModalComplex function removed - using simple version above

        // Add additional room
        function addAdditionalRoom() {
            const roomsList = document.getElementById('reservation-additional-rooms-list');
            const roomId = 'room-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const roomDiv = document.createElement('div');
            roomDiv.id = roomId;
            roomDiv.style.display = 'flex';
            roomDiv.style.gap = '10px';
            roomDiv.style.marginBottom = '10px';
            roomDiv.style.alignItems = 'center';
            
            roomDiv.innerHTML = `
                <div style="flex: 1;">
                    <label style="display: block; font-size: 12px; color: #6C757D; margin-bottom: 4px;">Oda Numarası</label>
                    <input type="text" class="additional-room-number" placeholder="Örn: 102" onchange="calculateTotalPax()" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-size: 12px; color: #6C757D; margin-bottom: 4px;">Yetişkin</label>
                    <input type="number" class="additional-room-adult" min="0" value="0" onchange="calculateTotalPax()" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-size: 12px; color: #6C757D; margin-bottom: 4px;">Çocuk</label>
                    <input type="number" class="additional-room-child" min="0" value="0" onchange="calculateTotalPax()" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
                </div>
                <div style="flex: 0 0 auto; padding-top: 20px;">
                    <button type="button" onclick="removeAdditionalRoom('${roomId}')" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Sil</button>
                </div>
            `;
            
            roomsList.appendChild(roomDiv);
            calculateTotalPax();
        }

        // Remove additional room
        function removeAdditionalRoom(roomId) {
            const roomDiv = document.getElementById(roomId);
            if (roomDiv) {
                roomDiv.remove();
                calculateTotalPax();
            }
        }

        // Calculate total pax
        function calculateTotalPax() {
            const mainAdult = parseInt(document.getElementById('reservation-pax-adult').value) || 0;
            const mainChild = parseInt(document.getElementById('reservation-pax-child').value) || 0;
            
            let additionalPax = 0;
            document.querySelectorAll('.additional-room-adult').forEach(input => {
                additionalPax += parseInt(input.value) || 0;
            });
            document.querySelectorAll('.additional-room-child').forEach(input => {
                additionalPax += parseInt(input.value) || 0;
            });
            
            const totalPax = mainAdult + mainChild + additionalPax;
            document.getElementById('reservation-total-pax-count').textContent = totalPax;
            
            // Check max total pax limit
            const warningEl = document.getElementById('reservation-max-pax-warning');
            if (window.currentRestaurantData && window.currentRestaurantData.rules_json && window.currentRestaurantData.rules_json.max_total_pax) {
                const maxPax = window.currentRestaurantData.rules_json.max_total_pax;
                if (totalPax > maxPax) {
                    warningEl.style.display = 'inline';
                    warningEl.textContent = `⚠️ Maksimum ${maxPax} kişi limiti aşıldı!`;
                } else {
                    warningEl.style.display = 'none';
                }
            } else {
                warningEl.style.display = 'none';
            }
        }

        // Select table preference (visual feedback)
        function selectTablePreference(preference) {
            const smokingLabel = document.getElementById('reservation-preference-smoking-label');
            const nonSmokingLabel = document.getElementById('reservation-preference-non-smoking-label');
            const smokingRadio = document.getElementById('reservation-preference-smoking');
            const nonSmokingRadio = document.getElementById('reservation-preference-non-smoking');
            
            // Reset styles
            smokingLabel.style.border = '2px solid #dee2e6';
            smokingLabel.style.background = 'white';
            nonSmokingLabel.style.border = '2px solid #dee2e6';
            nonSmokingLabel.style.background = 'white';
            
            // Apply selected style
            if (preference === 'smoking') {
                smokingRadio.checked = true;
                smokingLabel.style.border = '2px solid #1A4D6D';
                smokingLabel.style.background = '#E8F1F5';
            } else {
                nonSmokingRadio.checked = true;
                nonSmokingLabel.style.border = '2px solid #1A4D6D';
                nonSmokingLabel.style.background = '#E8F1F5';
            }
        }

        // Close restaurant reservation modal
        function closeRestaurantReservationModal() {
            const modal = document.getElementById('restaurantReservationModal');
            modal.style.display = 'none';
        }

        // Submit restaurant reservation (updated simplified version - second definition removed, using first one)

    </script>
    <div id="restaurantReservationModal" class="modal" onclick="if(event.target === this) closeRestaurantReservationModal()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #E8F1F5;">
                <h3 style="font-size: 20px; font-weight: 600; color: #1A4D6D; margin: 0;" id="restaurantReservationModalTitle">Restoran Rezervasyonu</h3>
                <button onclick="closeRestaurantReservationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6C757D; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <form id="restaurantReservationForm" onsubmit="submitRestaurantReservation(event)">
                <input type="hidden" id="reservation-restaurant-id">
                <input type="hidden" id="reservation-session-instance-id" value="" style="display: none;">
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 14px; font-weight: 500; color: #2C3E50; margin-bottom: 8px;">Yetişkin Sayısı *</label>
                    <input type="number" id="reservation-pax-adult" class="form-input" min="1" value="1" required style="width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 14px; font-weight: 500; color: #2C3E50; margin-bottom: 8px;">Çocuk Sayısı</label>
                    <input type="number" id="reservation-pax-child" class="form-input" min="0" value="0" style="width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                </div>
                
                <!-- Additional Rooms Section (Conditional) -->
                <div id="reservation-additional-rooms-section" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; font-size: 14px; font-weight: 500; color: #2C3E50; margin-bottom: 8px;">Başka Odaları Dahil Et <span style="color: #6C757D; font-weight: 400;">(Opsiyonel)</span></label>
                    <div id="reservation-additional-rooms-list" style="margin-bottom: 10px;">
                        <!-- Dynamic room inputs will be added here -->
                    </div>
                    <button type="button" onclick="addAdditionalRoom()" style="padding: 8px 16px; background: #E8F1F5; color: #1A4D6D; border: 1px solid #1A4D6D; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">+ Oda Ekle</button>
                    <div id="reservation-total-pax-summary" style="margin-top: 10px; padding: 10px; background: #E8F1F5; border-radius: 8px; font-size: 14px; color: #1A4D6D;">
                        <strong>Toplam Kişi Sayısı: <span id="reservation-total-pax-count">1</span></strong>
                        <span id="reservation-max-pax-warning" style="color: #dc3545; display: none; margin-left: 10px;">⚠️ Maksimum limit aşıldı!</span>
                    </div>
                </div>
                
                <!-- Masa/Alan Tercihi (Conditional) -->
                <div id="reservation-table-preference-section" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; font-size: 14px; font-weight: 500; color: #2C3E50; margin-bottom: 8px;">Masa/Alan Tercihi <span style="color: #6C757D; font-weight: 400;">(Opsiyonel)</span></label>
                    <div style="display: flex; gap: 10px;">
                        <label style="flex: 1; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; background: white;" id="reservation-preference-smoking-label" onclick="selectTablePreference('smoking')">
                            <input type="radio" name="table-preference" value="smoking" id="reservation-preference-smoking" style="display: none;">
                            <span style="font-size: 14px; color: #2C3E50; font-weight: 500;">🚬 Sigara</span>
                        </label>
                        <label style="flex: 1; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; background: white;" id="reservation-preference-non-smoking-label" onclick="selectTablePreference('non-smoking')">
                            <input type="radio" name="table-preference" value="non-smoking" id="reservation-preference-non-smoking" style="display: none;">
                            <span style="font-size: 14px; color: #2C3E50; font-weight: 500;">🚭 Sigarasız</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 14px; font-weight: 500; color: #2C3E50; margin-bottom: 8px;">Özel İstekler (Opsiyonel)</label>
                    <textarea id="reservation-special-requests" rows="3" style="width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button type="button" onclick="closeRestaurantReservationModal()" style="flex: 1; padding: 12px; background: #6C757D; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;">İptal</button>
                    <button type="submit" style="flex: 1; padding: 12px; background: #1A4D6D; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;">Rezervasyon Yap</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Story Viewer Modal -->
    <div id="storyViewerModal" class="story-viewer-modal">
        <div class="story-viewer-header">
            <button id="storyViewerClose" class="story-viewer-close">×</button>
            <div id="storyViewerTitle" class="story-viewer-title"></div>
        </div>
        <div id="storyViewerIndicators" class="story-viewer-indicators"></div>
        <div id="storyViewerContent" class="story-viewer-content"></div>
    </div>

    <!-- SPA Booking Wizard Modal -->
    <div id="spaBookingModal" class="spa-booking-modal" onclick="if(event.target === this) closeSpaBookingWizard()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div class="spa-booking-modal-content" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #E8F1F5;">
                <h3 style="font-size: 20px; font-weight: 600; color: #1A4D6D; margin: 0;">SPA Rezervasyon Talebi</h3>
                <button onclick="closeSpaBookingWizard()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6C757D; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            
            <!-- Progress Indicator -->
            <div class="spa-booking-progress" style="display: flex; justify-content: space-between; margin-bottom: 24px; padding: 0 20px;">
                <div class="spa-booking-progress-dot active"></div>
                <div class="spa-booking-progress-dot"></div>
                <div class="spa-booking-progress-dot"></div>
                <div class="spa-booking-progress-dot"></div>
                <div class="spa-booking-progress-dot"></div>
            </div>
            
            <!-- Step 1: Service Selection -->
            <div id="spa-booking-step-service" class="spa-booking-step" style="display: block;">
                <h4 style="font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 16px;">Hizmet Seçin</h4>
                <div id="spa-services-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- Services will be loaded here -->
                </div>
            </div>
            
            <!-- Step 2: Date Selection -->
            <div id="spa-booking-step-date" class="spa-booking-step" style="display: none;">
                <h4 style="font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 16px;">Tarih Seçin</h4>
                <div id="spa-availability-last-update" style="font-size: 12px; color: #667781; margin-bottom: 8px; text-align: center;"></div>
                <div id="spa-availability-warning" style="display: none; background: #fff3cd; color: #856404; padding: 8px 12px; border-radius: 6px; font-size: 12px; margin-bottom: 16px; text-align: center;"></div>
                <div id="spa-availability-calendar" style="display: flex; gap: 8px; flex-wrap: wrap; max-height: 400px; overflow-y: auto; justify-content: center;">
                    <!-- Calendar will be rendered here -->
                </div>
                <button onclick="showSpaBookingStep('service')" style="margin-top: 16px; padding: 8px 16px; background: #E8F1F5; color: #1A4D6D; border: 1px solid #1A4D6D; border-radius: 6px; font-size: 14px; cursor: pointer;">Geri</button>
            </div>
            
            <!-- Step 3: Time Slot Selection -->
            <div id="spa-booking-step-time" class="spa-booking-step" style="display: none;">
                <h4 style="font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 16px;">Saat Seçin</h4>
                <div id="spa-time-slots-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- Time slots will be rendered here -->
                </div>
                <button onclick="showSpaBookingStep('date')" style="margin-top: 16px; padding: 8px 16px; background: #E8F1F5; color: #1A4D6D; border: 1px solid #1A4D6D; border-radius: 6px; font-size: 14px; cursor: pointer;">Geri</button>
            </div>
            
            <!-- Step 4: Therapist Selection -->
            <div id="spa-booking-step-therapist" class="spa-booking-step" style="display: none;">
                <h4 style="font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 16px;">Terapist Seçin</h4>
                <div id="spa-therapists-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- Therapists will be rendered here -->
                </div>
                <button onclick="showSpaBookingStep('time')" style="margin-top: 16px; padding: 8px 16px; background: #E8F1F5; color: #1A4D6D; border: 1px solid #1A4D6D; border-radius: 6px; font-size: 14px; cursor: pointer;">Geri</button>
            </div>
            
            <!-- Step 5: Confirmation -->
            <div id="spa-booking-step-confirm" class="spa-booking-step" style="display: none;">
                <h4 style="font-size: 16px; font-weight: 600; color: #111b21; margin-bottom: 16px;">Talebi Onaylayın</h4>
                <div style="background: #E8F1F5; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">Hizmet</div>
                        <div style="font-weight: 600; color: #111b21;" id="spa-confirm-service">-</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">Tarih</div>
                        <div style="font-weight: 600; color: #111b21;" id="spa-confirm-date">-</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">Saat</div>
                        <div style="font-weight: 600; color: #111b21;" id="spa-confirm-time">-</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #667781; margin-bottom: 4px;">Terapist</div>
                        <div style="font-weight: 600; color: #111b21;" id="spa-confirm-therapist">-</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; font-weight: 500; color: #2C3E50; margin-bottom: 8px;">Not (Opsiyonel)</label>
                    <textarea id="spa-confirm-note" rows="3" style="width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px; resize: vertical; font-family: inherit;"></textarea>
                </div>
                
                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 12px; color: #856404; line-height: 1.5;">
                    ⚠️ Bu bir taleptir. SPA ekibi onayladıktan sonra kesinleşir.
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="showSpaBookingStep('therapist')" style="flex: 1; padding: 12px; background: #6C757D; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;">Geri</button>
                    <button id="spa-submit-request-btn" onclick="submitSpaRequest()" style="flex: 1; padding: 12px; background: #1A4D6D; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;">Talebi Gönder</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


